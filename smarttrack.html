<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartTrack - Suivi Intelligent d'Entra√Ænement</title>    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007AFF">
    
    <style>
        /* === VARIABLES CSS === */
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --background: #F2F2F7;
            --surface: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #6D6D70;
            --border: #C6C6C8;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --background: #1C1C1E;
            --surface: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border: #38383A;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        /* === RESET & BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* === LAYOUT === */
        .app-container {
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--background);
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            flex: 1;
            padding: 16px;
            animation: slideIn 0.3s ease-out;
            width: 100%;
            box-sizing: border-box;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* Am√©lioration des items d'exercices */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 8px;
            min-height: 80px;
        }

        .exercise-item > div:first-child {
            flex: 1;
            min-width: 250px;
            word-wrap: break-word;
        }

        .exercise-item > div:last-child {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-width: 300px;
        }

        .exercise-item input[type="number"] {
            min-width: 70px;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
        }

        .exercise-item span {
            font-size: 12px;
            white-space: nowrap;
            font-weight: 500;
        }

        /* Am√©lioration responsive */
        @media (max-width: 768px) {
            .exercise-item {
                flex-direction: column;
                align-items: stretch;
                padding: 12px;
            }
        
            .exercise-item > div:first-child {
                min-width: 100%;
                margin-bottom: 8px;
            }
        
            .exercise-item > div:last-child {
                justify-content: space-between;
                min-width: 100%;
            }
        
            .exercise-item input[type="number"] {
                min-width: 60px;
            }
        }

        /* Am√©lioration des cartes */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border);
            max-width: 100%;
            overflow-x: auto;
        }

        /* Am√©lioration des grilles de stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        /* Am√©lioration des inputs de performance */
            .performance-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 24px 0;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* === NAVIGATION === */
        .nav-bar {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 -2px 10px var(--shadow);
        }

        /* Compensation pour le menu fixe en bas */
        .screen {
            padding-bottom: 80px; /* Espace pour le menu de navigation */
        }

        /* Ajuster le padding existant */
        .screen.active {
            display: flex;
            flex-direction: column;
            padding-bottom: 80px;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item:hover {
            color: var(--primary);
        }

        /* === COMPONENTS === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-full {
            width: 100%;
            margin-bottom: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input, .select, .textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--surface);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
        }

        /* === CALENDAR GRID === */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin: 16px 0;
            max-height: 120px;
            overflow: hidden;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background: var(--border);
            opacity: 0.3;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            max-width: 20px;
            max-height: 20px;
        }

        .calendar-day.active {
            opacity: 1;
            background: var(--secondary);
            color: white;
        }

        .calendar-day.high-volume {
            background: var(--primary);
            color: white;
        }

        /* === STATS === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* === EXERCISE LIST === */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
        }

        /* === STYLES D√âTAILS EXERCICES === */
        .exercise-details-section {
            margin: 24px 0;
            padding: 20px;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .exercise-details-section h4 {
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 12px 0;
            padding: 12px;
            background: var(--background);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .tip-item, .mistake-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .tip-item {
            background: #34C75920;
            border-left: 3px solid #34C759;
        }

        .mistake-item {
            background: #FF3B3020;
            border-left: 3px solid #FF3B30;
        }

        .muscle-tag {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .muscle-primary {
            background: var(--primary);
            color: white;
        }

        .muscle-secondary {
            background: var(--border);
            color: var(--text-secondary);
        }

        .image-placeholder {
            width: 100%;
            height: 200px;
            background: var(--background);
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            margin: 16px 0;
        }

        .favorite-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .favorite-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .favorite-btn.active {
            background: #FFD700;
            color: #000;
        }

        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            margin: 8px 0;
        }

        .difficulty-beginner {
            background: #34C75920;
            color: #34C759;
            border: 2px solid #34C759;
        }

        .difficulty-intermediate {
            background: #FF950020;
            color: #FF9500;
            border: 2px solid #FF9500;
        }

        .difficulty-advanced {
            background: #FF3B3020;
            color: #FF3B30;
            border: 2px solid #FF3B30;
        }

        .exercise-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .exercise-stat {
            text-align: center;
            padding: 12px;
            background: var(--background);
            border-radius: 8px;
        }

        .exercise-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .exercise-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* === SYST√àME DE M√âDIAS === */
        .media-library-modal .modal-content {
            max-width: 900px;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .media-item {
            position: relative;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface);
        }

        .media-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .media-item.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .media-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .media-item-info {
            padding: 8px;
            font-size: 12px;
            text-align: center;
        }

        .media-item-name {
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .media-item-size {
            color: var(--text-secondary);
            font-size: 10px;
        }

        .media-upload-zone {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin: 16px 0;
            background: var(--background);
            transition: all 0.2s;
        }

        .media-upload-zone.dragover {
            background: var(--primary);
            color: white;
            transform: scale(1.02);
        }

        .media-optimization-info {
            background: var(--background);
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid var(--warning);
        }

        .media-optimization-info h5 {
            color: var(--warning);
            margin-bottom: 8px;
        }

        .compression-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
            padding: 16px;
            background: var(--surface);
            border-radius: 8px;
        }

        .compression-before, .compression-after {
            text-align: center;
        }

        .compression-stats {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s;
        }

        .lazy-image.loaded {
            opacity: 1;
        }

        .media-search {
            position: sticky;
            top: 0;
            background: var(--surface);
            padding: 16px;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        .media-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .media-category-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .media-category-btn:hover,
        .media-category-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* === SCH√âMAS ANATOMIQUES === */
        .anatomy-diagram {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .body-diagram {
            width: 150px;
            height: 300px;
            position: relative;
        }

        .body-diagram svg {
            width: 100%;
            height: 100%;
        }

        .muscle-group {
            fill: #E5E5E5;
            stroke: #CCCCCC;
            stroke-width: 1;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .muscle-group:hover {
            stroke-width: 2;
            stroke: var(--primary);
        }

        .muscle-group.primary {
            fill: var(--primary);
            stroke: var(--primary-dark);
            stroke-width: 2;
        }

        .muscle-group.secondary {
            fill: #FFB84D;
            stroke: #FF9500;
            stroke-width: 1.5;
        }

        .anatomy-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 12px 0;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .anatomy-title {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* === LIVE SESSION === */
        .session-timer {
            text-align: center;
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            margin: 24px 0;
        }

        .current-exercise {
            text-align: center;
            margin: 24px 0;
        }

        .exercise-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .set-counter {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .performance-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 24px 0;
        }

        .rest-timer {
            text-align: center;
            margin: 24px 0;
        }

        .rest-time {
            font-size: 72px;
            font-weight: 700;
            color: var(--warning);
        }

        .next-exercise {
            background: var(--surface);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            border: 1px solid var(--border);
        }

        /* === MODAL === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* === SYST√àME DE TAGS AVANC√â === */
        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tag-item.selected {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .tag-item.removable {
            padding-right: 4px;
        }

        .tag-item .remove-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 10px;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            opacity: 0.7;
        }

        .tag-item .remove-btn:hover {
            opacity: 1;
        }

        /* Couleurs des tags */
        .tag-blue { background: #007AFF20; color: #007AFF; border: 1px solid #007AFF40; }
        .tag-green { background: #34C75920; color: #34C759; border: 1px solid #34C75940; }
        .tag-orange { background: #FF950020; color: #FF9500; border: 1px solid #FF950040; }
        .tag-purple { background: #AF52DE20; color: #AF52DE; border: 1px solid #AF52DE40; }
        .tag-red { background: #FF3B3020; color: #FF3B30; border: 1px solid #FF3B3040; }
        .tag-gray { background: #8E8E9320; color: #8E8E93; border: 1px solid #8E8E9340; }

        /* Filtres avanc√©s */
        .advanced-filters-panel {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 300px; }
        }

        .filter-combination {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            background: var(--surface);
            border-radius: 6px;
        }

        .filter-operator {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .tag-suggestion {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: var(--background);
            border: 1px dashed var(--border);
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-suggestion:hover {
            background: var(--primary);
            color: white;
            border-style: solid;
        }

        .tags-input-container {
            position: relative;
        }

        .tags-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .tag-suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .tag-suggestion-item:hover {
            background: var(--background);
        }

        .tag-suggestion-item:last-child {
            border-bottom: none;
        }

        /* === NOTIFICATION === */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1001;
            display: none;
            /* Am√©lioration pour les s√©ances live */
            max-width: 300px;
            font-size: 14px;
            text-align: center;
        }

        .notification.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* Style sp√©cial pour les notifications en s√©ance */
        .notification.live-session {
            top: 80px;
            background: var(--primary);
            opacity: 0.9;
            font-size: 12px;
            padding: 8px 16px;
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }

        /* === CHART CONTAINER === */
        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        /* === RESPONSIVE === */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .screen {
                padding: 16px;
            }
            
            .performance-inputs {
                grid-template-columns: 1fr;
            }
        }

        /* Styles pour les sections d'exercices (√©chauffement/principal) */
        .exercise-section-title {
            margin: 16px 0 8px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exercise-section-title.warmup {
            color: var(--warning);
            border-color: var(--warning);
        }

        .exercise-section-title.main {
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Styles pour les boutons de r√©organisation */
        .reorder-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .reorder-buttons button {
            padding: 2px 6px;
            font-size: 10px;
            min-width: 24px;
            height: 20px;
        }

        .reorder-buttons button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Num√©rotation des exercices */
        .exercise-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Groupes d'exercices dans les mod√®les */
        .exercise-group-title {
            margin: 16px 0 8px 0;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Indicateurs de mode d'exercice */
        .exercise-mode-indicator {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--background);
            color: var(--text-secondary);
            margin-left: 8px;
        }

        /* Style pour les champs conditionnels */
        .conditional-input {
            transition: all 0.3s ease;
        }

        .conditional-input.hidden {
            display: none;
        }

        /* === RECHERCHE EXERCICES === */
        .search-results {
            position: fixed;
            top: auto;
            left: 16px;
            right: 16px;
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 12px;
            max-height: 75vh;
            overflow-y: auto;
            z-index: 1500;
            box-shadow: 0 8px 32px var(--shadow);
            margin-top: 8px;
        }

        /* Ajustement responsive pour petits √©crans */
        @media (max-width: 768px) {
            .search-results {
                max-height: 80vh;
                left: 8px;
                right: 8px;
            }
        }


        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover, .search-result-item.highlighted {
            background: var(--primary);
            color: white;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .search-result-details {
            font-size: 12px;
            opacity: 0.8;
        }

        .search-history-item {
            display: inline-block;
            background: var(--background);
            padding: 4px 8px;
            margin: 2px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: background-color 0.2s;
        }

        .search-history-item:hover {
            background: var(--primary);
            color: white;
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }
    </style>
    <script>
        // Emp√™cher le pull-to-refresh par d√©faut
        document.addEventListener('touchstart', handleTouchStart, { passive: true });
        document.addEventListener('touchmove', handleTouchMove, { passive: false });

        let startY = null;

        function handleTouchStart(evt) {
            startY = evt.touches[0].clientY;
        }

        function handleTouchMove(evt) {
            if (startY === null) return;
            
            const currentY = evt.touches[0].clientY;
            const diff = currentY - startY;
            
            // Si on tire vers le bas depuis le haut de la page
            if (diff > 0 && window.pageYOffset === 0) {
                evt.preventDefault(); // Emp√™cher le refresh
            }
            
            startY = null;
        }
    </script>
</head>
<body>
    <div class="app-container">
        <!-- √âcran 0: Tableau de Bord -->
        <div id="screen-dashboard" class="screen active">
            <div class="header">
                <h1>SmartTrack</h1>
                <button class="btn btn-small btn-secondary" onclick="actions.showSettings()">‚öôÔ∏è</button>
            </div>
            
            <div class="card">
                <h3>Calendrier de R√©gularit√©</h3>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-sessions">0</div>
                    <div class="stat-label">S√©ances Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="current-streak">0</div>
                    <div class="stat-label">S√©rie Actuelle</div>
                </div>
            </div>
            
            <button class="btn btn-primary btn-full" onclick="actions.startNewSession()">
                üöÄ D√©marrer une s√©ance vide
            </button>
            <button class="btn btn-secondary btn-full" onclick="actions.resumeLastSession()">
                üìã Reprendre la derni√®re s√©ance
            </button>
        </div>

        <!-- √âcran 1: Pr√©paration de S√©ance -->
        <div id="screen-preparation" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('dashboard')">‚Üê Retour</button>
                <h1>Pr√©paration</h1>
                <div></div>
            </div>
            
            <div class="card">
                <div class="input-group">
                    <label>Date de la s√©ance</label>
                    <input type="date" id="session-date" class="input" onchange="actions.updateSessionDate(this.value)">
                </div>
                
                <div class="input-group">
                    <label>Notes de s√©ance</label>
                    <textarea id="session-notes" class="textarea" placeholder="Notes optionnelles..." onchange="actions.updateSessionNotes(this.value)"></textarea>
                </div>
                
                <button class="btn btn-secondary btn-full" onclick="actions.showTemplates()">
                    üìã Charger un mod√®le
                </button>
            </div>

            <div class="card">
                <h3>Ajouter un exercice</h3>
                <div class="input-group">
                    <label>Rechercher un exercice</label>
                    <div style="position: relative;">
                        <input type="text" id="exercise-search" class="input" placeholder="Tapez le nom d'un exercice ou groupe musculaire..." autocomplete="off">
                        <div id="exercise-search-results" class="search-results" style="display: none;"></div>
                    </div>
                    <div id="search-history" style="margin-top: 8px; display: none;"></div>
                </div>
                <button class="btn btn-primary btn-full" onclick="actions.addExerciseToSession()">
                    ‚ûï Ajouter √† la s√©ance
                </button>
            </div>
            
            <div class="card">
                <h3>Exercices pr√©vus</h3>
                <div id="planned-exercises"></div>
            </div>
            
            <button class="btn btn-success btn-full" onclick="actions.startLiveSession()" id="start-live-btn" style="display: none;">
                üöÄ D√©marrer la S√©ance Live
            </button>

            <button class="btn btn-secondary btn-full" onclick="actions.saveSessionManually()" id="save-manual-btn" style="display: none;">
                üíæ Sauvegarder sans Live
            </button>
        </div>

        <!-- √âcran 2: S√©ance Live -->
        <div id="screen-live" class="screen">
            <div class="header">
                <button class="btn btn-small btn-warning" onclick="actions.pauseLiveSession()">‚è∏Ô∏è Pause</button>
                <div class="session-timer" id="live-timer">00:00</div>
                <button class="btn btn-small btn-danger" onclick="actions.stopLiveSession()">‚èπÔ∏è Arr√™ter</button>
            </div>
            <div id="live-content"></div>
        </div>

        <!-- √âcran 3: Historique -->
        <div id="screen-history" class="screen">
            <div class="header">
                <h1>Historique</h1>
                <div class="stat-value" id="history-count">0</div>
            </div>
            
            <div id="sessions-list"></div>
        </div>

        <!-- √âcran 4: Statistiques -->
        <div id="screen-stats" class="screen">
            <div class="header">
                <h1>Statistiques</h1>
            </div>
            
            <div class="card">
                <div class="input-group">
                    <label>S√©lectionner un exercice</label>
                    <select id="stats-exercise-select" class="select" onchange="actions.updateStats(this.value)">
                        <option value="">Choisir un exercice...</option>
                    </select>
                </div>
            </div>
            
            <div id="stats-content"></div>
        </div>

        <!-- √âcran 5: Suivi Corporel -->
        <div id="screen-body" class="screen">
            <div class="header">
                <h1>Mensurations</h1>
            </div>
            
            <div class="card">
                <h3>Nouvelle mensuration</h3>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="measurement-date" class="input">
                </div>
                <div class="input-group">
                    <label>Taille (cm)</label>
                    <input type="number" id="measurement-height" class="input" step="0.5" min="100" max="250">
                </div>
                <div class="input-group">
                    <label>Poids (kg)</label>
                    <input type="number" id="measurement-weight" class="input" step="0.1">
                </div>
                <div class="input-group">
                    <label>Tour de taille (cm)</label>
                    <input type="number" id="measurement-waist" class="input" step="0.5">
                </div>
                <div class="input-group">
                    <label>Tour de poitrine (cm)</label>
                    <input type="number" id="measurement-chest" class="input" step="0.5">
                </div>
                <div class="input-group">
                    <label>Tour de bras (cm)</label>
                    <input type="number" id="measurement-arm" class="input" step="0.5">
                </div>
                <div class="input-group">
                    <label>Tour de cuisse (cm)</label>
                    <input type="number" id="measurement-thigh" class="input" step="0.5">
                </div>
                <button class="btn btn-primary btn-full" onclick="actions.addMeasurement()">
                    ‚ûï Ajouter la mensuration
                </button>
            </div>
            
            <div class="card">
                <h3>√âvolution des mensurations</h3>
                <div class="chart-container">
                    üìä Graphiques d'√©volution des mensurations
                </div>
            </div>
            
            <div id="measurements-list"></div>
        </div>

        <!-- √âcran 6: Gestion des Exercices -->
        <div id="screen-exercises" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showSettings()">‚Üê Retour</button>
                <h1>Exercices</h1>
                <div></div>
            </div>
            
            <div class="card">
                <h3 id="exercise-form-title">Nouvel exercice</h3>
                
                <div class="input-group">
                    <label>Nom de l'exercice</label>
                    <input type="text" id="exercise-name" class="input" placeholder="Ex: D√©velopp√© couch√©">
                </div>
                
                <!-- NOUVEAU: Cat√©gorie principale -->
                <div class="input-group">
                    <label>Cat√©gorie</label>
                    <select id="exercise-category" class="select">
                        <option value="strength">Renforcement</option>
                        <option value="warmup">√âchauffement</option>
                    </select>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="exercise-unilateral" class="checkbox">
                    <label for="exercise-unilateral">Exercice unilat√©ral</label>
                </div>
                
                <!-- NOUVEAU: Mode d'exercice -->
                <div class="input-group">
                    <label>Mode d'ex√©cution</label>
                    <select id="exercise-mode" class="select" onchange="toggleExerciseMode()">
                        <option value="reps">R√©p√©titions</option>
                        <option value="time">Temps</option>
                        <option value="both">R√©p√©titions ou Temps</option>
                    </select>
                </div>
                
                <!-- NOUVEAU: Dur√©e par d√©faut (affich√© si mode temps) -->
                <div class="input-group" id="duration-group" style="display: none;">
                    <label>Dur√©e par d√©faut (secondes)</label>
                    <input type="number" id="exercise-duration" class="input" value="30" min="10" max="300">
                </div>
                
                <div class="input-group">
                    <label>Temps de repos par d√©faut (secondes)</label>
                    <input type="number" id="exercise-rest" class="input" value="90">
                </div>
                
                <div class="input-group">
                    <label>Groupe musculaire</label>
                    <select id="exercise-muscle-group" class="select">
                        <option value="echauffement">√âchauffement</option>
                        <option value="biceps">Biceps</option>
                        <option value="triceps">Triceps</option>
                        <option value="epaules">√âpaules</option>
                        <option value="dos">Dos</option>
                        <option value="pectoraux">Pectoraux</option>
                        <option value="jambes">Jambes</option>
                        <option value="autres">Autres</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Point d'ancrage</label>
                    <select id="exercise-anchor" class="select" onchange="showExerciseExamples(this.value)">
                        <option value="none">üèÉ Sans ancrage (√©lastique libre)</option>
                        <option value="door-middle">üö™ Porte - hauteur moyenne</option>
                        <option value="door-high">üö™‚¨ÜÔ∏è Porte - position haute</option>
                        <option value="door-low">üö™‚¨áÔ∏è Porte - position basse</option>
                        <option value="floor">ü¶µ Sol/Pieds (marcher dessus)</option>
                        <option value="body">üîÑ Corps (√©lastique autour)</option>
                        <option value="external">üå≥ Ancrage ext√©rieur</option>
                    </select>
                    <div id="exercise-examples" style="margin-top: 8px; padding: 8px; background: var(--background); border-radius: 6px; font-size: 12px; color: var(--text-secondary); display: none;">
                        <strong>Exemples d'exercices :</strong>
                        <div id="examples-list"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Image/GIF de l'exercice</label>
                    <div id="exercise-media-container" style="border: 2px dashed var(--border); border-radius: 8px; padding: 16px; text-align: center;">
                        <div id="exercise-media-preview" style="display: none;">
                            <img id="exercise-media-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                <span id="media-file-info"></span>
                            </div>
                            <button type="button" class="btn btn-small btn-danger" onclick="actions.removeExerciseMedia()">
                                üóëÔ∏è Supprimer l'image
                            </button>
                        </div>
                        <div id="exercise-media-upload" style="display: block;">
                            <input type="file" id="exercise-media-input" accept="image/*,video/*" style="display: none;" onchange="actions.handleExerciseMediaUpload(event)">
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 48px; margin-bottom: 8px;">üé•</div>
                                <div style="font-size: 14px; margin-bottom: 8px;">Ajoutez une image ou GIF pour cet exercice</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    Formats support√©s : JPG, PNG, WebP, GIF<br>
                                    Taille recommand√©e : 400x300px ‚Ä¢ Max : 50KB
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('exercise-media-input').click()">
                                üìÅ Choisir un fichier
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="actions.showMediaLibrary()" style="margin-left: 8px;">
                                üñºÔ∏è Biblioth√®que
                            </button>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        üí° <strong>Conseil :</strong> Les images am√©liorent consid√©rablement la compr√©hension des mouvements
                    </div>
                </div>

                <button class="btn btn-primary btn-full" onclick="actions.saveExercise()" id="save-exercise-btn">
                    ‚ûï Ajouter l'exercice
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.loadPredefinedExercises()" id="load-predefined-btn">
                    üìö Charger les exercices SmartWorkout
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.cancelExerciseEdit()" id="cancel-exercise-btn" style="display: none;">
                    ‚ùå Annuler
                </button>
            </div>
            
            <div class="card">
                <h3>Mes exercices</h3>
                <div id="exercises-list"></div>
            </div>
        </div>

        <!-- √âcran 7: Gestion des Mod√®les -->
        <div id="screen-templates" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showSettings()">‚Üê Retour</button>
                <h1>Mod√®les</h1>
                <div></div>
            </div>
            
            <div class="card">
                <h3>Nouveau mod√®le</h3>
                <div class="input-group">
                    <label>Nom du mod√®le</label>
                    <input type="text" id="template-name" class="input" placeholder="Ex: Push Day">
                </div>
                <div class="input-group">
                    <label>Exercices</label>
                    <div id="template-exercises-checkboxes"></div>
                </div>
                <button class="btn btn-primary btn-full" onclick="actions.saveTemplate()">
                    ‚ûï Cr√©er le mod√®le
                </button>
            </div>
            
            <div class="card">
                <h3>Mes mod√®les</h3>
                <div id="templates-list"></div>
            </div>
        </div>

        <!-- √âcran 8: Param√®tres -->
        <div id="screen-settings" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('dashboard')">‚Üê Retour</button>
                <h1>Param√®tres</h1>
                <div></div>
            </div>
            
            <div class="card">
                <h3>Apparence</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="dark-theme" class="checkbox" onchange="actions.toggleTheme()">
                    <label for="dark-theme">Th√®me sombre</label>
                </div>
            </div>
            
            <div class="card">
                <h3>Donn√©es</h3>
                <button class="btn btn-secondary btn-full" onclick="actions.exportData()">
                    üì§ Exporter les donn√©es
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.showImportModal()">
                    üì• Importer les donn√©es
                </button>
                <button class="btn btn-danger btn-full" onclick="actions.clearAllData()">
                    üóëÔ∏è Effacer toutes les donn√©es
                </button>
            </div>
            
            <div class="card">
                <h3>Gestion</h3>
                <button class="btn btn-secondary btn-full" onclick="actions.showScreen('exercises')">
                    üí™ G√©rer les exercices
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.showScreen('templates')">
                    üìã G√©rer les mod√®les
                </button>
            </div>
        </div>

        <!-- √âcran 9: Saisie Manuelle -->
        <div id="screen-manual-entry" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('preparation')">‚Üê Retour</button>
                <h1>Saisie Manuelle</h1>
                <div></div>
            </div>
            
            <div id="manual-entry-content"></div>
        </div>

        <!-- √âcran 10: Base de Donn√©es Exercices -->
        <div id="screen-exercise-database" class="screen">
            <div class="header">
                <h1>üí™ Base d'Exercices</h1>
                <button class="btn btn-small btn-secondary" onclick="actions.toggleExerciseView()">
                    <span id="view-toggle-btn">üî§ Vue Liste</span>
                </button>
            </div>
        
            <!-- Filtres et recherche -->
            <div class="card">
                <div class="input-group">
                    <label>üîç Rechercher un exercice</label>
                    <input type="text" id="exercise-db-search" class="input" placeholder="Nom d'exercice, groupe musculaire..." onkeyup="actions.filterExerciseDatabase()">
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
                    <div class="input-group">
                        <label>Groupe musculaire</label>
                        <select id="muscle-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous les groupes</option>
                            <option value="echauffement">üî• √âchauffement</option>
                            <option value="biceps">üí™ Biceps</option>
                            <option value="triceps">üîß Triceps</option>
                            <option value="epaules">ü§≤ √âpaules</option>
                            <option value="dos">üóÇÔ∏è Dos</option>
                            <option value="pectoraux">ü¶Ü Pectoraux</option>
                            <option value="jambes">ü¶µ Jambes</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Niveau de difficult√©</label>
                        <select id="difficulty-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous niveaux</option>
                            <option value="beginner">üü¢ D√©butant</option>
                            <option value="intermediate">üü° Interm√©diaire</option>
                            <option value="advanced">üî¥ Confirm√©</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Point d'ancrage</label>
                        <select id="anchor-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous ancrages</option>
                            <option value="none">üèÉ Sans ancrage</option>
                            <option value="door">üö™ Porte</option>
                            <option value="floor">ü¶µ Sol/Pieds</option>
                            <option value="body">üîÑ Corps</option>
                            <option value="external">üå≥ Ext√©rieur</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Tags</label>
                        <select id="tags-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous les tags</option>
                            <option value="isolation">üéØ Isolation</option>
                            <option value="compos√©">üèóÔ∏è Compos√©</option>
                            <option value="force">üí™ Force</option>
                            <option value="masse">üìà Masse</option>
                            <option value="endurance">‚è±Ô∏è Endurance</option>
                            <option value="fonctionnel">üîÑ Fonctionnel</option>
                            <option value="√©quilibre">‚öñÔ∏è √âquilibre</option>
                            <option value="posture">üßò Posture</option>
                            <option value="cardio">‚ù§Ô∏è Cardio</option>
                            <option value="gainage">üõ°Ô∏è Gainage</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-small btn-secondary" onclick="actions.clearExerciseFilters()">üóëÔ∏è Effacer filtres</button>
                    <button class="btn btn-small btn-primary" onclick="actions.showExerciseFavorites()">‚≠ê Favoris</button>
                    <button class="btn btn-small btn-secondary" onclick="actions.showTagsManager()">üè∑Ô∏è G√©rer tags</button>
                    <button class="btn btn-small btn-secondary" onclick="actions.toggleAdvancedFilters()" id="advanced-filters-btn">
                        üîß Filtres avanc√©s
                    </button>
                </div>

                <!-- Filtres avanc√©s (masqu√©s par d√©faut) -->
                <div id="advanced-filters" style="display: none; margin-top: 16px; padding: 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                    <h5 style="margin-bottom: 12px; color: var(--primary);">üîß Filtrage avanc√©</h5>
                    
                    <div class="input-group">
                        <label>Tags personnalis√©s</label>
                        <div id="custom-tags-container" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface);">
                            <span style="color: var(--text-secondary); font-size: 12px;" id="no-custom-tags">Aucun tag personnalis√©</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 12px;">
                        <div class="input-group">
                            <label>Dur√©e par d√©faut</label>
                            <select id="duration-filter" class="select" onchange="actions.filterExerciseDatabase()">
                                <option value="">Toutes dur√©es</option>
                                <option value="short">‚ö° Court (‚â§30s)</option>
                                <option value="medium">üïê Moyen (30-60s)</option>
                                <option value="long">‚è∞ Long (>60s)</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Mode d'ex√©cution</label>
                            <select id="mode-filter" class="select" onchange="actions.filterExerciseDatabase()">
                                <option value="">Tous modes</option>
                                <option value="reps">üî¢ R√©p√©titions</option>
                                <option value="time">‚è±Ô∏è Temps</option>
                                <option value="both">üîÑ Mixte</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Type d'exercice</label>
                            <select id="type-filter" class="select" onchange="actions.filterExerciseDatabase()">
                                <option value="">Tous types</option>
                                <option value="unilateral">üîÑ Unilat√©ral</option>
                                <option value="bilateral">‚öñÔ∏è Bilat√©ral</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sultats -->
            <div id="exercise-database-results"></div>
        </div>

        <!-- Navigation -->
        <nav class="nav-bar">
            <div class="nav-item active" onclick="actions.showScreen('dashboard')">
                <div>üè†</div>
                <div>Accueil</div>
            </div>
            <div class="nav-item" onclick="actions.goToSession()">
                <div>‚ö°</div>
                <div>S√©ance</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('exercise-database')">
                <div>üí™</div>
                <div>Exercices</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('history')">
                <div>üìä</div>
                <div>Historique</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('stats')">
                <div>üìà</div>
                <div>Stats</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('body')">
                <div>‚öñÔ∏è</div>
                <div>Corporel</div>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <div id="templates-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Charger un mod√®le</h3>
                <button class="close-btn" onclick="actions.closeModal('templates-modal')">&times;</button>
            </div>
            <div id="templates-modal-content"></div>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importer des donn√©es</h3>
                <button class="close-btn" onclick="actions.closeModal('import-modal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Donn√©es JSON</label>
                <textarea id="import-data" class="textarea" rows="10" placeholder="Collez vos donn√©es JSON ici..."></textarea>
            </div>
            <button class="btn btn-primary btn-full" onclick="actions.importData()">
                üì• Importer
            </button>
        </div>
    </div>

    <!-- Modal difficult√© de s√©ance -->
    <div id="difficulty-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üéØ Comment s'est pass√©e votre s√©ance ?</h3>
            </div>
            <p style="text-align: center; color: var(--text-secondary); margin: 16px 0;">
                Cette information nous aide √† suivre votre progression
            </p>
            <div style="display: grid; gap: 12px; margin: 20px 0;">
                <button class="btn btn-success btn-full" onclick="actions.finishSessionWithDifficulty('Facile')" style="padding: 16px;">
                    üòä Facile
                    <div style="font-size: 12px; opacity: 0.8;">J'aurais pu faire plus</div>
                </button>
                <button class="btn btn-primary btn-full" onclick="actions.finishSessionWithDifficulty('Normale')" style="padding: 16px;">
                    üí™ Normale  
                    <div style="font-size: 12px; opacity: 0.8;">Effort mod√©r√©, bien dos√©</div>
                </button>
                <button class="btn btn-danger btn-full" onclick="actions.finishSessionWithDifficulty('Difficile')" style="padding: 16px;">
                    üî• Difficile
                    <div style="font-size: 12px; opacity: 0.8;">J'ai donn√© le maximum</div>
                </button>
            </div>
            <button class="btn btn-secondary btn-full" onclick="actions.finishSessionWithDifficulty(null)" style="margin-top: 8px;">
                Passer
            </button>
        </div>
    </div>

    <!-- Modal d'√©dition de s√©ance -->
    <div id="edit-session-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier la s√©ance</h3>
                <button class="close-btn" onclick="actions.closeModal('edit-session-modal')">√ó</button>
            </div>
            <div id="edit-session-content"></div>
        </div>
    </div>

    <!-- Modal de d√©tails d'exercice -->
    <div id="exercise-details-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="exercise-details-title">D√©tails de l'exercice</h3>
                <button class="close-btn" onclick="actions.closeModal('exercise-details-modal')">√ó</button>
            </div>
            <div id="exercise-details-content"></div>
        </div>
    </div>

    <!-- Modal Biblioth√®que de M√©dias -->
    <div id="media-library-modal" class="modal">
        <div class="modal-content media-library-modal">
            <div class="modal-header">
                <h3>üñºÔ∏è Biblioth√®que de M√©dias</h3>
                <button class="close-btn" onclick="actions.closeModal('media-library-modal')">√ó</button>
            </div>
            
            <div class="media-search">
                <div class="input-group">
                    <input type="text" id="media-search-input" class="input" placeholder="üîç Rechercher une image..." onkeyup="actions.filterMediaLibrary()">
                </div>
            
                <div class="media-categories">
                    <button class="media-category-btn active" onclick="actions.filterMediaByCategory('all')">Tout</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('echauffement')">√âchauffement</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('biceps')">Biceps</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('triceps')">Triceps</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('epaules')">√âpaules</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('dos')">Dos</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('pectoraux')">Pectoraux</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('jambes')">Jambes</button>
                </div>
            </div>

            <div id="media-upload-section">
                <div class="media-upload-zone" id="media-drop-zone">
                    <div style="font-size: 48px; margin-bottom: 12px;">‚¨ÜÔ∏è</div>
                    <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">
                        Glissez-d√©posez vos images ici
                    </div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                        ou cliquez pour parcourir
                    </div>
                    <input type="file" id="media-library-input" multiple accept="image/*,video/*" style="display: none;" onchange="actions.handleMediaLibraryUpload(event)">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('media-library-input').click()">
                        üìÅ S√©lectionner des fichiers
                    </button>
                </div>
            
                <div class="media-optimization-info">
                    <h5>‚ö° Optimisation automatique</h5>
                    <div style="font-size: 14px;">
                        ‚Ä¢ Compression intelligente pour respecter la limite de 50KB<br>
                        ‚Ä¢ Redimensionnement automatique vers 400x300px<br>
                        ‚Ä¢ Conversion vers WebP pour une meilleure performance<br>
                        ‚Ä¢ Fallback JPG pour la compatibilit√©
                    </div>
                </div>
            </div>

            <div id="media-library-content">
                <div id="media-grid" class="media-grid"></div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="font-size: 14px; color: var(--text-secondary);">
                    <span id="media-count">0</span> image(s) ‚Ä¢ <span id="media-total-size">0</span> KB utilis√©s
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="actions.closeModal('media-library-modal')">Annuler</button>
                    <button class="btn btn-primary" onclick="actions.selectMediaFromLibrary()" id="select-media-btn" disabled>
                        ‚úÖ Utiliser cette image
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestionnaire de Tags -->
    <div id="tags-manager-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üè∑Ô∏è Gestionnaire de Tags</h3>
                <button class="close-btn" onclick="actions.closeModal('tags-manager-modal')">√ó</button>
            </div>
        
            <div style="margin-bottom: 24px;">
                <h4>‚ûï Cr√©er un nouveau tag</h4>
                <div style="display: flex; gap: 12px; align-items: end;">
                    <div class="input-group" style="flex: 1; margin-bottom: 0;">
                        <label>Nom du tag</label>
                        <input type="text" id="new-tag-name" class="input" placeholder="Ex: explosivit√©, r√©cup√©ration..." maxlength="20">
                    </div>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label>Couleur</label>
                        <select id="new-tag-color" class="select">
                            <option value="blue">üîµ Bleu</option>
                            <option value="green">üü¢ Vert</option>
                            <option value="orange">üü† Orange</option>
                            <option value="purple">üü£ Violet</option>
                            <option value="red">üî¥ Rouge</option>
                            <option value="gray">‚ö´ Gris</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="actions.createCustomTag()">Cr√©er</button>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <h4>üè∑Ô∏è Tags personnalis√©s existants</h4>
                <div id="existing-custom-tags" style="min-height: 60px; padding: 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                    <p style="color: var(--text-secondary); text-align: center; margin: 0;">Aucun tag personnalis√© cr√©√©</p>
                </div>
            </div>

            <div>
                <h4>üìä Statistiques d'utilisation</h4>
                <div id="tags-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <!-- Stats g√©n√©r√©es dynamiquement -->
                </div>
            </div>

            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary" onclick="actions.exportTags()">üì§ Exporter tags</button>
                <button class="btn btn-secondary" onclick="actions.importTags()" style="margin-left: 8px;">üì• Importer tags</button>
                <button class="btn btn-danger" onclick="actions.resetAllTags()" style="float: right;">üóëÔ∏è R√©initialiser tout</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // === BASE DE DONN√âES DES √âLASTIQUES SMARTWORKOUT ELITE ===
        const ELASTICS_DB = {
            cyan: { name: 'Cyan', resistance: 25, color: '#00FFFF', quantity: 3 },
            black: { name: 'Noir', resistance: 20, color: '#000000', quantity: 3 },
            blue: { name: 'Bleu', resistance: 15, color: '#0000FF', quantity: 1 },
            green: { name: 'Vert', resistance: 10, color: '#00FF00', quantity: 1 },
            beige: { name: 'Beige', resistance: 5, color: '#F5F5DC', quantity: 1 }
        };

        // === BASE DE DONN√âES DES R√âSISTANCES CONSEILL√âES ===
        const RESISTANCE_RECOMMENDATIONS = {
            // BICEPS
            'Curl biceps': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Curl biceps (poulie basse)': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Curl biceps face √† la porte': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Curl marteau': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            
            // TRICEPS
            'Extension triceps (poulie haute)': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Extension triceps verticale': {
                beginner: { min: 5, max: 10, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 10, max: 25, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 20, max: 40, elastics: ['Bleu', 'Noir', 'Cyan'] }
            },
            'Kickback triceps': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            
            // √âPAULES
            '√âl√©vations lat√©rales': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            '√âl√©vations frontales': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            'D√©velopp√© militaire assis': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 40, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 35, max: 65, elastics: ['Noir', 'Cyan'] }
            },
            'Oiseau': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            
            // DOS
            'Face Pull': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            'Tirage horizontal unilat√©ral': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            'Tirage vertical': {
                beginner: { min: 15, max: 25, elastics: ['Bleu', 'Noir'] },
                intermediate: { min: 25, max: 45, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 40, max: 70, elastics: ['Cyan x2'] }
            },
            'Rowing buste pench√©': {
                beginner: { min: 15, max: 25, elastics: ['Bleu', 'Noir'] },
                intermediate: { min: 25, max: 45, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 40, max: 70, elastics: ['Cyan x2'] }
            },
            
            // PECTORAUX
            'D√©velopp√© debout (poulie moyenne)': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            'D√©velopp√© inclin√©': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            '√âcart√© unilat√©ral': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 25, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 20, max: 40, elastics: ['Noir', 'Cyan'] }
            },
            'Pompes lest√©es': {
                beginner: { min: 10, max: 25, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 25, max: 45, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 40, max: 75, elastics: ['Cyan x2'] }
            },
            
            // JAMBES
            'Squat': {
                beginner: { min: 20, max: 35, elastics: ['Noir', 'Cyan'] },
                intermediate: { min: 35, max: 60, elastics: ['Cyan x2'] },
                advanced: { min: 55, max: 95, elastics: ['Cyan x2 ou x3'] }
            },
            'Front squat': {
                beginner: { min: 15, max: 30, elastics: ['Bleu', 'Noir'] },
                intermediate: { min: 30, max: 50, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 45, max: 80, elastics: ['Cyan x2'] }
            },
            'Fentes': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 60, elastics: ['Noir', 'Cyan'] }
            },
            'Hip thrust': {
                beginner: { min: 25, max: 40, elastics: ['Noir', 'Cyan'] },
                intermediate: { min: 40, max: 65, elastics: ['Cyan x2'] },
                advanced: { min: 60, max: 100, elastics: ['Cyan x3'] }
            },
            'Soulev√© de terre': {
                beginner: { min: 25, max: 40, elastics: ['Noir', 'Cyan'] },
                intermediate: { min: 40, max: 70, elastics: ['Cyan x2'] },
                advanced: { min: 65, max: 110, elastics: ['Cyan x3'] }
            }
        };

        // Base de donn√©es des exercices pr√©-d√©finis SmartWorkout
        const PREDEFINED_EXERCISES = {
            echauffement: [
                { name: 'Jumping Jacks', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Mont√©es de genoux', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Talons-fesses', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Burpees', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Planche', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Planche lat√©rale', anchor: 'none', unilateral: true, timeBase: true },
                { name: 'Mountain climbers', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Squats au poids du corps', anchor: 'none', unilateral: false, timeBase: false },
                { name: 'Pompes', anchor: 'none', unilateral: false, timeBase: false },
                { name: 'Fentes altern√©es', anchor: 'none', unilateral: true, timeBase: false },
                { name: 'Rotations √©paules', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Cercles de bras', anchor: 'none', unilateral: false, timeBase: true },
                { name: '√âtirements dynamiques', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'High knees', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Pas chass√©s', anchor: 'none', unilateral: false, timeBase: true }
            ],
            
            biceps: [
                { name: 'Curl biceps', anchor: 'none', unilateral: false },
                { name: 'Curl biceps (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Curl biceps face √† la porte', anchor: 'door-middle', unilateral: false },
                { name: 'Curl marteau', anchor: 'none', unilateral: false },
                { name: 'Curl marteau (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Curl biceps avec poign√©e', anchor: 'none', unilateral: false },
                { name: 'Curl biceps en pronation', anchor: 'none', unilateral: false }
            ],
            epaules: [
                { name: 'Cuban press', anchor: 'none', unilateral: false },
                { name: 'D√©velopp√© arnold', anchor: 'none', unilateral: false },
                { name: 'D√©velopp√© militaire assis', anchor: 'floor', unilateral: false },
                { name: '√âl√©vations frontales', anchor: 'none', unilateral: false },
                { name: '√âl√©vations lat√©rales', anchor: 'none', unilateral: false },
                { name: 'Oiseau', anchor: 'door-middle', unilateral: false },
                { name: 'Overhead press', anchor: 'none', unilateral: false },
                { name: 'Reverse fly', anchor: 'door-middle', unilateral: false },
                { name: 'Reverse fly unilat√©ral', anchor: 'door-middle', unilateral: true },
                { name: 'Shrug', anchor: 'none', unilateral: false },
                { name: 'Tirage menton', anchor: 'door-low', unilateral: false }
            ],
            dos: [
                { name: 'Face Pull', anchor: 'door-middle', unilateral: false },
                { name: 'Face pull (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Pull-Over', anchor: 'door-high', unilateral: false },
                { name: 'Rowing buste pench√©', anchor: 'floor', unilateral: false },
                { name: 'Rowing buste pench√© (prise large)', anchor: 'floor', unilateral: false },
                { name: 'Rowing buste pench√© (prise serr√©e)', anchor: 'floor', unilateral: false },
                { name: 'Soulev√© de terre', anchor: 'floor', unilateral: false },
                { name: 'Soulev√© de terre (prise large)', anchor: 'floor', unilateral: false },
                { name: 'Tirage Bucheron (poulie basse)', anchor: 'door-low', unilateral: true },
                { name: 'Tirage horizontal unilat√©ral', anchor: 'door-middle', unilateral: true },
                { name: 'Tirage poulie basse', anchor: 'door-low', unilateral: false },
                { name: 'Tirage poulie basse (supination)', anchor: 'door-low', unilateral: false },
                { name: 'Tirage vertical', anchor: 'door-high', unilateral: false },
                { name: 'Tirage vertical (prise serr√©e)', anchor: 'door-high', unilateral: false },
                { name: 'Tirage vertical (supination)', anchor: 'door-high', unilateral: false },
                { name: 'Tirage vertical unilat√©ral', anchor: 'door-high', unilateral: true }
            ],
            jambes: [
                { name: 'Abduction de hanches', anchor: 'body', unilateral: false },
                { name: 'Adduction de hanches', anchor: 'body', unilateral: false },
                { name: 'Donkey kick', anchor: 'body', unilateral: true },
                { name: 'Donkey kick (jambes fl√©chies)', anchor: 'body', unilateral: true },
                { name: 'Extensions mollets', anchor: 'floor', unilateral: false },
                { name: 'Extensions mollets unilat√©rales', anchor: 'floor', unilateral: true },
                { name: 'Fentes', anchor: 'none', unilateral: true },
                { name: 'Fentes bulgares', anchor: 'none', unilateral: true },
                { name: 'Front squat', anchor: 'floor', unilateral: false },
                { name: 'Hip thrust', anchor: 'body', unilateral: false },
                { name: 'Leg curl', anchor: 'body', unilateral: false },
                { name: 'Leg extension unilat√©rale', anchor: 'body', unilateral: true },
                { name: 'Soulev√© de terre jambes tendues', anchor: 'floor', unilateral: false },
                { name: 'Squat', anchor: 'none', unilateral: false },
                { name: 'Squat sumo', anchor: 'floor', unilateral: false },
                { name: 'Squat swing', anchor: 'none', unilateral: false },
                { name: 'Thruster', anchor: 'floor', unilateral: false }
            ],
            pectoraux: [
                { name: 'D√©velopp√© √©paules debout', anchor: 'none', unilateral: false },
                { name: 'D√©velopp√© debout (poulie moyenne)', anchor: 'door-middle', unilateral: false },
                { name: 'D√©velopp√© debout (2 ancrages)', anchor: 'door-middle', unilateral: false },
                { name: 'D√©velopp√© d√©clin√©', anchor: 'door-low', unilateral: false },
                { name: 'D√©velopp√© inclin√©', anchor: 'door-high', unilateral: false },
                { name: 'D√©velopp√© inclin√© (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'D√©velopp√© joint (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'D√©velopp√© joint (poulie haute)', anchor: 'door-high', unilateral: false },
                { name: 'D√©velopp√© 1 ancrage (poulie haute)', anchor: 'door-high', unilateral: false },
                { name: 'D√©velopp√© joint (poulie moyenne)', anchor: 'door-middle', unilateral: false },
                { name: '√âcart√© unilat√©ral', anchor: 'door-middle', unilateral: true },
                { name: '√âcart√© unilat√©ral (poulie basse)', anchor: 'door-low', unilateral: true },
                { name: '√âcart√© unilat√©ral (poulie haute)', anchor: 'door-high', unilateral: true },
                { name: 'Pompes lest√©es', anchor: 'body', unilateral: false }
            ],
            triceps: [
                { name: 'Triceps barre au front', anchor: 'door-high', unilateral: false },
                { name: 'Extension triceps (poulie haute)', anchor: 'door-high', unilateral: false },
                { name: 'Extension triceps verticale', anchor: 'none', unilateral: false },
                { name: 'Extension triceps verticale (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Kickback triceps (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Kickback triceps unilat√©ral', anchor: 'door-low', unilateral: true }
            ]
        };

        // Base de donn√©es des synonymes pour la recherche intelligente
        const EXERCISE_SYNONYMS = {
            'biceps': ['bicep', 'bras', 'curl', 'flexion'],
            'triceps': ['tricep', 'extension', 'bras'],
            'epaules': ['√©paule', 'shoulder', 'deltoide', 'delto√Øde', 'lateral', 'frontal'],
            'dos': ['back', 'tirage', 'rowing', 'pull', 'traction'],
            'pectoraux': ['pec', 'chest', 'poitrine', 'd√©velopp√©', 'ecart√©'],
            'jambes': ['leg', 'cuisse', 'squat', 'fente', 'mollet'],
            'echauffement': ['warmup', 'warm', 'prep', 'preparation', 'chauffe'],
            'abdos': ['abdominal', 'core', 'gainage', 'planche'],
            'cardio': ['course', 'v√©lo', 'rameur', 'endurance']
        };

        // Historique des recherches (stock√© en localStorage)
        let searchHistory = [];

        // Fonctions de recherche intelligente
        const smartSearch = {
            // Fonction principale de recherche
            search(query, exercises = appState.exercises) {
                if (!query || query.length < 1) {
                    return exercises;
                }
                
                // Si la query est tr√®s courte (1 caract√®re), retourner tous les exercices
                if (query.length < 2) {
                    return exercises;
                }
                
                query = query.toLowerCase().trim();
                
                // V√©rifier le cache
                const cacheKey = { query, exercisesCount: exercises.length };
                const cached = smartCache.get('exerciseSearch', cacheKey);
                if (cached) {
                    console.log('üîç R√©sultats de recherche r√©cup√©r√©s du cache');
                    this.addToHistory(query);
                    return cached;
                }
                
                console.log('üîç Recherche d\'exercices...');
                this.addToHistory(query);

                const results = exercises.filter(exercise => {
                    return this.matchExercise(exercise, query);
                });

                // Mettre en cache les r√©sultats et les retourner
                const sortedResults = this.sortByRelevance(results, query);
                return smartCache.set('exerciseSearch', cacheKey, sortedResults);
            },
        
            // V√©rifier si un exercice correspond √† la recherche
            matchExercise(exercise, query) {
                const searchTerms = query.split(' ').filter(term => term.length > 1);
            
                return searchTerms.every(term => {
                    // Recherche dans le nom
                    if (exercise.name.toLowerCase().includes(term)) return true;
                    
                    // Recherche dans le groupe musculaire
                    if (exercise.muscle_group && exercise.muscle_group.toLowerCase().includes(term)) return true;
                    
                    // Recherche avec tol√©rance aux fautes de frappe (distance de Levenshtein simplifi√©e)
                    if (this.fuzzyMatch(exercise.name.toLowerCase(), term)) return true;
                    
                    // Recherche dans les synonymes
                    if (this.matchSynonyms(exercise.muscle_group, term)) return true;
                    
                    // Recherche dans le type d'ancrage
                    if (exercise.anchor_point && this.matchAnchor(exercise.anchor_point, term)) return true;
                    
                    return false;
                });
            },
        
            // Correspondance floue pour les fautes de frappe
            fuzzyMatch(text, term) {
                if (term.length < 3) return false;
            
                // Recherche avec 1 caract√®re de diff√©rence maximum
                for (let i = 0; i <= text.length - term.length; i++) {
                    const substring = text.substring(i, i + term.length);
                    if (this.levenshteinDistance(substring, term) <= 1) {
                        return true;
                    }
                }
                return false;
            },
        
            // Distance de Levenshtein simplifi√©e
            levenshteinDistance(str1, str2) {
                if (str1.length !== str2.length) return 999;
                let diff = 0;
                for (let i = 0; i < str1.length; i++) {
                    if (str1[i] !== str2[i]) diff++;
                }
                return diff;
            },
        
            // Correspondance avec les synonymes
            matchSynonyms(muscleGroup, term) {
                if (!muscleGroup || !EXERCISE_SYNONYMS[muscleGroup]) return false;
                
                return EXERCISE_SYNONYMS[muscleGroup].some(synonym => 
                    synonym.toLowerCase().includes(term) || term.includes(synonym.toLowerCase())
                );
            },
        
            // Correspondance avec les points d'ancrage
            matchAnchor(anchorPoint, term) {
                const anchorTerms = {
                    'door': ['porte', 'door'],
                    'floor': ['sol', 'pied', 'floor'],
                    'body': ['corps', 'body'],
                    'none': ['libre', 'sans', 'none'],
                    'external': ['ext√©rieur', 'externe', 'external']
                };
                
                for (const [anchor, terms] of Object.entries(anchorTerms)) {
                    if (anchorPoint.includes(anchor) && terms.some(t => term.includes(t))) {
                        return true;
                    }
                }
                return false;
            },
        
            // Trier par pertinence
            sortByRelevance(results, query) {
                return results.sort((a, b) => {
                    const scoreA = this.calculateRelevanceScore(a, query);
                    const scoreB = this.calculateRelevanceScore(b, query);
                    return scoreB - scoreA;
                });
            },
        
            // Calculer le score de pertinence
            calculateRelevanceScore(exercise, query) {
                let score = 0;
                const lowerQuery = query.toLowerCase();
                const lowerName = exercise.name.toLowerCase();
                
                // Correspondance exacte dans le nom = score max
                if (lowerName.includes(lowerQuery)) score += 100;
                
                // Correspondance au d√©but du nom
                if (lowerName.startsWith(lowerQuery)) score += 50;
                
                // Correspondance dans le groupe musculaire
                if (exercise.muscle_group && exercise.muscle_group.toLowerCase().includes(lowerQuery)) {
                    score += 30;
                }
                
                // Bonus pour les exercices populaires
                const popularExercises = ['curl', 'squat', 'd√©velopp√©', 'tirage', 'fente'];
                if (popularExercises.some(pop => lowerName.includes(pop))) score += 10;
                
                return score;
            },
        
            // Ajouter √† l'historique
            addToHistory(query) {
                // √âviter les doublons
                searchHistory = searchHistory.filter(item => item.query !== query);
                
                // Ajouter en premi√®re position
                searchHistory.unshift({
                    query: query,
                    timestamp: Date.now()
                });
                
                // Limiter √† 10 recherches
                if (searchHistory.length > 10) {
                    searchHistory = searchHistory.slice(0, 10);
                }
                
                // Sauvegarder dans localStorage
                storage.save('searchHistory', searchHistory);
            },
        
            // Charger l'historique
            loadHistory() {
                searchHistory = storage.load('searchHistory', []);
                return searchHistory;
            },
        
            // Effacer l'historique
            clearHistory() {
                searchHistory = [];
                storage.remove('searchHistory');
            }
        };

        class ExerciseTimer {
            constructor() {
                this.duration = 0;
                this.timeLeft = 0;
                this.isRunning = false;
                this.isPaused = false;
                this.interval = null;
                this.audioContext = null;
                this.onTick = null;
                this.onComplete = null;
                this.lastBeepSecond = null;
                
                // Initialiser le contexte audio
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio non support√©');
                }
            }
            
            // Configurer le timer
            setup(duration, onTick, onComplete) {
                this.duration = duration;
                this.timeLeft = duration;
                this.onTick = onTick;
                this.onComplete = onComplete;
                this.isRunning = false;
                this.isPaused = false;
                
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
            
            // D√©marrer le timer
            start() {
                if (this.isRunning && !this.isPaused) return;
                this.isRunning = true;
                this.isPaused = false;
                
                // R√©initialiser le dernier bip
                this.lastBeepSecond = this.timeLeft + 1;
                
                this.interval = setInterval(() => {
                    if (this.timeLeft > 0) {
                        this.timeLeft--;
                        
                        // Appeler la fonction de mise √† jour
                        if (this.onTick) {
                            this.onTick(this.timeLeft, this.duration);
                        }
                        
                        // Alertes sonores am√©lior√©es - bip de 5 √† 2 secondes (pas √† 1 pour √©viter le double bip)
                        if (this.timeLeft <= 5 && this.timeLeft > 1 && this.timeLeft !== this.lastBeepSecond) {
                            this.lastBeepSecond = this.timeLeft;
                            this.playBeep(800, 200);
                            // Vibration dans les derni√®res secondes
                            if ('vibrate' in navigator) {
                                navigator.vibrate(100);
                            }
                        }
                    } else {
                        // Timer termin√©
                        this.complete();
                    }
                }, 1000);
            }
            
            // Mettre en pause
            pause() {
                this.isPaused = true;
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
            
            // Arr√™ter compl√®tement
            stop() {
                this.isRunning = false;
                this.isPaused = false;
                if (this.interval) {
                    clearInterval(this.interval);
                }
                this.timeLeft = this.duration;
            }
            
            // Timer termin√©
            complete() {
                this.isRunning = false;
                this.isPaused = false;
                if (this.interval) {
                    clearInterval(this.interval);
                }
                
                // Son de fin plus long
                this.playBeep(1000, 500);
                
                // Vibration de fin
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                // Appeler la fonction de completion
                if (this.onComplete) {
                    this.onComplete();
                }
            }
            
            // Jouer un bip sonore
            playBeep(frequency = 800, duration = 200) {
                if (!this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration / 1000);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration / 1000);
                } catch (e) {
                    console.log('Erreur audio:', e);
                }
            }
            
            // Formater le temps MM:SS
            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            

            // Ajouter du temps
            addTime(seconds) {
                this.timeLeft += seconds;
                this.duration += seconds;
                if (this.onTick) {
                    this.onTick(this.timeLeft, this.duration);
                }
            }
            
            // Enlever du temps
            removeTime(seconds) {
                this.timeLeft = Math.max(0, this.timeLeft - seconds);
                if (this.timeLeft === 0) {
                    this.complete();
                } else if (this.onTick) {
                    this.onTick(this.timeLeft, this.duration);
                }
            }
        }

        // Instance globale du timer
        let exerciseTimer = new ExerciseTimer();

        // Fonctions globales pour contr√¥ler le timer
        function startExerciseTimer() {
            exerciseTimer.start();
            updateTimerButtons();
        }

        function pauseExerciseTimer() {
            exerciseTimer.pause();
            updateTimerButtons();
        }

        function stopExerciseTimer() {
            exerciseTimer.stop();
            updateTimerButtons();
            // Remettre l'affichage par d√©faut
            const timerDisplay = document.getElementById('exercise-timer-display');
            if (timerDisplay) {
                timerDisplay.textContent = exerciseTimer.formatTime(exerciseTimer.duration);
                timerDisplay.style.color = 'var(--primary)';
            }
        }

        function addExerciseTime() {
            exerciseTimer.addTime(10); // Ajouter 10 secondes
        }

        function removeExerciseTime() {
            exerciseTimer.removeTime(10); // Enlever 10 secondes
        }

        function updateTimerButtons() {
            const startBtn = document.getElementById('timer-start-btn');
            const pauseBtn = document.getElementById('timer-pause-btn');
            const stopBtn = document.getElementById('timer-stop-btn');
            
            if (startBtn && pauseBtn && stopBtn) {
                if (exerciseTimer.isRunning && !exerciseTimer.isPaused) {
                    startBtn.style.display = 'none';
                    pauseBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'inline-block';
                } else if (exerciseTimer.isPaused) {
                    startBtn.style.display = 'inline-block';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                } else {
                    startBtn.style.display = 'inline-block';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                }
            }
        }

        // Fonction pour g√©n√©rer l'interface du timer
        function generateTimerInterface(exercise, prefix = '') {
            // R√©cup√©rer la dur√©e personnalis√©e si elle existe
            let defaultDuration = 30;
            if (appState.liveSession) {
                const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                defaultDuration = currentExercise?.duration || exercise.default_duration || 30;
            } else if (appState.manualSession) {
                const currentExercise = appState.manualSession.exercises[appState.manualSession.currentExerciseIndex];
                defaultDuration = currentExercise?.duration || exercise.default_duration || 30;
            } else {
                defaultDuration = exercise.default_duration || 30;
            }
            
            return `
                <div class="exercise-timer-container" style="text-align: center; margin: 20px 0; padding: 20px; background: var(--surface); border-radius: 16px; border: 2px solid var(--primary);">
                    <h3 style="margin-bottom: 16px; color: var(--primary);">‚è±Ô∏è Timer d'exercice</h3>
                    
                    <!-- Affichage du timer -->
                    <div id="exercise-timer-display" style="font-size: 48px; font-weight: bold; color: var(--primary); margin: 16px 0;">
                        ${exerciseTimer.formatTime(defaultDuration)}
                    </div>
                    
                    <!-- Contr√¥les de temps -->
                    <div style="display: flex; justify-content: center; gap: 8px; margin: 16px 0;">
                        <button class="btn btn-small btn-secondary" onclick="removeExerciseTime()" style="font-size: 18px; padding: 8px 12px;">-10s</button>
                        <input type="number" id="${prefix}duration" class="input" value="${defaultDuration}" min="10" max="300" 
                            style="width: 80px; text-align: center; font-weight: bold;" 
                            onchange="setupTimerDuration(this.value)">
                        <button class="btn btn-small btn-secondary" onclick="addExerciseTime()" style="font-size: 18px; padding: 8px 12px;">+10s</button>
                    </div>
                    
                    <!-- Boutons de contr√¥le -->
                    <div style="display: flex; justify-content: center; gap: 12px; margin: 16px 0;">
                        <button id="timer-start-btn" class="btn btn-success" onclick="startExerciseTimer()" style="display: inline-block;">
                            ‚ñ∂Ô∏è Start
                        </button>
                        <button id="timer-pause-btn" class="btn btn-warning" onclick="pauseExerciseTimer()" style="display: none;">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button id="timer-stop-btn" class="btn btn-danger" onclick="stopExerciseTimer()" style="display: none;">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                    
                    <!-- Indicateur de progression -->
                    <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 16px 0;">
                        <div id="timer-progress" style="height: 100%; background: var(--primary); width: 100%; transition: width 1s linear;"></div>
                    </div>
                    
                    <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">
                        üîî Sons et vibrations activ√©s ‚Ä¢ Validation automatique
                    </p>
                </div>
            `;
        }

        // Fonction pour configurer la dur√©e du timer
        function setupTimerDuration(newDuration) {
            const duration = parseInt(newDuration) || 30;
            const timerDisplay = document.getElementById('exercise-timer-display');
            
            if (timerDisplay && !exerciseTimer.isRunning) {
                exerciseTimer.setup(
                    duration,
                    updateTimerDisplay,
                    completeTimedExercise
                );
                timerDisplay.textContent = exerciseTimer.formatTime(duration);
                updateTimerProgress(duration, duration);
            }
        }

        // Fonction pour mettre √† jour l'affichage du timer
        function updateTimerDisplay(timeLeft, totalDuration) {
            const timerDisplay = document.getElementById('exercise-timer-display');
            
            if (timerDisplay) {
                timerDisplay.textContent = exerciseTimer.formatTime(timeLeft);
                
                // Changer la couleur selon le temps restant
                if (timeLeft <= 5) {
                    timerDisplay.style.color = 'var(--danger)';
                } else if (timeLeft <= 10) {
                    timerDisplay.style.color = 'var(--warning)';
                } else {
                    timerDisplay.style.color = 'var(--primary)';
                }
            }
            
            // Mettre √† jour la barre de progression
            updateTimerProgress(timeLeft, totalDuration);
        }

        // Fonction pour mettre √† jour la barre de progression
        function updateTimerProgress(timeLeft, totalDuration) {
            const progressBar = document.getElementById('timer-progress');
            if (progressBar) {
                const percentage = (timeLeft / totalDuration) * 100;
                progressBar.style.width = percentage + '%';
                
                // Changer la couleur de la barre selon le temps restant
                if (timeLeft <= 5) {
                    progressBar.style.background = 'var(--danger)';
                } else if (timeLeft <= 10) {
                    progressBar.style.background = 'var(--warning)';
                } else {
                    progressBar.style.background = 'var(--primary)';
                }
            }
        }

        // Fonction appel√©e quand le timer se termine
        function completeTimedExercise() {
            // Validation automatique de la s√©rie
            setTimeout(() => {
                if (confirm('‚è∞ Temps √©coul√© ! Valider cette s√©rie automatiquement ?')) {
                    // Remplir automatiquement la dur√©e
                    const durationInput = document.getElementById('duration');
                    if (durationInput) {
                        durationInput.value = exerciseTimer.duration;
                    }
                    
                    // Valider la s√©rie
                    actions.validateSet();
                }
            }, 500); // Petit d√©lai pour que l'utilisateur entende le son
        }

        // === FONCTIONS UTILITAIRES √âLASTIQUES ===

        // Fonction pour toggle le mode d'exercice dans le formulaire
        function toggleExerciseMode() {
            const mode = document.getElementById('exercise-mode').value;
            const durationGroup = document.getElementById('duration-group');
            
            if (mode === 'time' || mode === 'both') {
                durationGroup.style.display = 'block';
            } else {
                durationGroup.style.display = 'none';
            }
        }

        // Fonction pour toggle entre temps et r√©p√©titions dans les s√©ances
        function togglePerformanceMode(prefix = '') {
            const mode = document.getElementById(`${prefix}execution-mode`).value;
            const repsInputs = document.querySelectorAll(`[id*="${prefix}reps-inputs"]`);
            const timerContainer = document.getElementById(`${prefix}timer-container`);
            
            // Arr√™ter le timer si il √©tait en cours
            if (exerciseTimer.isRunning) {
                exerciseTimer.stop();
            }
            
            if (mode === 'time') {
                // Masquer les inputs de r√©p√©titions
                repsInputs.forEach(input => {
                    if (input) input.style.display = 'none';
                });
                
                // Afficher le timer
                if (timerContainer) {
                    timerContainer.style.display = 'block';
                    
                    // Configurer le timer apr√®s un court d√©lai
                    setTimeout(() => {
                        const defaultDuration = 30; // Valeur par d√©faut
                        exerciseTimer.setup(
                            defaultDuration,
                            updateTimerDisplay,
                            completeTimedExercise
                        );
                        
                        // Mettre √† jour l'affichage initial
                        const timerDisplay = document.getElementById('exercise-timer-display');
                        if (timerDisplay) {
                            timerDisplay.textContent = exerciseTimer.formatTime(defaultDuration);
                        }
                        updateTimerButtons();
                    }, 100);
                }
            } else {
                // Afficher les inputs de r√©p√©titions
                repsInputs.forEach(input => {
                    if (input) input.style.display = 'block';
                });
                
                // Masquer le timer
                if (timerContainer) {
                    timerContainer.style.display = 'none';
                }
            }
        }

        // Fonction pour cr√©er un item d'exercice avec r√©organisation
        function createExerciseItem(exerciseData, sectionIndex, section) {
            const { exercise, planned_sets, originalIndex } = exerciseData;
            
            const div = document.createElement('div');
            div.className = 'exercise-item';
            
            // Indicateur du mode d'exercice
            const modeIcon = exercise.exercise_mode === 'time' ? '‚è±Ô∏è' : 
                            exercise.exercise_mode === 'both' ? 'üîÑ' : 'üî¢';
            
            // Informations sur l'exercice
            const restTime = exerciseData.rest_time || exercise.default_rest_time;
            let exerciseInfo = `${exercise.is_unilateral ? 'Unilat√©ral' : 'Bilat√©ral'} ‚Ä¢ ${restTime}s repos`;
            if (exercise.exercise_mode === 'time') {
                exerciseInfo += ` ‚Ä¢ ${exercise.default_duration || 30}s par d√©faut`;
            }
            
            // Calculer si on peut monter/descendre
            const isFirst = sectionIndex === 0;
            const totalInSection = section === 'warmup' ? 
                appState.currentSession.exercises.filter(ex => {
                    const e = appState.exercises.find(e => e.id === ex.exercise_id);
                    return e && (e.muscle_group === 'echauffement' || e.category === 'warmup');
                }).length :
                appState.currentSession.exercises.filter(ex => {
                    const e = appState.exercises.find(e => e.id === ex.exercise_id);
                    return e && e.muscle_group !== 'echauffement' && e.category !== 'warmup';
                }).length;
            const isLast = sectionIndex === totalInSection - 1;
            
            div.innerHTML = `
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span class="exercise-number">${sectionIndex + 1}</span>
                        <strong>${modeIcon} ${exercise.name}</strong>
                    </div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-left: 32px;">
                        ${exerciseInfo}
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" value="${planned_sets}" min="1" max="20"
                        style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px;"
                        onchange="actions.updatePlannedSets(${exercise.id}, this.value)">
                    <span style="font-size: 14px;">s√©ries</span>
                    
                    <input type="number" value="${restTime}" min="30" max="600"
                        style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px;"
                        onchange="actions.updateExerciseRestTime(${exercise.id}, this.value)"
                        title="Temps de repos en secondes">
                    <span style="font-size: 14px;">s repos</span>
                    ${(exercise.exercise_mode === 'time' || exercise.exercise_mode === 'both') ? `
                        <input type="number" value="${exerciseData.duration || exercise.default_duration || 30}" min="10" max="300"
                            style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; margin-left: 8px;"
                            onchange="actions.updateExerciseDuration(${exercise.id}, this.value)"
                            title="Dur√©e de l'exercice en secondes">
                        <span style="font-size: 14px;">s dur√©e</span>
                    ` : ''}
                    
                    <div class="reorder-buttons">
                        <button class="btn btn-small btn-secondary" onclick="actions.moveExerciseUp(${originalIndex}, 'session')"
                            ${isFirst ? 'disabled' : ''}>‚Üë</button>
                        <button class="btn btn-small btn-secondary" onclick="actions.moveExerciseDown(${originalIndex}, 'session')"
                            ${isLast ? 'disabled' : ''}>‚Üì</button>
                    </div>
                    <button class="btn btn-small btn-danger" onclick="actions.removeExerciseFromSession(${exercise.id})">‚úï</button>
                </div>
            `;
            
            return div;
        }

        // Fonction pour calculer la r√©sistance totale
        function calculateTotalResistance(selectedElastics) {
            let total = 0;
            Object.keys(selectedElastics).forEach(color => {
                const count = selectedElastics[color] || 0;
                if (ELASTICS_DB[color] && count > 0) {
                    total += ELASTICS_DB[color].resistance * count;
                }
            });
            return total;
        }

        // Fonction pour g√©n√©rer le s√©lecteur d'√©lastiques
        function generateElasticSelector(prefix = '', isUnilateral = false) {
            if (isUnilateral) {
                // Pour les exercices unilat√©raux, deux s√©lecteurs s√©par√©s
                let html = '<div class="elastics-selector" style="margin: 16px 0;">';
                html += '<h4>Combinaison d\'√©lastiques par c√¥t√©</h4>';
                
                // C√¥t√© gauche
                html += '<div style="margin-bottom: 16px;">';
                html += '<h5 style="color: var(--primary); margin-bottom: 8px;">ü´± C√¥t√© gauche</h5>';
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                Object.keys(ELASTICS_DB).forEach(color => {
                    const elastic = ELASTICS_DB[color];
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="width: 20px; height: 20px; background: ${elastic.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        <div style="flex: 1; font-size: 14px;">${elastic.name} (${elastic.resistance}kg)</div>
                        <select id="${prefix}elastic-left-${color}" class="select" style="width: 60px; padding: 4px;" onchange="updateResistanceDisplay('${prefix}', true)">
                        `;
                    for (let i = 0; i <= elastic.quantity; i++) {
                        html += `<option value="${i}">${i}</option>`;
                    }
                    html += '</select></div>';
                });
                html += '</div>';
                html += `<div style="margin-top: 8px; padding: 8px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: bold;">R√©sistance gauche: <span id="${prefix}total-resistance-left">0</span> kg
                </div>`;
                html += '</div>';
                
                // C√¥t√© droit
                html += '<div>';
                html += '<h5 style="color: var(--primary); margin-bottom: 8px;">ü´≤ C√¥t√© droit</h5>';
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                Object.keys(ELASTICS_DB).forEach(color => {
                    const elastic = ELASTICS_DB[color];
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="width: 20px; height: 20px; background: ${elastic.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        <div style="flex: 1; font-size: 14px;">${elastic.name} (${elastic.resistance}kg)</div>
                        <select id="${prefix}elastic-right-${color}" class="select" style="width: 60px; padding: 4px;" onchange="updateResistanceDisplay('${prefix}', true)">
                        `;
                    for (let i = 0; i <= elastic.quantity; i++) {
                        html += `<option value="${i}">${i}</option>`;
                    }
                    html += '</select></div>';
                });
                html += '</div>';
                html += `<div style="margin-top: 8px; padding: 8px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: bold;">R√©sistance droite: <span id="${prefix}total-resistance-right">0</span> kg
                </div>`;
                html += '</div>';
                
                html += '</div>';
                return html;
            } else {
                // Code existant pour les exercices bilat√©raux
                let html = '<div class="elastics-selector" style="margin: 16px 0;">';
                html += '<h4>Combinaison d\'√©lastiques</h4>';
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                Object.keys(ELASTICS_DB).forEach(color => {
                    const elastic = ELASTICS_DB[color];
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="width: 20px; height: 20px; background: ${elastic.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        <div style="flex: 1; font-size: 14px;">${elastic.name} (${elastic.resistance}kg)</div>
                        <select id="${prefix}elastic-${color}" class="select" style="width: 60px; padding: 4px;" onchange="updateResistanceDisplay('${prefix}', false)">
                        `;
                    for (let i = 0; i <= elastic.quantity; i++) {
                        html += `<option value="${i}">${i}</option>`;
                    }
                    html += '</select></div>';
                });
                html += '</div>';
                html += `<div style="margin-top: 12px; padding: 8px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: bold;">R√©sistance totale: <span id="${prefix}total-resistance">0</span> kg
                </div>`;
                html += '</div>';
                return html;
            }
        }

        // Fonction pour mettre √† jour l'affichage de la r√©sistance
        function updateResistanceDisplay(prefix = '', isUnilateral = false) {
            if (isUnilateral) {
                // Pour les exercices unilat√©raux
                const selectedElasticsLeft = {};
                const selectedElasticsRight = {};
                
                Object.keys(ELASTICS_DB).forEach(color => {
                    const selectElementLeft = document.getElementById(`${prefix}elastic-left-${color}`);
                    const selectElementRight = document.getElementById(`${prefix}elastic-right-${color}`);
                    
                    if (selectElementLeft) {
                        selectedElasticsLeft[color] = parseInt(selectElementLeft.value) || 0;
                    }
                    if (selectElementRight) {
                        selectedElasticsRight[color] = parseInt(selectElementRight.value) || 0;
                    }
                });
                
                const totalLeft = calculateTotalResistance(selectedElasticsLeft);
                const totalRight = calculateTotalResistance(selectedElasticsRight);
                
                const totalElementLeft = document.getElementById(`${prefix}total-resistance-left`);
                const totalElementRight = document.getElementById(`${prefix}total-resistance-right`);
                
                if (totalElementLeft) {
                    totalElementLeft.textContent = totalLeft;
                }
                if (totalElementRight) {
                    totalElementRight.textContent = totalRight;
                }
                
                return { 
                    selectedElastics: { left: selectedElasticsLeft, right: selectedElasticsRight }, 
                    total: { left: totalLeft, right: totalRight } 
                };
            } else {
                // Code existant pour les exercices bilat√©raux
                const selectedElastics = {};
                Object.keys(ELASTICS_DB).forEach(color => {
                    const selectElement = document.getElementById(`${prefix}elastic-${color}`);
                    if (selectElement) {
                        selectedElastics[color] = parseInt(selectElement.value) || 0;
                    }
                });
                
                const total = calculateTotalResistance(selectedElastics);
                const totalElement = document.getElementById(`${prefix}total-resistance`);
                if (totalElement) {
                    totalElement.textContent = total;
                }
                
                return { selectedElastics, total };
            }
        }

        // Fonction pour charger les exercices pr√©-d√©finis
        function loadPredefinedExercises() {
            const exercisesToAdd = [];
            
            Object.keys(PREDEFINED_EXERCISES).forEach(category => {
                PREDEFINED_EXERCISES[category].forEach(ex => {
                    exercisesToAdd.push({
                        id: Date.now() + Math.floor(Math.random() * 1000),
                        name: ex.name,
                        is_unilateral: ex.unilateral,
                        default_rest_time: 90,
                        exercise_type: 'elastics',
                        anchor_point: ex.anchor,
                        muscle_group: category
                    });
                });
            });
            
            return exercisesToAdd;
        }

        // Fonction pour g√©n√©rer les conseils de r√©sistance
        function generateResistanceRecommendations(exerciseName) {
            const recommendations = RESISTANCE_RECOMMENDATIONS[exerciseName];
            if (!recommendations) {
                return '<p style="font-size: 14px; color: var(--text-secondary);">Pas de recommandations disponibles pour cet exercice.</p>';
            }
            
            let html = '<div style="background: var(--background); padding: 16px; border-radius: 8px; margin: 12px 0;">';
            html += '<h5 style="color: var(--primary); margin-bottom: 12px;">üí° Conseils de r√©sistance (premi√®re fois)</h5>';
            
            // D√©butant
            html += `
                <div style="margin-bottom: 12px; padding: 12px; background: var(--surface); border-radius: 8px; border-left: 4px solid #34C759;">
                    <div style="font-weight: 600; color: #34C759; margin-bottom: 4px;">üü¢ D√©butant</div>
                    <div style="font-size: 14px;">
                        <strong>${recommendations.beginner.min}-${recommendations.beginner.max}kg</strong> ‚Ä¢ 
                        √âlastiques : ${recommendations.beginner.elastics.join(' + ')}
                    </div>
                </div>
            `;
            
            // Interm√©diaire
            html += `
                <div style="margin-bottom: 12px; padding: 12px; background: var(--surface); border-radius: 8px; border-left: 4px solid #FF9500;">
                    <div style="font-weight: 600; color: #FF9500; margin-bottom: 4px;">üü° Interm√©diaire</div>
                    <div style="font-size: 14px;">
                        <strong>${recommendations.intermediate.min}-${recommendations.intermediate.max}kg</strong> ‚Ä¢ 
                        √âlastiques : ${recommendations.intermediate.elastics.join(' + ')}
                    </div>
                </div>
            `;
            
            // Confirm√©
            html += `
                <div style="padding: 12px; background: var(--surface); border-radius: 8px; border-left: 4px solid #FF3B30;">
                    <div style="font-weight: 600; color: #FF3B30; margin-bottom: 4px;">üî¥ Confirm√©</div>
                    <div style="font-size: 14px;">
                        <strong>${recommendations.advanced.min}-${recommendations.advanced.max}kg</strong> ‚Ä¢ 
                        √âlastiques : ${recommendations.advanced.elastics.join(' + ')}
                    </div>
                </div>
            `;
            
            html += '<p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px; font-style: italic;">Commencez l√©ger et ajustez selon vos sensations !</p>';
            html += '</div>';
            
            return html;
        }

        // Fonction pour afficher les exemples d'exercices
        function showExerciseExamples(anchorType) {
            const examplesContainer = document.getElementById('exercise-examples');
            const examplesList = document.getElementById('examples-list');
            
            if (anchorType && examplesList) {
                const examples = {
                    'none': ['Biceps curls', '√âl√©vations lat√©rales', 'Squats', 'Overhead press'],
                    'door-middle': ['Face Pull', 'D√©velopp√© debout', 'Rowing horizontal'],
                    'door-high': ['Tirage vertical', 'Extension triceps', 'D√©velopp√© inclin√©'],
                    'door-low': ['Tirage poulie basse', 'Curl biceps', 'D√©velopp√© d√©clin√©'],
                    'floor': ['Soulev√© de terre', 'Rowing buste pench√©', 'Front squat'],
                    'body': ['Hip thrust', 'Abduction hanches', 'Donkey kick'],
                    'external': ['Exercices ext√©rieurs', 'Sprints r√©sistance']
                };
                
                if (examples[anchorType]) {
                    examplesList.innerHTML = examples[anchorType].join(', ');
                    examplesContainer.style.display = 'block';
                } else {
                    examplesContainer.style.display = 'none';
                }
            }
        }

        // === ARCHITECTURE R√âACTIVE: √âTAT CENTRAL ===
        let appState = {
            currentScreen: 'dashboard',
            currentSession: null,
            liveSession: null,
            editingExercise: null,
            exercises: [],
            sessions: [],
            templates: [],
            measurements: [],
            records: {},
            settings: {
                theme: 'light'
            }
        };

        // === GESTION DE L'HISTORIQUE DE NAVIGATION ===
        let navigationHistory = ['dashboard'];
        let isNavigatingBack = false;

        // Fonction pour ajouter un √©cran √† l'historique
        function addToNavigationHistory(screenName) {
            if (!isNavigatingBack && screenName !== navigationHistory[navigationHistory.length - 1]) {
                navigationHistory.push(screenName);
                // Limiter l'historique √† 10 √©crans pour √©viter les fuites m√©moire
                if (navigationHistory.length > 10) {
                    navigationHistory = navigationHistory.slice(-10);
                }
            }
            isNavigatingBack = false;
        }

        // Fonction pour naviguer vers l'√©cran pr√©c√©dent
        function navigateBack() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Enlever l'√©cran actuel
                const previousScreen = navigationHistory[navigationHistory.length - 1];
                isNavigatingBack = true;
                actions.showScreen(previousScreen);
                return true; // Navigation interne effectu√©e
            }
            return false; // Pas d'√©cran pr√©c√©dent, laisser le comportement par d√©faut
        }

        // === STOCKAGE LOCAL AVEC VERSIONING ===
        const STORAGE_VERSION = 'v1';
        const STORAGE_PREFIX = `smarttrack_${STORAGE_VERSION}_`;

        const storage = {
            isAvailable() {
                try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
                } catch (e) {
                return false;
                }
            },
            
            save(key, data) {
                if (!this.isAvailable()) {
                console.warn('localStorage non disponible');
                return false;
                }
                try {
                localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(data));
                return true;
                } catch (e) {
                console.error('Erreur de sauvegarde:', e);
                return false;
                }
            },
            
            load(key, defaultValue = null) {
                if (!this.isAvailable()) {
                return defaultValue;
                }
                try {
                const item = localStorage.getItem(STORAGE_PREFIX + key);
                return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                console.error('Erreur de chargement:', e);
                return defaultValue;
                }
            },
            
            remove(key) {
                if (!this.isAvailable()) {
                return false;
                }
                try {
                localStorage.removeItem(STORAGE_PREFIX + key);
                return true;
                } catch (e) {
                console.error('Erreur de suppression:', e);
                return false;
                }
            },
            
            clear() {
                if (!this.isAvailable()) {
                return false;
                }
                try {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(STORAGE_PREFIX)) {
                    localStorage.removeItem(key);
                    }
                });
                return true;
                } catch (e) {
                console.error('Erreur de nettoyage:', e);
                return false;
                }
            }
        };

        // === CACHE INTELLIGENT ===
        const smartCache = {
            // Cache pour les calculs co√ªteux
            cache: new Map(),
            
            // G√©n√©rer une cl√© de cache
            generateKey(type, params) {
                return `${type}_${JSON.stringify(params)}`;
            },
        
            // R√©cup√©rer du cache
            get(type, params) {
                const key = this.generateKey(type, params);
                return this.cache.get(key);
            },
        
            // Stocker en cache
            set(type, params, value) {
                const key = this.generateKey(type, params);
                this.cache.set(key, value);
                
                // Limiter la taille du cache (garder les 100 entr√©es les plus r√©centes)
                if (this.cache.size > 100) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                return value;
            },
        
            // Invalider le cache pour un type donn√©
            invalidate(type) {
                const keysToDelete = [];
                for (let key of this.cache.keys()) {
                    if (key.startsWith(type + '_')) {
                        keysToDelete.push(key);
                    }
                }
                keysToDelete.forEach(key => this.cache.delete(key));
            },
        
            // Nettoyer tout le cache
            clear() {
                this.cache.clear();
            }
        };

        // === DEBOUNCING POUR OPTIMISER LES APPELS FR√âQUENTS ===
        const debounceManager = {
            timers: new Map(),
        
            debounce(func, delay = 300, key = 'default') {
                if (this.timers.has(key)) {
                    clearTimeout(this.timers.get(key));
                }
            
                const timer = setTimeout(() => {
                    func();
                    this.timers.delete(key);
                }, delay);
            
                this.timers.set(key, timer);
            }
        };

        // === FONCTIONS UTILITAIRES DE VALIDATION ===
        const utils = {
            validateNumber(value, min = 0, max = 999) {
                const num = parseFloat(value);
                return !isNaN(num) && num >= min && num <= max ? num : 0;
            },
            
            validateString(value, minLength = 1, maxLength = 100) {
                if (typeof value !== 'string') return '';
                return value.trim().length >= minLength && value.trim().length <= maxLength ? value.trim() : '';
            },
            
            validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },
            
            validateDate(dateString) {
                const date = new Date(dateString);
                return !isNaN(date.getTime()) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
            }
        };

        // === ACTIONS (MODIFICATION DE L'√âTAT) ===
        const actions = {
            // Initialisation
            init() {
                this.loadData();
                this.initializeMediaSystem();
                this.initializeTagsSystem();
                this.applyTheme();
                this.setCurrentDate();
                // Restaurer l'√©cran sauvegard√© ou dashboard par d√©faut
                const savedScreen = storage.load('currentScreen', 'dashboard');
                appState.currentScreen = savedScreen;
                render();
            },
            
            loadData() {
                appState.exercises = storage.load('exercises', []);
                appState.sessions = storage.load('sessions', []);
                appState.templates = storage.load('templates', []);
                appState.measurements = storage.load('measurements', []);
                appState.records = storage.load('records', {});
                appState.settings = storage.load('settings', { theme: 'light' });
                appState.currentScreen = storage.load('currentScreen', 'dashboard');
                appState.mediaLibrary = storage.load('mediaLibrary', []);
                appState.exerciseFavorites = storage.load('exerciseFavorites', []);
                console.log('üìö M√©dias charg√©s:', appState.mediaLibrary?.length || 0, 'images');
                appState.customTags = storage.load('customTags', []);
                appState.exerciseTags = storage.load('exerciseTags', {});
                console.log('üè∑Ô∏è Tags charg√©s:', appState.customTags?.length || 0, 'tags personnalis√©s');
            },
            
            saveData() {
                // Invalider les caches li√©s aux donn√©es modifi√©es
                smartCache.invalidate('generalStats');
                smartCache.invalidate('calendar');
                smartCache.invalidate('exerciseSearch');
                storage.save('exercises', appState.exercises);
                storage.save('sessions', appState.sessions);
                storage.save('templates', appState.templates);
                storage.save('measurements', appState.measurements);
                storage.save('records', appState.records);
                storage.save('settings', appState.settings);
                storage.save('mediaLibrary', appState.mediaLibrary || []);
                storage.save('exerciseFavorites', appState.exerciseFavorites || []);
                storage.save('customTags', appState.customTags || []);
                storage.save('exerciseTags', appState.exerciseTags || {});
            },
            
            // Navigation
            showScreen(screenName) {
                // Ajouter √† l'historique de navigation
                addToNavigationHistory(screenName);
                appState.currentScreen = screenName;
                // Sauvegarder l'√©cran actuel
                storage.save('currentScreen', screenName);
                
                // Synchroniser avec l'historique du navigateur
                if (!isNavigatingBack) {
                    window.history.pushState({ screen: screenName }, '', window.location.href);
                }
                
                render();
            },
            
            // Fonction pour naviguer intelligemment vers la s√©ance
            goToSession() {
                if (appState.liveSession) {
                    // Si une s√©ance live est en cours, aller directement √† l'√©cran live
                    this.showScreen('live');
                } else {
                    // Sinon, aller √† l'√©cran de pr√©paration
                    this.showScreen('preparation');
                }
            },

            showSettings() {
                appState.currentScreen = 'settings';
                render();
            },
            
            // Gestion des exercices
            saveExercise() {
                const name = utils.validateString(document.getElementById('exercise-name').value, 1, 50);
                const isUnilateral = document.getElementById('exercise-unilateral').checked;
                const restTime = utils.validateNumber(document.getElementById('exercise-rest').value, 30, 600);
                const category = document.getElementById('exercise-category')?.value || 'strength';
                const mode = document.getElementById('exercise-mode')?.value || 'reps';
                const duration = utils.validateNumber(document.getElementById('exercise-duration').value, 10, 300);

                if (!name) {
                    this.showNotification('Le nom de l\'exercice est requis (1-50 caract√®res)');
                    return;
                }

                if (appState.editingExercise) {
                    // Modification d'exercice existant
                    const exercise = appState.exercises.find(e => e.id === appState.editingExercise);
                    exercise.name = name;
                    exercise.is_unilateral = isUnilateral;
                    exercise.default_rest_time = restTime;
                    exercise.category = category;
                    exercise.exercise_mode = mode;
                    exercise.default_duration = duration;
                    exercise.exercise_type = category === 'warmup' ? 'bodyweight' : 'elastics';
                    exercise.anchor_point = document.getElementById('exercise-anchor')?.value || 'none';
                    exercise.muscle_group = document.getElementById('exercise-muscle-group')?.value || 'autres';
                    
                    // G√©rer les m√©dias
                    if (appState.currentExerciseMedia) {
                        this.saveExerciseMedia(exercise);
                    }
                    
                    appState.editingExercise = null;
                } else {
                    // Cr√©ation d'un nouvel exercice
                    const newExercise = {
                        id: Date.now(),
                        name,
                        is_unilateral: isUnilateral,
                        default_rest_time: restTime,
                        category: category,
                        exercise_mode: mode,
                        default_duration: duration,
                        exercise_type: category === 'warmup' ? 'bodyweight' : 'elastics',
                        anchor_point: document.getElementById('exercise-anchor')?.value || 'none',
                        muscle_group: document.getElementById('exercise-muscle-group')?.value || 'autres'
                    };

                    // G√©rer les m√©dias pour le nouvel exercice
                    if (appState.currentExerciseMedia) {
                        
                    }

                    appState.exercises.push(newExercise);
                }

                this.clearExerciseForm();
                this.saveData();
                render();
                this.showNotification('Exercice sauvegard√© !');
            },

            saveExerciseMedia(exercise) {
                if (!appState.currentExerciseMedia) return;

                console.log('üíæ Sauvegarde m√©dia pour:', exercise.name);
                console.log('üìä Donn√©es m√©dia:', appState.currentExerciseMedia);

                if (appState.currentExerciseMedia.libraryId) {
                    // Image vient de la biblioth√®que
                    exercise.mediaId = appState.currentExerciseMedia.libraryId;
                    console.log('‚úÖ MediaId assign√© depuis biblioth√®que:', exercise.mediaId);
                } else if (appState.currentExerciseMedia.file || appState.currentExerciseMedia.preview) {
                    // Nouvelle image upload√©e
                    if (!appState.mediaLibrary) {
                        appState.mediaLibrary = [];
                    }

                    // Ajouter √† la biblioth√®que avec cat√©gorie
                    const media = {
                        id: Date.now() + Math.random(),
                        name: appState.currentExerciseMedia.name,
                        preview: appState.currentExerciseMedia.preview,
                        size: appState.currentExerciseMedia.size,
                        type: appState.currentExerciseMedia.file?.type || 'image/webp',
                        dateAdded: new Date().toISOString(),
                        category: exercise.muscle_group,
                        tags: [exercise.muscle_group, exercise.name.toLowerCase()]
                    };

                    appState.mediaLibrary.push(media);
                    exercise.mediaId = media.id;
                    
                    console.log('‚úÖ Nouveau m√©dia ajout√©:', media);
                    console.log('‚úÖ MediaId assign√©:', exercise.mediaId);
                }

                // Nettoyer les donn√©es temporaires
                appState.currentExerciseMedia = null;
            },
            
            // Fonction pour d√©placer un exercice vers le haut
            moveExerciseUp(index, context = 'session') {
                if (index === 0) return;
                
                let exercises;
                if (context === 'session' && appState.currentSession) {
                    exercises = appState.currentSession.exercises;
                } else if (context === 'template' && appState.editingTemplate) {
                    exercises = appState.editingTemplate.exerciseIds;
                } else {
                    return;
                }
                
                // √âchanger les √©l√©ments
                [exercises[index], exercises[index - 1]] = [exercises[index - 1], exercises[index]];
                render();
            },

            // Fonction pour d√©placer un exercice vers le bas
            moveExerciseDown(index, context = 'session') {
                let exercises;
                if (context === 'session' && appState.currentSession) {
                    exercises = appState.currentSession.exercises;
                    if (index >= exercises.length - 1) return;
                } else if (context === 'template' && appState.editingTemplate) {
                    exercises = appState.editingTemplate.exerciseIds;
                    if (index >= exercises.length - 1) return;
                } else {
                    return;
                }
                
                // √âchanger les √©l√©ments
                [exercises[index], exercises[index + 1]] = [exercises[index + 1], exercises[index]];
                render();
            },

            editExercise(id) {
                const exercise = appState.exercises.find(e => e.id === id);
                if (exercise) {
                    appState.editingExercise = id;
                    document.getElementById('exercise-name').value = exercise.name;
                    document.getElementById('exercise-unilateral').checked = exercise.is_unilateral;
                    document.getElementById('exercise-rest').value = exercise.default_rest_time;
                    document.getElementById('exercise-category').value = exercise.category || 'strength';
                    document.getElementById('exercise-mode').value = exercise.exercise_mode || 'reps';
                    document.getElementById('exercise-duration').value = exercise.default_duration || 30;
                    document.getElementById('exercise-anchor').value = exercise.anchor_point || 'none';
                    document.getElementById('exercise-muscle-group').value = exercise.muscle_group || 'autres';
                    
                    // Charger l'image si elle existe
                    this.loadExerciseMedia(exercise);
                    
                    // Afficher/masquer le champ dur√©e selon le mode
                    toggleExerciseMode();
                    
                    // Afficher les exemples d'exercices
                    showExerciseExamples(exercise.anchor_point || 'none');
                    
                    render();
                }
            },

            loadExerciseMedia(exercise) {
                // Nettoyer d'abord
                this.removeExerciseMedia();
                
                if (exercise.mediaId && appState.mediaLibrary) {
                    const media = appState.mediaLibrary.find(m => m.id === exercise.mediaId);
                    if (media) {
                        appState.currentExerciseMedia = {
                            file: null,
                            preview: media.preview,
                            name: media.name,
                            size: media.size,
                            libraryId: media.id
                        };
                        
                        this.showMediaPreview(media.preview, media.name, media.size);
                    }
                }
            },
            
            debugExerciseMedia(exercise) {
                console.log('üîç Debug exercice:', exercise.name);
                console.log('üìä MediaId:', exercise.mediaId);
                console.log('üìö MediaLibrary:', appState.mediaLibrary);
                console.log('üîÑ Recherche media avec ID:', exercise.mediaId);
                
                if (exercise.mediaId && appState.mediaLibrary) {
                    const media = appState.mediaLibrary.find(m => m.id === exercise.mediaId);
                    console.log('üñºÔ∏è Media trouv√©:', media);
                }
                
                return this.getExerciseMediaDisplay(exercise);
            },

            getExerciseMediaDisplay(exercise) {
                // V√©rifier s'il y a une image dans la biblioth√®que
                if (exercise.mediaId && appState.mediaLibrary) {
                    const media = appState.mediaLibrary.find(m => m.id === exercise.mediaId);
                    if (media) {
                        return `
                            <img src="${media.preview}" 
                                 alt="${exercise.name}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                 loading="lazy">
                            <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">
                                ${Math.round(media.size/1024)}KB
                            </div>
                        `;
                    }
                }
                
                // Fallback : v√©rifier s'il y a une URL d'image (ancien syst√®me)
                if (exercise.imageUrl) {
                    return `
                        <img src="${exercise.imageUrl}" 
                             alt="${exercise.name}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                             loading="lazy">
                    `;
                }
                
                // Fallback par d√©faut avec emoji sp√©cifique au groupe musculaire
                const muscleEmojis = {
                    'echauffement': 'üî•',
                    'biceps': 'üí™',
                    'triceps': 'üîß', 
                    'epaules': 'ü§≤',
                    'dos': 'üóÇÔ∏è',
                    'pectoraux': 'ü¶Ü',
                    'jambes': 'ü¶µ',
                    'autres': 'üí™'
                };
                
                const emoji = muscleEmojis[exercise.muscle_group] || 'üí™';
                
                return `
                    <div style="text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%;">
                        <div style="font-size: 72px; margin-bottom: 16px; opacity: 0.6;">${emoji}</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Image √† venir</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            Bient√¥t disponible ‚Ä¢ Format WebP optimis√©
                        </div>
                        <button class="btn btn-small btn-secondary" onclick="actions.goToEditExercise(${exercise.id})" style="margin-top: 12px; max-width: 150px; margin-left: auto; margin-right: auto;">
                            üì∑ Ajouter une image
                        </button>
                    </div>
                `;
            },

            generateAnatomyDiagram(exercise) {
                // Mapping des muscles vers les zones SVG
                const muscleMapping = {
                    // Avant du corps
                    'Biceps brachial': 'biceps',
                    'Biceps court': 'biceps',
                    'Biceps': 'biceps',
                    'Delto√Øde ant√©rieur': 'shoulders-front',
                    'Delto√Øde moyen': 'shoulders-front',
                    'Delto√Ødes ant√©rieurs': 'shoulders-front',
                    'Delto√Ødes': 'shoulders-front',
                    'Pectoraux': 'chest',
                    'Pectoraux (partie haute)': 'chest',
                    'Quadriceps': 'quads',
                    'Fessiers': 'glutes',
                    'Abdominaux': 'abs',
                    'Core': 'abs',
                    'Avant-bras': 'forearms',
                    'Mollets': 'calves',

                    // Arri√®re du corps
                    'Triceps': 'triceps',
                    'Triceps (chef long)': 'triceps',
                    'Delto√Ødes post√©rieurs': 'shoulders-back',
                    'Grand dorsal': 'lats',
                    'Rhombo√Ødes': 'rhomboids',
                    'Trap√®zes': 'traps',
                    'Trap√®zes moyens': 'traps',
                    'Ischio-jambiers': 'hamstrings',
                    'Dos': 'back-general'
                };

                // Identifier les muscles actifs
                const primaryMuscles = exercise.muscleGroups.primary || [];
                const secondaryMuscles = exercise.muscleGroups.secondary || [];

                let primaryZones = [];
                let secondaryZones = [];

                primaryMuscles.forEach(muscle => {
                    const zone = muscleMapping[muscle];
                    if (zone && !primaryZones.includes(zone)) {
                        primaryZones.push(zone);
                    }
                });

                secondaryMuscles.forEach(muscle => {
                    const zone = muscleMapping[muscle];
                    if (zone && !secondaryZones.includes(zone) && !primaryZones.includes(zone)) {
                        secondaryZones.push(zone);
                    }
                });

                return `
                    <div class="anatomy-diagram">
                        <!-- Corps de face -->
                        <div class="body-diagram">
                            <div class="anatomy-title">Vue de face</div>
                            ${this.generateFrontBodySVG(primaryZones, secondaryZones)}
                        </div>
                    
                        <!-- Corps de dos -->
                        <div class="body-diagram">
                            <div class="anatomy-title">Vue de dos</div>
                            ${this.generateBackBodySVG(primaryZones, secondaryZones)}
                        </div>
                    </div>

                    <!-- L√©gende -->
                    <div class="anatomy-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--primary);"></div>
                            <span>Muscles principaux</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FFB84D;"></div>
                            <span>Muscles secondaires</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #E5E5E5;"></div>
                            <span>Non sollicit√©s</span>
                        </div>
                    </div>
                `;
            },

            generateFrontBodySVG(primaryZones, secondaryZones) {
                const getClass = (zone) => {
                    if (primaryZones.includes(zone)) return 'muscle-group primary';
                    if (secondaryZones.includes(zone)) return 'muscle-group secondary';
                    return 'muscle-group';
                };

                return `
                    <svg viewBox="0 0 150 300" xmlns="http://www.w3.org/2000/svg">
                        <!-- T√™te -->
                        <circle cx="75" cy="25" r="20" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- Cou -->
                        <rect x="70" y="40" width="10" height="15" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- √âpaules avant -->
                        <ellipse cx="55" cy="60" rx="12" ry="8" class="${getClass('shoulders-front')}" title="Delto√Ødes ant√©rieurs"/>
                        <ellipse cx="95" cy="60" rx="12" ry="8" class="${getClass('shoulders-front')}" title="Delto√Ødes ant√©rieurs"/>
                        
                        <!-- Pectoraux -->
                        <ellipse cx="75" cy="75" rx="25" ry="15" class="${getClass('chest')}" title="Pectoraux"/>
                        
                        <!-- Biceps -->
                        <ellipse cx="50" cy="85" rx="8" ry="20" class="${getClass('biceps')}" title="Biceps"/>
                        <ellipse cx="100" cy="85" rx="8" ry="20" class="${getClass('biceps')}" title="Biceps"/>
                        
                        <!-- Avant-bras -->
                        <ellipse cx="48" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        <ellipse cx="102" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        
                        <!-- Abdominaux -->
                        <rect x="65" y="95" width="20" height="25" rx="3" class="${getClass('abs')}" title="Abdominaux"/>
                        
                        <!-- Torse g√©n√©ral -->
                        <rect x="60" y="55" width="30" height="65" fill="none" stroke="#CCCCCC" stroke-width="1" opacity="0.3"/>
                        
                        <!-- Quadriceps -->
                        <ellipse cx="65" cy="160" rx="10" ry="35" class="${getClass('quads')}" title="Quadriceps"/>
                        <ellipse cx="85" cy="160" rx="10" ry="35" class="${getClass('quads')}" title="Quadriceps"/>
                        
                        <!-- Mollets -->
                        <ellipse cx="65" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        <ellipse cx="85" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        
                        <!-- Pieds -->
                        <ellipse cx="65" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                        <ellipse cx="85" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                    </svg>
                `;
            },

            generateBackBodySVG(primaryZones, secondaryZones) {
                const getClass = (zone) => {
                    if (primaryZones.includes(zone)) return 'muscle-group primary';
                    if (secondaryZones.includes(zone)) return 'muscle-group secondary';
                    return 'muscle-group';
                };

                return `
                    <svg viewBox="0 0 150 300" xmlns="http://www.w3.org/2000/svg">
                        <!-- T√™te -->
                        <circle cx="75" cy="25" r="20" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- Cou -->
                        <rect x="70" y="40" width="10" height="15" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- √âpaules arri√®re -->
                        <ellipse cx="55" cy="60" rx="12" ry="8" class="${getClass('shoulders-back')}" title="Delto√Ødes post√©rieurs"/>
                        <ellipse cx="95" cy="60" rx="12" ry="8" class="${getClass('shoulders-back')}" title="Delto√Ødes post√©rieurs"/>
                        
                        <!-- Trap√®zes -->
                        <polygon points="60,50 90,50 85,75 65,75" class="${getClass('traps')}" title="Trap√®zes"/>
                        
                        <!-- Grand dorsal -->
                        <ellipse cx="75" cy="90" rx="25" ry="20" class="${getClass('lats')}" title="Grand dorsal"/>
                        
                        <!-- Rhombo√Ødes -->
                        <ellipse cx="75" cy="75" rx="15" ry="10" class="${getClass('rhomboids')}" title="Rhombo√Ødes"/>
                        
                        <!-- Triceps -->
                        <ellipse cx="50" cy="85" rx="8" ry="18" class="${getClass('triceps')}" title="Triceps"/>
                        <ellipse cx="100" cy="85" rx="8" ry="18" class="${getClass('triceps')}" title="Triceps"/>
                        
                        <!-- Avant-bras arri√®re -->
                        <ellipse cx="48" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        <ellipse cx="102" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        
                        <!-- Fessiers -->
                        <ellipse cx="75" cy="135" rx="20" ry="15" class="${getClass('glutes')}" title="Fessiers"/>
                        
                        <!-- Ischio-jambiers -->
                        <ellipse cx="65" cy="170" rx="10" ry="30" class="${getClass('hamstrings')}" title="Ischio-jambiers"/>
                        <ellipse cx="85" cy="170" rx="10" ry="30" class="${getClass('hamstrings')}" title="Ischio-jambiers"/>
                        
                        <!-- Mollets arri√®re -->
                        <ellipse cx="65" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        <ellipse cx="85" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        
                        <!-- Pieds -->
                        <ellipse cx="65" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                        <ellipse cx="85" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                    </svg>
                `;
            },

            initializeMediaSystem() {
                // Charger la biblioth√®que de m√©dias au d√©marrage
                if (!appState.mediaLibrary) {
                    appState.mediaLibrary = storage.load('mediaLibrary', []);
                }
                
                // Nettoyer les URLs d'objets orphelins au d√©marrage
                this.cleanupOrphanedMediaUrls();
            },

            cleanupOrphanedMediaUrls() {
                // Cette fonction nettoie les URLs cr√©√©es par createObjectURL qui ne sont plus utilis√©es
                // Important pour √©viter les fuites m√©moire
                if (appState.mediaLibrary) {
                    appState.mediaLibrary.forEach(media => {
                        if (media.preview && media.preview.startsWith('blob:')) {
                            // V√©rifier si l'image est encore utilis√©e
                            const isUsed = appState.exercises.some(ex => ex.mediaId === media.id);
                            if (!isUsed) {
                                console.log(`üßπ Nettoyage de l'URL orpheline: ${media.name}`);
                            }
                        }
                    });
                }
            },

            // Fonction pour g√©n√©rer les inputs de performance selon le mode de l'exercice
            generatePerformanceInputs(exercise, prefix = '') {
                let html = '';
                
                if (exercise.exercise_mode === 'time') {
                    // Mode temps avec TIMER INT√âGR√â
                    html = `
                        ${generateTimerInterface(exercise, prefix)}
                        ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                    `;
                    
                    // Configurer le timer apr√®s le rendu
                    setTimeout(() => {
                        const defaultDuration = exercise.default_duration || 30;
                        exerciseTimer.setup(
                            defaultDuration,
                            updateTimerDisplay,
                            completeTimedExercise
                        );
                    }, 100);
                    
                } else if (exercise.exercise_mode === 'both') {
                    // Mode mixte - choix entre temps et r√©p√©titions
                    const modeInputs = exercise.is_unilateral ? `
                        <div class="input-group" id="${prefix}reps-inputs" style="display: none;">
                            <label>Reps Gauche</label>
                            <input type="number" id="${prefix}left-reps" class="input" min="0">
                        </div>
                        <div class="input-group" id="${prefix}reps-inputs-2" style="display: none;">
                            <label>Reps Droite</label>
                            <input type="number" id="${prefix}right-reps" class="input" min="0">
                        </div>
                        <div id="${prefix}timer-container" style="display: none;">
                            ${generateTimerInterface(exercise, prefix)}
                        </div>
                    ` : `
                        <div class="input-group" id="${prefix}reps-inputs" style="display: none;">
                            <label>R√©p√©titions</label>
                            <input type="number" id="${prefix}reps" class="input" min="0">
                        </div>
                        <div id="${prefix}timer-container" style="display: none;">
                            ${generateTimerInterface(exercise, prefix)}
                        </div>
                    `;
                    
                    html = `
                        <div class="input-group">
                            <label>Mode d'ex√©cution</label>
                            <select id="${prefix}execution-mode" class="select" onchange="togglePerformanceMode('${prefix}')">
                                <option value="reps">R√©p√©titions</option>
                                <option value="time">Temps avec Timer</option>
                            </select>
                        </div>
                        <div class="performance-inputs">
                            ${modeInputs}
                        </div>
                        ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                    `;
                } else {
                    // Mode r√©p√©titions classique
                    if (exercise.is_unilateral) {
                        html = `
                            <div class="performance-inputs">
                                <div class="input-group">
                                    <label>Reps Gauche</label>
                                    <input type="number" id="${prefix}left-reps" class="input" min="0">
                                </div>
                                <div class="input-group">
                                    <label>Reps Droite</label>
                                    <input type="number" id="${prefix}right-reps" class="input" min="0">
                                </div>
                            </div>
                            ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                        `;
                    } else {
                        html = `
                            <div class="performance-inputs">
                                <div class="input-group">
                                    <label>R√©p√©titions</label>
                                    <input type="number" id="${prefix}reps" class="input" min="0">
                                </div>
                            </div>
                            ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                        `;
                    }
                }
                
                return html;
            },

            deleteExercise(id) {
                if (confirm('Supprimer cet exercice ? Cette action est irr√©versible.')) {
                    appState.exercises = appState.exercises.filter(e => e.id !== id);
                    this.saveData();
                    render();
                    this.showNotification('Exercice supprim√©');
                }
            },
            
            cancelExerciseEdit() {
                appState.editingExercise = null;
                this.clearExerciseForm();
                render();
            },
            
            clearExerciseForm() {
                document.getElementById('exercise-name').value = '';
                document.getElementById('exercise-unilateral').checked = false;
                document.getElementById('exercise-rest').value = '90';
                document.getElementById('exercise-category').value = 'strength';
                document.getElementById('exercise-mode').value = 'reps';
                document.getElementById('exercise-duration').value = '30';
                document.getElementById('exercise-anchor').value = 'none';
                document.getElementById('exercise-muscle-group').value = 'biceps';
                document.getElementById('exercise-examples').style.display = 'none';
                document.getElementById('duration-group').style.display = 'none';
                // Nettoyer les m√©dias
                this.removeExerciseMedia();
            },
            
            // Gestion des mod√®les
            saveTemplate() {
                const name = document.getElementById('template-name').value.trim();
            
                if (!name) {
                    this.showNotification('Le nom du mod√®le est requis');
                    return;
                }

                if (!appState.templateInCreation || appState.templateInCreation.exercises.length === 0) {
                    this.showNotification('S√©lectionnez au moins un exercice');
                    return;
                }

                // R√©cup√©rer les param√®tres globaux
                const restBetweenExercises = parseInt(document.getElementById('template-rest-between-exercises')?.value) || 120;
                const restBetweenSets = parseInt(document.getElementById('template-rest-between-sets')?.value) || 90;

                const newTemplate = {
                    id: Date.now(),
                    name,
                    exercises: appState.templateInCreation.exercises.map(ex => ({
                        exerciseId: ex.exerciseId,
                        plannedSets: ex.plannedSets,
                        restTime: ex.restTime,
                        duration: ex.duration // Ajouter la dur√©e
                    })),
                    globalSettings: {
                        restBetweenExercises,
                        restBetweenSets
                    }
                };

                appState.templates.push(newTemplate);
                this.clearTemplateForm();
                this.saveData();
                render();
                this.showNotification('Mod√®le cr√©√© !');
            },
            
            deleteTemplate(id) {
                if (confirm('Supprimer ce mod√®le ?')) {
                    appState.templates = appState.templates.filter(t => t.id !== id);
                    this.saveData();
                    render();
                    this.showNotification('Mod√®le supprim√©');
                }
            },
            
            clearTemplateForm() {
                document.getElementById('template-name').value = '';
                
                // Nettoyer le mod√®le en cr√©ation
                appState.templateInCreation = null;
                
                // R√©afficher l'interface vide
                const selectedExercisesContainer = document.getElementById('template-selected-exercises');
                if (selectedExercisesContainer) {
                    selectedExercisesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucun exercice s√©lectionn√©</p>';
                }
                
                const globalSettings = document.getElementById('template-global-settings');
                if (globalSettings) {
                    globalSettings.style.display = 'none';
                }
            },
            
            // Afficher le s√©lecteur d'exercices
            showExerciseSelector() {
                // Fermer le modal existant s'il y en a un
                const existingModal = document.getElementById('exercise-selector-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                if (!appState.templateInCreation) {
                    appState.templateInCreation = {
                        exercises: [],
                        globalSettings: {
                            restBetweenExercises: 120,
                            restBetweenSets: 90
                        }
                    };
                }

                // Cr√©er le modal de s√©lection d'exercices
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'exercise-selector-modal';
                
                let exercisesList = '';
                const groupedExercises = {};
                appState.exercises.forEach(exercise => {
                    const group = exercise.muscle_group || 'autres';
                    if (!groupedExercises[group]) {
                        groupedExercises[group] = [];
                    }
                    groupedExercises[group].push(exercise);
                });

                const groupOrder = ['echauffement', 'biceps', 'triceps', 'epaules', 'dos', 'pectoraux', 'jambes', 'autres'];
                groupOrder.forEach(group => {
                    if (groupedExercises[group] && groupedExercises[group].length > 0) {
                        exercisesList += `<h4 class="exercise-group-title">${group.charAt(0).toUpperCase() + group.slice(1)}</h4>`;
                        groupedExercises[group].forEach(exercise => {
                            const modeIcon = exercise.exercise_mode === 'time' ? '‚è±Ô∏è' : 
                                             exercise.exercise_mode === 'both' ? 'üîÑ' : 'üî¢';
                            const isSelected = appState.templateInCreation.exercises.some(ex => ex.exerciseId === exercise.id);
                            exercisesList += `
                                <div class="exercise-item" style="opacity: ${isSelected ? '0.5' : '1'};">
                                    <div>
                                        <strong>${modeIcon} ${exercise.name}</strong>
                                        <div style="font-size: 14px; color: var(--text-secondary);">
                                            ${exercise.is_unilateral ? 'Unilat√©ral' : 'Bilat√©ral'} ‚Ä¢ ${exercise.default_rest_time}s repos
                                        </div>
                                    </div>
                                    <button class="btn btn-small ${isSelected ? 'btn-secondary' : 'btn-primary'}" 
                                        onclick="actions.${isSelected ? 'removeFromTemplate' : 'addToTemplate'}(${exercise.id})"
                                        ${isSelected ? 'disabled' : ''}>
                                        ${isSelected ? '‚úì Ajout√©' : '‚ûï Ajouter'}
                                    </button>
                                </div>
                            `;
                        });
                    }
                });

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>S√©lectionner des exercices</h3>
                            <button class="close-btn" onclick="actions.closeExerciseSelector()" style="font-size: 24px; padding: 8px; background: none; border: none; cursor: pointer;">√ó</button>
                        </div>
                        <div style="margin: 16px 0;">
                            ${exercisesList}
                        </div>
                        <button class="btn btn-success btn-full" onclick="actions.closeExerciseSelector()">
                            ‚úÖ Terminer la s√©lection
                        </button>
                    </div>
                `;
                    
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        actions.closeExerciseSelector();
                    }
                });

                document.body.appendChild(modal);
            },

            // Ajouter un exercice au mod√®le en cr√©ation
            addToTemplate(exerciseId) {
                if (!appState.templateInCreation) {
                    appState.templateInCreation = { exercises: [], globalSettings: { restBetweenExercises: 120, restBetweenSets: 90 } };
                }

                const exercise = appState.exercises.find(e => e.id === exerciseId);
                if (exercise && !appState.templateInCreation.exercises.some(ex => ex.exerciseId === exerciseId)) {
                    appState.templateInCreation.exercises.push({
                        exerciseId: exerciseId,
                        plannedSets: 3,
                        restTime: exercise.default_rest_time
                    });
                
                    // Mettre √† jour SEULEMENT le bouton de l'exercice ajout√© (√©viter la remont√©e)
                    const button = document.querySelector(`button[onclick*="addToTemplate(${exerciseId})"]`);
                    if (button) {
                        button.textContent = '‚úì Ajout√©';
                        button.className = 'btn btn-small btn-secondary';
                        button.disabled = true;
                        button.onclick = () => actions.removeFromTemplate(exerciseId);
                    }

                    // Rafra√Æchir l'affichage principal sans fermer le modal
                    this.renderSelectedExercises();
                }
            },

            // Retirer un exercice du mod√®le en cr√©ation
            removeFromTemplate(exerciseId) {
                if (appState.templateInCreation) {
                    appState.templateInCreation.exercises = appState.templateInCreation.exercises.filter(
                        ex => ex.exerciseId !== exerciseId
                    );
                
                    // Rafra√Æchir le modal
                    this.showExerciseSelector();
                    // Rafra√Æchir l'affichage principal
                    this.renderSelectedExercises();
                }
            },

            // Fermer le s√©lecteur d'exercices
            closeExerciseSelector() {
                const modal = document.getElementById('exercise-selector-modal');
                if (modal) {
                    modal.remove();
                }
                this.renderSelectedExercises();
            },

            // Afficher les exercices s√©lectionn√©s
            renderSelectedExercises() {
                const container = document.getElementById('template-selected-exercises');
                
                if (!container) {
                    console.error('Container template-selected-exercises not found');
                    return;
                }
                
                if (!appState.templateInCreation || appState.templateInCreation.exercises.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucun exercice s√©lectionn√©</p>';
                    return;
                }
                
                let html = '';
                appState.templateInCreation.exercises.forEach((exData, index) => {
                    const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                    if (exercise) {
                        const modeIcon = exercise.exercise_mode === 'time' ? '‚è±Ô∏è' :
                            exercise.exercise_mode === 'both' ? 'üîÑ' : 'üî¢';
                        html += `
                            <div class="exercise-item" style="margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span class="exercise-number">${index + 1}</span>
                                        <strong>${modeIcon} ${exercise.name}</strong>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" value="${exData.plannedSets}" min="1" max="20"
                                            style="width: 50px; padding: 4px; border: 1px solid var(--border); border-radius: 4px;"
                                            onchange="actions.updateTemplateExerciseSets(${index}, this.value)">
                                        <span style="font-size: 12px;">s√©ries</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" value="${exData.restTime}" min="30" max="600"
                                            style="width: 60px; padding: 4px; border: 1px solid var(--border); border-radius: 4px;"
                                            onchange="actions.updateTemplateExerciseRest(${index}, this.value)">
                                        <span style="font-size: 12px;">s repos</span>
                                    </div>
                                    ${exercise.exercise_mode === 'time' || exercise.exercise_mode === 'both' ? `
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <input type="number" value="${exData.duration || exercise.default_duration || 30}" min="10" max="300"
                                                style="width: 60px; padding: 4px; border: 1px solid var(--border); border-radius: 4px;"
                                                onchange="actions.updateTemplateExerciseDuration(${index}, this.value)">
                                            <span style="font-size: 12px;">s dur√©e</span>
                                        </div>
                                    ` : ''}
                                    <div class="reorder-buttons">
                                        <button class="btn btn-small btn-secondary" onclick="actions.moveTemplateExerciseUp(${index})"
                                            ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                                        <button class="btn btn-small btn-secondary" onclick="actions.moveTemplateExerciseDown(${index})"
                                            ${index === appState.templateInCreation.exercises.length - 1 ? 'disabled' : ''}>‚Üì</button>
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="actions.removeFromTemplateByIndex(${index})">‚úï</button>
                                </div>
                            </div>
                        `;
                    }
                });
                container.innerHTML = html;
                },

            // Mettre √† jour le nombre de s√©ries d'un exercice dans le mod√®le
            updateTemplateExerciseSets(index, sets) {
                const setsNumber = parseInt(sets);
                if (appState.templateInCreation && setsNumber >= 1 && setsNumber <= 20) {
                    appState.templateInCreation.exercises[index].plannedSets = setsNumber;
                }
            },

            // Mettre √† jour le temps de repos d'un exercice dans le mod√®le
            updateTemplateExerciseRest(index, restTime) {
                const rest = parseInt(restTime);
                if (appState.templateInCreation && rest >= 30 && rest <= 600) {
                    appState.templateInCreation.exercises[index].restTime = rest;
                }
            },

            // Mettre √† jour la dur√©e d'un exercice dans le mod√®le
            updateTemplateExerciseDuration(index, duration) {
                const durationNumber = parseInt(duration);
                if (appState.templateInCreation && durationNumber >= 10 && durationNumber <= 300) {
                    appState.templateInCreation.exercises[index].duration = durationNumber;
                }
            },

            // D√©placer un exercice vers le haut dans le mod√®le
            moveTemplateExerciseUp(index) {
                if (appState.templateInCreation && index > 0) {
                    const exercises = appState.templateInCreation.exercises;
                    [exercises[index], exercises[index - 1]] = [exercises[index - 1], exercises[index]];
                    this.renderSelectedExercises();
                }
            },

            // D√©placer un exercice vers le bas dans le mod√®le
            moveTemplateExerciseDown(index) {
                if (appState.templateInCreation && index < appState.templateInCreation.exercises.length - 1) {
                    const exercises = appState.templateInCreation.exercises;
                    [exercises[index], exercises[index + 1]] = [exercises[index + 1], exercises[index]];
                    this.renderSelectedExercises();
                }
            },

            // Retirer un exercice du mod√®le par index
            removeFromTemplateByIndex(index) {
                if (appState.templateInCreation) {
                    appState.templateInCreation.exercises.splice(index, 1);
                    this.renderSelectedExercises();
                }
            },

            // Pr√©paration de s√©ance
            setCurrentDate() {
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('session-date');
                if (dateInput) {
                    dateInput.value = today;
                    appState.currentSession = {
                        date: today,
                        notes: '',
                        exercises: [],
                        globalSettings: {
                            restBetweenExercises: 120,
                            restBetweenSets: 90
                        }
                    };
                }
            },
            
            updateSessionDate(date) {
                if (appState.currentSession) {
                    appState.currentSession.date = date;
                }
            },
            
            updateSessionNotes(notes) {
                if (appState.currentSession) {
                    appState.currentSession.notes = notes;
                }
            },
            
            addExerciseToSession() {
                // Cette fonction n'est plus utilis√©e avec le nouveau syst√®me de recherche
                // Elle est remplac√©e par selectExercise() dans le syst√®me de recherche
                this.showNotification('Utilisez la recherche ci-dessus pour ajouter un exercice');
            },
            
            removeExerciseFromSession(exerciseId) {
                if (appState.currentSession) {
                    appState.currentSession.exercises = appState.currentSession.exercises.filter(
                        e => e.exercise_id !== exerciseId
                    );
                    render();
                }
            },
            
            updatePlannedSets(exerciseId, sets) {
                if (appState.currentSession) {
                    const exercise = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                    if (exercise) {
                        const setsNumber = utils.validateNumber(sets, 1, 20);
                        if (setsNumber > 0) {
                            exercise.planned_sets = setsNumber;
                        } else {
                            // Remettre la valeur pr√©c√©dente si la validation √©choue
                            const input = document.querySelector(`input[onchange*="${exerciseId}"]`);
                            if (input) {
                                input.value = exercise.planned_sets;
                            }
                            this.showNotification('Nombre de s√©ries invalide (1-20)');
                        }
                    }
                }
            },
            
            updateExerciseRestTime(exerciseId, restTime) {
                if (appState.currentSession) {
                    const exercise = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                    if (exercise) {
                        const restNumber = utils.validateNumber(restTime, 30, 600);
                        if (restNumber >= 30) {
                            exercise.rest_time = restNumber;
                        } else {
                            // Remettre la valeur pr√©c√©dente si la validation √©choue
                            const input = document.querySelector(`input[onchange*="updateExerciseRestTime(${exerciseId}"]`);
                            if (input) {
                                input.value = exercise.rest_time || 90;
                            }
                            this.showNotification('Temps de repos invalide (30-600s)');
                        }
                    }
                }
            },

            updateExerciseDuration(exerciseId, duration) {
                if (appState.currentSession) {
                    const exercise = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                    if (exercise) {
                        const durationNumber = utils.validateNumber(duration, 10, 300);
                        if (durationNumber >= 10) {
                            exercise.duration = durationNumber;
                        } else {
                            // Remettre la valeur pr√©c√©dente si la validation √©choue
                            const input = document.querySelector(`input[onchange*="updateExerciseDuration(${exerciseId}"]`);
                            if (input) {
                                const defaultExercise = appState.exercises.find(e => e.id === exerciseId);
                                input.value = exercise.duration || defaultExercise?.default_duration || 30;
                            }
                            this.showNotification('Dur√©e invalide (10-300s)');
                        }
                    }
                }
            },

            updateSessionRestSettings() {
                if (!appState.currentSession) {
                    appState.currentSession = {
                        date: new Date().toISOString().split('T')[0],
                        notes: '',
                        exercises: []
                    };
                }

                const restBetweenExercises = utils.validateNumber(document.getElementById('session-rest-between-exercises')?.value, 30, 600);
                const restBetweenSets = utils.validateNumber(document.getElementById('session-rest-between-sets')?.value, 30, 300);

                if (!appState.currentSession.globalSettings) {
                    appState.currentSession.globalSettings = {};
                }

                appState.currentSession.globalSettings.restBetweenExercises = restBetweenExercises || 120;
                appState.currentSession.globalSettings.restBetweenSets = restBetweenSets || 90;
            },

            startNewSession() {
                appState.currentSession = {
                    date: new Date().toISOString().split('T')[0],
                    notes: '',
                    exercises: [],
                    globalSettings: {
                        restBetweenExercises: 120,
                        restBetweenSets: 90
                    }
                };
                this.showScreen('preparation');
            },
            
            resumeLastSession() {
                const lastSession = appState.sessions[appState.sessions.length - 1];
                if (lastSession) {
                    appState.currentSession = {
                        date: new Date().toISOString().split('T')[0],
                        notes: '',
                        exercises: lastSession.exercises.map(e => ({
                            exercise_id: e.exercise_id,
                            planned_sets: e.planned_sets,
                            rest_time: e.rest_time, // Conserver les temps de repos individuels
                            sets: []
                        })),
                        globalSettings: {
                            // Utiliser les param√®tres de la derni√®re s√©ance ou les valeurs par d√©faut
                            restBetweenExercises: lastSession.globalSettings?.restBetweenExercises || 120,
                            restBetweenSets: lastSession.globalSettings?.restBetweenSets || 90
                        }
                    };
                    this.showScreen('preparation');
                } else {
                    this.showNotification('Aucune s√©ance pr√©c√©dente trouv√©e');
                }
            },

            saveSessionManually() {
                if (!appState.currentSession || appState.currentSession.exercises.length === 0) {
                    this.showNotification('Ajoutez au moins un exercice');
                    return;
                }
                
                // Pr√©parer la s√©ance pour saisie manuelle
                appState.manualSession = {
                    ...appState.currentSession,
                    id: Date.now(),
                    startTime: Date.now(),
                    currentExerciseIndex: 0,
                    globalSettings: {
                        restBetweenExercises: appState.currentSession.globalSettings?.restBetweenExercises || 120,
                        restBetweenSets: appState.currentSession.globalSettings?.restBetweenSets || 90
                    }
                };
                this.showScreen('manual-entry');
                render();
            },

            finishManualSession() {
                if (appState.manualSession) {
                    // Pr√©parer la s√©ance √† sauvegarder
                    appState.sessionToFinish = {
                        ...appState.manualSession,
                        endTime: Date.now(),
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    // Nettoyer les variables de session en cours
                    appState.manualSession = null;
                    appState.currentSession = null;
                    
                    // Afficher le modal de difficult√©
                    document.getElementById('difficulty-modal').classList.add('active');
                }
            },

            // Fonction pour terminer la s√©ance avec √©valuation de difficult√©
            finishSessionWithDifficulty(difficulty) {
                if (!appState.sessionToFinish) return;
                
                // Ajouter la difficult√© √† la s√©ance
                if (difficulty) {
                    appState.sessionToFinish.difficulty = difficulty;
                }
                
                // Sauvegarder la s√©ance
                appState.sessions.push(appState.sessionToFinish);
                
                // Nettoyer les variables temporaires
                appState.sessionToFinish = null;
                
                // Fermer le modal
                document.getElementById('difficulty-modal').classList.remove('active');
                
                // Sauvegarder et rediriger
                this.saveData();
                this.showScreen('dashboard');
                
                const difficultyEmoji = {
                    'Facile': 'üòä',
                    'Normale': 'üí™', 
                    'Difficile': 'üî•'
                };
                
                this.showNotification(
                    difficulty ? 
                    `${difficultyEmoji[difficulty]} S√©ance ${difficulty.toLowerCase()} termin√©e ! üéâ` :
                    'S√©ance termin√©e ! üéâ'
                );
                
                // Forcer la mise √† jour du calendrier
                setTimeout(() => {
                    render();
                }, 50);
            },

            saveManualSet() {
                if (!appState.manualSession) return;
                
                const currentExercise = appState.manualSession.exercises[appState.manualSession.currentExerciseIndex];
                const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                
                // R√©cup√©rer les donn√©es de performance selon le mode de l'exercice
                let performance = {};
                const setType = document.getElementById('manual-set-type')?.value || 'work';

                // R√©cup√©rer la combinaison d'√©lastiques (si applicable)
                const elasticsData = exercise.exercise_type === 'elastics' ? updateResistanceDisplay('manual-', exercise.is_unilateral) : { selectedElastics: {}, total: 0 };

                if (exercise.exercise_mode === 'time') {
                    // Mode temps pur - utiliser la valeur du timer ou de l'input
                    const durationInput = document.getElementById('manual-duration');
                    const duration = durationInput ? parseInt(durationInput.value) : (exerciseTimer.duration || 30);
                    
                    performance = {
                        duration: duration,
                        exercise_mode: 'time',
                        elastics: elasticsData.selectedElastics,
                        total_resistance: elasticsData.total
                    };
                    
                    // Arr√™ter le timer si il √©tait en cours
                    if (exerciseTimer.isRunning) {
                        exerciseTimer.stop();
                    }
                    
                } else if (exercise.exercise_mode === 'both') {
                    // Mode mixte - v√©rifier le mode choisi
                    const executionMode = document.getElementById('manual-execution-mode')?.value || 'reps';
                    
                    if (executionMode === 'time') {
                        const durationInput = document.getElementById('manual-duration');
                        const duration = durationInput ? parseInt(durationInput.value) : 30;
                        
                        performance = {
                            duration: duration,
                            exercise_mode: 'time',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                        
                        if (exerciseTimer.isRunning) {
                            exerciseTimer.stop();
                        }
                    } else {
                        // Mode r√©p√©titions
                        if (exercise.is_unilateral) {
                            performance = {
                                left_reps: parseInt(document.getElementById('manual-left-reps')?.value) || 0,
                                right_reps: parseInt(document.getElementById('manual-right-reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        } else {
                            performance = {
                                reps: parseInt(document.getElementById('manual-reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        }
                    }
                } else {
                    // Mode r√©p√©titions classique
                    if (exercise.is_unilateral) {
                        performance = {
                            left_reps: parseInt(document.getElementById('manual-left-reps')?.value) || 0,
                            right_reps: parseInt(document.getElementById('manual-right-reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    } else {
                        performance = {
                            reps: parseInt(document.getElementById('manual-reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    }
                }
                
                // Ajouter la s√©rie
                currentExercise.sets.push({
                    type: setType,
                    ...performance
                });

                // V√©rification de s√©curit√© pour √©viter les bugs
                if (!currentExercise.sets) {
                    currentExercise.sets = [];
                }
                
                // V√©rifier les records
                this.checkRecords(currentExercise.exercise_id, performance, setType);
                
                // V√©rifier si on a atteint le nombre de s√©ries pr√©vues
                if (currentExercise.sets.length >= currentExercise.planned_sets) {
                    // V√©rifier s'il y a encore des exercices
                    if (appState.manualSession.currentExerciseIndex + 1 >= appState.manualSession.exercises.length) {
                        // C'√©tait le dernier exercice, proposer de finir
                        if (confirm('Toutes les s√©ries pr√©vues sont termin√©es. Finir la s√©ance ?')) {
                            this.finishManualSession();
                        } else {
                            render();
                        }
                    } else {
                        // Passer automatiquement √† l'exercice suivant
                        this.nextManualExercise();
                    }
                    return;
                }
                
                // Effacer les champs pour la s√©rie suivante
                if (exercise.is_unilateral) {
                    document.getElementById('manual-left-reps').value = '';
                    document.getElementById('manual-right-reps').value = '';
                } else {
                    document.getElementById('manual-reps').value = '';
                }
                
                // Remettre les √©lastiques √† z√©ro
                if (exercise.exercise_type === 'elastics') {
                    if (exercise.is_unilateral) {
                        // Pour les exercices unilat√©raux, remettre les deux c√¥t√©s √† z√©ro
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElementLeft = document.getElementById(`manual-elastic-left-${color}`);
                            const selectElementRight = document.getElementById(`manual-elastic-right-${color}`);
                            if (selectElementLeft) selectElementLeft.value = '0';
                            if (selectElementRight) selectElementRight.value = '0';
                        });
                        updateResistanceDisplay('manual-', true);
                    } else {
                        // Pour les exercices bilat√©raux
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElement = document.getElementById(`manual-elastic-${color}`);
                            if (selectElement) selectElement.value = '0';
                        });
                        updateResistanceDisplay('manual-', false);
                    }
                }
            },

            nextManualExercise() {
                if (appState.manualSession) {
                    appState.manualSession.currentExerciseIndex++;
                    if (appState.manualSession.currentExerciseIndex >= appState.manualSession.exercises.length) {
                        this.finishManualSession();
                    } else {
                        render();
                    }
                }
            },
            
            // S√©ance live
            startLiveSession() {
                if (!appState.currentSession || appState.currentSession.exercises.length === 0) {
                    this.showNotification('Ajoutez au moins un exercice');
                    return;
                }
                
                appState.liveSession = {
                    ...appState.currentSession,
                    id: Date.now(),
                    startTime: Date.now(),
                    currentExerciseIndex: 0,
                    currentSetIndex: 0,
                    isResting: false,
                    isPreparing: true, // NOUVEAU : phase de pr√©paration
                    prepareStartTime: Date.now(),
                    prepareDuration: 5000, // 5 secondes
                    restStartTime: null,
                    restDuration: 0,
                    exercises: appState.currentSession.exercises.map(ex => ({
                        ...ex,
                        sets: ex.sets || []  // IMPORTANT : s'assurer que sets existe
                    })),
                    globalSettings: {
                        restBetweenExercises: appState.currentSession.globalSettings?.restBetweenExercises || 120,
                        restBetweenSets: appState.currentSession.globalSettings?.restBetweenSets || 90
                    }
                };
                
                this.showScreen('live');
                this.startSessionTimer();
                render();
            },

            // Fonction pour mettre en pause la s√©ance live
            pauseLiveSession() {
                if (appState.liveSession && !appState.liveSession.isPaused) {
                    appState.liveSession.isPaused = true;
                    appState.liveSession.pauseStartTime = Date.now();
                    
                    // Arr√™ter tous les timers
                    this.cleanupTimers();
                    if (exerciseTimer.isRunning) {
                        exerciseTimer.pause();
                    }
                    
                    render();
                    this.showNotification('‚è∏Ô∏è S√©ance en pause');
                }
            },

            // Fonction pour reprendre la s√©ance live
            resumeLiveSession() {
                if (appState.liveSession && appState.liveSession.isPaused) {
                    const pauseDuration = Date.now() - appState.liveSession.pauseStartTime;
                    
                    // Ajuster les temps de d√©but pour compenser la pause
                    appState.liveSession.startTime += pauseDuration;
                    if (appState.liveSession.restStartTime) {
                        appState.liveSession.restStartTime += pauseDuration;
                    }
                    if (appState.liveSession.prepareStartTime) {
                        appState.liveSession.prepareStartTime += pauseDuration;
                    }
                    
                    appState.liveSession.isPaused = false;
                    delete appState.liveSession.pauseStartTime;
                    
                    // Red√©marrer les timers
                    this.startSessionTimer();
                    if (exerciseTimer.isPaused) {
                        exerciseTimer.start();
                    }
                    
                    render();
                    this.showNotification('‚ñ∂Ô∏è S√©ance reprise');
                }
            },
            
            startSessionTimer() {
                if (appState.sessionTimer) {
                    clearInterval(appState.sessionTimer);
                }
                
                appState.sessionTimer = setInterval(() => {
                    if (appState.liveSession) {
                        const elapsed = Date.now() - appState.liveSession.startTime;
                        const timerElement = document.getElementById('live-timer');
                        if (timerElement) {
                            if (appState.liveSession.isPaused) {
                                // Affichage en mode pause
                                const pauseDuration = Math.floor((Date.now() - appState.liveSession.pauseStartTime) / 1000);
                                timerElement.textContent = `‚è∏Ô∏è ${pauseDuration}s`;
                                timerElement.style.color = 'var(--warning)';
                            } else {
                                // Affichage normal
                                timerElement.textContent = this.formatTime(elapsed);
                                timerElement.style.color = 'var(--primary)';
                            }
                        }
                        
                        // G√©rer le timer de repos
                        if (appState.liveSession.isResting && !appState.liveSession.isPaused) {
                            const restElapsed = Date.now() - appState.liveSession.restStartTime;
                            const restRemaining = Math.max(0, appState.liveSession.restDuration - restElapsed);
                            const restElement = document.querySelector('.rest-time');
                            if (restElement) {
                                // Forcer la mise √† jour de l'affichage √† chaque seconde
                                const secondsRemaining = Math.ceil(restRemaining / 1000);
                                const minutes = Math.floor(secondsRemaining / 60);
                                const seconds = secondsRemaining % 60;
                                restElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                                // Couleurs selon le temps restant
                                if (restRemaining <= 5000) {
                                    restElement.style.color = 'var(--danger)';
                                } else if (restRemaining <= 10000) {
                                    restElement.style.color = 'var(--warning)';
                                } else {
                                    restElement.style.color = 'var(--warning)';
                                }
                            
                                // Sons pour les derni√®res secondes (logique finale corrig√©e)
                                const currentSecond = Math.ceil(restRemaining / 1000);
                                const previousSecond = appState.liveSession.lastRestSecond || currentSecond + 1;

                                // V√©rifier si on vient de passer √† une nouvelle seconde
                                if (currentSecond !== previousSecond && currentSecond > 1) {
                                    appState.liveSession.lastRestSecond = currentSecond;
                                    
                                    // Bip √† chaque seconde de 5 √† 2 secondes (pas √† 1 seconde pour √©viter le double bip)
                                    if (currentSecond <= 5) {
                                        exerciseTimer.playBeep(800, 200);
                                        if ('vibrate' in navigator) {
                                            navigator.vibrate(100);
                                        }
                                    }
                                } else if (restRemaining === 0 && previousSecond !== 0) {
                                    // Son sp√©cial pour la fin (remplace le bip √† 1 seconde)
                                    appState.liveSession.lastRestSecond = 0;
                                    exerciseTimer.playBeep(1000, 500);
                                    if ('vibrate' in navigator) {
                                        navigator.vibrate([200, 100, 200]);
                                    }
                                }
                            
                                // Passer automatiquement quand le repos est fini
                                if (restRemaining === 0) {
                                    appState.liveSession.isResting = false;
                                    appState.liveSession.lastRestSecond = null; // Reset
                                    // CORRECTION : V√©rifier que l'index est valide
                                    if (appState.liveSession.currentExerciseIndex < appState.liveSession.exercises.length) {
                                        const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                                        
                                        // D√©marrer automatiquement les exercices en mode temps
                                        const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                                        
                                        // Attendre que le rendu soit termin√© puis d√©marrer automatiquement
                                        setTimeout(() => {
                                            render();
                                        
                                            // Si l'exercice est en mode temps ou mode mixte, d√©marrer automatiquement le timer
                                            if (exercise && (exercise.exercise_mode === 'time' || exercise.exercise_mode === 'both')) {
                                                setTimeout(() => {
                                                    // V√©rifier le mode d'ex√©cution pour les exercices mixtes
                                                    const executionMode = document.getElementById('execution-mode');
                                                    const shouldAutoStart = !executionMode || executionMode.value === 'time';
                                                
                                                    if (shouldAutoStart) {
                                                        const durationInput = document.getElementById('duration');
                                                        const defaultDuration = currentExercise.duration || exercise.default_duration || 30;
                                                        
                                                        if (durationInput) {
                                                            durationInput.value = defaultDuration;
                                                        }
                                                        
                                                        // Configurer et d√©marrer automatiquement le timer
                                                        exerciseTimer.setup(
                                                            defaultDuration,
                                                            updateTimerDisplay,
                                                            completeTimedExercise
                                                        );
                                                        
                                                        // D√©marrer automatiquement
                                                        startExerciseTimer();
                                                        
                                                        // Notification pour informer l'utilisateur
                                                        actions.showNotification('‚è±Ô∏è Timer d√©marr√© automatiquement !');
                                                    }
                                                }, 300); // D√©lai pour que le DOM soit pr√™t
                                            }
                                        }, 100);
                                    
                                    } else {
                                        // Index invalide, terminer la s√©ance
                                        this.finishLiveSession();
                                    }
                                }
                            }
                        }

                        // G√©rer le timer de pr√©paration
                        if (appState.liveSession.isPreparing) {
                            const prepareElapsed = Date.now() - appState.liveSession.prepareStartTime;
                            const prepareRemaining = Math.max(0, appState.liveSession.prepareDuration - prepareElapsed);
                            const countdownElement = document.getElementById('countdown-display');
                            
                            if (countdownElement) {
                                const secondsLeft = Math.ceil(prepareRemaining / 1000);
                                countdownElement.textContent = secondsLeft;
                                
                                // Changer la couleur selon le temps restant
                                if (secondsLeft <= 2) {
                                    countdownElement.style.color = 'var(--danger)';
                                } else if (secondsLeft <= 3) {
                                    countdownElement.style.color = 'var(--warning)';
                                } else {
                                    countdownElement.style.color = 'var(--primary)';
                                }
                                
                                // Sons aux derni√®res secondes (√©viter les r√©p√©titions)
                                if (secondsLeft <= 3 && secondsLeft > 0) {
                                    const currentSecond = Math.floor(prepareRemaining / 1000);
                                    const lastSecond = Math.floor((prepareRemaining + 1000) / 1000);
                                    if (currentSecond !== lastSecond) {
                                        exerciseTimer.playBeep(800, 200);
                                    }
                                }
                                
                                // Fin de la pr√©paration
                                if (prepareRemaining === 0) {
                                    appState.liveSession.isPreparing = false;
                                    exerciseTimer.playBeep(1000, 500); // Son de d√©but plus long
                                    
                                    // D√©marrer automatiquement le timer si l'exercice est en mode temps
                                    const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                                    const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                                
                                    // Attendre un petit moment apr√®s le son pour d√©marrer
                                    setTimeout(() => {
                                        render();
                                    
                                        // Si l'exercice est en mode temps, d√©marrer automatiquement le timer
                                        if (exercise && (exercise.exercise_mode === 'time' ||
                                            (exercise.exercise_mode === 'both' && document.getElementById('execution-mode')?.value === 'time'))) {
                                            // Configurer et d√©marrer le timer automatiquement
                                            setTimeout(() => {
                                                const durationInput = document.getElementById('duration');
                                                const defaultDuration = exercise.default_duration || 30;
                                                if (durationInput) {
                                                    durationInput.value = defaultDuration;
                                                }
                                                exerciseTimer.setup(
                                                    defaultDuration,
                                                    updateTimerDisplay,
                                                    completeTimedExercise
                                                );
                                                // D√©marrer automatiquement
                                                startExerciseTimer();
                                                
                                                // Notification pour informer l'utilisateur
                                                actions.showNotification('üöÄ Premier exercice d√©marr√© !');
                                            }, 200); // Petit d√©lai pour que le DOM soit pr√™t
                                        }
                                    }, 500); // D√©lai pour que le son se termine
                                }
                            }
                        }
                    }
                }, 1000);
            },
            
            formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },
            
            // Calculer la progression bas√©e sur les s√©ries
            calculateSessionProgress() {
                if (!appState.liveSession || !appState.liveSession.exercises) return 0;
                
                let totalPlannedSets = 0;
                let totalCompletedSets = 0;
                
                appState.liveSession.exercises.forEach(exerciseData => {
                    totalPlannedSets += exerciseData.planned_sets || 0;
                    totalCompletedSets += exerciseData.sets ? exerciseData.sets.length : 0;
                });
                
                if (totalPlannedSets === 0) return 0;
                return Math.round((totalCompletedSets / totalPlannedSets) * 100);
            },

            validateSet() {
                if (!appState.liveSession) return;
                
                const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                
                // R√©cup√©rer les donn√©es de performance selon le mode de l'exercice
                let performance = {};
                const setType = document.getElementById('set-type')?.value || 'work';

                // R√©cup√©rer la combinaison d'√©lastiques (si applicable)
                const elasticsData = exercise.exercise_type === 'elastics' ? updateResistanceDisplay('', exercise.is_unilateral) : { selectedElastics: {}, total: 0 };

                if (exercise.exercise_mode === 'time') {
                    // Mode temps pur - utiliser la valeur du timer ou de l'input
                    const durationInput = document.getElementById('duration');
                    const duration = durationInput ? parseInt(durationInput.value) : (exerciseTimer.duration || 30);
                    
                    performance = {
                        duration: duration,
                        exercise_mode: 'time',
                        elastics: elasticsData.selectedElastics,
                        total_resistance: elasticsData.total
                    };
                    
                    // Arr√™ter le timer si il √©tait en cours
                    if (exerciseTimer.isRunning) {
                        exerciseTimer.stop();
                    }
                    
                } else if (exercise.exercise_mode === 'both') {
                    // Mode mixte - v√©rifier le mode choisi
                    const executionMode = document.getElementById('execution-mode')?.value || 'reps';
                    
                    if (executionMode === 'time') {
                        const durationInput = document.getElementById('duration');
                        const duration = durationInput ? parseInt(durationInput.value) : 30;
                        
                        performance = {
                            duration: duration,
                            exercise_mode: 'time',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                        
                        if (exerciseTimer.isRunning) {
                            exerciseTimer.stop();
                        }
                    } else {
                        // Mode r√©p√©titions
                        if (exercise.is_unilateral) {
                            performance = {
                                left_reps: parseInt(document.getElementById('left-reps')?.value) || 0,
                                right_reps: parseInt(document.getElementById('right-reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        } else {
                            performance = {
                                reps: parseInt(document.getElementById('reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        }
                    }
                } else {
                    // Mode r√©p√©titions classique
                    if (exercise.is_unilateral) {
                        performance = {
                            left_reps: parseInt(document.getElementById('left-reps')?.value) || 0,
                            right_reps: parseInt(document.getElementById('right-reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    } else {
                        performance = {
                            reps: parseInt(document.getElementById('reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    }
                }
                
                // Ajouter la s√©rie
                currentExercise.sets.push({
                    type: setType,
                    ...performance
                });
                
                // Remettre les √©lastiques √† z√©ro apr√®s validation
                if (exercise.exercise_type === 'elastics') {
                    if (exercise.is_unilateral) {
                        // Pour les exercices unilat√©raux, remettre les deux c√¥t√©s √† z√©ro
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElementLeft = document.getElementById(`elastic-left-${color}`);
                            const selectElementRight = document.getElementById(`elastic-right-${color}`);
                            if (selectElementLeft) selectElementLeft.value = '0';
                            if (selectElementRight) selectElementRight.value = '0';
                        });
                        updateResistanceDisplay('', true);
                    } else {
                        // Pour les exercices bilat√©raux
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElement = document.getElementById(`elastic-${color}`);
                            if (selectElement) selectElement.value = '0';
                        });
                        updateResistanceDisplay('', false);
                    }
                }        

                // V√©rifier les records
                this.checkRecords(currentExercise.exercise_id, performance, setType);
                
                // V√©rifier si on a atteint le nombre de s√©ries pr√©vues
                if (currentExercise.sets.length >= currentExercise.planned_sets) {
                    // V√©rifier s'il y a encore des exercices
                    if (appState.liveSession.currentExerciseIndex + 1 >= appState.liveSession.exercises.length) {
                        // C'√©tait le dernier exercice, finir la s√©ance
                        this.finishLiveSession();
                    } else {
                        // Passer √† l'exercice suivant
                        this.nextExercise();
                    }
                } else {
                    // Passer au repos pour la s√©rie suivante
                    appState.liveSession.isResting = true;
                    appState.liveSession.restStartTime = Date.now();
                    const sessionExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                    // Utiliser UNIQUEMENT le temps de repos sp√©cifique √† l'exercice, pas les r√®gles globales
                    const customRestTime = sessionExercise.rest_time || exercise.default_rest_time;
                    appState.liveSession.restDuration = customRestTime * 1000;
                    render();
                }
            },
            
            skipRest() {
                if (appState.liveSession) {
                    appState.liveSession.isResting = false;
                    render();
                }
            },
            
            nextExercise() {
                if (!appState.liveSession) return;
                appState.liveSession.currentExerciseIndex++;
                appState.liveSession.currentSetIndex = 0;
                if (appState.liveSession.currentExerciseIndex >= appState.liveSession.exercises.length) {
                    this.finishLiveSession();
                } else {
                    // Repos avant le prochain exercice - utiliser le temps de repos du prochain exercice
                    appState.liveSession.isResting = true;
                    appState.liveSession.restStartTime = Date.now();
                    
                    // CORRECTION : Utiliser le temps de repos sp√©cifique du prochain exercice
                    const nextExerciseData = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                    const nextExercise = appState.exercises.find(e => e.id === nextExerciseData.exercise_id);
                    const customRestTime = nextExerciseData.rest_time || nextExercise.default_rest_time || 90;
                    appState.liveSession.restDuration = customRestTime * 1000;
                    render();
                }
            },
            
            // Nettoyer tous les timers actifs
            cleanupTimers() {
                if (appState.sessionTimer) {
                    clearInterval(appState.sessionTimer);
                    appState.sessionTimer = null;
                }
                if (appState.restTimer) {
                    clearInterval(appState.restTimer);
                    appState.restTimer = null;
                }
            },

            finishLiveSession() {
                if (!appState.liveSession) return;
                
                // Pr√©parer la s√©ance √† sauvegarder
                appState.sessionToFinish = {
                    ...appState.liveSession,
                    endTime: Date.now(),
                    date: new Date().toISOString().split('T')[0]
                };
                
                // Nettoyer les timers
                this.cleanupTimers();
                if (exerciseTimer.isRunning) {
                    exerciseTimer.stop();
                }
                
                // Nettoyer les variables de session en cours
                appState.liveSession = null;
                appState.currentSession = null;
                
                // Afficher le modal de difficult√©
                document.getElementById('difficulty-modal').classList.add('active');
            },
            
            stopLiveSession() {
                if (confirm('Arr√™ter la s√©ance ? Les donn√©es seront perdues.')) {
                    appState.liveSession = null;
                    this.cleanupTimers(); // Utilise la nouvelle fonction
                    this.showScreen('preparation');
                    render();
                }
            },
            
            // Gestion des records
            checkRecords(exerciseId, performance, setType) {
                if (setType !== 'work') return; // Seules les s√©ries de travail comptent pour les records
                
                if (!appState.records[exerciseId]) {
                    appState.records[exerciseId] = [];
                }
                
                const today = new Date().toISOString().split('T')[0];
                let newRecords = [];
                
                // Record de poids max (utiliser la r√©sistance totale des √©lastiques)
                let maxWeight = performance.total_resistance || 0;
                
                const currentMaxWeight = this.getCurrentRecord(exerciseId, 'max_weight');
                if (maxWeight > currentMaxWeight) {
                    newRecords.push({ date: today, type: 'max_weight', value: maxWeight });
                }
                
                // Record de r√©p√©titions max
                let maxReps = 0;
                if (performance.reps) {
                    maxReps = performance.reps;
                } else if (performance.left_reps && performance.right_reps) {
                    maxReps = Math.max(performance.left_reps, performance.right_reps);
                }
                
                const currentMaxReps = this.getCurrentRecord(exerciseId, 'max_reps');
                if (maxReps > currentMaxReps) {
                    newRecords.push({ date: today, type: 'max_reps', value: maxReps });
                }

                // Record de temps max (pour les exercices en mode temps)
                if (performance.exercise_mode === 'time' && performance.duration) {
                    const currentMaxTime = this.getCurrentRecord(exerciseId, 'max_time');
                    if (performance.duration > currentMaxTime) {
                        newRecords.push({ date: today, type: 'max_time', value: performance.duration });
                    }
                }
                
                // 1RM estim√© (formule d'Epley)
                if (maxWeight > 0 && maxReps > 0) {
                    const estimated1RM = maxWeight * (1 + maxReps / 30);
                    const current1RM = this.getCurrentRecord(exerciseId, 'max_1rm');
                    if (estimated1RM > current1RM) {
                        newRecords.push({ date: today, type: 'max_1rm', value: estimated1RM });
                    }
                }
                
                // Ajouter les nouveaux records
                if (newRecords.length > 0) {
                    appState.records[exerciseId].push(...newRecords);
                    this.showNotification('üéâ Nouveau PR !');
                }
            },
            
            getCurrentRecord(exerciseId, type) {
                const records = appState.records[exerciseId] || [];
                const typeRecords = records.filter(r => r.type === type);
                return typeRecords.length > 0 ? Math.max(...typeRecords.map(r => r.value)) : 0;
            },

            getLastPerformance(exerciseId) {
                // Conversion en nombre pour √©viter les probl√®mes de type
                const numericExerciseId = parseInt(exerciseId);
                const exercise = appState.exercises.find(e => e.id === numericExerciseId);
                if (!exercise) {
                    console.log(`Exercise not found for ID: ${exerciseId}`);
                    return null;
                }
                
                // Trouver la derni√®re s√©ance avec cet exercice (comparaison flexible)
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => parseInt(ex.exercise_id) === numericExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));
                    
                if (sessionsWithExercise.length === 0) {
                    console.log(`No sessions found for exercise ID: ${exerciseId}`);
                    return null;
                }
                
                const lastSession = sessionsWithExercise[0];
                const exerciseData = lastSession.exercises.find(ex => parseInt(ex.exercise_id) === numericExerciseId);
                
                if (!exerciseData || !exerciseData.sets || exerciseData.sets.length === 0) {
                    console.log(`No exercise data or sets found for exercise ID: ${exerciseId}`);
                    return null;
                }
                
                // R√©cup√©rer TOUTES les s√©ries de travail de la derni√®re s√©ance
                const workSets = exerciseData.sets.filter(set => set.type === 'work' || !set.type);
                if (workSets.length === 0) {
                    console.log(`No work sets found for exercise ID: ${exerciseId}`);
                    return null;
                }
                
                // Retourner toutes les s√©ries avec leurs d√©tails
                const allSets = workSets.map(set => {
                    if (exercise.is_unilateral) {
                        return {
                            left_reps: set.left_reps || 0,
                            right_reps: set.right_reps || 0,
                            resistance: set.total_resistance || 0,
                            exercise_mode: set.exercise_mode || 'reps',
                            duration: set.duration || 0
                        };
                    } else {
                        return {
                            reps: set.reps || 0,
                            resistance: set.total_resistance || 0,
                            exercise_mode: set.exercise_mode || 'reps',
                            duration: set.duration || 0
                        };
                    }
                });
                
                console.log(`Found ${allSets.length} sets for exercise ${exercise.name}`);
                return {
                    date: lastSession.date,
                    sets: allSets,
                    totalSets: allSets.length
                };
            },

            getLastPerformanceForSet(exerciseId, setNumber) {
                // Conversion en nombre pour √©viter les probl√®mes de type
                const numericExerciseId = parseInt(exerciseId);
                const exercise = appState.exercises.find(e => e.id === numericExerciseId);
                if (!exercise) return null;
                
                // Trouver la derni√®re s√©ance avec cet exercice (comparaison flexible)
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => parseInt(ex.exercise_id) === numericExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));
                    
                if (sessionsWithExercise.length === 0) return null;
                
                const lastSession = sessionsWithExercise[0];
                const exerciseData = lastSession.exercises.find(ex => parseInt(ex.exercise_id) === numericExerciseId);
                
                if (!exerciseData || !exerciseData.sets || exerciseData.sets.length === 0) return null;
                
                // R√©cup√©rer seulement les s√©ries de travail
                const workSets = exerciseData.sets.filter(set => set.type === 'work' || !set.type);
                if (workSets.length < setNumber) return null;
                
                // R√©cup√©rer la s√©rie sp√©cifique (setNumber - 1 car les arrays commencent √† 0)
                const specificSet = workSets[setNumber - 1];
                if (!specificSet) return null;
                
                // Adapter le retour selon le mode de l'exercice
                if (specificSet.exercise_mode === 'time') {
                    return {
                        date: lastSession.date,
                        resistance: specificSet.total_resistance || 0,
                        duration: specificSet.duration || 0,
                        mode: 'time',
                        setNumber: setNumber,
                        elastics: specificSet.elastics || {}
                    };
                } else {
                    return {
                        date: lastSession.date,
                        resistance: specificSet.total_resistance || 0,
                        reps: exercise.is_unilateral ?
                            `${specificSet.left_reps || 0}G/${specificSet.right_reps || 0}D` :
                            (specificSet.reps || 0),
                        mode: 'reps',
                        setNumber: setNumber,
                        elastics: specificSet.elastics || {}
                    };
                }
            },

            getAllLastPerformances(exerciseId) {
                // Conversion en nombre pour √©viter les probl√®mes de type
                const numericExerciseId = parseInt(exerciseId);
                const exercise = appState.exercises.find(e => e.id === numericExerciseId);
                if (!exercise) return null;
                
                // Trouver la derni√®re s√©ance avec cet exercice (comparaison flexible)
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => parseInt(ex.exercise_id) === numericExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));
                    
                if (sessionsWithExercise.length === 0) return null;
                
                const lastSession = sessionsWithExercise[0];
                const exerciseData = lastSession.exercises.find(ex => parseInt(ex.exercise_id) === numericExerciseId);
                
                if (!exerciseData || !exerciseData.sets || exerciseData.sets.length === 0) return null;
                
                // R√©cup√©rer toutes les s√©ries de travail
                const workSets = exerciseData.sets.filter(set => set.type === 'work' || !set.type);
                if (workSets.length === 0) return null;
                
                return {
                    date: lastSession.date,
                    sets: workSets.map((set, index) => {
                        if (set.exercise_mode === 'time') {
                            return {
                                setNumber: index + 1,
                                resistance: set.total_resistance || 0,
                                duration: set.duration || 0,
                                mode: 'time'
                            };
                        } else {
                            return {
                                setNumber: index + 1,
                                resistance: set.total_resistance || 0,
                                reps: exercise.is_unilateral ?
                                    `${set.left_reps || 0}G/${set.right_reps || 0}D` :
                                    (set.reps || 0),
                                mode: 'reps'
                            };
                        }
                    })
                };
            },

            // Navigation du calendrier
            previousMonth() {
                if (!appState.calendarDate) {
                    appState.calendarDate = new Date();
                }
                appState.calendarDate.setMonth(appState.calendarDate.getMonth() - 1);
                render();
            },

            nextMonth() {
                if (!appState.calendarDate) {
                    appState.calendarDate = new Date();
                }
                appState.calendarDate.setMonth(appState.calendarDate.getMonth() + 1);
                render();
            },

            generateMeasurementsChart() {
                console.log('Measurements data:', appState.measurements); // LIGNE DE DEBUG
                if (appState.measurements.length === 0) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Aucune donn√©e disponible</p>';
                }
    
                // Trier par date
                const sortedMeasurements = [...appState.measurements].sort((a, b) => a.date.localeCompare(b.date));
    
                let chartHtml = '<div style="font-size: 12px; max-height: 250px; overflow-y: auto;">';
    
                // Graphique du poids
                const weightData = sortedMeasurements.filter(m => m.weight && m.weight > 0);
                if (weightData.length > 0) {
                    chartHtml += '<h4>√âvolution du poids</h4>';
                    const maxWeight = Math.max(...weightData.map(d => d.weight));
                    const minWeight = Math.min(...weightData.map(d => d.weight));
        
                    weightData.forEach(data => {
                        const date = new Date(data.date).toLocaleDateString('fr-FR', {month: 'short', day: 'numeric'});
                        const barWidth = Math.max(10, ((data.weight - minWeight) / (maxWeight - minWeight)) * 80 + 20);
            
                        chartHtml += `
                        <div style="display: flex; align-items: center; margin: 4px 0;">
                            <div style="width: 60px; font-size: 10px;">${date}</div>
                            <div style="width: ${barWidth}%; height: 15px; background: var(--primary); margin: 0 8px; border-radius: 2px;"></div>
                            <div style="font-size: 10px;">${data.weight}kg</div>
                        </div>
                        `;
                    });
                }
    
                // Graphique de la taille
                const waistData = sortedMeasurements.filter(m => m.waist && m.waist > 0);
                if (waistData.length > 0) {
                    chartHtml += '<h4 style="margin-top: 16px;">√âvolution tour de taille</h4>';
                    const maxWaist = Math.max(...waistData.map(d => d.waist));
                    const minWaist = Math.min(...waistData.map(d => d.waist));
                    
                    waistData.forEach(data => {
                        const date = new Date(data.date).toLocaleDateString('fr-FR', {month: 'short', day: 'numeric'});
                        const barWidth = Math.max(10, ((data.waist - minWaist) / (maxWaist - minWaist)) * 80 + 20);
                        
                        chartHtml += `
                            <div style="display: flex; align-items: center; margin: 4px 0;">
                                <div style="width: 60px; font-size: 10px;">${date}</div>
                                <div style="width: ${barWidth}%; height: 15px; background: var(--secondary); margin: 0 8px; border-radius: 2px;"></div>
                                <div style="font-size: 10px;">${data.waist}cm</div>
                            </div>
                        `;
                    });
                }
                
                // Si aucune donn√©e n'est disponible
                if (weightData.length === 0 && waistData.length === 0) {
                    chartHtml += '<p style="text-align: center; color: var(--text-secondary);">Ajoutez des mensurations pour voir les graphiques</p>';
                }
                
                chartHtml += '</div>';
                return chartHtml;
            },
    

            generateSimpleChart(exerciseId, exerciseName) {
                // R√©cup√©rer les donn√©es de performance
                const performanceData = [];
                const exercise = appState.exercises.find(e => e.id === exerciseId);
                
                appState.sessions.forEach(session => {
                    const sessionExercise = session.exercises.find(e => e.exercise_id === exerciseId);
                    if (sessionExercise && sessionExercise.sets.length > 0) {
                        // Calculer le meilleur set de la s√©ance
                        let maxWeight = 0;
                        let maxReps = 0;
                        
                        sessionExercise.sets.forEach(set => {
                            if (set.type === 'work') {
                                // Utiliser la r√©sistance totale des √©lastiques
                                const setWeight = set.total_resistance || 0;
                                if (setWeight > maxWeight) maxWeight = setWeight;
                                
                                // Pour les r√©p√©titions
                                if (exercise.is_unilateral) {
                                    const leftReps = set.left_reps || 0;
                                    const rightReps = set.right_reps || 0;
                                    if (leftReps > maxReps) maxReps = leftReps;
                                    if (rightReps > maxReps) maxReps = rightReps;
                                } else {
                                    const setReps = set.reps || 0;
                                    if (setReps > maxReps) maxReps = setReps;
                                }
                            }
                        });
                        
                        if (maxWeight > 0 || maxReps > 0) {
                            performanceData.push({
                                date: session.date,
                                weight: maxWeight,
                                reps: maxReps,
                                volume: maxWeight * maxReps
                            });
                        }
                    }
                });
                
                if (performanceData.length === 0) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Aucune donn√©e disponible</p>';
                }
                
                // Trier par date
                performanceData.sort((a, b) => a.date.localeCompare(b.date));
                
                // Cr√©er un graphique simple
                let chartHtml = `<div style="font-size: 12px; max-height: 250px; overflow-y: auto;">`;
                chartHtml += `<h4>Progression du poids max</h4>`;
                
                const maxWeight = Math.max(...performanceData.map(d => d.weight));
                
                performanceData.forEach((data, index) => {
                    const date = new Date(data.date).toLocaleDateString('fr-FR', {month: 'short', day: 'numeric'});
                    const barWidth = Math.max(1, (data.weight / maxWeight) * 100);
                    
                    chartHtml += `
                        <div style="display: flex; align-items: center; margin: 4px 0;">
                            <div style="width: 60px; font-size: 10px;">${date}</div>
                            <div style="width: ${barWidth}%; height: 20px; background: var(--primary); margin: 0 8px; border-radius: 2px;"></div>
                            <div style="font-size: 10px;">${data.weight}kg</div>
                        </div>
                    `;
                });
                
                chartHtml += `</div>`;
                return chartHtml;
            },
            
            // Gestion des mesures corporelles
            addMeasurement() {
                const date = document.getElementById('measurement-date').value;
                const height = parseFloat(document.getElementById('measurement-height').value);
                const weight = parseFloat(document.getElementById('measurement-weight').value);
                const waist = parseFloat(document.getElementById('measurement-waist').value);
                const chest = parseFloat(document.getElementById('measurement-chest').value);
                const arm = parseFloat(document.getElementById('measurement-arm').value);
                const thigh = parseFloat(document.getElementById('measurement-thigh').value);

                if (!date) {
                    this.showNotification('Date requise');
                    return;
                }

                // Calculer l'IMC si taille et poids sont renseign√©s
                let imc = 0;
                let imcCategory = '';
                if (height > 0 && weight > 0) {
                    const heightInMeters = height / 100;
                    imc = weight / (heightInMeters * heightInMeters);
                    
                    // D√©terminer la cat√©gorie IMC
                    if (imc < 18.5) {
                        imcCategory = 'Insuffisance pond√©rale';
                    } else if (imc < 25) {
                        imcCategory = 'Poids normal';
                    } else if (imc < 30) {
                        imcCategory = 'Surpoids';
                    } else if (imc < 35) {
                        imcCategory = 'Ob√©sit√© mod√©r√©e';
                    } else if (imc < 40) {
                        imcCategory = 'Ob√©sit√© s√©v√®re';
                    } else {
                        imcCategory = 'Ob√©sit√© morbide';
                    }
                }

                const newMeasurement = {
                    id: Date.now(),
                    date,
                    height: height || 0,
                    weight: weight || 0,
                    waist: waist || 0,
                    chest: chest || 0,
                    arm: arm || 0,
                    thigh: thigh || 0,
                    imc: Math.round(imc * 10) / 10, // Arrondir √† 1 d√©cimale
                    imcCategory: imcCategory
                };

                appState.measurements.push(newMeasurement);
                this.clearMeasurementForm();
                this.saveData();
                render();
                
                if (imc > 0) {
                    this.showNotification(`Mensuration ajout√©e ! IMC: ${newMeasurement.imc} (${imcCategory})`);
                } else {
                    this.showNotification('Mensuration ajout√©e !');
                }
            },
            
            deleteMeasurement(id) {
                if (confirm('Supprimer cette mesure ?')) {
                    appState.measurements = appState.measurements.filter(m => m.id !== id);
                    this.saveData();
                    render();
                    this.showNotification('Mensuration supprim√©e');
                }
            },
            
            clearMeasurementForm() {
                document.getElementById('measurement-date').value = '';
                document.getElementById('measurement-height').value = '';
                document.getElementById('measurement-weight').value = '';
                document.getElementById('measurement-waist').value = '';
                document.getElementById('measurement-chest').value = '';
                document.getElementById('measurement-arm').value = '';
                document.getElementById('measurement-thigh').value = '';
            },
            
            // Statistiques
            updateStats(exerciseId) {
                console.log('Updating stats for exercise:', exerciseId);
                // Pas besoin de render() complet, juste re-rendre les stats
                renderStats();
            },

            // Calculer les statistiques g√©n√©rales
            calculateGeneralStats() {
                // V√©rifier le cache d'abord
                const cacheKey = { sessionsCount: appState.sessions.length, today: new Date().toISOString().split('T')[0] };
                const cached = smartCache.get('generalStats', cacheKey);
                if (cached) {
                    console.log('üìä Stats g√©n√©rales r√©cup√©r√©es du cache');
                    return cached;
                }
                
                console.log('üìä Calcul des stats g√©n√©rales...');
                const now = new Date();
                const today = now.toISOString().split('T')[0];

                // Calculer le d√©but de la semaine (lundi)
                const startOfWeek = new Date(now);
                const dayOfWeek = now.getDay();
                const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Dimanche = 0
                startOfWeek.setDate(now.getDate() - daysToMonday);
                startOfWeek.setHours(0, 0, 0, 0);
                const weekStart = startOfWeek.toISOString().split('T')[0];

                // Calculer le d√©but du mois
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthStart = startOfMonth.toISOString().split('T')[0];

                // Statistiques cette semaine
                const sessionsThisWeek = appState.sessions.filter(session =>
                    session.date >= weekStart && session.date <= today
                );

                // Statistiques ce mois
                const sessionsThisMonth = appState.sessions.filter(session =>
                    session.date >= monthStart && session.date <= today
                );

                // Calculer le volume total cette semaine
                let totalVolumeThisWeek = 0;
                sessionsThisWeek.forEach(session => {
                    session.exercises.forEach(ex => {
                        const exercise = appState.exercises.find(e => e.id === ex.exercise_id);
                        ex.sets.forEach(set => {
                            if (set.type === 'work' && set.exercise_mode !== 'time') {
                                let resistance = 0;
                                let reps = 0;
                                if (exercise && exercise.is_unilateral) {
                                    if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                        resistance = (set.total_resistance.left || 0) + (set.total_resistance.right || 0);
                                    } else {
                                        resistance = (set.total_resistance || 0) * 2;
                                    }
                                    reps = (set.left_reps || 0) + (set.right_reps || 0);
                                } else {
                                    resistance = set.total_resistance || 0;
                                    reps = set.reps || 0;
                                }
                                totalVolumeThisWeek += (resistance * reps);
                            }
                        });
                    });
                });

                // Calculer le volume total ce mois
                let totalVolumeThisMonth = 0;
                sessionsThisMonth.forEach(session => {
                    session.exercises.forEach(ex => {
                        const exercise = appState.exercises.find(e => e.id === ex.exercise_id);
                        ex.sets.forEach(set => {
                            if (set.type === 'work' && set.exercise_mode !== 'time') {
                                let resistance = 0;
                                let reps = 0;
                                if (exercise && exercise.is_unilateral) {
                                    if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                        resistance = (set.total_resistance.left || 0) + (set.total_resistance.right || 0);
                                    } else {
                                        resistance = (set.total_resistance || 0) * 2;
                                    }
                                    reps = (set.left_reps || 0) + (set.right_reps || 0);
                                } else {
                                    resistance = set.total_resistance || 0;
                                    reps = set.reps || 0;
                                }
                                totalVolumeThisMonth += (resistance * reps);
                            }
                        });
                    });
                });

                // Calculer la dur√©e moyenne des s√©ances
                let totalDuration = 0;
                let sessionsWithDuration = 0;
                appState.sessions.forEach(session => {
                    if (session.endTime && session.startTime) {
                        totalDuration += (session.endTime - session.startTime);
                        sessionsWithDuration++;
                    }
                });
                const averageSessionDuration = sessionsWithDuration > 0 ?
                    Math.round(totalDuration / sessionsWithDuration / 1000 / 60) : 0;

                // R√©cup√©rer les records r√©cents (derniers 30 jours)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                const recentRecords = [];
                Object.keys(appState.records).forEach(exerciseId => {
                    const exercise = appState.exercises.find(e => e.id == exerciseId);
                    if (exercise) {
                        const records = appState.records[exerciseId] || [];
                        records.forEach(record => {
                            if (record.date >= thirtyDaysAgoStr) {
                                recentRecords.push({
                                    ...record,
                                    exerciseName: exercise.name
                                });
                            }
                        });
                    }
                });

                // Trier les records r√©cents par date (plus r√©cent en premier)
                recentRecords.sort((a, b) => b.date.localeCompare(a.date));

                const result = {
                    sessionsThisWeek: sessionsThisWeek.length,
                    totalVolumeThisWeek: Math.round(totalVolumeThisWeek),
                    sessionsThisMonth: sessionsThisMonth.length,
                    totalVolumeThisMonth: Math.round(totalVolumeThisMonth),
                    averageSessionDuration,
                    totalSessions: appState.sessions.length,
                    recentRecords: recentRecords.slice(0, 10)
                };

                // Mettre en cache et retourner
                return smartCache.set('generalStats', cacheKey, result);
            },
            
            // Modals
            showTemplates() {
                document.getElementById('templates-modal').classList.add('active');
                this.renderTemplatesModal();
            },
            
            showImportModal() {
                document.getElementById('import-modal').classList.add('active');
            },
            
            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            },
            
            loadTemplate(templateId) {
                const template = appState.templates.find(t => t.id === templateId);
                if (!template) {
                    this.showNotification('Mod√®le introuvable');
                    return;
                }
                
                if (!appState.currentSession) {
                    appState.currentSession = {
                        date: new Date().toISOString().split('T')[0],
                        notes: '',
                        exercises: [],
                        globalSettings: {
                            restBetweenExercises: 120,
                            restBetweenSets: 90
                        }
                    };
                }

                // Remplacer tous les exercices par ceux du mod√®le
                appState.currentSession.exercises = [];
                
                if (template.exercises && template.exercises.length > 0) {
                    // Nouveau format avec ordre et param√®tres d√©taill√©s
                    template.exercises.forEach(exData => {
                        const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                        if (exercise) {
                            appState.currentSession.exercises.push({
                                exercise_id: exData.exerciseId,
                                planned_sets: exData.plannedSets || 3,
                                rest_time: exData.restTime || exercise.default_rest_time || 90,
                                duration: exData.duration || exercise.default_duration || 30,
                                sets: []
                            });
                        }
                    });
                
                    // Appliquer les param√®tres globaux s'ils existent
                    if (template.globalSettings) {
                        appState.currentSession.globalSettings = {
                            restBetweenExercises: template.globalSettings.restBetweenExercises || 120,
                            restBetweenSets: template.globalSettings.restBetweenSets || 90
                        };
                    }
                } else {
                    // Compatibilit√© avec l'ancien format
                    (template.exerciseIds || []).forEach(exerciseId => {
                        const exercise = appState.exercises.find(e => e.id === exerciseId);
                        if (exercise) {
                            appState.currentSession.exercises.push({
                                exercise_id: exerciseId,
                                planned_sets: 3,
                                rest_time: exercise.default_rest_time || 90,
                                duration: exercise.default_duration || 30,
                                sets: []
                            });
                        }
                    });
                }

                this.closeModal('templates-modal');
                render();
                this.showNotification(`Mod√®le "${template.name}" charg√© ! (${appState.currentSession.exercises.length} exercices)`);
            },
            
            // √âditer un mod√®le existant
            editTemplate(templateId) {
                const template = appState.templates.find(t => t.id === templateId);
                if (template) {
                    // Pr√©-remplir le nom
                    document.getElementById('template-name').value = template.name;
                    
                    // Charger la structure dans templateInCreation
                    if (template.exercises && template.exercises.length > 0) {
                        // Nouveau format
                        appState.templateInCreation = {
                            exercises: template.exercises.map(ex => ({
                                exerciseId: ex.exerciseId,
                                plannedSets: ex.plannedSets,
                                restTime: ex.restTime
                            })),
                            globalSettings: template.globalSettings || {
                                restBetweenExercises: 120,
                                restBetweenSets: 90
                            }
                        };
                    } else {
                        // Convertir l'ancien format
                        appState.templateInCreation = {
                            exercises: (template.exerciseIds || []).map(exerciseId => ({
                                exerciseId: exerciseId,
                                plannedSets: 3,
                                restTime: 90
                            })),
                            globalSettings: {
                                restBetweenExercises: 120,
                                restBetweenSets: 90
                            }
                        };
                    }
                
                    // Marquer comme modification d'un mod√®le existant
                    appState.editingTemplateId = templateId;
                    
                    // Supprimer l'ancien mod√®le (il sera re-cr√©√© √† la sauvegarde)
                    appState.templates = appState.templates.filter(t => t.id !== templateId);
                    
                    // Remplir les param√®tres globaux
                    const restBetweenExercises = document.getElementById('template-rest-between-exercises');
                    const restBetweenSets = document.getElementById('template-rest-between-sets');
                    
                    if (restBetweenExercises) {
                        restBetweenExercises.value = appState.templateInCreation.globalSettings.restBetweenExercises;
                    }
                    if (restBetweenSets) {
                        restBetweenSets.value = appState.templateInCreation.globalSettings.restBetweenSets;
                    }
                
                    // R√©afficher les exercices s√©lectionn√©s
                    this.renderSelectedExercises();
                    
                    this.showNotification('Mod√®le charg√© pour modification');
                }
            },

            // Th√®me
            toggleTheme() {
                appState.settings.theme = appState.settings.theme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                this.saveData();
            },
            
            applyTheme() {
                document.documentElement.setAttribute('data-theme', appState.settings.theme);
                const checkbox = document.getElementById('dark-theme');
                if (checkbox) {
                    checkbox.checked = appState.settings.theme === 'dark';
                }
            },
            
            // Import/Export
            exportData() {
                const data = {
                    exercises: appState.exercises,
                    sessions: appState.sessions,
                    templates: appState.templates,
                    measurements: appState.measurements,
                    records: appState.records,
                    settings: appState.settings,
                    exportDate: new Date().toISOString(),
                    version: STORAGE_VERSION
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `smarttrack_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showNotification('Donn√©es export√©es !');
            },
            
            importData() {
                const textarea = document.getElementById('import-data');
                try {
                    const data = JSON.parse(textarea.value);
                    
                    if (confirm('Remplacer toutes les donn√©es actuelles ? Cette action est irr√©versible.')) {
                        appState.exercises = data.exercises || [];
                        appState.sessions = data.sessions || [];
                        appState.templates = data.templates || [];
                        appState.measurements = data.measurements || [];
                        appState.records = data.records || {};
                        appState.settings = data.settings || { theme: 'light' };
                        
                        this.saveData();
                        this.closeModal('import-modal');
                        this.applyTheme();
                        render();
                        this.showNotification('Donn√©es import√©es !');
                        textarea.value = '';
                    }
                } catch (e) {
                    this.showNotification('Format JSON invalide');
                }
            },
            
            clearAllData() {
                if (confirm('Effacer TOUTES les donn√©es ? Cette action est irr√©versible !')) {
                    if (confirm('√ätes-vous vraiment s√ªr ? Toutes vos s√©ances et exercices seront perdus !')) {
                        storage.clear();
                        appState = {
                            currentScreen: 'dashboard',
                            currentSession: null,
                            liveSession: null,
                            editingExercise: null,
                            exercises: [],
                            sessions: [],
                            templates: [],
                            measurements: [],
                            records: {},
                            settings: { theme: 'light' }
                        };
                        render();
                        this.showNotification('Toutes les donn√©es ont √©t√© effac√©es');
                    }
                }
            },
            
           loadPredefinedExercises() {
                if (appState.exercises.length > 0) {
                    if (!confirm('Cela va ajouter les nouveaux exercices SmartWorkout (+ √©chauffement). Continuer ?')) {
                        return;
                    }
                }
                
                const predefinedExercises = [];
                
                // Exercices existants + nouveaux exercices d'√©chauffement
                Object.keys(PREDEFINED_EXERCISES).forEach(category => {
                    PREDEFINED_EXERCISES[category].forEach(ex => {
                        predefinedExercises.push({
                            id: Date.now() + Math.floor(Math.random() * 10000),
                            name: ex.name,
                            is_unilateral: ex.unilateral,
                            default_rest_time: category === 'echauffement' ? 30 : 90,
                            exercise_type: category === 'echauffement' ? 'bodyweight' : 'elastics',
                            anchor_point: ex.anchor,
                            muscle_group: category,
                            category: category === 'echauffement' ? 'warmup' : 'strength',
                            exercise_mode: ex.timeBase ? 'time' : 'reps',
                            default_duration: ex.timeBase ? 30 : null
                        });
                    });
                });
                
                let added = 0;
                predefinedExercises.forEach(newEx => {
                    const exists = appState.exercises.find(ex =>
                        ex.name === newEx.name && ex.muscle_group === newEx.muscle_group
                    );
                    if (!exists) {
                        appState.exercises.push(newEx);
                        added++;
                    }
                });
                
                this.saveData();
                render();
                this.showNotification(`${added} nouveaux exercices ajout√©s (dont ${PREDEFINED_EXERCISES.echauffement ? PREDEFINED_EXERCISES.echauffement.length : 0} d'√©chauffement) !`);
            },

            // Notifications
            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                // Style sp√©cial pendant les s√©ances live
                if (appState.liveSession) {
                    notification.classList.add('live-session');
                } else {
                    notification.classList.remove('live-session');
                }
                // R√©duire le temps pour les notifications de records pendant les s√©ances
                const duration = appState.liveSession ? 1500 : 3000;
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.remove('live-session');
                }, duration);
            },

            // === GESTION BASE DE DONN√âES EXERCICES ===
            toggleExerciseView() {
                appState.exerciseView = appState.exerciseView === 'grid' ? 'list' : 'grid';
                const toggleBtn = document.getElementById('view-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.innerHTML = appState.exerciseView === 'grid' ? 'üìã Vue Grille' : 'üî§ Vue Liste';
                }
                this.filterExerciseDatabase();
            },

            filterExerciseDatabase() {
                const searchTerm = document.getElementById('exercise-db-search')?.value.toLowerCase() || '';
                const muscleFilter = document.getElementById('muscle-filter')?.value || '';
                const difficultyFilter = document.getElementById('difficulty-filter')?.value || '';
                const anchorFilter = document.getElementById('anchor-filter')?.value || '';
                const tagsFilter = document.getElementById('tags-filter')?.value || '';
                const durationFilter = document.getElementById('duration-filter')?.value || '';
                const modeFilter = document.getElementById('mode-filter')?.value || '';
                const typeFilter = document.getElementById('type-filter')?.value || '';
                
                // Obtenir la liste des exercices √©tendus avec les donn√©es d'entra√Ænement
                const extendedExercises = this.getExtendedExerciseDatabase();
                
                // Filtrer les exercices
                let filteredExercises = extendedExercises.filter(exercise => {
                    // Filtre de recherche textuelle
                    const matchesSearch = !searchTerm || 
                        exercise.name.toLowerCase().includes(searchTerm) ||
                        exercise.muscle_group.toLowerCase().includes(searchTerm) ||
                        (exercise.tags && exercise.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
                    
                    // Filtre groupe musculaire
                    const matchesMuscle = !muscleFilter || exercise.muscle_group === muscleFilter;
                    
                    // Filtre difficult√©
                    const matchesDifficulty = !difficultyFilter || exercise.difficulty === difficultyFilter;
                    
                    // Filtre ancrage
                    const matchesAnchor = !anchorFilter || 
                        (anchorFilter === 'door' && exercise.anchor_point.includes('door')) ||
                        exercise.anchor_point === anchorFilter;
                    
                    // Filtre tags pr√©d√©finis
                    const matchesTags = !tagsFilter || (exercise.tags && exercise.tags.includes(tagsFilter));
                    
                    // Filtre dur√©e par d√©faut
                    const matchesDuration = !durationFilter || this.matchesDurationFilter(exercise, durationFilter);
                    
                    // Filtre mode d'ex√©cution
                    const matchesMode = !modeFilter || exercise.exercise_mode === modeFilter;
                    
                    // Filtre type (unilat√©ral/bilat√©ral)
                    const matchesType = !typeFilter || this.matchesTypeFilter(exercise, typeFilter);
                    
                    // Filtre tags personnalis√©s actifs
                    const matchesCustomTags = this.matchesCustomTagsFilter(exercise);
                    
                    return matchesSearch && matchesMuscle && matchesDifficulty && matchesAnchor && 
                        matchesTags && matchesDuration && matchesMode && matchesType && matchesCustomTags;
                });
                
                this.renderExerciseResults(filteredExercises);
            },

            matchesDurationFilter(exercise, filter) {
                const duration = exercise.default_duration || 30;
                switch(filter) {
                    case 'short': return duration <= 30;
                    case 'medium': return duration > 30 && duration <= 60;
                    case 'long': return duration > 60;
                    default: return true;
                }
            },

            matchesTypeFilter(exercise, filter) {
                switch(filter) {
                    case 'unilateral': return exercise.is_unilateral;
                    case 'bilateral': return !exercise.is_unilateral;
                    default: return true;
                }
            },

            matchesCustomTagsFilter(exercise) {
                if (!appState.activeCustomTagFilters || appState.activeCustomTagFilters.length === 0) {
                    return true;
                }
                
                const exerciseTags = appState.exerciseTags?.[exercise.id] || [];
                return appState.activeCustomTagFilters.every(tag => exerciseTags.includes(tag));
            },

            getExtendedExerciseDatabase() {
                // Combiner exercices personnalis√©s avec donn√©es enrichies
                return appState.exercises.map(exercise => {
                    const enrichedData = this.getExerciseEnrichedData(exercise);
                    return {
                        ...exercise,
                        ...enrichedData
                    };
                });
            },

            getExerciseEnrichedData(exercise) {
                // Base de donn√©es enrichie avec descriptions, instructions, etc.
                const enrichedDatabase = {
                    // === √âCHAUFFEMENT ===
                    'Jumping Jacks': {
                        difficulty: 'beginner',
                        description: 'Excellent exercice cardio pour √©chauffer tout le corps.',
                        instructions: [
                            'Debout, pieds joints, bras le long du corps',
                            'Sautez en √©cartant les pieds et montant les bras',
                            'Revenez √† la position initiale en sautant',
                            'Maintenez un rythme r√©gulier'
                        ],
                        tips: ['Gardez le dos droit', 'Respirez r√©guli√®rement', 'Atterrissez sur la pointe des pieds'],
                        commonMistakes: ['Rythme trop rapide', 'Mauvaise coordination', 'Dos rond'],
                        muscleGroups: { primary: ['Cardio'], secondary: ['Mollets', '√âpaules'] },
                        tags: ['√©chauffement', 'cardio', 'coordination'],
                        imageUrl: null
                    },

                    'Mont√©es de genoux': {
                        difficulty: 'beginner',
                        description: '√âchauffement dynamique pour les jambes et le cardio.',
                        instructions: [
                            'Debout, montez alternativement les genoux',
                            'Amenez les genoux au niveau de la taille',
                            'Gardez le dos droit',
                            'Bougez les bras naturellement'
                        ],
                        tips: ['Montez bien les genoux', 'Gardez l\'√©quilibre', 'Respirez r√©guli√®rement'],
                        commonMistakes: ['Genoux pas assez hauts', 'Se pencher vers l\'arri√®re', 'Rythme irr√©gulier'],
                        muscleGroups: { primary: ['Hip flexeurs'], secondary: ['Quadriceps', 'Core'] },
                        tags: ['√©chauffement', 'jambes', 'cardio'],
                        imageUrl: null
                    },

                    'Planche': {
                        difficulty: 'intermediate',
                        description: 'Exercice isom√©trique pour renforcer le core et la stabilit√©.',
                        instructions: [
                            'Position de pompes, appui sur les avant-bras',
                            'Corps align√© de la t√™te aux pieds',
                            'Contractez les abdominaux',
                            'Maintenez la position'
                        ],
                        tips: ['Ne creusez pas le dos', 'Respirez normalement', 'Regardez le sol'],
                        commonMistakes: ['Fesses trop hautes', 'Dos creus√©', 'Retenir sa respiration'],
                        muscleGroups: { primary: ['Core', 'Abdominaux'], secondary: ['√âpaules', 'Dos'] },
                        tags: ['gainage', 'core', 'isom√©trique'],
                        imageUrl: null
                    },

                    'Squats au poids du corps': {
                        difficulty: 'beginner',
                        description: 'Version de base du squat pour √©chauffer les jambes.',
                        instructions: [
                            'Pieds √©cart√©s largeur d\'√©paules',
                            'Descendez en poussant les hanches vers l\'arri√®re',
                            'Gardez le dos droit',
                            'Remontez en poussant sur les talons'
                        ],
                        tips: ['Genoux dans l\'axe des orteils', 'Descendez bien bas', 'Gardez la poitrine haute'],
                        commonMistakes: ['Genoux vers l\'int√©rieur', 'Dos rond', 'Pas assez profond'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers'] },
                        tags: ['√©chauffement', 'jambes', 'fonctionnel'],
                        imageUrl: null
                    },

                    'Burpees': {
                        difficulty: 'advanced',
                        description: 'Exercice intense combinant squat, planche et saut.',
                        instructions: [
                            'Squat, mains au sol',
                            'Jetez les pieds vers l\'arri√®re en planche',
                            'Ramenez les pieds sous le corps',
                            'Sautez verticalement bras tendus'
                        ],
                        tips: ['Mouvement fluide', 'Gardez le rythme', 'Respirez bien'],
                        commonMistakes: ['Sauter l\'√©tape planche', 'Mouvement saccad√©', 'Mauvaise respiration'],
                        muscleGroups: { primary: ['Corps entier'], secondary: [] },
                        tags: ['cardio', 'intense', 'fonctionnel'],
                        imageUrl: null
                    },

                    // === BICEPS ===
                    'Curl biceps': {
                        difficulty: 'beginner',
                        description: 'Exercice de base pour d√©velopper la masse et la force des biceps.',
                        instructions: [
                            'Placez-vous debout, pieds √©cart√©s largeur d\'√©paules',
                            'Tenez l\'√©lastique avec prise en supination',
                            'Gardez les coudes pr√®s du corps',
                            'Montez lentement en fl√©chissant les avant-bras',
                            'Revenez lentement √† la position de d√©part'
                        ],
                        tips: ['Gardez le dos droit', 'Contr√¥lez la descente', 'Ne balancez pas le corps'],
                        commonMistakes: ['Utiliser l\'√©lan', 'L√¢cher trop vite', '√âcarter les coudes'],
                        muscleGroups: { primary: ['Biceps brachial'], secondary: ['Avant-bras', 'Brachial ant√©rieur'] },
                        tags: ['isolation', 'bras', 'force', 'masse'],
                        imageUrl: null
                    },

                    'Curl biceps (poulie basse)': {
                        difficulty: 'beginner',
                        description: 'Variante du curl avec ancrage bas pour un angle diff√©rent.',
                        instructions: [
                            'Ancrez l\'√©lastique en bas',
                            'Tenez les poign√©es en supination',
                            'Fl√©chissez les avant-bras en gardant les coudes fixes',
                            'Contractez les biceps en haut',
                            'Redescendez lentement'
                        ],
                        tips: ['Gardez le torse stable', 'Focalisez sur la contraction', 'Amplitude compl√®te'],
                        commonMistakes: ['Se pencher vers l\'avant', 'Bouger les coudes', 'Rel√¢cher trop vite'],
                        muscleGroups: { primary: ['Biceps brachial'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'bras', 'ancrage bas'],
                        imageUrl: null
                    },

                    'Curl biceps face √† la porte': {
                        difficulty: 'beginner',
                        description: 'Curl biceps avec ancrage frontal pour une r√©sistance constante.',
                        instructions: [
                            'Ancrez l\'√©lastique √† hauteur moyenne',
                            'Face √† l\'ancrage, tenez les poign√©es',
                            'Reculez pour cr√©er de la tension',
                            'Fl√©chissez en ramenant vers vous',
                            'Contr√¥lez le retour'
                        ],
                        tips: ['Gardez les coudes stables', 'Reculez suffisamment', 'Mouvement contr√¥l√©'],
                        commonMistakes: ['Trop proche de l\'ancrage', 'Coudes qui bougent', 'Mouvement saccad√©'],
                        muscleGroups: { primary: ['Biceps'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'biceps', 'ancrage frontal'],
                        imageUrl: null
                    },

                    'Curl marteau': {
                        difficulty: 'beginner',
                        description: 'Variante ciblant davantage le brachial et les avant-bras.',
                        instructions: [
                            'Prise neutre (pouces vers le haut)',
                            'Gardez les coudes pr√®s du corps',
                            'Montez en gardant la prise neutre',
                            'Contractez en haut',
                            'Descendez lentement'
                        ],
                        tips: ['Prise ferme', 'Coudes fixes', 'Contr√¥lez bien la descente'],
                        commonMistakes: ['Tourner les poignets', 'Bouger les coudes', 'Mouvement trop rapide'],
                        muscleGroups: { primary: ['Brachial', 'Biceps'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'bras', 'avant-bras'],
                        imageUrl: null
                    },

                    // === TRICEPS ===
                    'Extension triceps (poulie haute)': {
                        difficulty: 'beginner',
                        description: 'Exercice d\'isolation classique pour d√©velopper les triceps.',
                        instructions: [
                            'Ancrez l\'√©lastique en haut',
                            'Tenez les poign√©es, coudes pr√®s du corps',
                            '√âtendez les avant-bras vers le bas',
                            'Contractez les triceps en bas',
                            'Remontez lentement'
                        ],
                        tips: ['Gardez les coudes fixes', 'Mouvement des avant-bras uniquement', 'Contractez fort en bas'],
                        commonMistakes: ['Bouger les coudes', 'Utiliser le dos', 'Mouvement partiel'],
                        muscleGroups: { primary: ['Triceps'], secondary: ['Delto√Ødes ant√©rieurs'] },
                        tags: ['isolation', 'triceps', 'bras'],
                        imageUrl: null
                    },

                    'Extension triceps verticale': {
                        difficulty: 'intermediate',
                        description: 'Extension triceps au-dessus de la t√™te pour √©tirer le muscle.',
                        instructions: [
                            '√âlastique derri√®re le dos, une main en haut',
                            '√âtendez le bras vers le haut',
                            'Gardez le coude pr√®s de l\'oreille',
                            'Descendez lentement',
                            'Alternez les bras'
                        ],
                        tips: ['Coude pr√®s de la t√™te', 'Mouvement contr√¥l√©', 'Bon √©tirement en bas'],
                        commonMistakes: ['Coude qui part sur le c√¥t√©', 'Mouvement trop rapide', 'Mauvaise position'],
                        muscleGroups: { primary: ['Triceps (chef long)'], secondary: [] },
                        tags: ['isolation', 'triceps', '√©tirement'],
                        imageUrl: null
                    },

                    'Kickback triceps': {
                        difficulty: 'intermediate',
                        description: 'Isolation des triceps en position pench√©e.',
                        instructions: [
                            'Penchez-vous vers l\'avant, coude fixe',
                            '√âtendez l\'avant-bras vers l\'arri√®re',
                            'Gardez le bras parall√®le au sol',
                            'Contractez en fin de mouvement',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le coude fixe', 'Bras parall√®le au sol', 'Contraction forte'],
                        commonMistakes: ['Bouger le coude', 'Bras qui descend', 'Utiliser l\'√©lan'],
                        muscleGroups: { primary: ['Triceps'], secondary: [] },
                        tags: ['isolation', 'triceps', 'unilat√©ral'],
                        imageUrl: null
                    },

                    // === √âPAULES ===
                    '√âl√©vations lat√©rales': {
                        difficulty: 'beginner',
                        description: 'Exercice d\'isolation pour d√©velopper la largeur des √©paules.',
                        instructions: [
                            'Placez l\'√©lastique sous vos pieds',
                            'Tenez les poign√©es le long du corps',
                            '√âlevez les bras sur les c√¥t√©s jusqu\'√† l\'horizontale',
                            'Maintenez 1 seconde en haut',
                            'Redescendez lentement'
                        ],
                        tips: ['L√©g√®re flexion des coudes', 'Pas plus haut que les √©paules', 'Contr√¥lez la descente'],
                        commonMistakes: ['Monter trop haut', 'Utiliser l\'√©lan', 'Bras tendus', 'Pencher le torse'],
                        muscleGroups: { primary: ['Delto√Øde moyen'], secondary: ['Delto√Øde ant√©rieur', 'Trap√®zes'] },
                        tags: ['isolation', '√©paules', 'largeur'],
                        imageUrl: null
                    },

                    '√âl√©vations frontales': {
                        difficulty: 'beginner',
                        description: 'Isolation du delto√Øde ant√©rieur.',
                        instructions: [
                            '√âlastique sous les pieds',
                            'Levez un bras devant vous',
                            'Montez jusqu\'√† la hauteur des √©paules',
                            'Descendez lentement',
                            'Alternez les bras'
                        ],
                        tips: ['Pas plus haut que les √©paules', 'Mouvement contr√¥l√©', 'Gardez le torse stable'],
                        commonMistakes: ['Monter trop haut', 'Utiliser l\'√©lan', 'Pencher en arri√®re'],
                        muscleGroups: { primary: ['Delto√Øde ant√©rieur'], secondary: ['Core'] },
                        tags: ['isolation', '√©paules', 'avant'],
                        imageUrl: null
                    },

                    'D√©velopp√© militaire assis': {
                        difficulty: 'intermediate',
                        description: 'D√©velopp√© pour les √©paules en position assise.',
                        instructions: [
                            'Assis, √©lastique sous les pieds',
                            'Tenez les poign√©es √† hauteur d\'√©paules',
                            'Poussez vers le haut',
                            '√âtendez compl√®tement les bras',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le dos droit', 'Pouss√©e verticale', 'Extension compl√®te'],
                        commonMistakes: ['Dos rond', 'Pouss√©e vers l\'avant', 'Mouvement partiel'],
                        muscleGroups: { primary: ['Delto√Ødes'], secondary: ['Triceps', 'Trap√®zes'] },
                        tags: ['compos√©', '√©paules', 'force'],
                        imageUrl: null
                    },

                    'Oiseau': {
                        difficulty: 'intermediate',
                        description: 'Excellent pour les delto√Ødes post√©rieurs et la posture.',
                        instructions: [
                            'Ancrage √† hauteur de poitrine',
                            'Bras tendus devant vous',
                            '√âcartez les bras sur les c√¥t√©s',
                            'Contractez les omoplates',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez les bras tendus', 'Contractez les omoplates', 'Mouvement lent'],
                        commonMistakes: ['Plier les bras', 'Utiliser le dos', 'Mouvement trop rapide'],
                        muscleGroups: { primary: ['Delto√Ødes post√©rieurs'], secondary: ['Rhombo√Ødes', 'Trap√®zes'] },
                        tags: ['isolation', '√©paules', 'posture'],
                        imageUrl: null
                    },

                    // === DOS ===
                    'Face Pull': {
                        difficulty: 'intermediate',
                        description: 'Excellent exercice pour les delto√Ødes post√©rieurs et la posture.',
                        instructions: [
                            'Ancrez l\'√©lastique √† hauteur d\'√©paules',
                            'Tenez les poign√©es, bras tendus',
                            'Tirez vers votre visage en √©cartant les coudes',
                            'Contractez les omoplates',
                            'Revenez lentement'
                        ],
                        tips: ['Coudes hauts', 'Contractez le haut du dos', 'Mouvement contr√¥l√©'],
                        commonMistakes: ['Coudes qui descendent', 'Tirer vers le bas', 'Mouvement rapide'],
                        muscleGroups: { primary: ['Delto√Ødes post√©rieurs', 'Rhombo√Ødes'], secondary: ['Trap√®zes'] },
                        tags: ['isolation', 'dos', 'posture'],
                        imageUrl: null
                    },

                    'Tirage horizontal unilat√©ral': {
                        difficulty: 'intermediate',
                        description: 'Tirage horizontal pour d√©velopper l\'√©paisseur du dos.',
                        instructions: [
                            'Ancrage √† hauteur de poitrine',
                            'Un bras tendu devant vous',
                            'Tirez le coude vers l\'arri√®re',
                            'Contractez le dos',
                            'Alternez les bras'
                        ],
                        tips: ['Coude pr√®s du corps', 'Contractez le dos', 'Mouvement contr√¥l√©'],
                        commonMistakes: ['Tirer avec le bras', 'Coude qui s\'√©carte', 'Rotation du torse'],
                        muscleGroups: { primary: ['Grand dorsal', 'Rhombo√Ødes'], secondary: ['Biceps'] },
                        tags: ['unilat√©ral', 'dos', '√©paisseur'],
                        imageUrl: null
                    },

                    'Tirage vertical': {
                        difficulty: 'intermediate',
                        description: 'Simulation de tractions pour la largeur du dos.',
                        instructions: [
                            'Ancrez l\'√©lastique en haut',
                            'Bras tendus au-dessus de la t√™te',
                            'Tirez les coudes vers les c√¥tes',
                            'Contractez le dos',
                            'Remontez lentement'
                        ],
                        tips: ['Penchez-vous l√©g√®rement', 'Contractez les dorsaux', 'Tirez avec le dos'],
                        commonMistakes: ['Tirer avec les bras', 'Pas assez pench√©', 'Mouvement rapide'],
                        muscleGroups: { primary: ['Grand dorsal'], secondary: ['Biceps', 'Rhombo√Ødes'] },
                        tags: ['compos√©', 'dos', 'largeur'],
                        imageUrl: null
                    },

                    'Rowing buste pench√©': {
                        difficulty: 'intermediate',
                        description: 'Exercice de base pour l\'√©paisseur du dos.',
                        instructions: [
                            '√âlastique sous les pieds',
                            'Penchez le buste vers l\'avant',
                            'Tirez les coudes vers l\'arri√®re',
                            'Contractez les omoplates',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le dos droit', 'Contractez les omoplates', 'Coudes pr√®s du corps'],
                        commonMistakes: ['Dos rond', 'Tirer avec les bras', 'Se redresser'],
                        muscleGroups: { primary: ['Grand dorsal', 'Rhombo√Ødes'], secondary: ['Biceps', 'Trap√®zes'] },
                        tags: ['compos√©', 'dos', 'force'],
                        imageUrl: null
                    },

                    // === PECTORAUX ===
                    'D√©velopp√© debout (poulie moyenne)': {
                        difficulty: 'intermediate',
                        description: 'D√©velopp√© pour les pectoraux en position debout.',
                        instructions: [
                            'Ancrage √† hauteur de poitrine',
                            'Dos √† l\'ancrage, poign√©es en main',
                            'Poussez devant vous',
                            'Contractez les pectoraux',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le dos droit', 'Contractez les pectoraux', 'Mouvement fluide'],
                        commonMistakes: ['Pencher vers l\'avant', 'Mouvement rapide', 'Pas de contraction'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Delto√Ødes ant√©rieurs', 'Triceps'] },
                        tags: ['compos√©', 'pectoraux', 'pouss√©e'],
                        imageUrl: null
                    },

                    'D√©velopp√© inclin√©': {
                        difficulty: 'intermediate',
                        description: 'Variante inclin√©e pour cibler le haut des pectoraux.',
                        instructions: [
                            'Ancrage en bas',
                            'Poussez vers le haut et l\'avant',
                            'Angle de 45 degr√©s',
                            'Contractez le haut des pectoraux',
                            'Revenez contr√¥l√©'
                        ],
                        tips: ['Bon angle de pouss√©e', 'Contractez le haut', 'Mouvement contr√¥l√©'],
                        commonMistakes: ['Mauvais angle', 'Mouvement trop rapide', 'Pas de contraction'],
                        muscleGroups: { primary: ['Pectoraux (partie haute)'], secondary: ['Delto√Ødes', 'Triceps'] },
                        tags: ['compos√©', 'pectoraux', 'inclin√©'],
                        imageUrl: null
                    },

                    '√âcart√© unilat√©ral': {
                        difficulty: 'intermediate',
                        description: 'Isolation des pectoraux avec √©tirement.',
                        instructions: [
                            'Ancrage √† hauteur de poitrine',
                            'Bras tendu sur le c√¥t√©',
                            'Ramenez le bras devant la poitrine',
                            'Contractez le pectoral',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le bras tendu', 'Bon √©tirement', 'Contraction forte'],
                        commonMistakes: ['Plier le bras', 'Pas assez d\'√©tirement', 'Mouvement rapide'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: [] },
                        tags: ['isolation', 'pectoraux', '√©tirement'],
                        imageUrl: null
                    },

                    'Pompes lest√©es': {
                        difficulty: 'advanced',
                        description: 'Pompes avec r√©sistance √©lastique pour plus de difficult√©.',
                        instructions: [
                            'Position de pompes, √©lastique sur le dos',
                            'Tenez les extr√©mit√©s sous les mains',
                            'Effectuez des pompes normales',
                            'La r√©sistance augmente en montant',
                            'Descendez lentement'
                        ],
                        tips: ['Gardez le corps align√©', 'R√©sistance progressive', 'Mouvement complet'],
                        commonMistakes: ['Corps mal align√©', 'Mouvement partiel', 'Trop de r√©sistance'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Triceps', 'Delto√Ødes', 'Core'] },
                        tags: ['compos√©', 'pectoraux', 'avanc√©'],
                        imageUrl: null
                    },

                    // === JAMBES ===
                    'Squat': {
                        difficulty: 'beginner',
                        description: 'Exercice roi pour les jambes et les fessiers.',
                        instructions: [
                            '√âlastique sous les pieds',
                            'Pieds √©cart√©s largeur d\'√©paules',
                            'Descendez en poussant les hanches arri√®re',
                            'Gardez le dos droit',
                            'Remontez en poussant sur les talons'
                        ],
                        tips: ['Genoux dans l\'axe', 'Descendez bien bas', 'Gardez la poitrine haute'],
                        commonMistakes: ['Genoux vers l\'int√©rieur', 'Dos rond', 'Pas assez profond'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers', 'Mollets'] },
                        tags: ['compos√©', 'jambes', 'force', 'fonctionnel'],
                        imageUrl: null
                    },

                    'Front squat': {
                        difficulty: 'intermediate',
                        description: 'Squat avec r√©sistance frontale, plus difficile.',
                        instructions: [
                            '√âlastique sous les pieds',
                            'Tenez les poign√©es devant les √©paules',
                            'Squat normal en gardant les coudes hauts',
                            'R√©sistance frontale constante',
                            'Remontez en poussant les talons'
                        ],
                        tips: ['Coudes hauts', 'Gardez le torse droit', 'R√©sistance constante'],
                        commonMistakes: ['Coudes qui descendent', 'Pencher vers l\'avant', 'Mauvaise posture'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Core', 'Ischio-jambiers'] },
                        tags: ['compos√©', 'jambes', 'core'],
                        imageUrl: null
                    },

                    'Fentes': {
                        difficulty: 'intermediate',
                        description: 'Exercice unilat√©ral pour jambes et √©quilibre.',
                        instructions: [
                            '√âlastique sous le pied avant',
                            'Grand pas en arri√®re',
                            'Descendez en fl√©chissant les genoux',
                            'Genou arri√®re fr√¥le le sol',
                            'Remontez sur le pied avant'
                        ],
                        tips: ['Gardez le torse droit', 'Poids sur le pied avant', 'Descendez bien bas'],
                        commonMistakes: ['Pas assez grand', 'Pencher avant', 'Pas assez bas'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers', 'Core'] },
                        tags: ['unilat√©ral', 'jambes', '√©quilibre'],
                        imageUrl: null
                    },

                    'Hip thrust': {
                        difficulty: 'intermediate',
                        description: 'Excellent pour d√©velopper les fessiers.',
                        instructions: [
                            'Allong√©, √©lastique sur les hanches',
                            'Pieds au sol, genoux fl√©chis',
                            'Poussez les hanches vers le haut',
                            'Contractez les fessiers en haut',
                            'Redescendez lentement'
                        ],
                        tips: ['Contractez fort les fessiers', 'Gardez le dos droit', 'Pouss√©e vers le haut'],
                        commonMistakes: ['Pousser avec le dos', 'Pas de contraction', 'Mouvement partiel'],
                        muscleGroups: { primary: ['Fessiers'], secondary: ['Ischio-jambiers', 'Core'] },
                        tags: ['isolation', 'fessiers', 'force'],
                        imageUrl: null
                    },

                    'Soulev√© de terre': {
                        difficulty: 'intermediate',
                        description: 'Mouvement de charni√®re de hanche fondamental.',
                        instructions: [
                            '√âlastique sous les pieds',
                            'Penchez-vous en poussant les hanches arri√®re',
                            'Gardez le dos droit',
                            'Tirez en contractant les fessiers',
                            'Revenez debout'
                        ],
                        tips: ['Charni√®re de hanche', 'Dos droit', 'Contractez les fessiers'],
                        commonMistakes: ['Dos rond', 'Plier les genoux', 'Pas de pouss√©e de hanches'],
                        muscleGroups: { primary: ['Fessiers', 'Ischio-jambiers'], secondary: ['Dos', 'Trap√®zes'] },
                        tags: ['compos√©', 'cha√Æne post√©rieure', 'force'],
                        imageUrl: null
                    },

                    // Ajoutez plus d'exercices selon vos besoins...
                };
                
                // Donn√©es par d√©faut pour exercices non r√©f√©renc√©s
                const defaultData = {
                    difficulty: 'beginner',
                    description: 'Exercice avec √©lastiques SmartWorkout. Consultez votre guide pour plus de d√©tails.',
                    instructions: [
                        'Pr√©parez votre √©lastique selon la r√©sistance d√©sir√©e',
                        'Adoptez une position stable et s√©curis√©e',
                        'Effectuez le mouvement de mani√®re contr√¥l√©e',
                        'Respirez correctement pendant l\'exercice'
                    ],
                    tips: [
                        'Commencez avec une r√©sistance l√©g√®re',
                        'Augmentez progressivement la difficult√©',
                        'Maintenez une bonne technique'
                    ],
                    commonMistakes: [
                        'R√©sistance trop importante au d√©but',
                        'Mouvements trop rapides',
                        'Mauvaise position de d√©part'
                    ],
                    muscleGroups: {
                        primary: [exercise.muscle_group || 'Non d√©fini'],
                        secondary: []
                    },
                    tags: ['elastique', exercise.muscle_group || 'general'],
                    imageUrl: null
                };
                
                return enrichedDatabase[exercise.name] || defaultData;
            },

            renderExerciseResults(exercises) {
                const resultsContainer = document.getElementById('exercise-database-results');
            
                if (exercises.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="card">
                            <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                                üîç Aucun exercice trouv√© avec ces crit√®res
                            </p>
                        </div>
                    `;
                    return;
                }
            
                // En-t√™te avec compteur
                let html = `
                    <div class="card">
                        <h3>üìã ${exercises.length} exercice${exercises.length > 1 ? 's' : ''} trouv√©${exercises.length > 1 ? 's' : ''}</h3>
                    </div>
                `;
            
                if (appState.exerciseView === 'grid') {
                    // Vue grille - cartes compactes
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">';
                    
                    exercises.forEach(exercise => {
                        const difficultyColor = {
                            'beginner': '#34C759',
                            'intermediate': '#FF9500', 
                            'advanced': '#FF3B30'
                        };
                    
                        const difficultyLabel = {
                            'beginner': 'üü¢ D√©butant',
                            'intermediate': 'üü° Interm√©diaire',
                            'advanced': 'üî¥ Confirm√©'
                        };
                    
                        html += `
                            <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="actions.showExerciseDetails(${exercise.id})">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <h4 style="margin: 0; flex: 1;">${exercise.name}</h4>
                                    <span style="background: ${difficultyColor[exercise.difficulty]}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; white-space: nowrap;">
                                        ${difficultyLabel[exercise.difficulty]}
                                    </span>
                                </div>
                            
                                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                                    ${exercise.description.substring(0, 100)}...
                                </div>
                            
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
                                    <span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">
                                        ${exercise.muscle_group}
                                    </span>
                                    ${exercise.is_unilateral ? '<span style="background: var(--warning); color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">Unilat√©ral</span>' : ''}
                                    ${exercise.tags.slice(0, 2).map(tag => 
                                        `<span style="background: var(--border); color: var(--text-secondary); padding: 2px 6px; border-radius: 8px; font-size: 11px;">${tag}</span>`
                                    ).join('')}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-secondary);">
                                    <span>üëÜ Cliquer pour d√©tails</span>
                                    <span>${exercise.muscleGroups.primary.length} muscles cibl√©s</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    // Vue liste - format compact
                    exercises.forEach(exercise => {
                        const difficultyIcon = {
                            'beginner': 'üü¢',
                            'intermediate': 'üü°',
                            'advanced': 'üî¥'
                        };
                    
                        html += `
                            <div class="exercise-item" style="cursor: pointer;" onclick="actions.showExerciseDetails(${exercise.id})">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <strong>${exercise.name}</strong>
                                        <span>${difficultyIcon[exercise.difficulty]}</span>
                                        <span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;">
                                            ${exercise.muscle_group}
                                        </span>
                                    </div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">
                                        ${exercise.description.substring(0, 120)}...
                                    </div>
                                </div>
                                <div style="font-size: 20px; color: var(--primary);">üëÜ</div>
                            </div>
                        `;
                    });
                }
                
                resultsContainer.innerHTML = html;
            },

            clearExerciseFilters() {
                document.getElementById('exercise-db-search').value = '';
                document.getElementById('muscle-filter').value = '';
                document.getElementById('difficulty-filter').value = '';
                document.getElementById('anchor-filter').value = '';
                document.getElementById('tags-filter').value = '';
                
                // Nettoyer les filtres avanc√©s
                if (document.getElementById('duration-filter')) {
                    document.getElementById('duration-filter').value = '';
                }
                if (document.getElementById('mode-filter')) {
                    document.getElementById('mode-filter').value = '';
                }
                if (document.getElementById('type-filter')) {
                    document.getElementById('type-filter').value = '';
                }
                
                // Nettoyer les tags personnalis√©s actifs
                appState.activeCustomTagFilters = [];
                this.updateCustomTagFiltersDisplay();
                
                this.filterExerciseDatabase();
                this.showNotification('üóëÔ∏è Tous les filtres effac√©s');
            },

            showExerciseFavorites() {
                if (!appState.exerciseFavorites || appState.exerciseFavorites.length === 0) {
                    this.showNotification('‚≠ê Aucun exercice en favoris pour le moment');
                    return;
                }
                
                // Filtrer pour afficher seulement les favoris
                const favoriteExercises = appState.exercises.filter(ex => 
                    appState.exerciseFavorites.includes(ex.id)
                );
                
                const extendedFavorites = favoriteExercises.map(exercise => {
                    const enrichedData = this.getExerciseEnrichedData(exercise);
                    return { ...exercise, ...enrichedData };
                });
                
                this.renderExerciseResults(extendedFavorites);
                this.showNotification(`‚≠ê ${favoriteExercises.length} exercice(s) favori(s) affich√©(s)`);
            },

            showExerciseDetails(exerciseId) {
                // Recharger l'exercice depuis les donn√©es sauvegard√©es pour avoir les derni√®res infos
                this.loadData();
                
                const exercise = appState.exercises.find(e => e.id === exerciseId);
                if (!exercise) {
                    this.showNotification('Exercice introuvable');
                    return;
                }

                console.log('üîç Exercice √† afficher:', exercise.name, 'MediaId:', exercise.mediaId);

                const enrichedData = this.getExerciseEnrichedData(exercise);
                const fullExercise = { ...exercise, ...enrichedData };

                // Obtenir les statistiques de l'exercice
                const stats = this.getExerciseStats(exerciseId);

                // V√©rifier si c'est un favori
                const isFavorite = this.isExerciseFavorite(exerciseId);

                // Construire le contenu du modal
                const content = this.generateExerciseDetailsHTML(fullExercise, stats, isFavorite);

                // Afficher le modal
                document.getElementById('exercise-details-title').textContent = fullExercise.name;
                document.getElementById('exercise-details-content').innerHTML = content;
                document.getElementById('exercise-details-modal').classList.add('active');
            },

            generateExerciseDetailsHTML(exercise, stats, isFavorite) {
                const difficultyClass = `difficulty-${exercise.difficulty}`;
                const difficultyLabel = {
                    'beginner': 'üü¢ D√©butant',
                    'intermediate': 'üü° Interm√©diaire', 
                    'advanced': 'üî¥ Confirm√©'
                };

                const anchorText = {
                    'none': 'üèÉ Sans ancrage (√©lastique libre)',
                    'door-middle': 'üö™ Porte - hauteur moyenne',
                    'door-high': 'üö™‚¨ÜÔ∏è Porte - position haute',
                    'door-low': 'üö™‚¨áÔ∏è Porte - position basse',
                    'floor': 'ü¶µ Sol/Pieds (marcher dessus)',
                    'body': 'üîÑ Corps (√©lastique autour)',
                    'external': 'üå≥ Ancrage ext√©rieur'
                };

                return `
                    <!-- En-t√™te avec image et infos principales -->
                    <div class="exercise-details-section" style="position: relative;">
                        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="actions.toggleExerciseFavorite(${exercise.id})" title="${isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                            ${isFavorite ? '‚≠ê' : '‚òÜ'}
                        </button>
                    
                        <div class="image-placeholder">
                            ${this.debugExerciseMedia(exercise)}
                        </div>

                        <div style="margin-top: 16px;">
                            <div class="difficulty-badge ${difficultyClass}">
                                ${difficultyLabel[exercise.difficulty]}
                            </div>
                            
                            <p style="font-size: 16px; margin: 16px 0; line-height: 1.6;">
                                ${exercise.description}
                            </p>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 16px 0;">
                                <div>
                                    <strong>üéØ Type :</strong> ${exercise.is_unilateral ? 'Unilat√©ral' : 'Bilat√©ral'}
                                </div>
                                <div>
                                    <strong>‚öì Ancrage :</strong> ${anchorText[exercise.anchor_point] || 'Non d√©fini'}
                                </div>
                                <div>
                                    <strong>‚è±Ô∏è Mode :</strong> ${exercise.exercise_mode === 'time' ? 'Temps' : exercise.exercise_mode === 'both' ? 'Temps ou R√©p√©titions' : 'R√©p√©titions'}
                                </div>
                                <div>
                                    <strong>üò¥ Repos :</strong> ${exercise.default_rest_time}s
                                </div>
                            </div>

                            <!-- Tags -->
                            <div style="margin: 16px 0;">
                                ${exercise.tags.map(tag => 
                                    `<span style="background: var(--primary); color: white; padding: 4px 8px; margin: 2px; border-radius: 12px; font-size: 12px; display: inline-block;">${tag}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques personnelles -->
                    ${stats.totalSessions > 0 ? `
                        <div class="exercise-details-section">
                            <h4>üìä Vos statistiques</h4>
                            <div class="exercise-stats">
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.totalSessions}</div>
                                    <div class="exercise-stat-label">S√©ances</div>
                                </div>
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.totalSets}</div>
                                    <div class="exercise-stat-label">S√©ries</div>
                                </div>
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.maxWeight}kg</div>
                                    <div class="exercise-stat-label">Poids Max</div>
                                </div>
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.lastSession}</div>
                                    <div class="exercise-stat-label">Derni√®re fois</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Muscles cibl√©s -->
                    <div class="exercise-details-section">
                        <h4>üéØ Muscles cibl√©s</h4>
                        
                        <!-- Tags textuels -->
                        <div style="margin: 12px 0;">
                            <strong>Muscles principaux :</strong><br>
                            ${exercise.muscleGroups.primary.map(muscle => 
                                `<span class="muscle-tag muscle-primary">${muscle}</span>`
                            ).join('')}
                        </div>
                        ${exercise.muscleGroups.secondary.length > 0 ? `
                            <div style="margin: 12px 0;">
                                <strong>Muscles secondaires :</strong><br>
                                ${exercise.muscleGroups.secondary.map(muscle => 
                                    `<span class="muscle-tag muscle-secondary">${muscle}</span>`
                                ).join('')}
                            </div>
                        ` : ''}

                        <!-- Sch√©mas anatomiques interactifs -->
                        <div style="margin: 20px 0;">
                            ${this.generateAnatomyDiagram(exercise)}
                        </div>
                    </div>

                    <!-- Instructions d√©taill√©es -->
                    <div class="exercise-details-section">
                        <h4>üìã Instructions pas-√†-pas</h4>
                        ${exercise.instructions.map((instruction, index) => `
                            <div class="instruction-step">
                                <div class="step-number">${index + 1}</div>
                                <div style="flex: 1;">${instruction}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Conseils d'ex√©cution -->
                    <div class="exercise-details-section">
                        <h4>üí° Conseils d'ex√©cution</h4>
                        ${exercise.tips.map(tip => `
                            <div class="tip-item">
                                <div style="color: #34C759; font-size: 14px;">‚úì</div>
                                <div style="flex: 1;">${tip}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Erreurs communes -->
                    <div class="exercise-details-section">
                        <h4>‚ö†Ô∏è Erreurs communes √† √©viter</h4>
                        ${exercise.commonMistakes.map(mistake => `
                            <div class="mistake-item">
                                <div style="color: #FF3B30; font-size: 14px;">‚úó</div>
                                <div style="flex: 1;">${mistake}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Recommandations de r√©sistance -->
                    ${this.hasResistanceRecommendations(exercise.name) ? `
                        <div class="exercise-details-section">
                            <h4>üí™ Recommandations de r√©sistance</h4>
                            ${generateResistanceRecommendations(exercise.name)}
                        </div>
                    ` : ''}

                    <!-- Actions -->
                    <div class="exercise-details-section">
                        <h4>üöÄ Actions</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button class="btn btn-primary" onclick="actions.addExerciseToCurrentSession(${exercise.id})">
                                ‚ûï Ajouter √† la s√©ance
                            </button>
                            <button class="btn btn-secondary" onclick="actions.viewExerciseHistory(${exercise.id})">
                                üìä Voir l'historique
                            </button>
                            <button class="btn btn-secondary" onclick="actions.goToEditExercise(${exercise.id})">
                                ‚úèÔ∏è Modifier l'exercice
                            </button>
                            <button class="btn btn-secondary" onclick="actions.shareExercise(${exercise.id})">
                                üîó Partager
                            </button>
                        </div>
                    </div>
                `;
            },

            getExerciseStats(exerciseId) {
                let totalSessions = 0;
                let totalSets = 0;
                let maxWeight = 0;
                let lastSessionDate = null;

                appState.sessions.forEach(session => {
                    const exerciseData = session.exercises.find(ex => ex.exercise_id === exerciseId);
                    if (exerciseData && exerciseData.sets.length > 0) {
                        totalSessions++;
                        totalSets += exerciseData.sets.length;
                        lastSessionDate = session.date;
                    
                        exerciseData.sets.forEach(set => {
                            const resistance = set.total_resistance || 0;
                            if (resistance > maxWeight) {
                                maxWeight = resistance;
                            }
                        });
                    }
                });

                const lastSession = lastSessionDate ? 
                    new Date(lastSessionDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : 
                    'Jamais';

                return {
                    totalSessions,
                    totalSets,
                    maxWeight,
                    lastSession
                };
            },

            hasResistanceRecommendations(exerciseName) {
                return RESISTANCE_RECOMMENDATIONS.hasOwnProperty(exerciseName);
            },

            // Gestion des favoris
            isExerciseFavorite(exerciseId) {
                if (!appState.exerciseFavorites) {
                    appState.exerciseFavorites = [];
                }
                return appState.exerciseFavorites.includes(exerciseId);
            },

            toggleExerciseFavorite(exerciseId) {
                if (!appState.exerciseFavorites) {
                    appState.exerciseFavorites = [];
                }
                
                const index = appState.exerciseFavorites.indexOf(exerciseId);
                if (index === -1) {
                    appState.exerciseFavorites.push(exerciseId);
                    this.showNotification('‚≠ê Ajout√© aux favoris !');
                } else {
                    appState.exerciseFavorites.splice(index, 1);
                    this.showNotification('‚òÜ Retir√© des favoris');
                }
                
                this.saveData();
                
                // Mettre √† jour le bouton si le modal est ouvert
                const favoriteBtn = document.querySelector('.favorite-btn');
                if (favoriteBtn) {
                    const isFavorite = this.isExerciseFavorite(exerciseId);
                    favoriteBtn.classList.toggle('active', isFavorite);
                    favoriteBtn.innerHTML = isFavorite ? '‚≠ê' : '‚òÜ';
                    favoriteBtn.title = isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris';
                }
            },

            addExerciseToCurrentSession(exerciseId) {
                if (!appState.currentSession) {
                    if (confirm('Aucune s√©ance en cours. Voulez-vous cr√©er une nouvelle s√©ance ?')) {
                        this.startNewSession();
                    } else {
                        return;
                    }
                }

                const exercise = appState.exercises.find(e => e.id === exerciseId);
                const exists = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                
                if (exists) {
                    this.showNotification('Cet exercice est d√©j√† dans la s√©ance en cours');
                    return;
                }

                appState.currentSession.exercises.push({
                    exercise_id: exerciseId,
                    planned_sets: 3,
                    rest_time: exercise.default_rest_time || 90,
                    duration: exercise.default_duration || 30,
                    sets: []
                });

                this.closeModal('exercise-details-modal');
                this.showScreen('preparation');
                this.showNotification(`"${exercise.name}" ajout√© √† la s√©ance !`);
            },

            viewExerciseHistory(exerciseId) {
                // Aller aux stats avec cet exercice s√©lectionn√©
                this.closeModal('exercise-details-modal');
                this.showScreen('stats');
                
                // S√©lectionner l'exercice dans le dropdown
                setTimeout(() => {
                    const select = document.getElementById('stats-exercise-select');
                    if (select) {
                        select.value = exerciseId;
                        this.updateStats(exerciseId);
                    }
                }, 100);
            },

            shareExercise(exerciseId) {
                const exercise = appState.exercises.find(e => e.id === exerciseId);
                const enrichedData = this.getExerciseEnrichedData(exercise);
                
                const shareText = `üí™ ${exercise.name}\n\nüìù ${enrichedData.description}\n\nüéØ Muscles: ${enrichedData.muscleGroups.primary.join(', ')}\n\nD√©couvrez SmartTrack pour vos entra√Ænements !`;
                
                if (navigator.share) {
                    navigator.share({
                        title: `Exercice: ${exercise.name}`,
                        text: shareText
                    });
                } else if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareText);
                    this.showNotification('üìã Informations copi√©es dans le presse-papier !');
                } else {
                    this.showNotification('Partage non support√© sur cet appareil');
                }
            },

            goToEditExercise(exerciseId) {
                this.closeModal('exercise-details-modal');
                this.showScreen('exercises');
                
                // Attendre que l'√©cran soit charg√© puis √©diter
                setTimeout(() => {
                    this.editExercise(exerciseId);
                }, 100);
            },

            // === GESTION DES M√âDIAS ===
            handleExerciseMediaUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // V√©rifications de base
                if (!this.validateMediaFile(file)) {
                    return;
                }

                this.processMediaFile(file, (optimizedFile, preview) => {
                    // Stocker temporairement pour l'exercice en cours d'√©dition
                    appState.currentExerciseMedia = {
                        file: optimizedFile,
                        preview: preview,
                        name: file.name,
                        size: optimizedFile.size
                    };

                    this.showMediaPreview(preview, file.name, optimizedFile.size);
                });
            },

            validateMediaFile(file) {
                const maxSize = 5 * 1024 * 1024; // 5MB avant compression
                const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];

                if (!allowedTypes.includes(file.type)) {
                    this.showNotification('‚ùå Format non support√©. Utilisez JPG, PNG, WebP ou GIF');
                    return false;
                }

                if (file.size > maxSize) {
                    this.showNotification('‚ùå Fichier trop volumineux. Maximum 5MB avant compression');
                    return false;
                }

                return true;
            },

            processMediaFile(file, callback) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    // Redimensionner vers 400x300
                    const targetWidth = 400;
                    const targetHeight = 300;
                    
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;

                    // Calculer le ratio pour conserver les proportions
                    const ratio = Math.min(targetWidth / img.width, targetHeight / img.height);
                    const width = img.width * ratio;
                    const height = img.height * ratio;
                    
                    // Centrer l'image
                    const x = (targetWidth - width) / 2;
                    const y = (targetHeight - height) / 2;

                    // Fond blanc si n√©cessaire
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, targetWidth, targetHeight);
                    
                    // Dessiner l'image redimensionn√©e
                    ctx.drawImage(img, x, y, width, height);

                    // Convertir en WebP avec compression
                    this.compressToTargetSize(canvas, callback, file.name);
                };

                img.src = URL.createObjectURL(file);
            },

            compressToTargetSize(canvas, callback, originalName) {
                const targetSize = 50 * 1024; // 50KB
                let quality = 0.9;
                let attempts = 0;
                const maxAttempts = 10;

                const tryCompress = () => {
                    canvas.toBlob((blob) => {
                        if (blob.size <= targetSize || attempts >= maxAttempts || quality <= 0.1) {
                            // Cr√©er le fichier optimis√©
                            const optimizedFile = new File([blob], originalName, { type: 'image/webp' });
                            const preview = URL.createObjectURL(blob);
                            
                            console.log(`üéØ Compression termin√©e: ${blob.size} bytes (${Math.round(blob.size/1024)}KB) avec qualit√© ${quality}`);
                            callback(optimizedFile, preview);
                        } else {
                            // R√©duire la qualit√© et r√©essayer
                            quality -= 0.1;
                            attempts++;
                            tryCompress();
                        }
                    }, 'image/webp', quality);
                };

                tryCompress();
            },

            showMediaPreview(preview, name, size) {
                const previewDiv = document.getElementById('exercise-media-preview');
                const uploadDiv = document.getElementById('exercise-media-upload');
                const img = document.getElementById('exercise-media-img');
                const info = document.getElementById('media-file-info');

                img.src = preview;
                info.textContent = `${name} ‚Ä¢ ${Math.round(size/1024)}KB`;
                
                previewDiv.style.display = 'block';
                uploadDiv.style.display = 'none';
            },

            removeExerciseMedia() {
                const previewDiv = document.getElementById('exercise-media-preview');
                const uploadDiv = document.getElementById('exercise-media-upload');
                
                previewDiv.style.display = 'none';
                uploadDiv.style.display = 'block';
                
                // Nettoyer les donn√©es temporaires
                if (appState.currentExerciseMedia && appState.currentExerciseMedia.preview) {
                    URL.revokeObjectURL(appState.currentExerciseMedia.preview);
                }
                appState.currentExerciseMedia = null;
                
                // Nettoyer l'input
                document.getElementById('exercise-media-input').value = '';
            },

            showMediaLibrary() {
                this.loadMediaLibrary();
                document.getElementById('media-library-modal').classList.add('active');
                
                // Configurer le drag & drop
                this.setupMediaDragDrop();
            },

            loadMediaLibrary() {
                if (!appState.mediaLibrary) {
                    appState.mediaLibrary = [];
                }

                this.renderMediaLibrary();
                this.updateMediaStats();
            },

            renderMediaLibrary() {
                const grid = document.getElementById('media-grid');
                const searchTerm = document.getElementById('media-search-input')?.value.toLowerCase() || '';
                const activeCategory = document.querySelector('.media-category-btn.active')?.textContent.toLowerCase() || 'tout';

                let filteredMedia = appState.mediaLibrary.filter(media => {
                    const matchesSearch = !searchTerm || media.name.toLowerCase().includes(searchTerm) || (media.tags && media.tags.some(tag => tag.includes(searchTerm)));
                    const matchesCategory = activeCategory === 'tout' || (media.category && media.category === activeCategory);
                    return matchesSearch && matchesCategory;
                });

                if (filteredMedia.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                            ${appState.mediaLibrary.length === 0 ? 
                                'üìÅ Aucune image dans la biblioth√®que<br><small>Ajoutez des images en les glissant ci-dessus</small>' :
                                'üîç Aucun r√©sultat pour cette recherche'
                            }
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = filteredMedia.map((media, index) => `
                    <div class="media-item" onclick="actions.selectMediaItem(${media.id})" data-media-id="${media.id}">
                        <img src="${media.preview}" alt="${media.name}" loading="lazy" class="lazy-image">
                        <div class="media-item-info">
                            <div class="media-item-name">${media.name}</div>
                            <div class="media-item-size">${Math.round(media.size/1024)}KB</div>
                        </div>
                    </div>
                `).join('');

                // Lazy loading des images
                this.setupLazyLoading();
            },

            setupLazyLoading() {
                const images = document.querySelectorAll('.lazy-image');
                
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.classList.add('loaded');
                            observer.unobserve(img);
                        }
                    });
                });

                images.forEach(img => imageObserver.observe(img));
            },

            selectMediaItem(mediaId) {
                // D√©s√©lectionner tous
                document.querySelectorAll('.media-item').forEach(item => {
                    item.classList.remove('selected');
                });

                // S√©lectionner le cliqu√©
                const item = document.querySelector(`[data-media-id="${mediaId}"]`);
                if (item) {
                    item.classList.add('selected');
                    appState.selectedMediaId = mediaId;
                    document.getElementById('select-media-btn').disabled = false;
                }
            },

            selectMediaFromLibrary() {
                if (!appState.selectedMediaId) return;

                const media = appState.mediaLibrary.find(m => m.id === appState.selectedMediaId);
                if (media) {
                    // Utiliser cette image pour l'exercice
                    appState.currentExerciseMedia = {
                        file: null, // D√©j√† en biblioth√®que
                        preview: media.preview,
                        name: media.name,
                        size: media.size,
                        libraryId: media.id
                    };

                    this.showMediaPreview(media.preview, media.name, media.size);
                    this.closeModal('media-library-modal');
                    this.showNotification('‚úÖ Image s√©lectionn√©e !');
                }
            },

            filterMediaLibrary() {
                this.renderMediaLibrary();
            },

            filterMediaByCategory(category) {
                // Mettre √† jour les boutons actifs
                document.querySelectorAll('.media-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                this.renderMediaLibrary();
            },

            setupMediaDragDrop() {
                const dropZone = document.getElementById('media-drop-zone');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
                });

                dropZone.addEventListener('drop', this.handleDrop.bind(this), false);
                dropZone.addEventListener('click', () => {
                    document.getElementById('media-library-input').click();
                });
            },

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            },

            handleDrop(e) {
                const files = e.dataTransfer.files;
                this.handleMediaLibraryUpload({ target: { files } });
            },

            handleMediaLibraryUpload(event) {
                const files = Array.from(event.target.files);
                let processed = 0;
                const total = files.length;

                if (total === 0) return;

                this.showNotification(`üì§ Traitement de ${total} fichier(s)...`);

                files.forEach(file => {
                    if (this.validateMediaFile(file)) {
                        this.processMediaFile(file, (optimizedFile, preview) => {
                            this.addToMediaLibrary(optimizedFile, preview, file.name);
                            processed++;
                            
                            if (processed === total) {
                                this.showNotification(`‚úÖ ${processed} image(s) ajout√©e(s) √† la biblioth√®que !`);
                                this.renderMediaLibrary();
                                this.updateMediaStats();
                            }
                        });
                    }
                });
            },

            addToMediaLibrary(file, preview, originalName) {
                if (!appState.mediaLibrary) {
                    appState.mediaLibrary = [];
                }

                const media = {
                    id: Date.now() + Math.random(),
                    name: originalName,
                    preview: preview,
                    size: file.size,
                    type: file.type,
                    dateAdded: new Date().toISOString(),
                    category: null, // √Ä d√©terminer selon l'exercice
                    tags: []
                };

                appState.mediaLibrary.push(media);
                this.saveData();
            },

            updateMediaStats() {
                const count = appState.mediaLibrary?.length || 0;
                const totalSize = appState.mediaLibrary?.reduce((sum, media) => sum + media.size, 0) || 0;
                
                document.getElementById('media-count').textContent = count;
                document.getElementById('media-total-size').textContent = Math.round(totalSize / 1024);
            },

            // === SYST√àME DE TAGS AVANC√â ===
            initializeTagsSystem() {
                if (!appState.customTags) {
                    appState.customTags = [];
                }
                if (!appState.exerciseTags) {
                    appState.exerciseTags = {}; // exerciseId -> [tags]
                }
            },

            toggleAdvancedFilters() {
                const panel = document.getElementById('advanced-filters');
                const btn = document.getElementById('advanced-filters-btn');
                
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    btn.innerHTML = 'üîß Masquer filtres';
                    this.loadCustomTagsInFilters();
                } else {
                    panel.style.display = 'none';
                    btn.innerHTML = 'üîß Filtres avanc√©s';
                }
            },

            loadCustomTagsInFilters() {
                const container = document.getElementById('custom-tags-container');
                const noTagsSpan = document.getElementById('no-custom-tags');
                
                if (!appState.customTags || appState.customTags.length === 0) {
                    noTagsSpan.style.display = 'block';
                    return;
                }
                
                noTagsSpan.style.display = 'none';
                
                // Ajouter les tags personnalis√©s comme filtres cliquables
                appState.customTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = `tag-item tag-${tag.color}`;
                    tagElement.textContent = tag.name;
                    tagElement.onclick = () => this.toggleCustomTagFilter(tag.name);
                    container.appendChild(tagElement);
                });
            },

            toggleCustomTagFilter(tagName) {
                if (!appState.activeCustomTagFilters) {
                    appState.activeCustomTagFilters = [];
                }
                
                const index = appState.activeCustomTagFilters.indexOf(tagName);
                if (index === -1) {
                    appState.activeCustomTagFilters.push(tagName);
                } else {
                    appState.activeCustomTagFilters.splice(index, 1);
                }
                
                // Mettre √† jour l'affichage des tags actifs
                this.updateCustomTagFiltersDisplay();
                this.filterExerciseDatabase();
            },

            updateCustomTagFiltersDisplay() {
                const container = document.getElementById('custom-tags-container');
                const tags = container.querySelectorAll('.tag-item');
                
                tags.forEach(tag => {
                    if (appState.activeCustomTagFilters && appState.activeCustomTagFilters.includes(tag.textContent)) {
                        tag.classList.add('selected');
                    } else {
                        tag.classList.remove('selected');
                    }
                });
            },

            showTagsManager() {
                this.loadTagsManager();
                document.getElementById('tags-manager-modal').classList.add('active');
            },

            loadTagsManager() {
                this.renderExistingCustomTags();
                this.renderTagsStats();
            },

            renderExistingCustomTags() {
                const container = document.getElementById('existing-custom-tags');
                
                if (!appState.customTags || appState.customTags.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin: 0;">Aucun tag personnalis√© cr√©√©</p>';
                    return;
                }
                
                container.innerHTML = appState.customTags.map(tag => `
                    <div class="tag-item tag-${tag.color} removable" style="margin: 4px;">
                        ${tag.name}
                        <button class="remove-btn" onclick="actions.deleteCustomTag('${tag.name}')" title="Supprimer ce tag">√ó</button>
                    </div>
                `).join('');
            },

            renderTagsStats() {
                const container = document.getElementById('tags-stats');
                
                // Calculer les statistiques d'utilisation des tags
                const tagUsage = {};
                
                // Tags par d√©faut
                appState.exercises.forEach(exercise => {
                    const enrichedData = this.getExerciseEnrichedData(exercise);
                    enrichedData.tags.forEach(tag => {
                        tagUsage[tag] = (tagUsage[tag] || 0) + 1;
                    });
                });
                
                // Tags personnalis√©s
                Object.values(appState.exerciseTags || {}).forEach(tags => {
                    tags.forEach(tag => {
                        tagUsage[tag] = (tagUsage[tag] || 0) + 1;
                    });
                });
                
                // Trier par utilisation
                const sortedTags = Object.entries(tagUsage)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 8); // Top 8
                
                container.innerHTML = sortedTags.map(([tag, count]) => `
                    <div style="background: var(--surface); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary);">${count}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${tag}</div>
                    </div>
                `).join('');
            },

            createCustomTag() {
                const nameInput = document.getElementById('new-tag-name');
                const colorSelect = document.getElementById('new-tag-color');
                
                const name = nameInput.value.trim().toLowerCase();
                const color = colorSelect.value;
                
                if (!name) {
                    this.showNotification('‚ùå Nom du tag requis');
                    return;
                }
                
                if (name.length > 20) {
                    this.showNotification('‚ùå Nom trop long (max 20 caract√®res)');
                    return;
                }
                
                // V√©rifier les doublons
                if (appState.customTags.some(tag => tag.name === name)) {
                    this.showNotification('‚ùå Ce tag existe d√©j√†');
                    return;
                }
                
                // Ajouter le nouveau tag
                appState.customTags.push({
                    name,
                    color,
                    createdAt: new Date().toISOString()
                });
                
                // Nettoyer le formulaire
                nameInput.value = '';
                colorSelect.value = 'blue';
                
                // Rafra√Æchir l'affichage
                this.renderExistingCustomTags();
                this.renderTagsStats();
                this.saveData();
                
                this.showNotification(`‚úÖ Tag "${name}" cr√©√© !`);
            },

            deleteCustomTag(tagName) {
                if (!confirm(`Supprimer le tag "${tagName}" ? Il sera retir√© de tous les exercices.`)) {
                    return;
                }
                
                // Supprimer le tag de la liste
                appState.customTags = appState.customTags.filter(tag => tag.name !== tagName);
                
                // Supprimer le tag de tous les exercices
                Object.keys(appState.exerciseTags || {}).forEach(exerciseId => {
                    appState.exerciseTags[exerciseId] = appState.exerciseTags[exerciseId].filter(tag => tag !== tagName);
                });
                
                // Rafra√Æchir l'affichage
                this.renderExistingCustomTags();
                this.renderTagsStats();
                this.saveData();
                
                this.showNotification(`üóëÔ∏è Tag "${tagName}" supprim√©`);
            },

            exportTags() {
                const data = {
                    customTags: appState.customTags || [],
                    exerciseTags: appState.exerciseTags || {},
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `smarttrack_tags_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showNotification('üì§ Tags export√©s !');
            },

            importTags() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (data.customTags) {
                                appState.customTags = [...(appState.customTags || []), ...data.customTags];
                            }
                            
                            if (data.exerciseTags) {
                                appState.exerciseTags = {...(appState.exerciseTags || {}), ...data.exerciseTags};
                            }
                            
                            this.loadTagsManager();
                            this.saveData();
                            this.showNotification('üì• Tags import√©s !');
                        } catch (error) {
                            this.showNotification('‚ùå Fichier invalide');
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            },

            resetAllTags() {
                if (!confirm('‚ö†Ô∏è Supprimer TOUS les tags personnalis√©s ? Cette action est irr√©versible !')) {
                    return;
                }
                
                appState.customTags = [];
                appState.exerciseTags = {};
                
                this.loadTagsManager();
                this.saveData();
                this.showNotification('üóëÔ∏è Tous les tags supprim√©s');
            }
        };

        // === FONCTION DE RENDU UNIQUE ===
        function render() {
            console.log('Rendu pour l\'√©cran:', appState.currentScreen);
            
            // Mettre √† jour la navigation active
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Afficher le bon √©cran
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(`screen-${appState.currentScreen}`).classList.add('active');
            
            // Rendu sp√©cifique par √©cran
            switch (appState.currentScreen) {
                case 'dashboard':
                    renderDashboard();
                    document.querySelector('.nav-item').classList.add('active');
                    break;
                case 'preparation':
                    renderPreparation();
                    document.querySelectorAll('.nav-item')[1].classList.add('active');
                    break;
                case 'live':
                    renderLiveSession();
                    break;
                case 'history':
                    renderHistory();
                    document.querySelectorAll('.nav-item')[2].classList.add('active');
                    break;
                case 'stats':
                    renderStats();
                    document.querySelectorAll('.nav-item')[3].classList.add('active');
                    break;
                case 'body':
                    renderBody();
                    document.querySelectorAll('.nav-item')[4].classList.add('active');
                    break;
                case 'exercise-database':
                    renderExerciseDatabase();
                    document.querySelectorAll('.nav-item')[2].classList.add('active');
                    break;
                case 'exercises':
                    renderExercises();
                    break;
                case 'templates':
                    renderTemplates();
                    break;
                case 'settings':
                    renderSettings();
                    break;
                case 'manual-entry':
                    renderManualEntry();
                    break;
            }
        }

        // === FONCTIONS DE RENDU PAR √âCRAN ===
        function renderDashboard() {
            // Date actuelle ou mois s√©lectionn√©
            if (!appState.calendarDate) {
                appState.calendarDate = new Date();
            }
  
            const currentMonth = appState.calendarDate.getMonth();
            const currentYear = appState.calendarDate.getFullYear();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Calendrier mensuel
            const calendarGrid = document.getElementById('calendar-grid');
            const calendarContainer = calendarGrid.parentElement;
            
            // Remplacer le titre et ajouter la navigation
            const titleElement = calendarContainer.querySelector('h3');
            if (titleElement) {
                const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin','Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    
                titleElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button onclick="actions.previousMonth()" class="btn btn-small btn-secondary">‚Üê</button>
                        <span>${monthNames[currentMonth]} ${currentYear}</span>
                        <button onclick="actions.nextMonth()" class="btn btn-small btn-secondary">‚Üí</button>
                    </div>
                `;
            }
  
            // V√©rifier le cache du calendrier
            const calendarCacheKey = { 
                month: currentMonth, 
                year: currentYear, 
                sessionsCount: appState.sessions.length 
            };
            const cachedCalendar = smartCache.get('calendar', calendarCacheKey);

            if (cachedCalendar) {
                console.log('üìÖ Calendrier r√©cup√©r√© du cache');
                calendarGrid.innerHTML = cachedCalendar;
                return;
            }

            console.log('üìÖ G√©n√©ration du calendrier...');
            // Cr√©er le calendrier
            calendarGrid.innerHTML = '';
            calendarGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
            calendarGrid.style.gap = '4px';
            calendarGrid.style.maxHeight = 'none';
            
            // En-t√™tes des jours
            const dayHeaders = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.style.cssText = 'text-align: center; font-weight: bold; padding: 8px; font-size: 12px; color: var(--text-secondary);';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
  
            // Premier jour du mois et nombre de jours
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const firstDayOfWeek = (firstDay.getDay() + 6) % 7; // Lundi = 0
            const daysInMonth = lastDay.getDate();
            
            // R√©cup√©rer les dates des s√©ances
            const sessionDates = new Set(appState.sessions.map(s => s.date));
            
            // Cases vides avant le 1er du mois
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.style.cssText = 'aspect-ratio: 1; border-radius: 8px; opacity: 0.3;';
                calendarGrid.appendChild(emptyDay);
            }
  
            // Jours du mois
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
    
                const dayElement = document.createElement('div');
                dayElement.style.cssText = `
                    aspect-ratio: 1; 
                    border-radius: 8px; 
                    background: var(--border); 
                    opacity: 0.3; 
                    font-size: 14px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: var(--text-secondary); 
                    font-weight: 500;
                    min-height: 35px;
                `;
    
                dayElement.textContent = day;
    
                // Jour actuel
                if (dateStr === todayStr) {
                    dayElement.style.border = '2px solid var(--primary)';
                    dayElement.style.fontWeight = 'bold';
                }
    
                // Jour avec s√©ance
                if (sessionDates.has(dateStr)) {
                    dayElement.style.opacity = '1';
                    dayElement.style.background = 'var(--secondary)';
                    dayElement.style.color = 'white';
                }
    
                calendarGrid.appendChild(dayElement);
            }
  
            // Mettre en cache le HTML du calendrier
            smartCache.set('calendar', calendarCacheKey, calendarGrid.innerHTML);

            // Statistiques
            document.getElementById('total-sessions').textContent = appState.sessions.length;
            
            // Calcul de la s√©rie actuelle
            let streak = 0;
            const sortedSessions = [...appState.sessions].sort((a, b) => b.date.localeCompare(a.date));
            
            if (sortedSessions.length > 0) {
                let checkDate = new Date();
                const sessionDatesArray = new Set(sortedSessions.map(s => s.date));
                
                for (let i = 0; i < 30; i++) {
                    const dateStr = checkDate.toISOString().split('T')[0];
      
                    if (sessionDatesArray.has(dateStr)) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        if (i === 0 && dateStr === todayStr) {
                            checkDate.setDate(checkDate.getDate() - 1);
                            continue;
                        }
                        break;
                    }
                }
            }
  
            document.getElementById('current-streak').textContent = streak;
        }

        function renderPreparation() {
            // Initialiser la recherche d'exercices
            actions.initializeExerciseSearch();
            
            // Afficher les exercices planifi√©s AVEC SECTIONS
            const plannedDiv = document.getElementById('planned-exercises');
            plannedDiv.innerHTML = '';
            
            if (appState.currentSession && appState.currentSession.exercises.length > 0) {
                // S√©parer √©chauffement et entra√Ænement principal
                const warmupExercises = [];
                const mainExercises = [];
                
                appState.currentSession.exercises.forEach((plannedEx, index) => {
                    const exercise = appState.exercises.find(e => e.id === plannedEx.exercise_id);
                    if (exercise) {
                        const exerciseData = { ...plannedEx, exercise, originalIndex: index };
                        if (exercise.muscle_group === 'echauffement' || exercise.category === 'warmup') {
                            warmupExercises.push(exerciseData);
                        } else {
                            mainExercises.push(exerciseData);
                        }
                    }
                });
                
                // Section √âchauffement
                if (warmupExercises.length > 0) {
                    const warmupTitle = document.createElement('h4');
                    warmupTitle.textContent = 'üî• √âchauffement';
                    warmupTitle.className = 'exercise-section-title warmup';
                    plannedDiv.appendChild(warmupTitle);
                    warmupExercises.forEach((exerciseData, sectionIndex) => {
                        plannedDiv.appendChild(createExerciseItem(exerciseData, sectionIndex, 'warmup'));
                    });
                }
                
                // Section Entra√Ænement Principal
                if (mainExercises.length > 0) {
                    const mainTitle = document.createElement('h4');
                    mainTitle.textContent = 'üí™ Entra√Ænement Principal';
                    mainTitle.className = 'exercise-section-title main';
                    plannedDiv.appendChild(mainTitle);
                    mainExercises.forEach((exerciseData, sectionIndex) => {
                        plannedDiv.appendChild(createExerciseItem(exerciseData, sectionIndex, 'main'));
                    });
                }
                
                document.getElementById('start-live-btn').style.display = 'block';
                document.getElementById('save-manual-btn').style.display = 'block';
            } else {
                plannedDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Aucun exercice planifi√©</p>';
                document.getElementById('start-live-btn').style.display = 'none';
                document.getElementById('save-manual-btn').style.display = 'none';
            }
            
            // Les temps de repos sont maintenant g√©r√©s individuellement par exercice
            // Plus besoin de param√®tres globaux
        }

        function renderLiveSession() {
            const liveContent = document.getElementById('live-content');
            
            // AJOUTEZ CES LIGNES DE DEBUG
            console.log('Live session state:', appState.liveSession);
            console.log('Current session:', appState.currentSession);

            if (!appState.liveSession) {
                liveContent.innerHTML = '<p>Aucune s√©ance en cours</p>';
                return;
            }
            
            const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
            if (!currentExercise) {
                actions.finishLiveSession();
                return;
            }
            
            const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
            
            // Calculer la progression
            const currentExerciseNum = appState.liveSession.currentExerciseIndex + 1;
            const totalExercises = appState.liveSession.exercises.length;
            const progressPercentage = actions.calculateSessionProgress();

            // G√©n√©rer la barre de progression
            const progressBarHtml = `
                <div style="background: var(--surface); padding: 16px; margin-bottom: 16px; border-radius: 12px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">Progression de la s√©ance</span>
                        <span style="font-size: 14px; font-weight: 600; color: var(--primary);">${progressPercentage}%</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; background: var(--primary); width: ${progressPercentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; text-align: center;">
                        Exercice ${currentExerciseNum}/${totalExercises} ‚Ä¢ ${progressPercentage}% des s√©ries
                    </div>
                </div>
            `;

            // G√©rer la phase de pr√©paration avant le premier exercice
            if (appState.liveSession.isPreparing) {
                const firstExercise = exercise;
                
                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div style="text-align: center; padding: 40px 20px;">
                        <h2 style="margin-bottom: 24px; color: var(--primary);">üèÅ Pr√©paration</h2>
                        <div id="countdown-display" style="font-size: 72px; font-weight: bold; color: var(--primary); margin: 24px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                            5
                        </div>
                        <h3 style="margin-bottom: 16px;">Premier exercice :</h3>
                        <div style="font-size: 24px; font-weight: 600; margin: 16px 0; color: var(--text-primary);">
                            ${firstExercise.name}
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); background: var(--background); padding: 12px; border-radius: 8px; margin: 16px 0;">
                            Pr√©parez vos √©lastiques et votre position
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            ${firstExercise.is_unilateral ? 'üîÑ Exercice unilat√©ral' : '‚öñÔ∏è Exercice bilat√©ral'} ‚Ä¢ 
                            ${firstExercise.default_rest_time}s de repos par d√©faut
                        </div>
                    </div>
                `;
                return; // Sortir de la fonction
            }

            if (appState.liveSession.isPaused) {
                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 24px;">‚è∏Ô∏è</div>
                        <h2 style="color: var(--warning);">S√©ance en pause</h2>
                        <p style="color: var(--text-secondary); margin: 16px 0;">
                            Votre progression est sauvegard√©e
                        </p>
                        <div style="font-size: 14px; color: var(--text-secondary); margin: 16px 0;">
                            Pause depuis ${Math.floor((Date.now() - appState.liveSession.pauseStartTime) / 1000)}s
                        </div>
                        <button class="btn btn-success btn-full" onclick="actions.resumeLiveSession()">
                            ‚ñ∂Ô∏è Reprendre la s√©ance
                        </button>
                        <button class="btn btn-secondary btn-full" onclick="actions.stopLiveSession()" style="margin-top: 12px;">
                            üèÅ Terminer la s√©ance
                        </button>
                    </div>
                `;
                return; // Sortir de la fonction
            }

            if (appState.liveSession.isResting) {
                // Phase de repos - LOGIQUE CORRIG√âE
                const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                
                // D√©terminer si on est entre s√©ries du m√™me exercice ou entre exercices diff√©rents
                const isRestBetweenSets = currentExercise.sets.length < currentExercise.planned_sets;
                
                let completedExercise, completedExerciseData;
                let nextExercise, nextExerciseData;
                let isLastExercise = false;
                
                if (isRestBetweenSets) {
                    // Repos entre s√©ries du M√äME exercice
                    completedExercise = exercise;
                    completedExerciseData = currentExercise;
                    nextExercise = exercise; // M√™me exercice pour la s√©rie suivante
                    nextExerciseData = currentExercise;
                } else {
                    // Repos entre exercices DIFF√âRENTS
                    // L'exercice termin√© est celui √† l'index actuel (qui vient de finir toutes ses s√©ries)
                    completedExercise = exercise;
                    completedExerciseData = currentExercise;
                    
                    // Le prochain exercice est √† l'index suivant
                    const nextExerciseIndex = appState.liveSession.currentExerciseIndex + 1;
                    isLastExercise = nextExerciseIndex >= appState.liveSession.exercises.length;
                    
                    if (!isLastExercise) {
                        nextExerciseData = appState.liveSession.exercises[nextExerciseIndex];
                        nextExercise = appState.exercises.find(e => e.id === nextExerciseData.exercise_id);
                    } else {
                        nextExercise = null;
                        nextExerciseData = null;
                    }
                }
                
                // R√©cup√©rer les derni√®res performances du prochain exercice
                let nextExerciseInfo = '';
                if (nextExercise) {
                    let lastPerf;
                    if (isRestBetweenSets) {
                        // Repos entre s√©ries - r√©cup√©rer la performance de la s√©rie suivante de la derni√®re s√©ance
                        const nextSetNumber = completedExerciseData.sets.length + 1;
                        lastPerf = actions.getLastPerformanceForSet(completedExerciseData.exercise_id, nextSetNumber);
                    } else {
                        // Repos entre exercices - r√©cup√©rer toutes les s√©ries du prochain exercice
                        lastPerf = actions.getAllLastPerformances(nextExercise.id);
                    }
                    if (lastPerf) {
                        let performanceDetails = '';
                        if (lastPerf.sets) {
                            // Affichage de toutes les s√©ries (repos entre exercices)
                            performanceDetails = lastPerf.sets.map(set => {
                                const resistance = set.resistance || 0;
                                const duration = set.duration || 0;
                                const reps = set.reps || 0;
                                return `S√©rie ${set.setNumber}: ${resistance}kg ‚Ä¢ ${set.mode === 'time' ? `${duration}s` : `${reps} reps`}`;
                            }).join('<br>');
                        } else {
                            // Affichage d'une seule s√©rie (repos entre s√©ries du m√™me exercice)
                            const resistance = lastPerf.resistance || 0;
                            const duration = lastPerf.duration || 0;
                            const reps = lastPerf.reps || '0';
                            performanceDetails = `${resistance}kg ‚Ä¢ ${lastPerf.mode === 'time' ? `${duration}s` : `${reps} reps`}`;
                        }
                        
                        nextExerciseInfo = `
                            <div class="card" style="margin: 16px 0; padding: 16px; background: var(--surface); border: 2px solid var(--primary);">
                                <h4 style="color: var(--primary); margin-bottom: 8px;">üîú Prochain exercice</h4>
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                                    ${nextExercise.name}
                                </div>
                                <div style="font-size: 14px; color: var(--primary); font-weight: bold; background: var(--background); padding: 8px; border-radius: 8px;">
                                    üìä Derni√®re fois :<br>${performanceDetails}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    ${new Date(lastPerf.date).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                        `;
                    } else {
                        // NOUVEAU CODE : Afficher les conseils de r√©sistance
                        const resistanceAdvice = generateResistanceRecommendations(nextExercise.name);
                        
                        nextExerciseInfo = `
                            <div class="card" style="margin: 16px 0; padding: 16px; background: var(--surface); border: 2px solid var(--primary);">
                                <h4 style="color: var(--primary); margin-bottom: 8px;">üîú Prochain exercice</h4>
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                                    ${nextExercise.name}
                                </div>
                                <div style="font-size: 14px; color: var(--text-secondary); background: var(--background); padding: 8px; border-radius: 8px;">
                                    üÜï Premier essai pour cet exercice
                                </div>
                                ${resistanceAdvice}
                            </div>
                        `;
                    }
                } else {
                    nextExerciseInfo = `
                        <div class="card" style="margin: 16px 0; padding: 16px; background: var(--secondary); color: white; text-align: center;">
                            <h4 style="margin-bottom: 8px;">üèÅ Dernier exercice termin√© !</h4>
                            <div style="font-size: 18px;">F√©licitations ! üéâ</div>
                        </div>
                    `;
                }

                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div class="rest-timer">
                        <h2>Temps de repos</h2>
                        <div class="rest-time">00:00</div>
                        <button class="btn btn-primary btn-full" onclick="actions.skipRest()">
                            ‚è≠Ô∏è Passer le repos
                        </button>
                    </div>
                    
                    <div class="card" style="margin: 16px 0; padding: 12px; background: var(--background);">
                        <h4>‚úÖ ${isRestBetweenSets ? 'S√©rie termin√©e' : 'Exercice termin√©'}</h4>
                        <div style="font-size: 16px; font-weight: bold;">${completedExercise.name}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            ${isRestBetweenSets ?
                                `S√©rie ${completedExerciseData.sets.length} / ${completedExerciseData.planned_sets} termin√©e` :
                                `Toutes les s√©ries termin√©es (${completedExerciseData.sets.length}/${completedExerciseData.planned_sets})`
                            }
                        </div>
                    </div>
                    
                    ${nextExerciseInfo}
                `;
            } else {
                // Phase d'exercice
                const setNumber = currentExercise.sets.length + 1;
                
                // MODIFICATION : Utiliser la nouvelle fonction pour g√©rer tous les modes
                const performanceInputs = actions.generatePerformanceInputs(exercise);
                
                // R√©cup√©rer les derni√®res performances
                const lastPerf = actions.getLastPerformance(exercise.id);

                let perfRecap = '';
                if (lastPerf) {
                    let setsDisplay = '';
                    if (lastPerf.sets && lastPerf.sets.length > 0) {
                        setsDisplay = lastPerf.sets.map((set, index) => {
                            if (set.exercise_mode === 'time') {
                                return `S√©rie ${index + 1}: ${set.duration}s${set.resistance > 0 ? ` - ${set.resistance}kg` : ''}`;
                            } else if (exercise.is_unilateral) {
                                return `S√©rie ${index + 1}: ${set.left_reps}G/${set.right_reps}D - ${set.resistance}kg`;
                            } else {
                                return `S√©rie ${index + 1}: ${set.reps} reps - ${set.resistance}kg`;
                            }
                        }).join(' ‚Ä¢ ');
                    }
                    
                    perfRecap += `
                        <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                            <h5>üéØ Derni√®re performance (${lastPerf.totalSets} s√©ries) :</h5>
                            <div style="font-size: 14px;">
                                ${setsDisplay}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${new Date(lastPerf.date).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                    `;
                }


                // D√©terminer ce qui vient apr√®s cette s√©rie
                const willHaveMoreSets = (currentExercise.sets.length + 1) < currentExercise.planned_sets;
                if (willHaveMoreSets) {
                    // Il reste des s√©ries pour cet exercice
                    perfRecap += `
                        <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                            <h5>üîú Apr√®s cette s√©rie :</h5>
                            <div style="font-size: 14px;">
                                S√©rie ${currentExercise.sets.length + 2} de ${exercise.name}
                            </div>
                        </div>
                    `;
                } else {
                    // C'est la derni√®re s√©rie de cet exercice, afficher le prochain exercice
                    const nextExerciseIndex = appState.liveSession.currentExerciseIndex + 1;
                    const nextExercise = nextExerciseIndex < appState.liveSession.exercises.length ?
                        appState.exercises.find(e => e.id === appState.liveSession.exercises[nextExerciseIndex].exercise_id) : null;
                    const nextPerf = nextExercise ? actions.getLastPerformance(nextExercise.id) : null;
                    
                    if (nextPerf && nextExercise) {
                        const resistance = nextPerf.resistance || 0;
                        const duration = nextPerf.duration || 0;
                        const reps = nextPerf.reps || '0';
                        perfRecap += `
                            <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                                <h5>üîú Prochain exercice : ${nextExercise.name}</h5>
                                <div style="font-size: 14px;">
                                    Derni√®re fois : ${resistance}kg ‚Ä¢ ${nextPerf.mode === 'time' ? `${duration}s` : `${reps} reps`}
                                </div>
                            </div>
                        `;
                    } else if (nextExercise) {
                        perfRecap += `
                            <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                                <h5>üîú Prochain exercice : ${nextExercise.name}</h5>
                                <div style="font-size: 14px;">
                                    üÜï Premier essai pour cet exercice
                                </div>
                            </div>
                        `;
                    } else {
                        perfRecap += `
                            <div class="card" style="margin: 12px 0; padding: 12px; background: var(--secondary); color: white;">
                                <h5>üèÅ Derni√®re s√©rie du dernier exercice !</h5>
                                <div style="font-size: 14px;">F√©licitations, vous terminez ! üéâ</div>
                            </div>
                        `;
                    }
                }

                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div class="current-exercise">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="set-counter">S√©rie ${setNumber} / ${currentExercise.planned_sets}</div>
                    </div>
                    ${perfRecap}
                    ${performanceInputs}
                    
                    <div class="input-group">
                        <label>Type de s√©rie</label>
                        <select id="set-type" class="select">
                            <option value="work">Travail</option>
                            <option value="warmup">√âchauffement</option>
                            <option value="dropset">S√©rie d√©gressif</option>
                            <option value="failure">Jusqu'√† l'√©chec</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success btn-full" onclick="actions.validateSet()">
                        ‚úÖ Valider la s√©rie
                    </button>
                    
                    <button class="btn btn-secondary btn-full" onclick="actions.nextExercise()">
                        ‚û°Ô∏è Exercice suivant
                    </button>
                `;
            }
        }

        function renderHistory() {
            const sessionsList = document.getElementById('sessions-list');
            const historyCount = document.getElementById('history-count');
            
            historyCount.textContent = appState.sessions.length;
            sessionsList.innerHTML = '';
            
            const sortedSessions = [...appState.sessions].sort((a, b) => b.date.localeCompare(a.date));
            
            sortedSessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'card';
                
                const date = new Date(session.date);
                const formattedDate = date.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                let exercisesHtml = '';
                session.exercises.forEach(sessionEx => {
                    const exercise = appState.exercises.find(e => e.id === sessionEx.exercise_id);
                    if (exercise) {
                        exercisesHtml += `
                            <div style="margin: 8px 0; padding: 8px; background: var(--background); border-radius: 8px;">
                                <strong>${exercise.name}</strong> (${sessionEx.sets.length} s√©ries)
                                <div style="font-size: 14px; color: var(--text-secondary);">
                                    ${sessionEx.sets.map(set => {
                                        if (set.exercise_mode === 'time') {
                                            // Exercice en mode temps - ne pas afficher les r√©sistances si elles sont √† 0
                                            if (exercise.is_unilateral) {
                                                let leftResistance, rightResistance;
                                                if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                    leftResistance = set.total_resistance.left || 0;
                                                    rightResistance = set.total_resistance.right || 0;
                                                } else {
                                                    leftResistance = set.total_resistance || 0;
                                                    rightResistance = set.total_resistance || 0;
                                                }
                                            
                                                // Afficher les r√©sistances seulement si elles sont > 0
                                                if (leftResistance > 0 || rightResistance > 0) {
                                                    return `${set.duration || 0}s - ${leftResistance}kg (G) | ${rightResistance}kg (D)`;
                                                } else {
                                                    return `${set.duration || 0}s`;
                                                }
                                            } else {
                                                const resistance = set.total_resistance || 0;
                                                // Afficher la r√©sistance seulement si elle est > 0
                                                if (resistance > 0) {
                                                    return `${set.duration || 0}s - ${resistance}kg`;
                                                } else {
                                                    return `${set.duration || 0}s`;
                                                }
                                            }
                                        } else {
                                            // Exercice en mode r√©p√©titions (logique existante)
                                            if (exercise.is_unilateral) {
                                                let leftResistance, rightResistance;
                                                if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                    leftResistance = set.total_resistance.left || 0;
                                                    rightResistance = set.total_resistance.right || 0;
                                                } else {
                                                    leftResistance = set.total_resistance || 0;
                                                    rightResistance = set.total_resistance || 0;
                                                }
                                                return `${set.left_reps || 0} reps (G) | ${set.right_reps || 0} reps (D) - ${leftResistance}kg (G) | ${rightResistance}kg (D)`;
                                            } else {
                                                return `${set.reps || 0} reps - ${set.total_resistance || 0}kg`;
                                            }
                                        }
                                    }).join(' ‚Ä¢ ')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                // Calculer la dur√©e totale de la s√©ance
                const sessionDuration = session.endTime && session.startTime ? 
                    Math.floor((session.endTime - session.startTime) / 1000 / 60) : 0;

                // Calculer le volume total et le temps total d'exercice
                let totalVolume = 0;
                let totalExerciseTime = 0;
                session.exercises.forEach(ex => {
                    const sessionExercise = appState.exercises.find(e => e.id === ex.exercise_id);
                    ex.sets.forEach(set => {
                        // Calculer le temps d'exercice selon le mode
                        if (set.exercise_mode === 'time' && set.duration) {
                            // Exercice en mode temps
                            totalExerciseTime += set.duration;
                        } else if (set.exercise_mode === 'reps' || !set.exercise_mode) {
                            // Exercice en mode r√©p√©titions - estimer le temps
                            let reps = 0;
                            if (sessionExercise && sessionExercise.is_unilateral) {
                                reps = (set.left_reps || 0) + (set.right_reps || 0);
                            } else {
                                reps = set.reps || 0;
                            }
                            // Estimer 2 secondes par r√©p√©tition
                            totalExerciseTime += (reps * 2);
                        }
                    
                        // Calculer le volume pour les exercices en r√©p√©titions
                        if (set.exercise_mode !== 'time' && set.type === 'work') {
                            let resistance = 0;
                            let reps = 0;
                    
                            if (sessionExercise && sessionExercise.is_unilateral) {
                                // Exercice unilat√©ral - g√©rer les r√©sistances par c√¥t√©
                                if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                    resistance = (set.total_resistance.left || 0) + (set.total_resistance.right || 0);
                                } else {
                                    // Compatibilit√© avec l'ancien format
                                    resistance = (set.total_resistance || 0) * 2;
                                }
                                reps = (set.left_reps || 0) + (set.right_reps || 0);
                            } else {
                                // Exercice bilat√©ral
                                resistance = set.total_resistance || 0;
                                reps = set.reps || 0;
                            }
                    
                            totalVolume += (resistance * reps);
                        }
                    });
                });

                sessionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h3>${formattedDate}</h3>
                            <div style="font-size: 14px; color: var(--text-secondary); margin: 4px 0;">
                                ‚è±Ô∏è ${sessionDuration}min ‚Ä¢ üìä ${Math.round(totalVolume)}kg volume
                                ${totalExerciseTime > 0 ? ` ‚Ä¢ üî• ${Math.floor(totalExerciseTime / 60)}min ${totalExerciseTime % 60}s actif` : ''}
                                ${session.difficulty ? ` ‚Ä¢ ${session.difficulty === 'Facile' ? 'üòä' : session.difficulty === 'Normale' ? 'üí™' : 'üî•'} ${session.difficulty}` : ''}
                                ${session.globalSettings ? ` ‚Ä¢ Repos: ${session.globalSettings.restBetweenExercises}s/${session.globalSettings.restBetweenSets}s` : ''}
                            </div>
                            ${session.notes ? `<p style="color: var(--text-secondary); margin: 8px 0;">${session.notes}</p>` : ''}
                            <details style="margin-top: 12px;">
                                <summary style="cursor: pointer; font-weight: 500;">Voir les d√©tails</summary>
                                <div style="margin-top: 12px;">${exercisesHtml}</div>
                            </details>
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 12px;">
                            <button class="btn btn-small btn-secondary" onclick="actions.editSession(${session.id})" title="Modifier la s√©ance">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-small btn-danger" onclick="actions.deleteSession(${session.id})" title="Supprimer la s√©ance">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
                
                sessionsList.appendChild(sessionDiv);
            });
            
            if (sortedSessions.length === 0) {
                sessionsList.innerHTML = '<div class="card"><p style="text-align: center; color: var(--text-secondary);">Aucune s√©ance enregistr√©e</p></div>';
            }
        }

        function renderStats() {
            const statsContent = document.getElementById('stats-content');
            
            // STATISTIQUES G√âN√âRALES
            const generalStats = actions.calculateGeneralStats();
            let generalStatsHtml = `
                <div class="card">
                    <h3>üìä Statistiques g√©n√©rales</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.sessionsThisWeek}</div>
                            <div class="stat-label">S√©ances cette semaine</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalVolumeThisWeek}kg</div>
                            <div class="stat-label">Volume cette semaine</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.sessionsThisMonth}</div>
                            <div class="stat-label">S√©ances ce mois</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalVolumeThisMonth}kg</div>
                            <div class="stat-label">Volume ce mois</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.averageSessionDuration}min</div>
                            <div class="stat-label">Dur√©e moyenne</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalSessions}</div>
                            <div class="stat-label">Total s√©ances</div>
                        </div>
                    </div>
                    <div style="margin: 16px 0;">
                        <h4>üèÜ Records personnels r√©cents</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${generalStats.recentRecords.length > 0 ?
                                generalStats.recentRecords.map(record => `
                                    <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                                        <div>
                                            <strong>${record.exerciseName}</strong>
                                            <div style="font-size: 14px; color: var(--text-secondary);">
                                                ${record.type === 'max_weight' ? 'Poids Max' :
                                                    record.type === 'max_reps' ? 'Reps Max' : '1RM Estim√©'}:
                                                ${record.value}${record.type === 'max_reps' ? '' : 'kg'}
                                            </div>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            ${new Date(record.date).toLocaleDateString('fr-FR')}
                                        </div>
                                    </div>
                                `).join('') :
                                '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun record r√©cent</p>'
                            }
                        </div>
                    </div>
                </div>
            `;

            // UTILISER LE SELECT EXISTANT dans le HTML (pas en cr√©er un nouveau)
            const exerciseSelect = document.getElementById('stats-exercise-select');
            
            // Remplir le select existant s'il est vide
            if (exerciseSelect && exerciseSelect.children.length <= 1) {
                // Grouper les exercices par groupes musculaires
                const groupedExercises = {};
                appState.exercises.forEach(exercise => {
                    const group = exercise.muscle_group || 'autres';
                    if (!groupedExercises[group]) {
                        groupedExercises[group] = [];
                    }
                    groupedExercises[group].push(exercise);
                });

                // Ordre d'affichage des cat√©gories
                const groupOrder = ['echauffement', 'biceps', 'triceps', 'epaules', 'dos', 'pectoraux', 'jambes', 'autres'];
                
                // Vider le select et ajouter l'option par d√©faut
                exerciseSelect.innerHTML = '<option value="">Choisir un exercice...</option>';
                
                groupOrder.forEach(group => {
                    if (groupedExercises[group] && groupedExercises[group].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `${group.charAt(0).toUpperCase() + group.slice(1)} (${groupedExercises[group].length})`;
                        // Trier les exercices par nom dans chaque groupe
                        groupedExercises[group].sort((a, b) => a.name.localeCompare(b.name));
                        groupedExercises[group].forEach(exercise => {
                            const option = document.createElement('option');
                            option.value = exercise.id;
                            // Ajouter l'indicateur de mode
                            const modeIcon = exercise.exercise_mode === 'time' ? '‚è±Ô∏è' :
                                exercise.exercise_mode === 'both' ? 'üîÑ' : 'üî¢';
                            option.textContent = `${modeIcon} ${exercise.name}`;
                            optgroup.appendChild(option);
                        });
                        exerciseSelect.appendChild(optgroup);
                    }
                });
            }

            // Afficher les statistiques de base
            statsContent.innerHTML = generalStatsHtml;

            // Afficher les stats de l'exercice s√©lectionn√©
            const selectedExerciseId = parseInt(exerciseSelect?.value || '0');
            if (selectedExerciseId) {
                const exercise = appState.exercises.find(e => e.id === selectedExerciseId);
                const records = appState.records[selectedExerciseId] || [];

                // Calculer les records actuels
                const maxWeight = actions.getCurrentRecord(selectedExerciseId, 'max_weight');
                const maxReps = actions.getCurrentRecord(selectedExerciseId, 'max_reps');
                const max1RM = actions.getCurrentRecord(selectedExerciseId, 'max_1rm');

                // Calculer le volume max
                let maxVolume = 0;
                appState.sessions.forEach(session => {
                    const sessionExercise = session.exercises.find(e => e.exercise_id === selectedExerciseId);
                    if (sessionExercise) {
                        let sessionVolume = 0;
                        sessionExercise.sets.forEach(set => {
                            if (set.type === 'work') {
                                const resistance = set.total_resistance || 0;
                                if (exercise.is_unilateral) {
                                    const leftReps = set.left_reps || 0;
                                    const rightReps = set.right_reps || 0;
                                    sessionVolume += (leftReps + rightReps) * resistance;
                                } else {
                                    const reps = set.reps || 0;
                                    sessionVolume += reps * resistance;
                                }
                            }
                        });
                        maxVolume = Math.max(maxVolume, sessionVolume);
                    }
                });

                // Calculer le temps max pour les exercices en mode temps
                let maxTime = 0;
                let hasTimeMode = false;
                appState.sessions.forEach(session => {
                    const sessionExercise = session.exercises.find(e => e.exercise_id === selectedExerciseId);
                    if (sessionExercise) {
                        sessionExercise.sets.forEach(set => {
                            if (set.exercise_mode === 'time' && set.duration) {
                                hasTimeMode = true;
                                maxTime = Math.max(maxTime, set.duration);
                            }
                        });
                    }
                });

                // G√©n√©rer les cartes de statistiques selon le mode de l'exercice
                let statsCardsHtml = '';
                if (hasTimeMode) {
                    statsCardsHtml = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${maxTime}s</div>
                                <div class="stat-label">Temps Max Tenu</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxWeight}kg</div>
                                <div class="stat-label">Poids Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxVolume}kg</div>
                                <div class="stat-label">Volume Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${Math.round((maxTime * maxWeight) / 10) / 10}pts</div>
                                <div class="stat-label">Score Temps√óPoids</div>
                            </div>
                        </div>
                    `;
                } else {
                    statsCardsHtml = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${maxWeight}kg</div>
                                <div class="stat-label">Poids Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxReps}</div>
                                <div class="stat-label">Reps Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxVolume}kg</div>
                                <div class="stat-label">Volume Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${max1RM.toFixed(1)}kg</div>
                                <div class="stat-label">1RM Estim√©</div>
                            </div>
                        </div>
                    `;
                }

                // R√©cup√©rer les derni√®res s√©ries effectu√©es
                const lastSets = [];
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => ex.exercise_id === selectedExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));

                // Collecter les derni√®res s√©ries jusqu'√† 5 maximum
                for (const session of sessionsWithExercise) {
                    const exerciseData = session.exercises.find(ex => ex.exercise_id === selectedExerciseId);
                    if (exerciseData && exerciseData.sets.length > 0) {
                        const workSets = exerciseData.sets.filter(set => set.type === 'work');
                        for (const set of workSets) {
                            if (lastSets.length < 5) {
                                lastSets.push({
                                    date: session.date,
                                    ...set
                                });
                            }
                        }
                    }
                    if (lastSets.length >= 5) break;
                }

                // G√©n√©rer l'HTML des derni√®res s√©ries
                let lastSetsHtml = '';
                if (lastSets.length > 0) {
                    lastSetsHtml = `
                        <div class="card">
                            <h3>üîÑ Derni√®res s√©ries effectu√©es</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${lastSets.map((set, index) => {
                                    const date = new Date(set.date).toLocaleDateString('fr-FR', {
                                        day: 'numeric',
                                        month: 'short'
                                    });
                                    let setInfo = '';
                                    if (set.exercise_mode === 'time') {
                                        if (exercise.is_unilateral) {
                                            let leftResistance, rightResistance;
                                            if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                leftResistance = set.total_resistance.left || 0;
                                                rightResistance = set.total_resistance.right || 0;
                                            } else {
                                                leftResistance = set.total_resistance || 0;
                                                rightResistance = set.total_resistance || 0;
                                            }
                                            setInfo = leftResistance > 0 || rightResistance > 0 ?
                                                `${set.duration || 0}s - ${leftResistance}kg (G) | ${rightResistance}kg (D)` :
                                                `${set.duration || 0}s`;
                                        } else {
                                            const resistance = set.total_resistance || 0;
                                            setInfo = resistance > 0 ?
                                                `${set.duration || 0}s - ${resistance}kg` :
                                                `${set.duration || 0}s`;
                                        }
                                    } else {
                                        if (exercise.is_unilateral) {
                                            let leftResistance, rightResistance;
                                            if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                leftResistance = set.total_resistance.left || 0;
                                                rightResistance = set.total_resistance.right || 0;
                                            } else {
                                                leftResistance = set.total_resistance || 0;
                                                rightResistance = set.total_resistance || 0;
                                            }
                                            setInfo = `${set.left_reps || 0} reps (G) | ${set.right_reps || 0} reps (D) - ${leftResistance}kg (G) | ${rightResistance}kg (D)`;
                                        } else {
                                            setInfo = `${set.reps || 0} reps - ${set.total_resistance || 0}kg`;
                                        }
                                    }
                                    return `
                                        <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500;">${setInfo}</div>
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">${date}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Ajouter les statistiques d√©taill√©es
                const detailedStatsHtml = `
                    <div class="card">
                        <h3>üìà Statistiques pour ${exercise.name}</h3>
                        ${statsCardsHtml}
                    </div>
                    ${lastSetsHtml}
                    <div class="card">
                        <h3>√âvolution des performances</h3>
                        <div class="chart-container">
                            ${actions.generateSimpleChart(selectedExerciseId, exercise.name)}
                        </div>
                    </div>
                    <div class="card">
                        <h3>Historique des records</h3>
                        <div id="records-history">
                            ${records.length > 0 ?
                                records.map(record => `
                                    <div style="padding: 8px; border-bottom: 1px solid var(--border);">
                                        <strong>${new Date(record.date).toLocaleDateString('fr-FR')}</strong> -
                                        ${record.type === 'max_weight' ? 'Poids Max' :
                                            record.type === 'max_reps' ? 'Reps Max' :
                                            record.type === 'max_time' ? 'Temps Max' : '1RM Estim√©'}:
                                        <span style="color: var(--primary);">${record.value}${record.type === 'max_reps' ? '' : record.type === 'max_time' ? 's' : 'kg'}</span>
                                    </div>
                                `).join('')
                                : '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun record enregistr√©</p>'
                            }
                        </div>
                    </div>
                `;

                // Ajouter les statistiques d√©taill√©es apr√®s les statistiques g√©n√©rales
                statsContent.innerHTML = generalStatsHtml + detailedStatsHtml;
            }
        }

        function renderBody() {
            const measurementsList = document.getElementById('measurements-list');
            
            // D√©finir la date par d√©faut √† aujourd'hui
            const measurementDate = document.getElementById('measurement-date');
            if (!measurementDate.value) {
                measurementDate.value = new Date().toISOString().split('T')[0];
            }
            
            measurementsList.innerHTML = '';
            
            // Mettre √† jour le graphique
            const chartContainer = document.querySelector('#screen-body .chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = actions.generateMeasurementsChart();
            }
            
            const sortedMeasurements = [...appState.measurements].sort((a, b) => b.date.localeCompare(a.date));
            
            // Calculer l'IMC actuel (derni√®re mesure)
            const latestMeasurement = sortedMeasurements.length > 0 ? sortedMeasurements[0] : null;
            let currentImcCard = '';

            if (latestMeasurement && latestMeasurement.height > 0 && latestMeasurement.weight > 0) {
                let imc, imcCategory;
            
                if (latestMeasurement.imc && latestMeasurement.imc > 0) {
                    // IMC d√©j√† calcul√©
                    imc = latestMeasurement.imc;
                    imcCategory = latestMeasurement.imcCategory;
                } else {
                    // Calculer l'IMC
                    const heightInMeters = latestMeasurement.height / 100;
                    imc = latestMeasurement.weight / (heightInMeters * heightInMeters);
                    imc = Math.round(imc * 10) / 10;
                    
                    if (imc < 18.5) {
                        imcCategory = 'Insuffisance pond√©rale';
                    } else if (imc < 25) {
                        imcCategory = 'Poids normal';
                    } else if (imc < 30) {
                        imcCategory = 'Surpoids';
                    } else if (imc < 35) {
                        imcCategory = 'Ob√©sit√© mod√©r√©e';
                    } else if (imc < 40) {
                        imcCategory = 'Ob√©sit√© s√©v√®re';
                    } else {
                        imcCategory = 'Ob√©sit√© morbide';
                    }
                }
            
                const imcColor = imc < 18.5 ? '#FF9500' : 
                                 imc < 25 ? '#34C759' : 
                                 imc < 30 ? '#FF9500' : '#FF3B30';
                
                const imcIcon = imc < 18.5 ? '‚¨áÔ∏è' : 
                                imc < 25 ? '‚úÖ' : 
                                imc < 30 ? '‚ö†Ô∏è' : 'üî¥';
            
                currentImcCard = `
                    <div class="card">
                        <h3>üìè IMC Actuel</h3>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; font-weight: bold; color: ${imcColor}; margin-bottom: 8px;">
                                ${imc}
                            </div>
                            <div style="font-size: 18px; font-weight: 600; color: ${imcColor}; margin-bottom: 16px;">
                                ${imcIcon} ${imcCategory}
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                Taille: ${latestMeasurement.height}cm ‚Ä¢ Poids: ${latestMeasurement.weight}kg
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                                Mesur√© le ${new Date(latestMeasurement.date).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                
                        <div style="font-size: 12px; color: var(--text-secondary); background: var(--background); padding: 12px; border-radius: 8px; margin-top: 16px;">
                            <strong>R√©f√©rence IMC :</strong><br>
                            ‚Ä¢ &lt; 18.5 : Insuffisance pond√©rale<br>
                            ‚Ä¢ 18.5 - 24.9 : Poids normal<br>
                            ‚Ä¢ 25 - 29.9 : Surpoids<br>
                            ‚Ä¢ ‚â• 30 : Ob√©sit√©
                        </div>
                    </div>
                `;
            }

            if (sortedMeasurements.length > 0) {
                const listDiv = document.createElement('div');
                listDiv.className = 'card';
                listDiv.innerHTML = '<h3>Historique des mensurations</h3>';
                
                sortedMeasurements.forEach(measurement => {
                    const measurementDiv = document.createElement('div');
                    measurementDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);';
                    
                    let details = [];
                    let imcInfo = '';

                    // Afficher les mensurations de base
                    if (measurement.height > 0) details.push('Taille: ' + measurement.height + 'cm');
                    if (measurement.weight > 0) details.push(measurement.weight + 'kg');

                    // Calculer et afficher l'IMC s'il n'est pas d√©j√† stock√©
                    if (measurement.imc && measurement.imc > 0) {
                        // IMC d√©j√† calcul√© et stock√©
                        const imcColor = measurement.imc < 18.5 ? '#FF9500' : 
                                         measurement.imc < 25 ? '#34C759' : 
                                         measurement.imc < 30 ? '#FF9500' : '#FF3B30';
                        imcInfo = `<div style="font-size: 14px; margin-top: 4px; padding: 4px 8px; background: ${imcColor}20; border-radius: 4px; color: ${imcColor}; font-weight: 600;">
                            IMC: ${measurement.imc} ‚Ä¢ ${measurement.imcCategory}
                        </div>`;
                    } else if (measurement.height > 0 && measurement.weight > 0) {
                        // Calculer l'IMC √† la vol√©e pour les anciennes donn√©es
                        const heightInMeters = measurement.height / 100;
                        const imc = measurement.weight / (heightInMeters * heightInMeters);
                        const roundedImc = Math.round(imc * 10) / 10;
                    
                        let imcCategory = '';
                        if (imc < 18.5) {
                            imcCategory = 'Insuffisance pond√©rale';
                        } else if (imc < 25) {
                            imcCategory = 'Poids normal';
                        } else if (imc < 30) {
                            imcCategory = 'Surpoids';
                        } else if (imc < 35) {
                            imcCategory = 'Ob√©sit√© mod√©r√©e';
                        } else if (imc < 40) {
                            imcCategory = 'Ob√©sit√© s√©v√®re';
                        } else {
                            imcCategory = 'Ob√©sit√© morbide';
                        }
                    
                        const imcColor = imc < 18.5 ? '#FF9500' : 
                                         imc < 25 ? '#34C759' : 
                                         imc < 30 ? '#FF9500' : '#FF3B30';
                        imcInfo = `<div style="font-size: 14px; margin-top: 4px; padding: 4px 8px; background: ${imcColor}20; border-radius: 4px; color: ${imcColor}; font-weight: 600;">
                            IMC: ${roundedImc} ‚Ä¢ ${imcCategory}
                        </div>`;
                    }

                    // Autres mensurations
                    if (measurement.waist > 0) details.push('Tour taille: ' + measurement.waist + 'cm');
                    if (measurement.chest > 0) details.push('Poitrine: ' + measurement.chest + 'cm');
                    if (measurement.arm > 0) details.push('Bras: ' + measurement.arm + 'cm');
                    if (measurement.thigh > 0) details.push('Cuisse: ' + measurement.thigh + 'cm');
                    
                    measurementDiv.innerHTML = `
                        <div>
                            <strong>${new Date(measurement.date).toLocaleDateString('fr-FR')}</strong>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${details.join(' ‚Ä¢ ')}
                            </div>
                            ${imcInfo}
                        </div>
                        <button class="btn btn-small btn-danger" onclick="actions.deleteMeasurement(${measurement.id})">üóëÔ∏è</button>
                    `;
                    listDiv.appendChild(measurementDiv);
                });
                
                // Ajouter la carte IMC si elle existe
                if (currentImcCard) {
                    const imcDiv = document.createElement('div');
                    imcDiv.innerHTML = currentImcCard;
                    measurementsList.appendChild(imcDiv);
                }

                measurementsList.appendChild(listDiv);
            } else {
                measurementsList.innerHTML = '<div class="card"><p style="text-align: center; color: var(--text-secondary);">Aucune mensuration enregistr√©e</p></div>';
            }
        }

        function renderExerciseDatabase() {
            // Initialiser la vue si elle n'existe pas
            if (!appState.exerciseView) {
                appState.exerciseView = 'grid'; // 'grid' ou 'list'
            }
            
            actions.filterExerciseDatabase();
        }

        function renderExercises() {
            const exercisesList = document.getElementById('exercises-list');
            const formTitle = document.getElementById('exercise-form-title');
            const saveBtn = document.getElementById('save-exercise-btn');
            const cancelBtn = document.getElementById('cancel-exercise-btn');
            
            // Mise √† jour du formulaire selon le mode (cr√©ation/√©dition)
            if (appState.editingExercise) {
                formTitle.textContent = 'Modifier l\'exercice';
                saveBtn.textContent = 'üíæ Sauvegarder';
                cancelBtn.style.display = 'block';
            } else {
                formTitle.textContent = 'Nouvel exercice';
                saveBtn.textContent = '‚ûï Ajouter l\'exercice';
                cancelBtn.style.display = 'none';
            }
            
            // Liste des exercices
            exercisesList.innerHTML = '';
            
            if (appState.exercises.length > 0) {
                // Grouper les exercices par groupe musculaire
                const groupedExercises = {};
                appState.exercises.forEach(exercise => {
                    const group = exercise.muscle_group || 'autres';
                    if (!groupedExercises[group]) {
                        groupedExercises[group] = [];
                    }
                    groupedExercises[group].push(exercise);
                });
                
                // Afficher par groupes
                const groupOrder = ['echauffement', 'biceps', 'triceps', 'epaules', 'dos', 'pectoraux', 'jambes', 'autres'];
                groupOrder.forEach(group => {
                    if (groupedExercises[group] && groupedExercises[group].length > 0) {
                        const groupTitle = document.createElement('h4');
                        groupTitle.textContent = `${group.charAt(0).toUpperCase() + group.slice(1)} (${groupedExercises[group].length})`;
                        groupTitle.style.cssText = 'margin: 20px 0 10px 0; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 8px;';
                        exercisesList.appendChild(groupTitle);
                        
                        groupedExercises[group].forEach(exercise => {
                            const anchorText = {
                                'none': 'Sans ancrage',
                                'door-middle': 'Porte (milieu)',
                                'door-high': 'Porte (haut)',
                                'door-low': 'Porte (bas)',
                                'floor': 'Sol/Pieds',
                                'body': 'Corps',
                                'external': 'Ext√©rieur'
                            };
                            
                            const div = document.createElement('div');
                            div.className = 'exercise-item';
                            div.innerHTML = `
                                <div>
                                    <strong>${exercise.name}</strong>
                                    <div style="font-size: 14px; color: var(--text-secondary);">
                                        ${exercise.is_unilateral ? 'Unilat√©ral' : 'Bilat√©ral'} ‚Ä¢ ${exercise.default_rest_time}s repos ‚Ä¢ ${anchorText[exercise.anchor_point] || 'Non d√©fini'}
                                    </div>
                                </div>
                                <div class="exercise-actions">
                                    <button class="btn btn-small btn-secondary" onclick="actions.editExercise(${exercise.id})">‚úèÔ∏è</button>
                                    <button class="btn btn-small btn-danger" onclick="actions.deleteExercise(${exercise.id})">üóëÔ∏è</button>
                                </div>
                            `;
                            exercisesList.appendChild(div);
                        });
                    }
                });
            } else {
                exercisesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun exercice cr√©√©</p>';
            }
        }

        function renderTemplates() {
            const templatesList = document.getElementById('templates-list');
            const checkboxContainer = document.getElementById('template-exercises-checkboxes');

            // NOUVELLE INTERFACE DE CR√âATION DE MOD√àLE
            checkboxContainer.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-secondary btn-full" onclick="actions.showExerciseSelector()" id="show-exercise-selector-btn">
                        ‚ûï Ajouter des exercices au mod√®le
                    </button>
                </div>
                
                <div id="selected-exercises-container" style="margin: 16px 0;">
                    <h4>Exercices s√©lectionn√©s :</h4>
                    <div id="template-selected-exercises" style="min-height: 50px; padding: 16px; border: 2px dashed var(--border); border-radius: 8px; background: var(--background);">
                        <p style="text-align: center; color: var(--text-secondary);">Aucun exercice s√©lectionn√©</p>
                    </div>
                </div>
            `;

            // Initialiser la liste des exercices s√©lectionn√©s si elle existe
            if (appState.templateInCreation) {
                actions.renderSelectedExercises();
            }

            // Afficher les mod√®les existants avec les nouvelles informations
            templatesList.innerHTML = '';
            if (appState.templates.length > 0) {
                appState.templates.forEach(template => {
                    const div = document.createElement('div');
                    div.className = 'exercise-item';
                
                    // Construire la liste des exercices du mod√®le avec les nouvelles informations
                    let exercisesHtml = '';
                    if (template.exercises && template.exercises.length > 0) {
                        exercisesHtml = template.exercises.map((exData, index) => {
                            const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                            if (exercise) {
                                const modeIcon = exercise.exercise_mode === 'time' ? '‚è±Ô∏è' : 
                                                exercise.exercise_mode === 'both' ? 'üîÑ' : 'üî¢';
                                return `${index + 1}. ${modeIcon} ${exercise.name} (${exData.plannedSets} s√©ries)`;
                            }
                            return null;
                        }).filter(name => name).join(', ');
                    } else {
                        // Compatibilit√© avec l'ancien format
                        exercisesHtml = (template.exerciseIds || [])
                            .map(id => {
                                const exercise = appState.exercises.find(e => e.id === id);
                                if (exercise) {
                                    const modeIcon = exercise.exercise_mode === 'time' ? '‚è±Ô∏è' : 
                                                    exercise.exercise_mode === 'both' ? 'üîÑ' : 'üî¢';
                                    return `${modeIcon} ${exercise.name}`;
                                }
                                return null;
                            })
                            .filter(name => name)
                            .join(', ');
                    }

                    // Afficher les param√®tres globaux s'ils existent
                    let settingsHtml = '';
                    if (template.globalSettings) {
                        settingsHtml = `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                            Repos: ${template.globalSettings.restBetweenExercises}s (exercices) ‚Ä¢ ${template.globalSettings.restBetweenSets}s (s√©ries)
                        </div>`;
                    }

                    div.innerHTML = `
                        <div>
                            <strong>${template.name}</strong>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${exercisesHtml || 'Aucun exercice'}
                            </div>
                            ${settingsHtml}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-small btn-secondary" onclick="actions.editTemplate(${template.id})">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="actions.deleteTemplate(${template.id})">üóëÔ∏è</button>
                        </div>
                    `;
                    templatesList.appendChild(div);
                });
            } else {
                templatesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun mod√®le cr√©√©</p>';
            }
        }    

        function renderSettings() {
            // Le th√®me est d√©j√† appliqu√© via applyTheme()
        }

        function renderManualEntry() {
            const content = document.getElementById('manual-entry-content');
            if (!appState.manualSession) {
                content.innerHTML = '<p>Aucune s√©ance en cours</p>';
                return;
            }

            const currentExercise = appState.manualSession.exercises[appState.manualSession.currentExerciseIndex];
            if (!currentExercise) {
                actions.finishManualSession();
                return;
            }

            const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
            const performanceInputs = actions.generatePerformanceInputs(exercise, 'manual-');

            // Afficher les s√©ries d√©j√† saisies
            let setsHtml = '';
            if (currentExercise.sets.length > 0) {
                setsHtml = `
                    <div class="card">
                        <h4>S√©ries effectu√©es</h4>
                        ${currentExercise.sets.map((set, index) => {
                            if (exercise.is_unilateral) {
                                return `<div>S√©rie ${index + 1}: ${set.left_reps || 0} reps (G) | ${set.right_reps || 0} reps (D) - ${set.total_resistance || 0}kg</div>`;
                            } else {
                                return `<div>S√©rie ${index + 1}: ${set.reps || 0} reps - ${set.total_resistance || 0}kg</div>`;
                            }
                        }).join('')}
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="current-exercise">
                    <div class="exercise-name">${exercise.name}</div>
                    <div class="set-counter">S√©rie ${currentExercise.sets.length + 1}</div>
                    <div style="color: var(--text-secondary);">Exercice ${appState.manualSession.currentExerciseIndex + 1} / ${appState.manualSession.exercises.length}</div>
                </div>
                ${setsHtml}
                ${performanceInputs}
                <div class="input-group">
                    <label>Type de s√©rie</label>
                    <select id="manual-set-type" class="select">
                        <option value="work">Travail</option>
                        <option value="warmup">√âchauffement</option>
                        <option value="dropset">S√©rie d√©gressif</option>
                        <option value="failure">Jusqu'√† l'√©chec</option>
                    </select>
                </div>
                <button class="btn btn-success btn-full" onclick="actions.saveManualSet()">
                    ‚úÖ Ajouter cette s√©rie
                </button>
                <button class="btn btn-primary btn-full" onclick="actions.nextManualExercise()">
                    ‚û°Ô∏è Exercice suivant
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.finishManualSession()">
                    üèÅ Terminer la s√©ance
                </button>
            `;
        }

        // === FONCTIONS UTILITAIRES ===
        actions.renderTemplatesModal = function() {
            const modalContent = document.getElementById('templates-modal-content');
            modalContent.innerHTML = '';

            // Forcer le rechargement des mod√®les depuis le stockage
            appState.templates = storage.load('templates', []);

            if (appState.templates.length > 0) {
                appState.templates.forEach(template => {
                    const div = document.createElement('div');
                    div.className = 'exercise-item';
                    div.style.cursor = 'pointer';
                    div.onclick = () => actions.loadTemplate(template.id);
                    
                    let exerciseNames = '';
                    if (template.exercises && template.exercises.length > 0) {
                        // Nouveau format
                        exerciseNames = template.exercises.map(exData => {
                            const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                            return exercise ? exercise.name : 'Exercice supprim√©';
                        }).join(', ');
                    } else {
                        // Ancien format
                        exerciseNames = (template.exerciseIds || [])
                            .map(id => appState.exercises.find(e => e.id === id)?.name)
                            .filter(name => name)
                            .join(', ');
                    }
                
                    div.innerHTML = `
                        <div>
                            <strong>${template.name}</strong>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${exerciseNames || 'Aucun exercice'}
                            </div>
                        </div>
                        <div>üëÜ</div>
                    `;
                    modalContent.appendChild(div);
                });
            } else {
            modalContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun mod√®le disponible</p>';
            }
        };

        actions.deleteSession = function(sessionId) {
            if (confirm('Supprimer cette s√©ance ?')) {
                appState.sessions = appState.sessions.filter(s => s.id !== sessionId);
                this.saveData();
                render();
                this.showNotification('S√©ance supprim√©e');
            }
        };

        // √âdition des s√©ances
        actions.editSession = function(sessionId) {
            const session = appState.sessions.find(s => s.id === sessionId);
            if (!session) {
                this.showNotification('S√©ance introuvable');
                return;
            }
            
            appState.editingSession = { ...session }; // Copie pour √©viter les modifications directes
            this.renderEditSessionModal();
            document.getElementById('edit-session-modal').classList.add('active');
        };

        actions.renderEditSessionModal = function() {
            const content = document.getElementById('edit-session-content');
            const session = appState.editingSession;
            
            let exercisesHtml = '';
            session.exercises.forEach((sessionEx, exerciseIndex) => {
                const exercise = appState.exercises.find(e => e.id === sessionEx.exercise_id);
                if (!exercise) return;
                
                let setsHtml = '';
                sessionEx.sets.forEach((set, setIndex) => {
                    setsHtml += this.renderEditableSet(set, exercise, exerciseIndex, setIndex);
                });
                
                exercisesHtml += `
                    <div class="card" style="margin-bottom: 16px;">
                        <h4>${exercise.name}</h4>
                        <div style="margin-bottom: 12px;">
                            <button class="btn btn-small btn-secondary" onclick="actions.addSetToExercise(${exerciseIndex})">
                                ‚ûï Ajouter une s√©rie
                            </button>
                        </div>
                        ${setsHtml}
                    </div>
                `;
            });
            
            content.innerHTML = `
                <div class="input-group">
                    <label>Date de la s√©ance</label>
                    <input type="date" id="edit-session-date" class="input" value="${session.date}">
                </div>
                
                <div class="input-group">
                    <label>Notes de s√©ance</label>
                    <textarea id="edit-session-notes" class="textarea" placeholder="Notes optionnelles...">${session.notes || ''}</textarea>
                </div>
                
                <div class="input-group" ${session.difficulty ? '' : 'style="display: none;"'}>
                    <label>Difficult√© ressentie</label>
                    <select id="edit-session-difficulty" class="select">
                        <option value="">Non d√©finie</option>
                        <option value="Facile" ${session.difficulty === 'Facile' ? 'selected' : ''}>üòä Facile</option>
                        <option value="Normale" ${session.difficulty === 'Normale' ? 'selected' : ''}>üí™ Normale</option>
                        <option value="Difficile" ${session.difficulty === 'Difficile' ? 'selected' : ''}>üî• Difficile</option>
                    </select>
                </div>
                
                <h3>Exercices et performances</h3>
                ${exercisesHtml}
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-success" onclick="actions.saveSessionEdits()" style="flex: 1;">
                        üíæ Sauvegarder les modifications
                    </button>
                    <button class="btn btn-secondary" onclick="actions.cancelSessionEdit()" style="flex: 1;">
                        ‚ùå Annuler
                    </button>
                </div>
            `;
        };

        actions.renderEditableSet = function(set, exercise, exerciseIndex, setIndex) {
            const setId = `exercise-${exerciseIndex}-set-${setIndex}`;
            
            let performanceInputs = '';
            if (set.exercise_mode === 'time') {
                performanceInputs = `
                    <div class="input-group">
                        <label>Dur√©e (secondes)</label>
                        <input type="number" id="${setId}-duration" class="input" value="${set.duration || 0}" min="0" max="600">
                    </div>
                `;
            } else {
                if (exercise.is_unilateral) {
                    performanceInputs = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="input-group">
                                <label>Reps Gauche</label>
                                <input type="number" id="${setId}-left-reps" class="input" value="${set.left_reps || 0}" min="0">
                            </div>
                            <div class="input-group">
                                <label>Reps Droite</label>
                                <input type="number" id="${setId}-right-reps" class="input" value="${set.right_reps || 0}" min="0">
                            </div>
                        </div>
                    `;
                } else {
                    performanceInputs = `
                        <div class="input-group">
                            <label>R√©p√©titions</label>
                            <input type="number" id="${setId}-reps" class="input" value="${set.reps || 0}" min="0">
                        </div>
                    `;
                }
            }
            
            // Gestion de la r√©sistance (simplifi√©e pour l'√©dition)
            let resistanceInput = '';
            if (exercise.exercise_type === 'elastics') {
                const resistance = exercise.is_unilateral ? 
                    (typeof set.total_resistance === 'object' ? 
                        (set.total_resistance.left || 0) + (set.total_resistance.right || 0) : 
                        (set.total_resistance || 0) * 2) :
                    (set.total_resistance || 0);
                
                resistanceInput = `
                    <div class="input-group">
                        <label>R√©sistance totale (kg)</label>
                        <input type="number" id="${setId}-resistance" class="input" value="${resistance}" min="0" step="0.5">
                    </div>
                `;
            }
            
            return `
                <div class="card" style="margin: 8px 0; padding: 12px; background: var(--background);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5>S√©rie ${setIndex + 1}</h5>
                        <button class="btn btn-small btn-danger" onclick="actions.removeSetFromExercise(${exerciseIndex}, ${setIndex})" title="Supprimer cette s√©rie">
                            üóëÔ∏è
                        </button>
                    </div>
                
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        ${performanceInputs}
                        ${resistanceInput}
                        <div class="input-group">
                            <label>Type</label>
                            <select id="${setId}-type" class="select">
                                <option value="work" ${set.type === 'work' ? 'selected' : ''}>Travail</option>
                                <option value="warmup" ${set.type === 'warmup' ? 'selected' : ''}>√âchauffement</option>
                                <option value="dropset" ${set.type === 'dropset' ? 'selected' : ''}>D√©gressif</option>
                                <option value="failure" ${set.type === 'failure' ? 'selected' : ''}>√âchec</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        };

        actions.addSetToExercise = function(exerciseIndex) {
            const session = appState.editingSession;
            const sessionExercise = session.exercises[exerciseIndex];
            const exercise = appState.exercises.find(e => e.id === sessionExercise.exercise_id);
            
            // Cr√©er une nouvelle s√©rie bas√©e sur le type d'exercice
            const newSet = {
                type: 'work',
                exercise_mode: exercise.exercise_mode || 'reps'
            };
            
            if (exercise.is_unilateral) {
                newSet.left_reps = 0;
                newSet.right_reps = 0;
            } else {
                newSet.reps = 0;
            }
            
            if (exercise.exercise_mode === 'time') {
                newSet.duration = exercise.default_duration || 30;
            }
            
            newSet.total_resistance = 0;
            
            sessionExercise.sets.push(newSet);
            this.renderEditSessionModal();
        };

        actions.removeSetFromExercise = function(exerciseIndex, setIndex) {
            if (confirm('Supprimer cette s√©rie ?')) {
                appState.editingSession.exercises[exerciseIndex].sets.splice(setIndex, 1);
                this.renderEditSessionModal();
            }
        };

        actions.saveSessionEdits = function() {
            const session = appState.editingSession;
            
            // R√©cup√©rer les donn√©es du formulaire
            session.date = document.getElementById('edit-session-date').value;
            session.notes = document.getElementById('edit-session-notes').value;
            
            const difficultySelect = document.getElementById('edit-session-difficulty');
            if (difficultySelect) {
                session.difficulty = difficultySelect.value || null;
            }
            
            // R√©cup√©rer toutes les modifications de performances
            session.exercises.forEach((sessionEx, exerciseIndex) => {
                const exercise = appState.exercises.find(e => e.id === sessionEx.exercise_id);
                
                sessionEx.sets.forEach((set, setIndex) => {
                    const setId = `exercise-${exerciseIndex}-set-${setIndex}`;
                
                    // Type de s√©rie
                    const typeInput = document.getElementById(`${setId}-type`);
                    if (typeInput) set.type = typeInput.value;
                
                    // Performances selon le mode
                    if (set.exercise_mode === 'time') {
                        const durationInput = document.getElementById(`${setId}-duration`);
                        if (durationInput) set.duration = parseInt(durationInput.value) || 0;
                    } else {
                        if (exercise.is_unilateral) {
                            const leftRepsInput = document.getElementById(`${setId}-left-reps`);
                            const rightRepsInput = document.getElementById(`${setId}-right-reps`);
                            if (leftRepsInput) set.left_reps = parseInt(leftRepsInput.value) || 0;
                            if (rightRepsInput) set.right_reps = parseInt(rightRepsInput.value) || 0;
                        } else {
                            const repsInput = document.getElementById(`${setId}-reps`);
                            if (repsInput) set.reps = parseInt(repsInput.value) || 0;
                        }
                    }
                
                    // R√©sistance
                    const resistanceInput = document.getElementById(`${setId}-resistance`);
                    if (resistanceInput) {
                        const totalResistance = parseFloat(resistanceInput.value) || 0;
                        if (exercise.is_unilateral) {
                            // Pour les exercices unilat√©raux, diviser √©quitablement
                            set.total_resistance = {
                                left: totalResistance / 2,
                                right: totalResistance / 2
                            };
                        } else {
                            set.total_resistance = totalResistance;
                        }
                    }
                });
            });
            
            // Sauvegarder dans l'√©tat principal
            const sessionIndex = appState.sessions.findIndex(s => s.id === session.id);
            if (sessionIndex !== -1) {
                appState.sessions[sessionIndex] = session;
                this.saveData();
                this.closeModal('edit-session-modal');
                render();
                this.showNotification('‚úÖ S√©ance modifi√©e avec succ√®s !');
            }
        };

        actions.cancelSessionEdit = function() {
            appState.editingSession = null;
            this.closeModal('edit-session-modal');
        };

        // Initialisation de la recherche d'exercices
        actions.initializeExerciseSearch = function() {
            const searchInput = document.getElementById('exercise-search');
            const resultsContainer = document.getElementById('exercise-search-results');
            const historyContainer = document.getElementById('search-history');
            
            if (!searchInput) return;
            
            let currentSelection = -1;
            let currentResults = [];
            
            // Charger l'historique
            smartSearch.loadHistory();
            this.updateSearchHistory();
            
            // √âv√©nement de saisie avec debouncing
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                currentSelection = -1;
                
                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    historyContainer.style.display = searchHistory.length > 0 ? 'block' : 'none';
                    return;
                }
                
                historyContainer.style.display = 'none';
                
                // Utiliser le debouncing pour √©viter trop d'appels
                debounceManager.debounce(() => {
                    currentResults = smartSearch.search(query);
                    this.displaySearchResults(currentResults, query);
                }, 200, 'search');
            });
        
            // √âv√©nement focus - afficher la liste compl√®te ou l'historique
            searchInput.addEventListener('focus', () => {
                if (!searchInput.value) {
                    if (searchHistory.length > 0) {
                        historyContainer.style.display = 'block';
                    } else {
                        // Afficher tous les exercices si pas d'historique
                        currentResults = smartSearch.search('');
                        this.displaySearchResults(currentResults, '');
                    }
                }
            });
        
            // √âv√©nement blur - masquer les r√©sultats (avec d√©lai pour permettre les clics)
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    resultsContainer.style.display = 'none';
                    historyContainer.style.display = 'none';
                }, 200);
            });
        
            // Navigation au clavier
            searchInput.addEventListener('keydown', (e) => {
                if (resultsContainer.style.display === 'none') return;
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentSelection = Math.min(currentSelection + 1, currentResults.length - 1);
                        this.highlightResult(currentSelection);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentSelection = Math.max(currentSelection - 1, -1);
                        this.highlightResult(currentSelection);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentSelection >= 0 && currentResults[currentSelection]) {
                            this.selectExercise(currentResults[currentSelection]);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        resultsContainer.style.display = 'none';
                        searchInput.blur();
                        break;
                }
            });
        };

        actions.displaySearchResults = function(results, query) {
            const resultsContainer = document.getElementById('exercise-search-results');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-no-results">
                        Aucun exercice trouv√© pour "${query}"
                        <div style="margin-top: 8px; font-size: 11px;">
                            üí° Essayez avec des mots-cl√©s comme "biceps", "squat", "porte"...
                        </div>
                    </div>
                `;
                resultsContainer.style.display = 'block';
                return;
            }
        
            let html = '';
            results.forEach((exercise, index) => {
                const modeIcon = exercise.exercise_mode === 'time' ? '‚è±Ô∏è' :
                                 exercise.exercise_mode === 'both' ? 'üîÑ' : 'üî¢';
            
                const anchorText = {
                    'none': 'Sans ancrage',
                    'door-middle': 'Porte (milieu)',
                    'door-high': 'Porte (haut)', 
                    'door-low': 'Porte (bas)',
                    'floor': 'Sol/Pieds',
                    'body': 'Corps',
                    'external': 'Ext√©rieur'
                };
            
                html += `
                    <div class="search-result-item" onclick="actions.selectExercise({id: ${exercise.id}, name: '${exercise.name.replace(/'/g, "\\'")}'})" data-index="${index}">
                        <div>
                            <div class="search-result-name">${modeIcon} ${exercise.name}</div>
                            <div class="search-result-details">
                                ${exercise.muscle_group} ‚Ä¢ ${exercise.is_unilateral ? 'Unilat√©ral' : 'Bilat√©ral'} ‚Ä¢ ${anchorText[exercise.anchor_point] || 'Non d√©fini'}
                            </div>
                        </div>
                        <div style="font-size: 20px;">+</div>
                    </div>
                `;
            });
        
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        };

        actions.highlightResult = function(index) {
            const items = document.querySelectorAll('.search-result-item');
            items.forEach(item => item.classList.remove('highlighted'));
            
            if (index >= 0 && items[index]) {
                items[index].classList.add('highlighted');
                items[index].scrollIntoView({ block: 'nearest' });
            }
        };

        actions.selectExercise = function(exercise) {
            // Ajouter l'exercice √† la session
            if (!appState.currentSession) {
                appState.currentSession = {
                    date: new Date().toISOString().split('T')[0],
                    notes: '',
                    exercises: [],
                    globalSettings: {
                        restBetweenExercises: 120,
                        restBetweenSets: 90
                    }
                };
            }
            
            // V√©rifier si l'exercice n'est pas d√©j√† dans la liste
            const exists = appState.currentSession.exercises.find(e => e.exercise_id === exercise.id);
            if (exists) {
                this.showNotification('Cet exercice est d√©j√† dans la liste');
                return;
            }
            
            const fullExercise = appState.exercises.find(e => e.id === exercise.id);
            if (!fullExercise) {
                this.showNotification('Exercice introuvable');
                return;
            }
            
            appState.currentSession.exercises.push({
                exercise_id: exercise.id,
                planned_sets: 3,
                rest_time: fullExercise.default_rest_time || 90,
                duration: fullExercise?.default_duration || 30,
                sets: []
            });
            
            // R√©initialiser la recherche
            const searchInput = document.getElementById('exercise-search');
            const resultsContainer = document.getElementById('exercise-search-results');
            if (searchInput) searchInput.value = '';
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            render();
            this.showNotification(`Exercice "${exercise.name}" ajout√© !`);
        };

        actions.updateSearchHistory = function() {
            const historyContainer = document.getElementById('search-history');
            if (!historyContainer) return;
            
            if (searchHistory.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }
            
            let html = '<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Recherches r√©centes :</div>';
            searchHistory.slice(0, 5).forEach(item => {
                html += `
                    <span class="search-history-item" onclick="actions.useHistorySearch('${item.query}')">
                        ${item.query}
                    </span>
                `;
            });
            
            html += `
                <span class="search-history-item" onclick="actions.clearSearchHistory()" style="background: var(--danger); color: white;">
                    ‚úï Effacer
                </span>
            `;
            
            historyContainer.innerHTML = html;
        };

        actions.useHistorySearch = function(query) {
            const searchInput = document.getElementById('exercise-search');
            if (searchInput) {
                searchInput.value = query;
                searchInput.focus();
                // D√©clencher la recherche
                const event = new Event('input', { bubbles: true });
                searchInput.dispatchEvent(event);
            }
        };

        actions.clearSearchHistory = function() {
            smartSearch.clearHistory();
            this.updateSearchHistory();
            this.showNotification('Historique de recherche effac√©');
        };

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log('SmartTrack - Initialisation de l\'application');
            actions.init();
        
            // === GESTION DU BOUTON RETOUR ===
            window.addEventListener('popstate', (event) => {
                event.preventDefault();
            
                // V√©rifier s'il y a une s√©ance en cours
                if (appState.liveSession || appState.manualSession) {
                    if (confirm('Une s√©ance est en cours. Voulez-vous vraiment revenir en arri√®re ?')) {
                        const canGoBack = navigateBack();
                        if (!canGoBack && appState.currentScreen === 'dashboard') {
                            // On est d√©j√† au dashboard, confirmer la sortie
                            if (confirm('Voulez-vous vraiment quitter SmartTrack ?')) {
                                return; // Laisser le navigateur g√©rer la sortie
                            }
                        }
                    }
                    // Rester dans l'application
                    window.history.pushState({ screen: appState.currentScreen }, '', window.location.href);
                    return;
                }
            
                const canGoBack = navigateBack();
                if (!canGoBack) {
                    // Si on est sur le dashboard et qu'il n'y a nulle part o√π aller, on peut quitter
                    if (appState.currentScreen === 'dashboard') {
                        // Demander confirmation avant de quitter
                        if (confirm('Voulez-vous vraiment quitter SmartTrack ?')) {
                            return; // Laisser le navigateur g√©rer la sortie
                        } else {
                            // Rester dans l'application
                            window.history.pushState({ screen: appState.currentScreen }, '', window.location.href);
                        }
                    } else {
                        // Revenir au dashboard par d√©faut
                        actions.showScreen('dashboard');
                    }
                }
            });

            // Intercepter aussi la tentative de fermeture/actualisation
            window.addEventListener('beforeunload', (event) => {
                // Ne demander confirmation que s'il y a une s√©ance en cours
                if (appState.liveSession || appState.manualSession) {
                    event.preventDefault();
                    event.returnValue = 'Une s√©ance est en cours. √ätes-vous s√ªr de vouloir quitter ?';
                    return event.returnValue;
                }
            });

            // Ajouter un √©tat initial √† l'historique du navigateur
            window.history.replaceState({ screen: 'dashboard' }, '', window.location.href);
        });

        // Fermeture des modals en cliquant √† l'ext√©rieur
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    
    
    </script>
    <script>
    // Enregistrement du Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('SmartTrack SW: Enregistr√© avec succ√®s');
            
            // √âcouter les mises √† jour
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nouvelle version disponible
                  console.log('SmartTrack: Nouvelle version disponible');
                  // Optionnel: afficher une notification √† l'utilisateur
                }
              });
            });
          })
          .catch(error => {
            console.log('SmartTrack SW: √âchec d\'enregistrement', error);
          });
      });
    }
  </script>
</body>
</html>
