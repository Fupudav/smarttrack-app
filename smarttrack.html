<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartTrack - Suivi Intelligent d'Entraînement</title>    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007AFF">
    
    <style>
        /* === VARIABLES CSS === */
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --background: #F2F2F7;
            --surface: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #6D6D70;
            --border: #C6C6C8;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --background: #1C1C1E;
            --surface: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border: #38383A;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        /* === RESET & BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* === LAYOUT === */
        .app-container {
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--background);
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            flex: 1;
            padding: 16px;
            animation: slideIn 0.3s ease-out;
            width: 100%;
            box-sizing: border-box;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* Amélioration des items d'exercices */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 8px;
            min-height: 80px;
        }

        .exercise-item > div:first-child {
            flex: 1;
            min-width: 250px;
            word-wrap: break-word;
        }

        .exercise-item > div:last-child {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-width: 300px;
        }

        .exercise-item input[type="number"] {
            min-width: 70px;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
        }

        .exercise-item span {
            font-size: 12px;
            white-space: nowrap;
            font-weight: 500;
        }

        /* Amélioration responsive */
        @media (max-width: 768px) {
            .exercise-item {
                flex-direction: column;
                align-items: stretch;
                padding: 12px;
            }
        
            .exercise-item > div:first-child {
                min-width: 100%;
                margin-bottom: 8px;
            }
        
            .exercise-item > div:last-child {
                justify-content: space-between;
                min-width: 100%;
            }
        
            .exercise-item input[type="number"] {
                min-width: 60px;
            }
        }

        /* Amélioration des cartes */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border);
            max-width: 100%;
            overflow-x: auto;
        }

        /* Amélioration des grilles de stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        /* Amélioration des inputs de performance */
            .performance-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 24px 0;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* === NAVIGATION === */
        .nav-bar {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 -2px 10px var(--shadow);
        }

        /* Compensation pour le menu fixe en bas */
        .screen {
            padding-bottom: 80px; /* Espace pour le menu de navigation */
        }

        /* Ajuster le padding existant */
        .screen.active {
            display: flex;
            flex-direction: column;
            padding-bottom: 80px;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item:hover {
            color: var(--primary);
        }

        /* === COMPONENTS === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-full {
            width: 100%;
            margin-bottom: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input, .select, .textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--surface);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
        }

        /* === CALENDAR GRID === */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin: 16px 0;
            max-height: 120px;
            overflow: hidden;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background: var(--border);
            opacity: 0.3;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            max-width: 20px;
            max-height: 20px;
        }

        .calendar-day.active {
            opacity: 1;
            background: var(--secondary);
            color: white;
        }

        .calendar-day.high-volume {
            background: var(--primary);
            color: white;
        }

        /* === STATS === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* === EXERCISE LIST === */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
        }

        /* === STYLES DÉTAILS EXERCICES === */
        .exercise-details-section {
            margin: 24px 0;
            padding: 20px;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .exercise-details-section h4 {
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 12px 0;
            padding: 12px;
            background: var(--background);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .tip-item, .mistake-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .tip-item {
            background: #34C75920;
            border-left: 3px solid #34C759;
        }

        .mistake-item {
            background: #FF3B3020;
            border-left: 3px solid #FF3B30;
        }

        .muscle-tag {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .muscle-primary {
            background: var(--primary);
            color: white;
        }

        .muscle-secondary {
            background: var(--border);
            color: var(--text-secondary);
        }

        /* === STYLES PROGRAMMES === */
        .program-tabs {
            display: flex;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .program-subtabs {
            display: flex;
            margin-bottom: 16px;
            gap: 8px;
        }

        .subtab-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--surface);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .subtab-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        .subtab-content {
            display: none;
        }

        .subtab-content.active {
            display: block;
        }

        .story-intro {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 24px;
        }

        .progress-indicator {
            margin-top: 20px;
        }

        .chapter-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            max-width: 300px;
            margin: 0 auto 8px;
        }

        .chapter {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .chapter.completed {
            background: rgba(52, 199, 89, 0.9);
            box-shadow: 0 0 15px rgba(52, 199, 89, 0.4);
        }

        .chapter.locked {
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.6;
        }

        .chapter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            max-width: 300px;
            margin: 0 auto;
        }

        .program-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .program-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow);
            border-color: var(--primary);
        }

        .program-card.unavailable {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .program-card.unavailable:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--border);
        }

        .program-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .program-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .program-category {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .program-category.debutant {
            background: #34C75920;
            color: #34C759;
        }

        .program-category.intermediaire {
            background: #FF950020;
            color: #FF9500;
        }

        .program-category.avance {
            background: #FF3B3020;
            color: #FF3B30;
        }

        .program-category.legende {
            background: #AF52DE20;
            color: #AF52DE;
        }

        .program-category.specifique {
            background: #007AFF20;
            color: #007AFF;
        }

        .program-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .program-stat {
            text-align: center;
            padding: 8px;
            background: var(--background);
            border-radius: 8px;
        }

        .program-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        .program-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .program-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .program-objectives {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .objective-tag {
            font-size: 11px;
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-weight: 500;
        }

        .program-difficulty {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 12px;
        }

        .difficulty-stars {
            color: #FFD60A;
            font-size: 16px;
        }

        .unavailable-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--warning);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .progress-bar-container {
            margin: 16px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.6s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }

        .week-accordion {
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .week-header {
            padding: 16px;
            background: var(--surface);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .week-header:hover {
            background: var(--background);
        }

        .week-header.active {
            background: var(--primary);
            color: white;
        }

        .week-title {
            font-size: 16px;
            font-weight: 600;
        }

        .week-progress {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .week-header.active .week-progress {
            color: rgba(255, 255, 255, 0.8);
        }

        .week-content {
            display: none;
            padding: 0;
            background: var(--background);
        }

        .week-content.active {
            display: block;
        }

        .session-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:last-child {
            border-bottom: none;
        }

        .session-item:hover {
            background: var(--surface);
        }

        .session-item.completed {
            background: #34C75920;
        }

        .session-item.current {
            background: #FF950020;
            border-left: 4px solid #FF9500;
        }

        .session-day {
            font-weight: 600;
            color: var(--text-primary);
        }

        .session-name {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .session-duration {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .session-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .session-status.completed {
            background: #34C759;
            color: white;
        }

        .session-status.current {
            background: #FF9500;
            color: white;
        }

        .session-status.pending {
            background: var(--border);
            color: var(--text-secondary);
        }

        .quick-action-btn {
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 8px 0;
        }

        .quick-action-primary {
            background: var(--primary);
            color: white;
        }

        .quick-action-secondary {
            background: var(--border);
            color: var(--text-primary);
        }

        .training-days {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .calendar-preview {
            margin-top: 16px;
            padding: 16px;
            background: var(--background);
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .program-stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .program-stat {
                padding: 6px;
            }
            
            .program-stat-value {
                font-size: 14px;
            }
            
            .program-stat-label {
                font-size: 10px;
            }
            
            .chapter-bar {
                max-width: 250px;
            }
            
            .chapter {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }
            
            .training-days {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .image-placeholder {
            width: 100%;
            height: 200px;
            background: var(--background);
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            margin: 16px 0;
        }

        .favorite-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .favorite-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .favorite-btn.active {
            background: #FFD700;
            color: #000;
        }

        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            margin: 8px 0;
        }

        .difficulty-beginner {
            background: #34C75920;
            color: #34C759;
            border: 2px solid #34C759;
        }

        .difficulty-intermediate {
            background: #FF950020;
            color: #FF9500;
            border: 2px solid #FF9500;
        }

        .difficulty-advanced {
            background: #FF3B3020;
            color: #FF3B30;
            border: 2px solid #FF3B30;
        }

        .exercise-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .exercise-stat {
            text-align: center;
            padding: 12px;
            background: var(--background);
            border-radius: 8px;
        }

        .exercise-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .exercise-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* === SYSTÈME DE MÉDIAS === */
        .media-library-modal .modal-content {
            max-width: 900px;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .media-item {
            position: relative;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface);
        }

        .media-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .media-item.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .media-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .media-item-info {
            padding: 8px;
            font-size: 12px;
            text-align: center;
        }

        .media-item-name {
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .media-item-size {
            color: var(--text-secondary);
            font-size: 10px;
        }

        .media-upload-zone {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin: 16px 0;
            background: var(--background);
            transition: all 0.2s;
        }

        .media-upload-zone.dragover {
            background: var(--primary);
            color: white;
            transform: scale(1.02);
        }

        .media-optimization-info {
            background: var(--background);
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid var(--warning);
        }

        .media-optimization-info h5 {
            color: var(--warning);
            margin-bottom: 8px;
        }

        .compression-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
            padding: 16px;
            background: var(--surface);
            border-radius: 8px;
        }

        .compression-before, .compression-after {
            text-align: center;
        }

        .compression-stats {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s;
        }

        .lazy-image.loaded {
            opacity: 1;
        }

        .media-search {
            position: sticky;
            top: 0;
            background: var(--surface);
            padding: 16px;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        .media-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .media-category-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .media-category-btn:hover,
        .media-category-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* === SCHÉMAS ANATOMIQUES === */
        .anatomy-diagram {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .body-diagram {
            width: 150px;
            height: 300px;
            position: relative;
        }

        .body-diagram svg {
            width: 100%;
            height: 100%;
        }

        .muscle-group {
            fill: #E5E5E5;
            stroke: #CCCCCC;
            stroke-width: 1;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .muscle-group:hover {
            stroke-width: 2;
            stroke: var(--primary);
        }

        .muscle-group.primary {
            fill: var(--primary);
            stroke: var(--primary-dark);
            stroke-width: 2;
        }

        .muscle-group.secondary {
            fill: #FFB84D;
            stroke: #FF9500;
            stroke-width: 1.5;
        }

        .anatomy-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 12px 0;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .anatomy-title {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* === LIVE SESSION === */
        .session-timer {
            text-align: center;
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            margin: 24px 0;
        }

        .current-exercise {
            text-align: center;
            margin: 24px 0;
        }

        .exercise-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .set-counter {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .performance-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 24px 0;
        }

        .rest-timer {
            text-align: center;
            margin: 24px 0;
        }

        .rest-time {
            font-size: 72px;
            font-weight: 700;
            color: var(--warning);
        }

        .next-exercise {
            background: var(--surface);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            border: 1px solid var(--border);
        }

        /* === MODAL === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* === SYSTÈME DE TAGS AVANCÉ === */
        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tag-item.selected {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .tag-item.removable {
            padding-right: 4px;
        }

        .tag-item .remove-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 10px;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            opacity: 0.7;
        }

        .tag-item .remove-btn:hover {
            opacity: 1;
        }

        /* Couleurs des tags */
        .tag-blue { background: #007AFF20; color: #007AFF; border: 1px solid #007AFF40; }
        .tag-green { background: #34C75920; color: #34C759; border: 1px solid #34C75940; }
        .tag-orange { background: #FF950020; color: #FF9500; border: 1px solid #FF950040; }
        .tag-purple { background: #AF52DE20; color: #AF52DE; border: 1px solid #AF52DE40; }
        .tag-red { background: #FF3B3020; color: #FF3B30; border: 1px solid #FF3B3040; }
        .tag-gray { background: #8E8E9320; color: #8E8E93; border: 1px solid #8E8E9340; }

        /* Filtres avancés */
        .advanced-filters-panel {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 300px; }
        }

        .filter-combination {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            background: var(--surface);
            border-radius: 6px;
        }

        .filter-operator {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .tag-suggestion {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: var(--background);
            border: 1px dashed var(--border);
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-suggestion:hover {
            background: var(--primary);
            color: white;
            border-style: solid;
        }

        .tags-input-container {
            position: relative;
        }

        .tags-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .tag-suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .tag-suggestion-item:hover {
            background: var(--background);
        }

        .tag-suggestion-item:last-child {
            border-bottom: none;
        }

        /* === NOTIFICATION === */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1001;
            display: none;
            /* Amélioration pour les séances live */
            max-width: 300px;
            font-size: 14px;
            text-align: center;
        }

        .notification.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* Style spécial pour les notifications en séance */
        .notification.live-session {
            top: 80px;
            background: var(--primary);
            opacity: 0.9;
            font-size: 12px;
            padding: 8px 16px;
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }

        /* === CHART CONTAINER === */
        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        /* === RESPONSIVE === */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .screen {
                padding: 16px;
            }
            
            .performance-inputs {
                grid-template-columns: 1fr;
            }
        }

        /* Styles pour les sections d'exercices (échauffement/principal) */
        .exercise-section-title {
            margin: 16px 0 8px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exercise-section-title.warmup {
            color: var(--warning);
            border-color: var(--warning);
        }

        .exercise-section-title.main {
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Styles pour les boutons de réorganisation */
        .reorder-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .reorder-buttons button {
            padding: 2px 6px;
            font-size: 10px;
            min-width: 24px;
            height: 20px;
        }

        .reorder-buttons button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Numérotation des exercices */
        .exercise-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Groupes d'exercices dans les modèles */
        .exercise-group-title {
            margin: 16px 0 8px 0;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Indicateurs de mode d'exercice */
        .exercise-mode-indicator {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--background);
            color: var(--text-secondary);
            margin-left: 8px;
        }

        /* Style pour les champs conditionnels */
        .conditional-input {
            transition: all 0.3s ease;
        }

        .conditional-input.hidden {
            display: none;
        }

        /* === RECHERCHE EXERCICES === */
        .search-results {
            position: fixed;
            top: auto;
            left: 16px;
            right: 16px;
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 12px;
            max-height: 75vh;
            overflow-y: auto;
            z-index: 1500;
            box-shadow: 0 8px 32px var(--shadow);
            margin-top: 8px;
        }

        /* Ajustement responsive pour petits écrans */
        @media (max-width: 768px) {
            .search-results {
                max-height: 80vh;
                left: 8px;
                right: 8px;
            }
        }


        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover, .search-result-item.highlighted {
            background: var(--primary);
            color: white;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .search-result-details {
            font-size: 12px;
            opacity: 0.8;
        }

        .search-history-item {
            display: inline-block;
            background: var(--background);
            padding: 4px 8px;
            margin: 2px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: background-color 0.2s;
        }

        .search-history-item:hover {
            background: var(--primary);
            color: white;
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }
    </style>
    <script>
        // Empêcher le pull-to-refresh par défaut
        document.addEventListener('touchstart', handleTouchStart, { passive: true });
        document.addEventListener('touchmove', handleTouchMove, { passive: false });

        let startY = null;

        function handleTouchStart(evt) {
            startY = evt.touches[0].clientY;
        }

        function handleTouchMove(evt) {
            if (startY === null) return;
            
            const currentY = evt.touches[0].clientY;
            const diff = currentY - startY;
            
            // Si on tire vers le bas depuis le haut de la page
            if (diff > 0 && window.pageYOffset === 0) {
                evt.preventDefault(); // Empêcher le refresh
            }
            
            startY = null;
        }
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Écran 0: Tableau de Bord -->
        <div id="screen-dashboard" class="screen active">
            <div class="header">
                <h1>SmartTrack</h1>
                <button class="btn btn-small btn-secondary" onclick="actions.showSettings()">⚙️</button>
            </div>
            
            <div class="card">
                <h3>Calendrier de Régularité</h3>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-sessions">0</div>
                    <div class="stat-label">Séances Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="current-streak">0</div>
                    <div class="stat-label">Série Actuelle</div>
                </div>
            </div>
            
            <button class="btn btn-primary btn-full" onclick="actions.startNewSession()">
                🚀 Démarrer une séance vide
            </button>
            <button class="btn btn-secondary btn-full" onclick="actions.resumeLastSession()">
                📋 Reprendre la dernière séance
            </button>
        </div>

        <!-- Écran 1: Préparation de Séance -->
        <div id="screen-preparation" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('dashboard')">← Retour</button>
                <h1>Préparation</h1>
                <div></div>
            </div>
            
            <div class="card">
                <div class="input-group">
                    <label>Date de la séance</label>
                    <input type="date" id="session-date" class="input" onchange="actions.updateSessionDate(this.value)">
                </div>
                
                <div class="input-group">
                    <label>Notes de séance</label>
                    <textarea id="session-notes" class="textarea" placeholder="Notes optionnelles..." onchange="actions.updateSessionNotes(this.value)"></textarea>
                </div>
                
                <button class="btn btn-secondary btn-full" onclick="actions.showTemplates()">
                    📋 Charger un modèle
                </button>
            </div>

            <div class="card">
                <h3>Ajouter un exercice</h3>
                <div class="input-group">
                    <label>Rechercher un exercice</label>
                    <div style="position: relative;">
                        <input type="text" id="exercise-search" class="input" placeholder="Tapez le nom d'un exercice ou groupe musculaire..." autocomplete="off">
                        <div id="exercise-search-results" class="search-results" style="display: none;"></div>
                    </div>
                    <div id="search-history" style="margin-top: 8px; display: none;"></div>
                </div>
                <button class="btn btn-primary btn-full" onclick="actions.addExerciseToSession()">
                    ➕ Ajouter à la séance
                </button>
            </div>
            
            <div class="card">
                <h3>Exercices prévus</h3>
                <div id="planned-exercises"></div>
            </div>
            
            <button class="btn btn-success btn-full" onclick="actions.startLiveSession()" id="start-live-btn" style="display: none;">
                🚀 Démarrer la Séance Live
            </button>

            <button class="btn btn-secondary btn-full" onclick="actions.saveSessionManually()" id="save-manual-btn" style="display: none;">
                💾 Sauvegarder sans Live
            </button>
        </div>

        <!-- Écran 2: Séance Live -->
        <div id="screen-live" class="screen">
            <div class="header">
                <button class="btn btn-small btn-warning" onclick="actions.pauseLiveSession()">⏸️ Pause</button>
                <div class="session-timer" id="live-timer">00:00</div>
                <button class="btn btn-small btn-danger" onclick="actions.stopLiveSession()">⏹️ Arrêter</button>
            </div>
            <div id="live-content"></div>
        </div>

        <!-- Écran 3: Historique -->
        <div id="screen-history" class="screen">
            <div class="header">
                <h1>Historique</h1>
                <div class="stat-value" id="history-count">0</div>
            </div>
            
            <div id="sessions-list"></div>
        </div>

        <!-- Écran 4: Statistiques -->
        <div id="screen-stats" class="screen">
            <div class="header">
                <h1>Statistiques</h1>
            </div>
            
            <div class="card">
                <div class="input-group">
                    <label>Sélectionner un exercice</label>
                    <select id="stats-exercise-select" class="select" onchange="actions.updateStats(this.value)">
                        <option value="">Choisir un exercice...</option>
                    </select>
                </div>
            </div>
            
            <div id="stats-content"></div>
        </div>

        <!-- Écran 5: Suivi Corporel -->
        <div id="screen-body" class="screen">
            <div class="header">
                <h1>Mensurations</h1>
            </div>
            
            <div class="card">
                <h3>Nouvelle mensuration</h3>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="measurement-date" class="input">
                </div>
                <div class="input-group">
                    <label>Taille (cm)</label>
                    <input type="number" id="measurement-height" class="input" step="0.5" min="100" max="250">
                </div>
                <div class="input-group">
                    <label>Poids (kg)</label>
                    <input type="number" id="measurement-weight" class="input" step="0.1">
                </div>
                <div class="input-group">
                    <label>Tour de taille (cm)</label>
                    <input type="number" id="measurement-waist" class="input" step="0.5">
                </div>
                <div class="input-group">
                    <label>Tour de poitrine (cm)</label>
                    <input type="number" id="measurement-chest" class="input" step="0.5">
                </div>
                <div class="input-group">
                    <label>Tour de bras (cm)</label>
                    <input type="number" id="measurement-arm" class="input" step="0.5">
                </div>
                <div class="input-group">
                    <label>Tour de cuisse (cm)</label>
                    <input type="number" id="measurement-thigh" class="input" step="0.5">
                </div>
                <button class="btn btn-primary btn-full" onclick="actions.addMeasurement()">
                    ➕ Ajouter la mensuration
                </button>
            </div>
            
            <div class="card">
                <h3>Évolution des mensurations</h3>
                <div class="chart-container">
                    📊 Graphiques d'évolution des mensurations
                </div>
            </div>
            
            <div id="measurements-list"></div>
        </div>

        <!-- Écran 6: Gestion des Exercices -->
        <div id="screen-exercises" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showSettings()">← Retour</button>
                <h1>Exercices</h1>
                <div></div>
            </div>
            
            <div class="card">
                <h3 id="exercise-form-title">Nouvel exercice</h3>
                
                <div class="input-group">
                    <label>Nom de l'exercice</label>
                    <input type="text" id="exercise-name" class="input" placeholder="Ex: Développé couché">
                </div>
                
                <!-- NOUVEAU: Catégorie principale -->
                <div class="input-group">
                    <label>Catégorie</label>
                    <select id="exercise-category" class="select">
                        <option value="strength">Renforcement</option>
                        <option value="warmup">Échauffement</option>
                    </select>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="exercise-unilateral" class="checkbox">
                    <label for="exercise-unilateral">Exercice unilatéral</label>
                </div>
                
                <!-- NOUVEAU: Mode d'exercice -->
                <div class="input-group">
                    <label>Mode d'exécution</label>
                    <select id="exercise-mode" class="select" onchange="toggleExerciseMode()">
                        <option value="reps">Répétitions</option>
                        <option value="time">Temps</option>
                        <option value="both">Répétitions ou Temps</option>
                    </select>
                </div>
                
                <!-- NOUVEAU: Durée par défaut (affiché si mode temps) -->
                <div class="input-group" id="duration-group" style="display: none;">
                    <label>Durée par défaut (secondes)</label>
                    <input type="number" id="exercise-duration" class="input" value="30" min="10" max="300">
                </div>
                
                <div class="input-group">
                    <label>Temps de repos par défaut (secondes)</label>
                    <input type="number" id="exercise-rest" class="input" value="90">
                </div>
                
                <div class="input-group">
                    <label>Groupe musculaire</label>
                    <select id="exercise-muscle-group" class="select">
                        <option value="echauffement">Échauffement</option>
                        <option value="biceps">Biceps</option>
                        <option value="triceps">Triceps</option>
                        <option value="epaules">Épaules</option>
                        <option value="dos">Dos</option>
                        <option value="pectoraux">Pectoraux</option>
                        <option value="jambes">Jambes</option>
                        <option value="autres">Autres</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Point d'ancrage</label>
                    <select id="exercise-anchor" class="select" onchange="showExerciseExamples(this.value)">
                        <option value="none">🏃 Sans ancrage (élastique libre)</option>
                        <option value="door-middle">🚪 Porte - hauteur moyenne</option>
                        <option value="door-high">🚪⬆️ Porte - position haute</option>
                        <option value="door-low">🚪⬇️ Porte - position basse</option>
                        <option value="floor">🦵 Sol/Pieds (marcher dessus)</option>
                        <option value="body">🔄 Corps (élastique autour)</option>
                        <option value="external">🌳 Ancrage extérieur</option>
                    </select>
                    <div id="exercise-examples" style="margin-top: 8px; padding: 8px; background: var(--background); border-radius: 6px; font-size: 12px; color: var(--text-secondary); display: none;">
                        <strong>Exemples d'exercices :</strong>
                        <div id="examples-list"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Image/GIF de l'exercice</label>
                    <div id="exercise-media-container" style="border: 2px dashed var(--border); border-radius: 8px; padding: 16px; text-align: center;">
                        <div id="exercise-media-preview" style="display: none;">
                            <img id="exercise-media-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                <span id="media-file-info"></span>
                            </div>
                            <button type="button" class="btn btn-small btn-danger" onclick="actions.removeExerciseMedia()">
                                🗑️ Supprimer l'image
                            </button>
                        </div>
                        <div id="exercise-media-upload" style="display: block;">
                            <input type="file" id="exercise-media-input" accept="image/*,video/*" style="display: none;" onchange="actions.handleExerciseMediaUpload(event)">
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 48px; margin-bottom: 8px;">🎥</div>
                                <div style="font-size: 14px; margin-bottom: 8px;">Ajoutez une image ou GIF pour cet exercice</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    Formats supportés : JPG, PNG, WebP, GIF<br>
                                    Taille recommandée : 400x300px • Max : 50KB
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('exercise-media-input').click()">
                                📁 Choisir un fichier
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="actions.showMediaLibrary()" style="margin-left: 8px;">
                                🖼️ Bibliothèque
                            </button>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        💡 <strong>Conseil :</strong> Les images améliorent considérablement la compréhension des mouvements
                    </div>
                </div>

                <button class="btn btn-primary btn-full" onclick="actions.saveExercise()" id="save-exercise-btn">
                    ➕ Ajouter l'exercice
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.loadPredefinedExercises()" id="load-predefined-btn">
                    📚 Charger les exercices SmartWorkout
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.cancelExerciseEdit()" id="cancel-exercise-btn" style="display: none;">
                    ❌ Annuler
                </button>
            </div>
            
            <div class="card">
                <h3>Mes exercices</h3>
                <div id="exercises-list"></div>
            </div>
        </div>

        <!-- Écran 7: Gestion des Modèles -->
        <div id="screen-templates" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showSettings()">← Retour</button>
                <h1>Modèles</h1>
                <div></div>
            </div>
            
            <div class="card">
                <h3>Nouveau modèle</h3>
                <div class="input-group">
                    <label>Nom du modèle</label>
                    <input type="text" id="template-name" class="input" placeholder="Ex: Push Day">
                </div>
                <div class="input-group">
                    <label>Exercices</label>
                    <div id="template-exercises-checkboxes"></div>
                </div>
                <button class="btn btn-primary btn-full" onclick="actions.saveTemplate()">
                    ➕ Créer le modèle
                </button>
            </div>
            
            <div class="card">
                <h3>Mes modèles</h3>
                <div id="templates-list"></div>
            </div>
        </div>

        <!-- Écran 8: Paramètres -->
        <div id="screen-settings" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('dashboard')">← Retour</button>
                <h1>Paramètres</h1>
                <div></div>
            </div>
            
            <div class="card">
                <h3>Apparence</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="dark-theme" class="checkbox" onchange="actions.toggleTheme()">
                    <label for="dark-theme">Thème sombre</label>
                </div>
            </div>
            
            <div class="card">
                <h3>Données</h3>
                <button class="btn btn-secondary btn-full" onclick="actions.exportData()">
                    📤 Exporter les données
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.showImportModal()">
                    📥 Importer les données
                </button>
                <button class="btn btn-danger btn-full" onclick="actions.clearAllData()">
                    🗑️ Effacer toutes les données
                </button>
            </div>
            
            <div class="card">
                <h3>Gestion</h3>
                <button class="btn btn-secondary btn-full" onclick="actions.showScreen('exercises')">
                    💪 Gérer les exercices
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.showScreen('templates')">
                    📋 Gérer les modèles
                </button>
            </div>
        </div>

        <!-- Écran 9: Saisie Manuelle -->
        <div id="screen-manual-entry" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('preparation')">← Retour</button>
                <h1>Saisie Manuelle</h1>
                <div></div>
            </div>
            
            <div id="manual-entry-content"></div>
        </div>

        <!-- Écran 10: Base de Données Exercices -->
        <div id="screen-exercise-database" class="screen">
            <div class="header">
                <h1>💪 Base d'Exercices</h1>
                <button class="btn btn-small btn-secondary" onclick="actions.toggleExerciseView()">
                    <span id="view-toggle-btn">🔤 Vue Liste</span>
                </button>
            </div>
        
            <!-- Filtres et recherche -->
            <div class="card">
                <div class="input-group">
                    <label>🔍 Rechercher un exercice</label>
                    <input type="text" id="exercise-db-search" class="input" placeholder="Nom d'exercice, groupe musculaire..." onkeyup="actions.filterExerciseDatabase()">
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
                    <div class="input-group">
                        <label>Groupe musculaire</label>
                        <select id="muscle-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous les groupes</option>
                            <option value="echauffement">🔥 Échauffement</option>
                            <option value="biceps">💪 Biceps</option>
                            <option value="triceps">🔧 Triceps</option>
                            <option value="epaules">🤲 Épaules</option>
                            <option value="dos">🗂️ Dos</option>
                            <option value="pectoraux">🦆 Pectoraux</option>
                            <option value="jambes">🦵 Jambes</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Niveau de difficulté</label>
                        <select id="difficulty-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous niveaux</option>
                            <option value="beginner">🟢 Débutant</option>
                            <option value="intermediate">🟡 Intermédiaire</option>
                            <option value="advanced">🔴 Confirmé</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Point d'ancrage</label>
                        <select id="anchor-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous ancrages</option>
                            <option value="none">🏃 Sans ancrage</option>
                            <option value="door">🚪 Porte</option>
                            <option value="floor">🦵 Sol/Pieds</option>
                            <option value="body">🔄 Corps</option>
                            <option value="external">🌳 Extérieur</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Tags</label>
                        <select id="tags-filter" class="select" onchange="actions.filterExerciseDatabase()">
                            <option value="">Tous les tags</option>
                            <option value="isolation">🎯 Isolation</option>
                            <option value="composé">🏗️ Composé</option>
                            <option value="force">💪 Force</option>
                            <option value="masse">📈 Masse</option>
                            <option value="endurance">⏱️ Endurance</option>
                            <option value="fonctionnel">🔄 Fonctionnel</option>
                            <option value="équilibre">⚖️ Équilibre</option>
                            <option value="posture">🧘 Posture</option>
                            <option value="cardio">❤️ Cardio</option>
                            <option value="gainage">🛡️ Gainage</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-small btn-secondary" onclick="actions.clearExerciseFilters()">🗑️ Effacer filtres</button>
                    <button class="btn btn-small btn-primary" onclick="actions.showExerciseFavorites()">⭐ Favoris</button>
                    <button class="btn btn-small btn-secondary" onclick="actions.showTagsManager()">🏷️ Gérer tags</button>
                    <button class="btn btn-small btn-secondary" onclick="actions.toggleAdvancedFilters()" id="advanced-filters-btn">
                        🔧 Filtres avancés
                    </button>
                </div>

                <!-- Filtres avancés (masqués par défaut) -->
                <div id="advanced-filters" style="display: none; margin-top: 16px; padding: 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                    <h5 style="margin-bottom: 12px; color: var(--primary);">🔧 Filtrage avancé</h5>
                    
                    <div class="input-group">
                        <label>Tags personnalisés</label>
                        <div id="custom-tags-container" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface);">
                            <span style="color: var(--text-secondary); font-size: 12px;" id="no-custom-tags">Aucun tag personnalisé</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 12px;">
                        <div class="input-group">
                            <label>Durée par défaut</label>
                            <select id="duration-filter" class="select" onchange="actions.filterExerciseDatabase()">
                                <option value="">Toutes durées</option>
                                <option value="short">⚡ Court (≤30s)</option>
                                <option value="medium">🕐 Moyen (30-60s)</option>
                                <option value="long">⏰ Long (>60s)</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Mode d'exécution</label>
                            <select id="mode-filter" class="select" onchange="actions.filterExerciseDatabase()">
                                <option value="">Tous modes</option>
                                <option value="reps">🔢 Répétitions</option>
                                <option value="time">⏱️ Temps</option>
                                <option value="both">🔄 Mixte</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Type d'exercice</label>
                            <select id="type-filter" class="select" onchange="actions.filterExerciseDatabase()">
                                <option value="">Tous types</option>
                                <option value="unilateral">🔄 Unilatéral</option>
                                <option value="bilateral">⚖️ Bilatéral</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Résultats -->
            <div id="exercise-database-results"></div>
        </div>

        <!-- Écran 11: Programmes Prédéfinis -->
        <div id="screen-programmes" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('dashboard')">← Retour</button>
                <h1>🏆 Programmes</h1>
                <div></div>
            </div>
            
            <!-- Onglets Programmes -->
            <div class="program-tabs">
                <button class="tab-btn active" onclick="actions.switchProgramTab('predefined')">
                    📚 Programmes prédéfinis
                </button>
                <button class="tab-btn" onclick="actions.switchProgramTab('custom')">
                    ✏️ Mes programmes
                </button>
            </div>

            <!-- Contenu Programmes Prédéfinis -->
            <div id="tab-predefined" class="tab-content active">
                <!-- Sous-onglet Une longue histoire vers la gloire -->
                <div class="program-subtabs">
                    <button class="subtab-btn active" onclick="actions.switchProgramSubtab('histoire-gloire')">
                        🏰 Une longue histoire vers la gloire
                    </button>
                    <button class="subtab-btn" onclick="actions.switchProgramSubtab('autres')">
                        🎯 Autres programmes
                    </button>
                </div>

                <div id="subtab-histoire-gloire" class="subtab-content active">
                    <div class="story-intro card">
                        <h3>⚔️ Une longue histoire vers la gloire</h3>
                        <p>Embarquez dans une épopée légendaire où chaque programme vous transforme en guerrier des temps modernes. De novice à légende immortelle, forgez votre corps et votre mental avec la puissance des élastiques SmartWorkout.</p>
                        <div class="progress-indicator">
                            <div class="chapter-bar">
                                <div class="chapter completed">🔰</div>
                                <div class="chapter locked">⚔️</div>
                                <div class="chapter locked">🏺</div>
                                <div class="chapter locked">👑</div>
                                <div class="chapter locked">🎯</div>
                            </div>
                            <div class="chapter-labels">
                                <span>Débutant</span>
                                <span>Intermédiaire</span>
                                <span>Avancé</span>
                                <span>Légende</span>
                                <span>Spécifique</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="programs-list-histoire"></div>
                </div>

                <div id="subtab-autres" class="subtab-content">
                    <div class="card">
                        <h3>🎯 Programmes spécialisés</h3>
                        <p>Programmes ciblés pour des objectifs spécifiques : force, endurance, perte de poids, rééducation...</p>
                    </div>
                    <div id="programs-list-autres"></div>
                </div>
            </div>

            <!-- Contenu Mes Programmes -->
            <div id="tab-custom" class="tab-content">
                <div class="card">
                    <h3>✏️ Créer un programme personnalisé</h3>
                    <button class="btn btn-primary btn-full" onclick="actions.startCustomProgram()">
                        ➕ Nouveau programme
                    </button>
                </div>
                <div id="custom-programs-list"></div>
            </div>
        </div>

        <!-- Écran 12: Présentation de Programme -->
        <div id="screen-program-details" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('programmes')">← Retour</button>
                <h1 id="program-details-title">Programme</h1>
                <div></div>
            </div>
            
            <div id="program-details-content"></div>
        </div>

        <!-- Écran 13: Programme Suivi -->
        <div id="screen-program-tracking" class="screen">
            <div class="header">
                <button class="btn btn-small btn-secondary" onclick="actions.showScreen('dashboard')">← Retour</button>
                <h1 id="program-tracking-title">Mon Programme</h1>
                <button class="btn btn-small btn-secondary" onclick="actions.showProgramSettings()">⚙️</button>
            </div>
            
            <!-- Progression globale -->
            <div class="card">
                <div id="program-progress-header"></div>
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="program-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="program-progress-text">0% complété</div>
                </div>
                <div id="program-quick-actions"></div>
            </div>

            <!-- Semaines (accordéon) -->
            <div id="program-weeks-container"></div>
        </div>

        <!-- Navigation -->
        <nav class="nav-bar">
            <div class="nav-item active" onclick="actions.showScreen('dashboard')">
                <div>🏠</div>
                <div>Accueil</div>
            </div>
            <div class="nav-item" onclick="actions.goToSession()">
                <div>⚡</div>
                <div>Séance</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('programmes')">
                <div>🏆</div>
                <div>Programmes</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('exercise-database')">
                <div>💪</div>
                <div>Exercices</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('history')">
                <div>📊</div>
                <div>Historique</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('stats')">
                <div>📈</div>
                <div>Stats</div>
            </div>
            <div class="nav-item" onclick="actions.showScreen('body')">
                <div>⚖️</div>
                <div>Corporel</div>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <div id="templates-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Charger un modèle</h3>
                <button class="close-btn" onclick="actions.closeModal('templates-modal')">&times;</button>
            </div>
            <div id="templates-modal-content"></div>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importer des données</h3>
                <button class="close-btn" onclick="actions.closeModal('import-modal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Données JSON</label>
                <textarea id="import-data" class="textarea" rows="10" placeholder="Collez vos données JSON ici..."></textarea>
            </div>
            <button class="btn btn-primary btn-full" onclick="actions.importData()">
                📥 Importer
            </button>
        </div>
    </div>

    <!-- Modal difficulté de séance -->
    <div id="difficulty-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🎯 Comment s'est passée votre séance ?</h3>
            </div>
            <p style="text-align: center; color: var(--text-secondary); margin: 16px 0;">
                Cette information nous aide à suivre votre progression
            </p>
            <div style="display: grid; gap: 12px; margin: 20px 0;">
                <button class="btn btn-success btn-full" onclick="actions.finishSessionWithDifficulty('Facile')" style="padding: 16px;">
                    😊 Facile
                    <div style="font-size: 12px; opacity: 0.8;">J'aurais pu faire plus</div>
                </button>
                <button class="btn btn-primary btn-full" onclick="actions.finishSessionWithDifficulty('Normale')" style="padding: 16px;">
                    💪 Normale  
                    <div style="font-size: 12px; opacity: 0.8;">Effort modéré, bien dosé</div>
                </button>
                <button class="btn btn-danger btn-full" onclick="actions.finishSessionWithDifficulty('Difficile')" style="padding: 16px;">
                    🔥 Difficile
                    <div style="font-size: 12px; opacity: 0.8;">J'ai donné le maximum</div>
                </button>
            </div>
            <button class="btn btn-secondary btn-full" onclick="actions.finishSessionWithDifficulty(null)" style="margin-top: 8px;">
                Passer
            </button>
        </div>
    </div>

    <!-- Modal d'édition de séance -->
    <div id="edit-session-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>✏️ Modifier la séance</h3>
                <button class="close-btn" onclick="actions.closeModal('edit-session-modal')">×</button>
            </div>
            <div id="edit-session-content"></div>
        </div>
    </div>

    <!-- Modal de détails d'exercice -->
    <div id="exercise-details-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="exercise-details-title">Détails de l'exercice</h3>
                <button class="close-btn" onclick="actions.closeModal('exercise-details-modal')">×</button>
            </div>
            <div id="exercise-details-content"></div>
        </div>
    </div>

    <!-- Modal Bibliothèque de Médias -->
    <div id="media-library-modal" class="modal">
        <div class="modal-content media-library-modal">
            <div class="modal-header">
                <h3>🖼️ Bibliothèque de Médias</h3>
                <button class="close-btn" onclick="actions.closeModal('media-library-modal')">×</button>
            </div>
            
            <div class="media-search">
                <div class="input-group">
                    <input type="text" id="media-search-input" class="input" placeholder="🔍 Rechercher une image..." onkeyup="actions.filterMediaLibrary()">
                </div>
            
                <div class="media-categories">
                    <button class="media-category-btn active" onclick="actions.filterMediaByCategory('all')">Tout</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('echauffement')">Échauffement</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('biceps')">Biceps</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('triceps')">Triceps</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('epaules')">Épaules</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('dos')">Dos</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('pectoraux')">Pectoraux</button>
                    <button class="media-category-btn" onclick="actions.filterMediaByCategory('jambes')">Jambes</button>
                </div>
            </div>

            <div id="media-upload-section">
                <div class="media-upload-zone" id="media-drop-zone">
                    <div style="font-size: 48px; margin-bottom: 12px;">⬆️</div>
                    <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">
                        Glissez-déposez vos images ici
                    </div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                        ou cliquez pour parcourir
                    </div>
                    <input type="file" id="media-library-input" multiple accept="image/*,video/*" style="display: none;" onchange="actions.handleMediaLibraryUpload(event)">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('media-library-input').click()">
                        📁 Sélectionner des fichiers
                    </button>
                </div>
            
                <div class="media-optimization-info">
                    <h5>⚡ Optimisation automatique</h5>
                    <div style="font-size: 14px;">
                        • Compression intelligente pour respecter la limite de 50KB<br>
                        • Redimensionnement automatique vers 400x300px<br>
                        • Conversion vers WebP pour une meilleure performance<br>
                        • Fallback JPG pour la compatibilité
                    </div>
                </div>
            </div>

            <div id="media-library-content">
                <div id="media-grid" class="media-grid"></div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="font-size: 14px; color: var(--text-secondary);">
                    <span id="media-count">0</span> image(s) • <span id="media-total-size">0</span> KB utilisés
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="actions.closeModal('media-library-modal')">Annuler</button>
                    <button class="btn btn-primary" onclick="actions.selectMediaFromLibrary()" id="select-media-btn" disabled>
                        ✅ Utiliser cette image
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestionnaire de Tags -->
    <div id="tags-manager-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>🏷️ Gestionnaire de Tags</h3>
                <button class="close-btn" onclick="actions.closeModal('tags-manager-modal')">×</button>
            </div>
        
            <div style="margin-bottom: 24px;">
                <h4>➕ Créer un nouveau tag</h4>
                <div style="display: flex; gap: 12px; align-items: end;">
                    <div class="input-group" style="flex: 1; margin-bottom: 0;">
                        <label>Nom du tag</label>
                        <input type="text" id="new-tag-name" class="input" placeholder="Ex: explosivité, récupération..." maxlength="20">
                    </div>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label>Couleur</label>
                        <select id="new-tag-color" class="select">
                            <option value="blue">🔵 Bleu</option>
                            <option value="green">🟢 Vert</option>
                            <option value="orange">🟠 Orange</option>
                            <option value="purple">🟣 Violet</option>
                            <option value="red">🔴 Rouge</option>
                            <option value="gray">⚫ Gris</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="actions.createCustomTag()">Créer</button>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <h4>🏷️ Tags personnalisés existants</h4>
                <div id="existing-custom-tags" style="min-height: 60px; padding: 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                    <p style="color: var(--text-secondary); text-align: center; margin: 0;">Aucun tag personnalisé créé</p>
                </div>
            </div>

            <div>
                <h4>📊 Statistiques d'utilisation</h4>
                <div id="tags-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <!-- Stats générées dynamiquement -->
                </div>
            </div>

            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary" onclick="actions.exportTags()">📤 Exporter tags</button>
                <button class="btn btn-secondary" onclick="actions.importTags()" style="margin-left: 8px;">📥 Importer tags</button>
                <button class="btn btn-danger" onclick="actions.resetAllTags()" style="float: right;">🗑️ Réinitialiser tout</button>
            </div>
        </div>
    </div>

    <!-- Modal de sélection de date pour programme -->
    <div id="program-date-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📅 Démarrer le programme</h3>
                <button class="close-btn" onclick="actions.closeModal('program-date-modal')">×</button>
            </div>
            <div class="modal-body">
                <p id="program-date-description">À partir de quelle date souhaitez-vous débuter ce programme ?</p>
                <div class="input-group">
                    <label>Date de début</label>
                    <input type="date" id="program-start-date" class="input" onchange="actions.updateProgramEndDate()">
                </div>
                <div class="input-group">
                    <label>Date de fin prévue</label>
                    <input type="date" id="program-end-date" class="input" readonly>
                </div>
                <div class="calendar-preview" id="program-calendar-preview"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="actions.closeModal('program-date-modal')">Annuler</button>
                <button class="btn btn-primary" onclick="actions.confirmStartProgram()" id="confirm-program-btn">
                    🚀 Commencer le programme
                </button>
            </div>
        </div>
    </div>

    <!-- Modal paramètres de programme -->
    <div id="program-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Paramètres du programme</h3>
                <button class="close-btn" onclick="actions.closeModal('program-settings-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Type de progression</label>
                    <select id="program-progression-type" class="select">
                        <option value="linear">Progression linéaire (+2.5kg/semaine)</option>
                        <option value="step">Progression par paliers (+5kg toutes les 2 semaines)</option>
                        <option value="adaptive">Progression adaptative (basée sur RPE)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Notifications</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="program-notifications" class="checkbox">
                        <label for="program-notifications">Recevoir des rappels quotidiens</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>Jours d'entraînement</label>
                    <div class="training-days">
                        <div class="checkbox-group">
                            <input type="checkbox" id="day-monday" class="checkbox">
                            <label for="day-monday">Lundi</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="day-tuesday" class="checkbox">
                            <label for="day-tuesday">Mardi</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="day-wednesday" class="checkbox">
                            <label for="day-wednesday">Mercredi</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="day-thursday" class="checkbox">
                            <label for="day-thursday">Jeudi</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="day-friday" class="checkbox">
                            <label for="day-friday">Vendredi</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="day-saturday" class="checkbox">
                            <label for="day-saturday">Samedi</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="day-sunday" class="checkbox">
                            <label for="day-sunday">Dimanche</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="actions.closeModal('program-settings-modal')">Annuler</button>
                <button class="btn btn-primary" onclick="actions.saveProgramSettings()">
                    💾 Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // === BASE DE DONNÉES DES ÉLASTIQUES SMARTWORKOUT ELITE ===
        const ELASTICS_DB = {
            cyan: { name: 'Cyan', resistance: 25, color: '#00FFFF', quantity: 3 },
            black: { name: 'Noir', resistance: 20, color: '#000000', quantity: 3 },
            blue: { name: 'Bleu', resistance: 15, color: '#0000FF', quantity: 1 },
            green: { name: 'Vert', resistance: 10, color: '#00FF00', quantity: 1 },
            beige: { name: 'Beige', resistance: 5, color: '#F5F5DC', quantity: 1 }
        };

        // === BASE DE DONNÉES DES RÉSISTANCES CONSEILLÉES ===
        const RESISTANCE_RECOMMENDATIONS = {
            // BICEPS
            'Curl biceps': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Curl biceps (poulie basse)': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Curl biceps face à la porte': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Curl marteau': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            
            // TRICEPS
            'Extension triceps (poulie haute)': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 30, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 25, max: 50, elastics: ['Noir', 'Cyan'] }
            },
            'Extension triceps verticale': {
                beginner: { min: 5, max: 10, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 10, max: 25, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 20, max: 40, elastics: ['Bleu', 'Noir', 'Cyan'] }
            },
            'Kickback triceps': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            
            // ÉPAULES
            'Élévations latérales': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            'Élévations frontales': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            'Développé militaire assis': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 40, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 35, max: 65, elastics: ['Noir', 'Cyan'] }
            },
            'Oiseau': {
                beginner: { min: 5, max: 10, elastics: ['Beige'] },
                intermediate: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                advanced: { min: 15, max: 35, elastics: ['Bleu', 'Noir'] }
            },
            
            // DOS
            'Face Pull': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            'Tirage horizontal unilatéral': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            'Tirage vertical': {
                beginner: { min: 15, max: 25, elastics: ['Bleu', 'Noir'] },
                intermediate: { min: 25, max: 45, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 40, max: 70, elastics: ['Cyan x2'] }
            },
            'Rowing buste penché': {
                beginner: { min: 15, max: 25, elastics: ['Bleu', 'Noir'] },
                intermediate: { min: 25, max: 45, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 40, max: 70, elastics: ['Cyan x2'] }
            },
            
            // PECTORAUX
            'Développé debout (poulie moyenne)': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            'Développé incliné': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 55, elastics: ['Noir', 'Cyan'] }
            },
            'Écarté unilatéral': {
                beginner: { min: 5, max: 15, elastics: ['Beige', 'Vert'] },
                intermediate: { min: 15, max: 25, elastics: ['Vert', 'Bleu', 'Noir'] },
                advanced: { min: 20, max: 40, elastics: ['Noir', 'Cyan'] }
            },
            'Pompes lestées': {
                beginner: { min: 10, max: 25, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 25, max: 45, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 40, max: 75, elastics: ['Cyan x2'] }
            },
            
            // JAMBES
            'Squat': {
                beginner: { min: 20, max: 35, elastics: ['Noir', 'Cyan'] },
                intermediate: { min: 35, max: 60, elastics: ['Cyan x2'] },
                advanced: { min: 55, max: 95, elastics: ['Cyan x2 ou x3'] }
            },
            'Front squat': {
                beginner: { min: 15, max: 30, elastics: ['Bleu', 'Noir'] },
                intermediate: { min: 30, max: 50, elastics: ['Noir', 'Cyan'] },
                advanced: { min: 45, max: 80, elastics: ['Cyan x2'] }
            },
            'Fentes': {
                beginner: { min: 10, max: 20, elastics: ['Vert', 'Bleu'] },
                intermediate: { min: 20, max: 35, elastics: ['Bleu', 'Noir'] },
                advanced: { min: 30, max: 60, elastics: ['Noir', 'Cyan'] }
            },
            'Hip thrust': {
                beginner: { min: 25, max: 40, elastics: ['Noir', 'Cyan'] },
                intermediate: { min: 40, max: 65, elastics: ['Cyan x2'] },
                advanced: { min: 60, max: 100, elastics: ['Cyan x3'] }
            },
            'Soulevé de terre': {
                beginner: { min: 25, max: 40, elastics: ['Noir', 'Cyan'] },
                intermediate: { min: 40, max: 70, elastics: ['Cyan x2'] },
                advanced: { min: 65, max: 110, elastics: ['Cyan x3'] }
            }
        };

        // Base de données des exercices pré-définis SmartWorkout
        const PREDEFINED_EXERCISES = {
            echauffement: [
                { name: 'Jumping Jacks', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Montées de genoux', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Talons-fesses', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Burpees', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Planche', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Planche latérale', anchor: 'none', unilateral: true, timeBase: true },
                { name: 'Mountain climbers', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Squats au poids du corps', anchor: 'none', unilateral: false, timeBase: false },
                { name: 'Pompes', anchor: 'none', unilateral: false, timeBase: false },
                { name: 'Fentes alternées', anchor: 'none', unilateral: true, timeBase: false },
                { name: 'Rotations épaules', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Cercles de bras', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Étirements dynamiques', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'High knees', anchor: 'none', unilateral: false, timeBase: true },
                { name: 'Pas chassés', anchor: 'none', unilateral: false, timeBase: true }
            ],
            
            biceps: [
                { name: 'Curl biceps', anchor: 'none', unilateral: false },
                { name: 'Curl biceps (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Curl biceps face à la porte', anchor: 'door-middle', unilateral: false },
                { name: 'Curl marteau', anchor: 'none', unilateral: false },
                { name: 'Curl marteau (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Curl biceps avec poignée', anchor: 'none', unilateral: false },
                { name: 'Curl biceps en pronation', anchor: 'none', unilateral: false }
            ],
            epaules: [
                { name: 'Cuban press', anchor: 'none', unilateral: false },
                { name: 'Développé arnold', anchor: 'none', unilateral: false },
                { name: 'Développé militaire assis', anchor: 'floor', unilateral: false },
                { name: 'Élévations frontales', anchor: 'none', unilateral: false },
                { name: 'Élévations latérales', anchor: 'none', unilateral: false },
                { name: 'Oiseau', anchor: 'door-middle', unilateral: false },
                { name: 'Overhead press', anchor: 'none', unilateral: false },
                { name: 'Reverse fly', anchor: 'door-middle', unilateral: false },
                { name: 'Reverse fly unilatéral', anchor: 'door-middle', unilateral: true },
                { name: 'Shrug', anchor: 'none', unilateral: false },
                { name: 'Tirage menton', anchor: 'door-low', unilateral: false }
            ],
            dos: [
                { name: 'Face Pull', anchor: 'door-middle', unilateral: false },
                { name: 'Face pull (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Pull-Over', anchor: 'door-high', unilateral: false },
                { name: 'Rowing buste penché', anchor: 'floor', unilateral: false },
                { name: 'Rowing buste penché (prise large)', anchor: 'floor', unilateral: false },
                { name: 'Rowing buste penché (prise serrée)', anchor: 'floor', unilateral: false },
                { name: 'Soulevé de terre', anchor: 'floor', unilateral: false },
                { name: 'Soulevé de terre (prise large)', anchor: 'floor', unilateral: false },
                { name: 'Tirage Bucheron (poulie basse)', anchor: 'door-low', unilateral: true },
                { name: 'Tirage horizontal unilatéral', anchor: 'door-middle', unilateral: true },
                { name: 'Tirage poulie basse', anchor: 'door-low', unilateral: false },
                { name: 'Tirage poulie basse (supination)', anchor: 'door-low', unilateral: false },
                { name: 'Tirage vertical', anchor: 'door-high', unilateral: false },
                { name: 'Tirage vertical (prise serrée)', anchor: 'door-high', unilateral: false },
                { name: 'Tirage vertical (supination)', anchor: 'door-high', unilateral: false },
                { name: 'Tirage vertical unilatéral', anchor: 'door-high', unilateral: true }
            ],
            jambes: [
                { name: 'Abduction de hanches', anchor: 'body', unilateral: false },
                { name: 'Adduction de hanches', anchor: 'body', unilateral: false },
                { name: 'Donkey kick', anchor: 'body', unilateral: true },
                { name: 'Donkey kick (jambes fléchies)', anchor: 'body', unilateral: true },
                { name: 'Extensions mollets', anchor: 'floor', unilateral: false },
                { name: 'Extensions mollets unilatérales', anchor: 'floor', unilateral: true },
                { name: 'Fentes', anchor: 'none', unilateral: true },
                { name: 'Fentes bulgares', anchor: 'none', unilateral: true },
                { name: 'Front squat', anchor: 'floor', unilateral: false },
                { name: 'Hip thrust', anchor: 'body', unilateral: false },
                { name: 'Leg curl', anchor: 'body', unilateral: false },
                { name: 'Leg extension unilatérale', anchor: 'body', unilateral: true },
                { name: 'Soulevé de terre jambes tendues', anchor: 'floor', unilateral: false },
                { name: 'Squat', anchor: 'none', unilateral: false },
                { name: 'Squat sumo', anchor: 'floor', unilateral: false },
                { name: 'Squat swing', anchor: 'none', unilateral: false },
                { name: 'Thruster', anchor: 'floor', unilateral: false }
            ],
            pectoraux: [
                { name: 'Développé épaules debout', anchor: 'none', unilateral: false },
                { name: 'Développé debout (poulie moyenne)', anchor: 'door-middle', unilateral: false },
                { name: 'Développé debout (2 ancrages)', anchor: 'door-middle', unilateral: false },
                { name: 'Développé décliné', anchor: 'door-low', unilateral: false },
                { name: 'Développé incliné', anchor: 'door-high', unilateral: false },
                { name: 'Développé incliné (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Développé joint (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Développé joint (poulie haute)', anchor: 'door-high', unilateral: false },
                { name: 'Développé 1 ancrage (poulie haute)', anchor: 'door-high', unilateral: false },
                { name: 'Développé joint (poulie moyenne)', anchor: 'door-middle', unilateral: false },
                { name: 'Écarté unilatéral', anchor: 'door-middle', unilateral: true },
                { name: 'Écarté unilatéral (poulie basse)', anchor: 'door-low', unilateral: true },
                { name: 'Écarté unilatéral (poulie haute)', anchor: 'door-high', unilateral: true },
                { name: 'Pompes lestées', anchor: 'body', unilateral: false }
            ],
            triceps: [
                { name: 'Triceps barre au front', anchor: 'door-high', unilateral: false },
                { name: 'Extension triceps (poulie haute)', anchor: 'door-high', unilateral: false },
                { name: 'Extension triceps verticale', anchor: 'none', unilateral: false },
                { name: 'Extension triceps verticale (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Kickback triceps (poulie basse)', anchor: 'door-low', unilateral: false },
                { name: 'Kickback triceps unilatéral', anchor: 'door-low', unilateral: true }
            ]
        };

        // Base de données des synonymes pour la recherche intelligente
        const EXERCISE_SYNONYMS = {
            'biceps': ['bicep', 'bras', 'curl', 'flexion'],
            'triceps': ['tricep', 'extension', 'bras'],
            'epaules': ['épaule', 'shoulder', 'deltoide', 'deltoïde', 'lateral', 'frontal'],
            'dos': ['back', 'tirage', 'rowing', 'pull', 'traction'],
            'pectoraux': ['pec', 'chest', 'poitrine', 'développé', 'ecarté'],
            'jambes': ['leg', 'cuisse', 'squat', 'fente', 'mollet'],
            'echauffement': ['warmup', 'warm', 'prep', 'preparation', 'chauffe'],
            'abdos': ['abdominal', 'core', 'gainage', 'planche'],
            'cardio': ['course', 'vélo', 'rameur', 'endurance']
        };

        // Historique des recherches (stocké en localStorage)
        let searchHistory = JSON.parse(localStorage.getItem('exerciseSearchHistory') || '[]');

        // === BASE DE DONNÉES DES PROGRAMMES PRÉDÉFINIS ===
        const PREDEFINED_PROGRAMS = {
            // 🔰 DÉBUTANT (6-8 semaines)
            'forge-novice': {
                id: 'forge-novice',
                nom: 'FORGE DU NOVICE',
                sous_titre: 'Chapitre I de l\'Épopée',
                categorie: 'debutant',
                duree_semaines: 6,
                seances_par_semaine: 3,
                difficulte: 1,
                objectifs: [
                    'Découvrir ses vraies limites musculaires',
                    'Maîtrise de l\'échec musculaire contrôlé', 
                    'Construction des bases techniques',
                    'Éveil des muscles endormis',
                    'Préparation pour "RÉVEIL DU TITAN"'
                ],
                equipement_requis: [
                    'Kit élastiques : 5kg, 10kg, 15kg, 20kg, 30kg',
                    'Point d\'ancrage solide (porte, barre, etc.)',
                    'Espace de 2m x 2m minimum',
                    'Poignées confortables'
                ],
                description: 'Ton baptême du feu avec les élastiques. Dans la Forge du Novice, chaque série est une bataille menée jusqu\'au bout. Pas de demi-mesures, pas de compromis. Tu pousses jusqu\'à ce que tes muscles crient grâce - c\'est là que naît le guerrier.',
                philosophie: '🔥 PHILOSOPHIE DE L\'ÉCHEC MUSCULAIRE\n"L\'échec n\'est pas une fin, c\'est le signal que tes muscles ont tout donné. C\'est là que commence la vraie croissance."\n\nCe premier chapitre de ton épopée pose les fondations de fer sur lesquelles tu construiras ta légende.',
                progression_type: 'adaptive',
                disponible: true,
                image: 'forge-novice.jpg',
                niveau_utilisateur: {
                    'debutant_complet': {
                        titre: 'Débutant Complet',
                        elastiques: ['Élastique léger (5-10 kg)', 'Élastique moyen (10-15 kg)'],
                        description: 'Échauffement et finitions avec léger, exercices principaux avec moyen'
                    },
                    'experience_elastique': {
                        titre: 'Expérience Élastique',
                        elastiques: ['Élastique moyen (10-15 kg)', 'Élastique fort (15-25 kg)'],
                        description: 'Échauffement avec moyen, exercices composés avec fort'
                    },
                    'veteran_reconversion': {
                        titre: 'Vétéran en Reconversion',
                        elastiques: ['Élastique fort (20-30 kg)', 'Élastique très fort (30-40 kg)'],
                        description: 'Base de travail avec fort, mouvements principaux avec très fort'
                    }
                },
                resistances_par_exercice: {
                    'jambes': {
                        'debutant': '15-20 kg',
                        'experimente': '25-35 kg', 
                        'veteran': '35-50 kg'
                    },
                    'dos_pectoraux': {
                        'debutant': '10-15 kg',
                        'experimente': '20-30 kg',
                        'veteran': '30-40 kg'
                    },
                    'epaules_bras': {
                        'debutant': '5-10 kg',
                        'experimente': '15-25 kg',
                        'veteran': '25-35 kg'
                    }
                },
                structure_batailles: {
                    'bataille_a': {
                        nom: 'ASSAUT DU HAUT',
                        sous_titre: 'Forgez le torse d\'un conquérant',
                        duree: '35-45 minutes',
                        phase_eveil: '8-10 minutes : Rotations épaules, cercles de bras, jumping jacks',
                        phase_destruction: '25-35 minutes : 2 exos pectoraux, 2 exos dorsaux, 1 épaules, 1 biceps, 1 triceps'
                    },
                    'bataille_b': {
                        nom: 'CONQUÊTE DU BAS', 
                        sous_titre: 'Bâtissez les piliers de votre royaume',
                        duree: '35-45 minutes',
                        phase_eveil: '8-10 minutes : Squats poids du corps, fentes alternées, high knees',
                        phase_destruction: '25-35 minutes : 2 exos quadri/fessiers, 1 ischio, 1 mollets, 2-3 haut du corps'
                    },
                    'bataille_c': {
                        nom: 'UNIFICATION TOTALE',
                        sous_titre: 'Harmonisez votre armure corporelle', 
                        duree: '35-45 minutes',
                        phase_eveil: '8-10 minutes : Mix dynamique complet',
                        phase_destruction: '25-35 minutes : 1 full body, 1 dos, 1 pectoraux, 2 jambes, 2 épaules/bras'
                    }
                },
                progression_phases: {
                    'phase_1': {
                        semaines: '1-2',
                        nom: 'RÉVÉLATION',
                        objectif: 'Découvrir tes vraies limites',
                        series: '2-3 jusqu\'à l\'échec',
                        repos: '60-90 secondes',
                        focus: 'Trouver la bonne résistance pour chaque exercice'
                    },
                    'phase_2': {
                        semaines: '3-4', 
                        nom: 'ADAPTATION',
                        objectif: 'Repousser tes limites découvertes',
                        series: '3 jusqu\'à l\'échec',
                        repos: '75-90 secondes',
                        focus: 'Augmenter résistance quand échec > 15 reps'
                    },
                    'phase_3': {
                        semaines: '5-6',
                        nom: 'FORGE ARDENTE', 
                        objectif: 'Tremper ton acier dans le feu',
                        series: '3-4 jusqu\'à l\'échec',
                        repos: '90-120 secondes',
                        focus: 'Résistance maximale, technique parfaite'
                    }
                },
                principes_forge: [
                    'TECHNIQUE AVANT TOUT : Un mouvement parfait avec 10 kg vaut mieux que mille répétitions bâclées à 20 kg',
                    'PROGRESSION MESURÉE : Augmentation de résistance seulement si échec > 15 reps',
                    'RÉCUPÉRATION SACRÉE : 48h minimum entre les séances, hydratation constante, 7h de sommeil minimum'
                ],
                regle_or: 'Si tu termines ta série en pouvant faire 3 répétitions de plus, tu n\'as pas trouvé ton échec. Augmente la résistance !',
                heritage_forge: {
                    'physique': 'Base musculaire tonifiée, posture de guerrier',
                    'mental': 'Discipline de l\'échec musculaire acquise', 
                    'technique': '15+ mouvements maîtrisés à différentes résistances',
                    'preparation': 'Prêt pour le Chapitre II "RÉVEIL DU TITAN"'
                },
                transformation_garantie: [
                    'Muscles réveillés et sculptés',
                    'Force fonctionnelle doublée',
                    'Endurance de base établie', 
                    'Maîtrise des résistances 5-30 kg',
                    'Confiance de guerrier naissant'
                ],
                arsenal_principal: [
                    'Squat (15-20 kg) - Trône du roi des mouvements',
                    'Rowing buste penché (10-15 kg) - Épée dorsale', 
                    'Développé épaules debout (10-15 kg) - Lance pectorale',
                    'Curl biceps (5-10 kg) - Bouclier du bras',
                    'Extension triceps verticale (5-10 kg) - Marteau du triceps'
                ],
                conseils: [
                    'Contrôle total du mouvement avec amplitude complète',
                    'Contraction volontaire à chaque répétition',
                    'Technique parfaite = priorité absolue sur le poids',
                    'Ajout d\'une série en semaine 3 si maîtrise acquise',
                    '48h de récupération minimum entre chaque bataille'
                ],
                seances: [
                    // ⚔️ SEMAINE 1 - RÉVÉLATION DES LIMITES
                    {
                        id: 's1_bataille_a',
                        semaine: 1,
                        jour: 1,
                        jour_semaine: 'Lundi',
                        nom: 'Bataille A - Assaut du Haut',
                        type: 'strength',
                        duree_minutes: 45,
                        difficulte: 1,
                        philosophie: 'Cette semaine, tu découvres de quoi tu es vraiment capable. Chaque série jusqu\'à l\'échec révèle un fragment de ton potentiel.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Rotations épaules - 10 rotations avant/arrière',
                                'Cercles de bras - 10 cercles petits/grands', 
                                'Étirements dynamiques - 30 secondes chaque bras',
                                'Jumping jacks - 30 secondes',
                                'Montées de genoux - 20 répétitions'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Développé épaules debout',
                                groupe: 'PECTORAUX - "Forge ta cuirasse"',
                                resistance: '10-15 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Pieds écartés, tronc gainé, pousser jusqu\'à l\'extension complète',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé debout (poulie moyenne)',
                                groupe: 'PECTORAUX - "Forge ta cuirasse"',
                                resistance: '10-15 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Position de boxeur, contrôle la phase de retour',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Rowing buste penché',
                                groupe: 'DOS - "Bâtis ton bouclier"',
                                resistance: '10-15 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Buste penché à 45°, tire vers le sternum',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage poulie basse',
                                groupe: 'DOS - "Bâtis ton bouclier"',
                                resistance: '10-15 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Assis, torse droit, squeeze les omoplates',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Élévations latérales',
                                groupe: 'ÉPAULES - "Couronne du guerrier"',
                                resistance: '5-10 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Bras légèrement fléchis, monte jusqu\'aux épaules',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl biceps',
                                groupe: 'BICEPS - "Épées du bras"',
                                resistance: '5-10 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Coudes fixes, contraction maximale en haut',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extension triceps verticale',
                                groupe: 'TRICEPS - "Marteaux de force"',
                                resistance: '5-10 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Bras au-dessus de la tête, seuls les avant-bras bougent',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's1_bataille_b',
                        semaine: 1,
                        jour: 3,
                        jour_semaine: 'Mercredi',
                        nom: 'Bataille B - Conquête du Bas',
                        type: 'strength',
                        duree_minutes: 40,
                        difficulte: 1,
                        philosophie: 'Cette semaine, tu découvres de quoi tu es vraiment capable. Chaque série jusqu\'à l\'échec révèle un fragment de ton potentiel.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Squats au poids du corps - 15 répétitions',
                                'Fentes alternées - 10 de chaque jambe',
                                'High knees - 30 secondes',
                                'Pas chassés - 20 répétitions',
                                'Rotations de chevilles - 10 chaque pied'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Squat',
                                groupe: 'QUADRICEPS/FESSIERS - "Piliers du royaume"',
                                resistance: '15-20 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Pieds largeur d\'épaules, descente contrôlée, remontée explosive',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Front squat',
                                groupe: 'QUADRICEPS/FESSIERS - "Piliers du royaume"',
                                resistance: '15-20 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Élastique devant les épaules, torse plus droit',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Soulevé de terre jambes tendues',
                                groupe: 'ISCHIO-JAMBIERS - "Ressorts de puissance"',
                                resistance: '15-20 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Jambes semi-tendues, penche le buste en gardant le dos droit',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extensions mollets',
                                groupe: 'MOLLETS - "Ressorts d\'acier"',
                                resistance: '10-15 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Monte sur la pointe des pieds, contraction maximale',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé joint (poulie basse)',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '5-10 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60 secondes',
                                conseil: 'Mouvement lent et contrôlé',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Face Pull',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '5-10 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60 secondes',
                                conseil: 'Tire vers le visage, coudes hauts',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's1_bataille_c',
                        semaine: 1,
                        jour: 5,
                        jour_semaine: 'Vendredi',
                        nom: 'Bataille C - Unification Totale',
                        type: 'fullbody',
                        duree_minutes: 50,
                        difficulte: 1,
                        philosophie: 'Cette semaine, tu découvres de quoi tu es vraiment capable. Chaque série jusqu\'à l\'échec révèle un fragment de ton potentiel.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Mix complet - 2 minutes d\'échauffement dynamique',
                                'Planche - 20-30 secondes',
                                'Mountain climbers - 20 répétitions',
                                'Burpees - 5 répétitions',
                                'Étirements complets - 3 minutes'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Thruster',
                                groupe: 'FULL BODY - "Harmonie du guerrier"',
                                resistance: '15-20 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90 secondes',
                                conseil: 'Squat + développé militaire en un mouvement fluide',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage vertical',
                                groupe: 'DOS - "Colonne vertébrale du héros"',
                                resistance: '10-15 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Tire vers la poitrine, penche légèrement le buste',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé incliné',
                                groupe: 'PECTORAUX - "Armure frontale"',
                                resistance: '10-15 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Angle 45°, presse vers le haut et l\'avant',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Fentes',
                                groupe: 'JAMBES - "Fondations mobiles"',
                                resistance: '15-20 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '60-90 secondes',
                                conseil: 'Grand pas, genou arrière frôle le sol',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Hip thrust',
                                groupe: 'JAMBES - "Fondations mobiles"',
                                resistance: '15-20 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Allongé, pousse les hanches vers le ciel',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Overhead press',
                                groupe: 'ÉPAULES/BRAS - "Armes de précision"',
                                resistance: '5-10 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Debout, presse au-dessus de la tête',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl marteau',
                                groupe: 'ÉPAULES/BRAS - "Armes de précision"',
                                resistance: '5-10 kg',
                                series: 2,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-90 secondes',
                                conseil: 'Poignets neutres, contrôle total',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            }
                        ],
                        consignes_semaine: {
                            mission_principale: 'DÉCOUVRIR TES VRAIS LIMITES',
                            instructions: [
                                'Teste différentes résistances pour trouver ton échec entre 8-15 répétitions',
                                'Note tes performances pour la semaine suivante',
                                'La technique prime sur la résistance'
                            ],
                            signaux_alarme: [
                                'Douleur articulaire → Stop immédiat',
                                'Technique qui se dégrade → Diminue la résistance', 
                                'Pas d\'échec musculaire → Augmente la résistance'
                            ],
                            journal_guerrier: [
                                'Résistance utilisée',
                                'Nombre de répétitions à l\'échec',
                                'Sensation (facile/modéré/difficile/impossible)'
                            ]
                        }
                    },
                    
                    // ⚔️ SEMAINE 2 - CONFIRMATION DES FORCES
                    {
                        id: 's2_bataille_a',
                        semaine: 2,
                        jour: 1,
                        jour_semaine: 'Lundi',
                        nom: 'Bataille A - Assaut du Haut Renforcé',
                        type: 'strength',
                        duree_minutes: 50,
                        difficulte: 2,
                        philosophie: 'Tu connais maintenant tes limites. Cette semaine, tu les confirmes et commences à les repousser. La vraie forge commence.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Rotations épaules - 12 rotations avant/arrière',
                                'Cercles de bras - 12 cercles petits/grands', 
                                'Étirements dynamiques - 30 secondes chaque bras',
                                'Jumping jacks - 45 secondes',
                                'Montées de genoux - 25 répétitions'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Développé épaules debout',
                                groupe: 'PECTORAUX - "Cuirasse renforcée"',
                                resistance: '10-15 kg (augmente si échec > 15 reps semaine 1)',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Concentration maximale sur la contraction pectorale',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé debout (poulie moyenne)',
                                groupe: 'PECTORAUX - "Cuirasse renforcée"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Tempo plus lent sur la phase négative',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Rowing buste penché',
                                groupe: 'DOS - "Bouclier trempé"',
                                resistance: '10-15 kg (augmente si nécessaire)',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Squeeze plus fort les omoplates en fin de mouvement',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage poulie basse',
                                groupe: 'DOS - "Bouclier trempé"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Tire plus vers le sternum, moins vers le ventre',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Élévations latérales',
                                groupe: 'ÉPAULES - "Couronne du conquérant"',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Maintiens 1 seconde en haut de chaque répétition',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl biceps',
                                groupe: 'BICEPS - "Épées affûtées"',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Phase négative de 2 secondes',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extension triceps verticale',
                                groupe: 'TRICEPS - "Marteaux de guerre"',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Extension complète, contraction forte en bas',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's2_bataille_b',
                        semaine: 2,
                        jour: 3,
                        jour_semaine: 'Mercredi',
                        nom: 'Bataille B - Conquête du Bas Intensifiée',
                        type: 'strength',
                        duree_minutes: 45,
                        difficulte: 2,
                        philosophie: 'Tu connais maintenant tes limites. Cette semaine, tu les confirmes et commences à les repousser. La vraie forge commence.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Squats au poids du corps - 20 répétitions',
                                'Fentes alternées - 12 de chaque jambe',
                                'High knees - 45 secondes',
                                'Pas chassés - 25 répétitions',
                                'Rotations de chevilles - 12 chaque pied'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Squat',
                                groupe: 'QUADRICEPS/FESSIERS - "Piliers renforcés"',
                                resistance: '15-20 kg (augmente si échec > 15 reps)',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Descente en 3 secondes, remontée explosive',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Front squat',
                                groupe: 'QUADRICEPS/FESSIERS - "Piliers renforcés"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Maintiens le torse plus vertical, chest up !',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Soulevé de terre jambes tendues',
                                groupe: 'ISCHIO-JAMBIERS - "Ressorts de puissance"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Étirement maximal des ischio-jambiers en bas',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extensions mollets',
                                groupe: 'MOLLETS - "Ressorts d\'acier trempé"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Pause de 1 seconde en contraction maximale',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé joint (poulie basse)',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60 secondes',
                                conseil: 'Focus sur l\'amplitude maximale',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Face Pull',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60 secondes',
                                conseil: 'Coudes plus hauts, tire jusqu\'aux oreilles',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's2_bataille_c',
                        semaine: 2,
                        jour: 5,
                        jour_semaine: 'Vendredi',
                        nom: 'Bataille C - Unification Maîtrisée',
                        type: 'fullbody',
                        duree_minutes: 55,
                        difficulte: 2,
                        philosophie: 'Tu connais maintenant tes limites. Cette semaine, tu les confirmes et commences à les repousser. La vraie forge commence.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Mix complet - 3 minutes d\'échauffement dynamique',
                                'Planche - 30-40 secondes',
                                'Mountain climbers - 25 répétitions',
                                'Burpees - 7 répétitions',
                                'Étirements complets - 2 minutes'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Thruster',
                                groupe: 'FULL BODY - "Harmonie du conquérant"',
                                resistance: '15-20 kg (augmente si nécessaire)',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90 secondes',
                                conseil: 'Transition fluide squat-press, sans pause',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage vertical',
                                groupe: 'DOS - "Colonne vertébrale du héros"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Tire vers la clavicule, pas vers le sternum',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé incliné',
                                groupe: 'PECTORAUX - "Armure frontale"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Angle parfait, trajectoire vers l\'avant et le haut',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Fentes',
                                groupe: 'JAMBES - "Fondations mobiles"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '75-90 secondes',
                                conseil: 'Pas plus grand, descente plus profonde',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Hip thrust',
                                groupe: 'JAMBES - "Fondations mobiles"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Squeeze des fessiers en haut pendant 1 seconde',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Overhead press',
                                groupe: 'ÉPAULES/BRAS - "Armes de précision"',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Stabilité maximale du tronc, press vertical pur',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl marteau',
                                groupe: 'ÉPAULES/BRAS - "Armes de précision"',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Alternance des bras pour intensité maximale',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            }
                        ],
                        evolution_semaine: {
                            progressions_cles: [
                                'Volume : Passage de 2 à 3 séries sur tous les exercices',
                                'Intensité : Tempo plus contrôlé, contractions volontaires', 
                                'Technique : Affinement des mouvements appris semaine 1',
                                'Résistance : Ajustement selon tes performances semaine 1'
                            ],
                            nouveaux_defis: [
                                'Maintien de la technique sur 3 séries complètes',
                                'Gestion de la fatigue avec des temps de repos optimisés',
                                'Connexion muscle-cerveau renforcée'
                            ],
                            journal_comparaison: [
                                'As-tu progressé en nombre de répétitions ?',
                                'La résistance est-elle devenue plus facile ?',
                                'Ta technique s\'améliore-t-elle ?',
                                'Ton endurance augmente-t-elle ?'
                            ]
                        }
                    },
                    
                    // ⚔️ SEMAINE 3 - ADAPTATION ET ÉVOLUTION (Début Phase 2)
                    {
                        id: 's3_bataille_a',
                        semaine: 3,
                        jour: 1,
                        jour_semaine: 'Lundi',
                        nom: 'Bataille A - Assaut du Haut Évolutif',
                        type: 'strength',
                        duree_minutes: 55,
                        difficulte: 3,
                        philosophie: 'L\'adaptation commence. Ton corps n\'est plus celui d\'il y a deux semaines. Nouveaux défis, nouvelles armes, nouvelle intensité.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Rotations épaules - 15 rotations avant/arrière',
                                'Cercles de bras - 15 cercles petits/grands', 
                                'Étirements dynamiques - 45 secondes chaque bras',
                                'Jumping jacks - 1 minute',
                                'Montées de genoux - 30 répétitions'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Développé épaules debout',
                                groupe: 'PECTORAUX - "Cuirasse forgée"',
                                resistance: '12-18 kg (progression de +2-3 kg)',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Focus sur la sensation de brûlure, chaque rep compte',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé incliné (poulie basse)',
                                groupe: 'PECTORAUX - "Cuirasse forgée"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'ÉVOLUTION : Angle 45°, sensation dans la partie haute des pecs',
                                evolution: 'Passage à l\'incliné pour cibler différemment',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Rowing buste penché (prise large)',
                                groupe: 'DOS - "Bouclier de légende"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Tire vers le sternum haut, squeeze 1 seconde',
                                evolution: 'Prise large pour cibler les rhomboïdes',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Face Pull',
                                groupe: 'DOS - "Bouclier de légende"',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Coudes hauts, sépare les mains en fin de mouvement',
                                evolution: 'Remplacement du tirage poulie basse',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Cuban press',
                                groupe: 'ÉPAULES - "Couronne de fer"',
                                resistance: '5-10 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Rotation externe puis press, contrôle total',
                                evolution: 'Mouvement plus complexe que les élévations',
                                charge_base: 7,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl biceps face à la porte',
                                groupe: 'BICEPS - "Lames aiguisées"',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Corps penché en arrière, curl vers le front',
                                evolution: 'Angle différent pour nouvelle stimulation',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extension triceps (poulie haute)',
                                groupe: 'TRICEPS - "Marteaux de titan"',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Coudes fixes, extension complète',
                                evolution: 'Changement d\'angle pour variation',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's3_bataille_b',
                        semaine: 3,
                        jour: 3,
                        jour_semaine: 'Mercredi',
                        nom: 'Bataille B - Conquête du Bas Avancée',
                        type: 'strength',
                        duree_minutes: 50,
                        difficulte: 3,
                        philosophie: 'L\'adaptation commence. Ton corps n\'est plus celui d\'il y a deux semaines. Nouveaux défis, nouvelles armes, nouvelle intensité.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Squats au poids du corps - 25 répétitions',
                                'Fentes alternées - 15 de chaque jambe',
                                'High knees - 1 minute',
                                'Pas chassés - 30 répétitions',
                                'Rotations de hanches - 10 chaque direction'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Squat sumo',
                                groupe: 'QUADRICEPS/FESSIERS - "Piliers immortels"',
                                resistance: '18-25 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Pieds écartés, pointes vers l\'extérieur, descente profonde',
                                evolution: 'Stance large pour cibler différemment',
                                charge_base: 21,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Fentes bulgares',
                                groupe: 'QUADRICEPS/FESSIERS - "Piliers immortels"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '60-75 secondes',
                                conseil: 'Pied arrière surélevé, tout le poids sur la jambe avant',
                                evolution: 'Version unilatérale plus difficile',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Leg curl',
                                groupe: 'ISCHIO-JAMBIERS - "Câbles de puissance"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'À plat ventre, ramène les talons vers les fessiers',
                                evolution: 'Mouvement plus isolé',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extensions mollets unilatérales',
                                groupe: 'MOLLETS - "Ressorts de diamant"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '60-75 secondes',
                                conseil: 'Une jambe à la fois, amplitude maximale',
                                evolution: 'Unilatéral pour équilibrage',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé joint (poulie moyenne)',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60 secondes',
                                conseil: 'Bras joints, presse vers l\'avant',
                                evolution: 'Changement de hauteur d\'ancrage',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Rowing buste penché (prise serrée)',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60 secondes',
                                conseil: 'Coudes près du corps, tire vers le ventre',
                                evolution: 'Prise serrée pour les dorsaux',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's3_bataille_c',
                        semaine: 3,
                        jour: 5,
                        jour_semaine: 'Vendredi',
                        nom: 'Bataille C - Unification Perfectionnée',
                        type: 'fullbody',
                        duree_minutes: 60,
                        difficulte: 3,
                        philosophie: 'L\'adaptation commence. Ton corps n\'est plus celui d\'il y a deux semaines. Nouveaux défis, nouvelles armes, nouvelle intensité.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Planche - 45 secondes',
                                'Mountain climbers - 30 répétitions',
                                'Burpees - 8 répétitions',
                                'Squats sautés - 15 répétitions',
                                'Étirements dynamiques - 3 minutes'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Squat swing',
                                groupe: 'FULL BODY - "Symphonie du guerrier"',
                                resistance: '20-25 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75 secondes',
                                conseil: 'Squat + balancement, rythme soutenu',
                                evolution: 'Mouvement balistique plus complexe',
                                charge_base: 22,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage vertical (prise serrée)',
                                groupe: 'DOS - "Muraille dorsale"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Mains rapprochées, tire vers le sternum',
                                evolution: 'Prise serrée pour variation',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé décliné',
                                groupe: 'PECTORAUX - "Bouclier frontal"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Ancrage haut, presse vers le bas et l\'avant',
                                evolution: 'Angle décliné pour partie basse',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Hip thrust',
                                groupe: 'JAMBES - "Fondations dynamiques"',
                                resistance: '20-25 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Resistance augmentée, contraction maximale',
                                charge_base: 22,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Soulevé de terre',
                                groupe: 'JAMBES - "Fondations dynamiques"',
                                resistance: '20-25 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Dos droit, hanches en arrière, remontée puissante',
                                evolution: 'Mouvement complet jambes tendues',
                                charge_base: 22,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé arnold',
                                groupe: 'ÉPAULES/BRAS - "Arsenal perfectionné"',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Rotation + press, amplitude complète',
                                evolution: 'Mouvement complexe combiné',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl biceps avec poignée',
                                groupe: 'ÉPAULES/BRAS - "Arsenal perfectionné"',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Poignées neutres, concentration maximale',
                                evolution: 'Prise différente pour stimulation',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            }
                        ],
                        revolution_semaine: {
                            grandes_evolutions: [
                                'Exercices avancés : Introduction de mouvements plus complexes',
                                'Résistances augmentées : +2-5 kg selon les groupes musculaires',
                                'Temps de repos optimisés : 60-75 secondes pour intensité maximale',
                                'Angles variés : Stimulation musculaire sous de nouveaux angles'
                            ],
                            focus_mental: [
                                'Connexion muscle-cerveau : Ressens chaque fibre qui travaille',
                                'Qualité vs quantité : Mieux vaut 8 reps parfaites que 15 bâclées',
                                'Progression intelligente : Ton corps s\'adapte, tes entraînements évoluent'
                            ],
                            signaux_progression: [
                                'Force : Tu pousses plus lourd qu\'en semaine 1',
                                'Endurance : Tu récupères plus vite entre les séries',
                                'Technique : Tes mouvements sont plus fluides et précis',
                                'Mental : Tu anticipes l\'échec musculaire et l\'acceptes'
                            ],
                            nouvelles_metriques: [
                                'Adaptation aux nouveaux exercices (facile/difficile)',
                                'Gestion de la fatigue avec repos réduits',
                                'Sensation musculaire sur les nouvelles variantes',
                                'Progression générale depuis le début'
                            ]
                        }
                    },
                    
                    // ⚔️ SEMAINE 4 - CONSOLIDATION DU POUVOIR (Fin Phase 2)
                    {
                        id: 's4_bataille_a',
                        semaine: 4,
                        jour: 1,
                        jour_semaine: 'Lundi',
                        nom: 'Bataille A - Assaut du Haut Consolidé',
                        type: 'strength',
                        duree_minutes: 55,
                        difficulte: 3,
                        philosophie: 'La consolidation du pouvoir. Tu maîtrises maintenant tes nouvelles armes. Cette semaine, tu les perfectionnes et tu confirmes ta domination.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Rotations épaules - 15 rotations avant/arrière',
                                'Cercles de bras - 15 cercles petits/grands', 
                                'Étirements dynamiques - 45 secondes chaque bras',
                                'Jumping jacks - 1 minute',
                                'Pompes - 10 répétitions (activation)'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Développé épaules debout',
                                groupe: 'PECTORAUX - "Cuirasse de maître"',
                                resistance: '15-20 kg (progression continue)',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Maîtrise totale, chaque rep est un chef-d\'œuvre',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé incliné (poulie basse)',
                                groupe: 'PECTORAUX - "Cuirasse de maître"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Consolidation de la technique acquise semaine 3',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Rowing buste penché (prise large)',
                                groupe: 'DOS - "Forteresse imprenable"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Prise large maîtrisée, activation parfaite des rhomboïdes',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Face Pull',
                                groupe: 'DOS - "Forteresse imprenable"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Mouvement fluide, coordination parfaite',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Cuban press',
                                groupe: 'ÉPAULES - "Diadème du conquérant"',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Maîtrise du mouvement complexe, fluidité maximale',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl marteau (poulie basse)',
                                groupe: 'BICEPS - "Épées du maître d\'armes"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Position basse, tire vers le haut, poignets neutres',
                                evolution: 'Changement d\'angle pour nouvelle stimulation',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extension triceps (poulie haute)',
                                groupe: 'TRICEPS - "Massues de titan"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Technique parfaitement rodée, résistance optimisée',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's4_bataille_b',
                        semaine: 4,
                        jour: 3,
                        jour_semaine: 'Mercredi',
                        nom: 'Bataille B - Conquête du Bas Maîtrisée',
                        type: 'strength',
                        duree_minutes: 50,
                        difficulte: 3,
                        philosophie: 'La consolidation du pouvoir. Tu maîtrises maintenant tes nouvelles armes. Cette semaine, tu les perfectionnes et tu confirmes ta domination.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Squats au poids du corps - 30 répétitions',
                                'Fentes alternées - 20 de chaque jambe',
                                'High knees - 1 minute',
                                'Pas chassés - 35 répétitions',
                                'Rotations de hanches - 12 chaque direction'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Squat sumo',
                                groupe: 'QUADRICEPS/FESSIERS - "Colonnes de marbre"',
                                resistance: '20-28 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Stance large parfaitement maîtrisée, descente maximale',
                                charge_base: 24,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Fentes bulgares',
                                groupe: 'QUADRICEPS/FESSIERS - "Colonnes de marbre"',
                                resistance: '18-25 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '75-90 secondes',
                                conseil: 'Équilibre parfait, charge maximale sur jambe avant',
                                charge_base: 21,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Leg curl',
                                groupe: 'ISCHIO-JAMBIERS - "Ressorts d\'adamantium"',
                                resistance: '18-25 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Isolation parfaite, contraction maximale',
                                charge_base: 21,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extensions mollets unilatérales',
                                groupe: 'MOLLETS - "Piliers d\'acier"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '75-90 secondes',
                                conseil: 'Équilibrage parfait entre les deux jambes',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé joint (poulie moyenne)',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Technique consolidée, résistance adaptée',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage bucheron (poulie basse)',
                                groupe: 'HAUT DU CORPS (Récupération active)',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '60-75 secondes',
                                conseil: 'Une main à la fois, rotation du tronc',
                                evolution: 'Mouvement unilatéral pour équilibrage',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's4_bataille_c',
                        semaine: 4,
                        jour: 5,
                        jour_semaine: 'Vendredi',
                        nom: 'Bataille C - Unification Suprême',
                        type: 'fullbody',
                        duree_minutes: 60,
                        difficulte: 3,
                        philosophie: 'La consolidation du pouvoir. Tu maîtrises maintenant tes nouvelles armes. Cette semaine, tu les perfectionnes et tu confirmes ta domination.',
                        phase_eveil: {
                            duree: '8-10 minutes',
                            exercices: [
                                'Planche - 50 secondes',
                                'Mountain climbers - 35 répétitions',
                                'Burpees - 10 répétitions',
                                'Squats sautés - 20 répétitions',
                                'Étirements dynamiques - 2 minutes'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Squat swing',
                                groupe: 'FULL BODY - "Harmonie absolue"',
                                resistance: '22-28 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90 secondes',
                                conseil: 'Rythme maîtrisé, puissance contrôlée',
                                charge_base: 25,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage vertical (prise serrée)',
                                groupe: 'DOS - "Citadelle dorsale"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Prise serrée parfaitement exécutée',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé décliné',
                                groupe: 'PECTORAUX - "Plastron royal"',
                                resistance: '15-20 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Angle décliné maîtrisé, partie basse ciblée',
                                charge_base: 17,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Hip thrust',
                                groupe: 'JAMBES - "Socle inébranlable"',
                                resistance: '22-28 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Résistance maximale, fessiers de fer',
                                charge_base: 25,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Soulevé de terre',
                                groupe: 'JAMBES - "Socle inébranlable"',
                                resistance: '22-28 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Mouvement roi consolidé, technique irréprochable',
                                charge_base: 25,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé arnold',
                                groupe: 'ÉPAULES/BRAS - "Artillerie de précision"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Rotation fluide, mouvement artistique',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Kickback triceps (poulie basse)',
                                groupe: 'ÉPAULES/BRAS - "Artillerie de précision"',
                                resistance: '8-12 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '75-90 secondes',
                                conseil: 'Buste penché, extension arrière pure',
                                evolution: 'Nouveau mouvement pour finaliser la phase',
                                charge_base: 10,
                                progression_type: 'adaptive'
                            }
                        ],
                        consolidation_semaine: {
                            maitrise_acquise: [
                                'Technique : Tous les mouvements de la semaine 3 sont consolidés',
                                'Résistances : Progression naturelle de +2-5 kg selon les exercices',
                                'Endurance : Capacité à maintenir l\'intensité sur 3 séries complètes',
                                'Confiance : Tu maîtrises ton arsenal d\'exercices avancés'
                            ],
                            adaptations_physiologiques: [
                                'Force : Augmentation significative depuis le début',
                                'Masse musculaire : Premières modifications visibles',
                                'Endurance : Récupération améliorée entre séries',
                                'Coordination : Mouvements complexes intégrés'
                            ],
                            evolution_mentale: [
                                'Discipline : L\'échec musculaire devient naturel',
                                'Persévérance : Tu ne lâches jamais avant la vraie limite',
                                'Progression : Tu anticipes et planifies tes améliorations',
                                'Confiance : Tu te sens devenir un vrai guerrier'
                            ],
                            bilan_mi_parcours: [
                                'Résistances utilisées : +30-50% d\'augmentation vs semaine 1',
                                'Volume total : +50% (passage de 2 à 3 séries)',
                                'Complexité : Exercices 2-3 fois plus techniques',
                                'Endurance : Séances 30% plus longues'
                            ],
                            preparation_finale: 'La semaine 5 marquera l\'entrée dans la FORGE ARDENTE - la phase finale où tu vas repousser tes limites absolues avec 3-4 séries et des résistances maximales. Ton corps est maintenant prêt pour cette ultime épreuve.'
                        }
                    },
                    
                    // ⚔️ SEMAINE 5 - FORGE ARDENTE COMMENCE (Phase 3)
                    {
                        id: 's5_bataille_a',
                        semaine: 5,
                        jour: 1,
                        jour_semaine: 'Lundi',
                        nom: 'Bataille A - Assaut du Haut Incandescent',
                        type: 'strength',
                        duree_minutes: 62,
                        difficulte: 4,
                        philosophie: 'Bienvenue dans la Forge Ardente. Ici, l\'acier ordinaire fond et seuls les métaux nobles survivent. Tu vas découvrir de quoi tu es vraiment fait.',
                        phase_eveil: {
                            duree: '10-12 minutes',
                            exercices: [
                                'Rotations épaules - 20 rotations avant/arrière',
                                'Cercles de bras - 20 cercles petits/grands',
                                'Pompes - 15 répétitions (activation complète)',
                                'Planche - 30 secondes',
                                'Étirements dynamiques - 60 secondes chaque bras',
                                'Jumping jacks - 90 secondes'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Développé épaules debout',
                                groupe: 'PECTORAUX - "Cuirasse de feu"',
                                resistance: '18-25 kg (montée significative)',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Résistance maximale, technique irréprochable malgré l\'intensité',
                                charge_base: 21,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé 1 ancrage (poulie haute)',
                                groupe: 'PECTORAUX - "Cuirasse de feu"',
                                resistance: '15-22 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Un seul point d\'ancrage, stabilisation maximale du tronc',
                                evolution: 'Nouvel angle, ancrage unique pour instabilité',
                                charge_base: 18,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Rowing buste penché (prise large)',
                                groupe: 'DOS - "Muraille incandescente"',
                                resistance: '18-25 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Résistance maximale, garde la forme à tout prix',
                                charge_base: 21,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Pull-Over',
                                groupe: 'DOS - "Muraille incandescente"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Allongé, bras tendus, arc de cercle complet',
                                evolution: 'Exercice advanced pour les dorsaux/pecs',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé militaire assis',
                                groupe: 'ÉPAULES - "Brasier royal"',
                                resistance: '12-18 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Dos droit, press vertical strict',
                                evolution: 'Position assise pour isolation pure',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl biceps avec poignée',
                                groupe: 'BICEPS - "Forges des bras"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Résistance lourde, concentration maximale',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Triceps barre au front',
                                groupe: 'TRICEPS - "Enclumes de puissance"',
                                resistance: '12-18 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Allongé, barre vers le front, coudes fixes',
                                evolution: 'Mouvement couché plus intense',
                                charge_base: 15,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's5_bataille_b',
                        semaine: 5,
                        jour: 3,
                        jour_semaine: 'Mercredi',
                        nom: 'Bataille B - Conquête du Bas Infernale',
                        type: 'strength',
                        duree_minutes: 62,
                        difficulte: 4,
                        philosophie: 'Bienvenue dans la Forge Ardente. Ici, l\'acier ordinaire fond et seuls les métaux nobles survivent. Tu vas découvrir de quoi tu es vraiment fait.',
                        phase_eveil: {
                            duree: '10-12 minutes',
                            exercices: [
                                'Squats au poids du corps - 40 répétitions',
                                'Fentes alternées - 25 de chaque jambe',
                                'High knees - 90 secondes',
                                'Burpees - 10 répétitions',
                                'Rotations de hanches - 15 chaque direction',
                                'Pas chassés - 50 répétitions'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Squat',
                                groupe: 'QUADRICEPS/FESSIERS - "Fondations de diamant"',
                                resistance: '25-35 kg (retour au classique avec charge lourde)',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Le roi des exercices avec résistance de maître',
                                charge_base: 30,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Fentes bulgares',
                                groupe: 'QUADRICEPS/FESSIERS - "Fondations de diamant"',
                                resistance: '20-28 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '90-120 secondes',
                                conseil: 'Résistance maximale, équilibre parfait',
                                charge_base: 24,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Soulevé de terre (prise large)',
                                groupe: 'ISCHIO-JAMBIERS - "Câbles d\'acier trempé"',
                                resistance: '25-35 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Prise large, même technique parfaite',
                                evolution: 'Prise large pour variation',
                                charge_base: 30,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Extensions mollets',
                                groupe: 'MOLLETS - "Ressorts titanesques"',
                                resistance: '15-22 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Retour au bilatéral avec charge maximale',
                                charge_base: 18,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Écarté unilatéral',
                                groupe: 'HAUT DU CORPS (Intensité soutenue)',
                                resistance: '8-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec (chaque bras)',
                                temps_repos: '90 secondes',
                                conseil: 'Un bras à la fois, arc de cercle complet',
                                evolution: 'Nouvel exercice pectoral intense',
                                charge_base: 11,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Reverse fly',
                                groupe: 'HAUT DU CORPS (Intensité soutenue)',
                                resistance: '8-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90 secondes',
                                conseil: 'Buste penché, ouvre les bras vers l\'arrière',
                                charge_base: 11,
                                progression_type: 'adaptive'
                            }
                        ]
                    },
                    {
                        id: 's5_bataille_c',
                        semaine: 5,
                        jour: 5,
                        jour_semaine: 'Vendredi',
                        nom: 'Bataille C - Unification Légendaire',
                        type: 'fullbody',
                        duree_minutes: 65,
                        difficulte: 4,
                        philosophie: 'Bienvenue dans la Forge Ardente. Ici, l\'acier ordinaire fond et seuls les métaux nobles survivent. Tu vas découvrir de quoi tu es vraiment fait.',
                        phase_eveil: {
                            duree: '10-12 minutes',
                            exercices: [
                                'Planche - 60 secondes',
                                'Mountain climbers - 40 répétitions',
                                'Burpees - 12 répétitions',
                                'Pompes - 20 répétitions',
                                'Squats sautés - 25 répétitions',
                                'Étirements complets - 3 minutes'
                            ]
                        },
                        exercices: [
                            {
                                nom: 'Thruster',
                                groupe: 'FULL BODY - "Fusion nucléaire"',
                                resistance: '25-32 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '120 secondes',
                                conseil: 'Résistance de légende, mouvement roi maîtrisé',
                                charge_base: 28,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Tirage vertical (supination)',
                                groupe: 'DOS - "Forteresse éternelle"',
                                resistance: '18-25 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Paumes vers toi, tire vers la poitrine',
                                evolution: 'Prise supination pour variation',
                                charge_base: 21,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Développé joint (poulie haute)',
                                groupe: 'PECTORAUX - "Armure légendaire"',
                                resistance: '15-22 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Bras joints, trajectoire descendante',
                                evolution: 'Ancrage haut pour angle descendant',
                                charge_base: 18,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Front squat',
                                groupe: 'JAMBES - "Piliers d\'éternité"',
                                resistance: '22-30 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Résistance maximale en position frontale',
                                charge_base: 26,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Donkey kick',
                                groupe: 'JAMBES - "Piliers d\'éternité"',
                                resistance: '15-22 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec (chaque jambe)',
                                temps_repos: '90-120 secondes',
                                conseil: 'À quatre pattes, pousse la jambe vers l\'arrière',
                                evolution: 'Exercice intense pour les fessiers',
                                charge_base: 18,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Shrug',
                                groupe: 'ÉPAULES/BRAS - "Artillerie divine"',
                                resistance: '20-28 kg',
                                series: 4,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Haussement d\'épaules, résistance maximale',
                                evolution: 'Trapèzes en force pure',
                                charge_base: 24,
                                progression_type: 'adaptive'
                            },
                            {
                                nom: 'Curl biceps en pronation',
                                groupe: 'ÉPAULES/BRAS - "Artillerie divine"',
                                resistance: '10-15 kg',
                                series: 3,
                                repetitions: 'jusqu\'à l\'échec',
                                temps_repos: '90-120 secondes',
                                conseil: 'Paumes vers le bas, travail intense',
                                evolution: 'Prise en pronation pour difficulté',
                                charge_base: 12,
                                progression_type: 'adaptive'
                            }
                        ],
                        forge_ardente: {
                            intensite_maximale: [
                                'Volume : 3-4 séries sur tous les exercices principaux',
                                'Résistances : +20-30% par rapport à la semaine 1',
                                'Repos : 90-120 secondes pour récupération optimale',
                                'Nouveaux défis : Exercices avancés introduits'
                            ],
                            adaptations_majeures: [
                                'Force : Tu soulèves maintenant des charges considérables',
                                'Endurance : Tu maintiens l\'intensité sur 4 séries',
                                'Technique : Mouvements complexes parfaitement exécutés',
                                'Mental : L\'échec musculaire est ton territoire de prédilection'
                            ],
                            philosophie_forge: 'Dans la chaleur extrême, les impuretés sont éliminées et seule la perfection demeure. Chaque série est un passage dans les flammes qui te forge en guerrier d\'élite.',
                            metriques_performance: [
                                'Maintenir la technique parfaite malgré les charges lourdes',
                                'Atteindre l\'échec musculaire sur chaque série',
                                'Gérer 4 séries sans dégradation de performance',
                                'Intégrer les nouveaux exercices avancés'
                            ],
                            signaux_maitrise: [
                                'Technique stable : Même sous charge maximale',
                                'Récupération contrôlée : Prêt pour la série suivante',
                                'Mental d\'acier : Tu cherches l\'échec musculaire',
                                'Progression constante : Chaque séance te renforce'
                            ]
                        }
                    }
                    // ... Semaine 6 viendra finaliser l'épopée du Chapitre I
                ]
            },
            
            // Programmes "Bientôt disponible"
            'reveil-titan': {
                id: 'reveil-titan',
                nom: 'RÉVEIL DU TITAN',
                categorie: 'debutant',
                duree_semaines: 7,
                seances_par_semaine: 6,
                difficulte: 2,
                objectifs: ['Réveil musculaire', 'Force de base', 'Transformation'],
                equipement_requis: ['Élastique léger', 'Élastique moyen', 'Élastique fort'],
                description: 'Réveille la bête qui sommeille en toi. Programme complet pour découvrir ta force cachée et transformer ton corps de civil en machine de guerre.',
                disponible: false,
                image: 'reveil-titan.jpg'
            },
            'premiere-bataille': {
                id: 'premiere-bataille',
                nom: 'PREMIÈRE BATAILLE',
                categorie: 'debutant',
                duree_semaines: 8,
                seances_par_semaine: 6,
                difficulte: 2,
                objectifs: ['Combat méthodique', 'Tous groupes musculaires', 'Discipline'],
                equipement_requis: ['Kit complet élastiques', 'Ancrage porte', 'Sangle cheville'],
                description: 'Ta première vraie campagne militaire. Affrontage méthodique de tous les groupes musculaires avec la sagesse de l\'élastique comme seule arme.',
                disponible: false,
                image: 'premiere-bataille.jpg'
            },
            'chemin-samourai': {
                id: 'chemin-samourai',
                nom: 'CHEMIN DU SAMOURAÏ',
                categorie: 'debutant',
                duree_semaines: 6,
                seances_par_semaine: 5,
                difficulte: 2,
                objectifs: ['Discipline', 'Précision', 'Art martial'],
                equipement_requis: ['Élastiques légers', 'Focus technique'],
                description: 'La voie du guerrier discipliné. Chaque mouvement compte, chaque série forge ton caractère. L\'art martial de la musculation aux élastiques.',
                disponible: false,
                image: 'chemin-samourai.jpg'
            },
            'eveil-gladiateur': {
                id: 'eveil-gladiateur',
                nom: 'ÉVEIL DU GLADIATEUR',
                categorie: 'debutant',
                duree_semaines: 7,
                seances_par_semaine: 6,
                difficulte: 3,
                objectifs: ['Équilibre', 'Mental d\'acier', 'Préparation bataille'],
                equipement_requis: ['Kit élastiques complet', 'Ancrage porte'],
                description: 'De l\'arène des débutants vers la gloire. Programme équilibré qui sculpte ton corps et trempe ton mental pour les batailles à venir.',
                disponible: false,
                image: 'eveil-gladiateur.jpg'
            },

            // ⚔️ INTERMÉDIAIRE (8-12 semaines)
            'lame-affutee': {
                id: 'lame-affutee',
                nom: 'LAME AFFÛTÉE',
                categorie: 'intermediaire',
                duree_semaines: 10,
                seances_par_semaine: 6,
                difficulte: 3,
                objectifs: ['Techniques avancées', 'Intensité accrue', 'Arme vivante'],
                equipement_requis: ['Kit élastiques complet', 'Techniques avancées'],
                description: 'Aiguise ton corps comme une lame de combat. Techniques plus poussées et intensité accrue pour devenir une arme vivante.',
                disponible: false,
                image: 'lame-affutee.jpg'
            },
            'conquerant-plaines': {
                id: 'conquerant-plaines',
                nom: 'CONQUÉRANT DES PLAINES',
                categorie: 'intermediaire',
                duree_semaines: 12,
                seances_par_semaine: 6,
                difficulte: 3,
                objectifs: ['Stratégie militaire', 'Territoire musculaire', 'Tactique'],
                equipement_requis: ['Kit élastiques avancé', 'Combinaisons complexes'],
                description: 'Étends ton territoire musculaire avec la stratégie d\'un général. Combinaisons d\'exercices et progression tactique vers la victoire.',
                disponible: false,
                image: 'conquerant-plaines.jpg'
            },
            'fureur-berserker': {
                id: 'fureur-berserker',
                nom: 'FUREUR DU BERSERKER',
                categorie: 'intermediaire',
                duree_semaines: 8,
                seances_par_semaine: 6,
                difficulte: 4,
                objectifs: ['Rage contrôlée', 'Limites repoussées', 'Mental d\'acier'],
                equipement_requis: ['Élastiques forts', 'Intensité maximale'],
                description: 'Déchaîne ta rage contrôlée ! Programme intense qui pousse tes limites et forge un mental d\'acier trempé dans le feu.',
                disponible: false,
                image: 'fureur-berserker.jpg'
            },
            'gardien-temple': {
                id: 'gardien-temple',
                nom: 'GARDIEN DU TEMPLE',
                categorie: 'intermediaire',
                duree_semaines: 11,
                seances_par_semaine: 6,
                difficulte: 3,
                objectifs: ['Forteresse corporelle', 'Équilibre parfait', 'Sentinelle'],
                equipement_requis: ['Kit complet', 'Exercices d\'équilibre'],
                description: 'Protège et renforce ta forteresse corporelle. Équilibre parfait entre force, endurance et technique pour un corps de sentinelle.',
                disponible: false,
                image: 'gardien-temple.jpg'
            },
            'renaissance-phenix': {
                id: 'renaissance-phenix',
                nom: 'RENAISSANCE DU PHÉNIX',
                categorie: 'intermediaire',
                duree_semaines: 9,
                seances_par_semaine: 6,
                difficulte: 4,
                objectifs: ['Transformation profonde', 'Guerrier légendaire', 'Renaissance'],
                equipement_requis: ['Kit élastiques pro', 'Dépassement de soi'],
                description: 'Renaître de ses cendres, plus fort que jamais. Transformation profonde qui révèle le guerrier légendaire en toi.',
                disponible: false,
                image: 'renaissance-phenix.jpg'
            }

            // Les autres programmes suivront le même format avec disponible: false
        };

        // === GESTIONNAIRE DE PROGRESSION ===
        class ProgressionManager {
            
            // Progression linéaire : +2.5kg/semaine
            progressionLineaire(chargeActuelle, semaine) {
                return chargeActuelle + (semaine * 2.5);
            }
            
            // Progression par paliers : +5kg toutes les 2 semaines
            progressionPaliers(chargeActuelle, semaine) {
                const palier = Math.floor(semaine / 2);
                return chargeActuelle + (palier * 5);
            }
            
            // Progression adaptative basée sur RPE
            progressionAdaptative(chargeActuelle, rpeHistorique) {
                const rpeMoyenne = this.calculateAverageRPE(rpeHistorique);
                
                if (rpeMoyenne < 6) {
                    return chargeActuelle * 1.1; // +10%
                } else if (rpeMoyenne > 8) {
                    return chargeActuelle * 0.95; // -5%
                } else {
                    return chargeActuelle * 1.05; // +5%
                }
            }

            calculateAverageRPE(rpeHistorique) {
                if (!rpeHistorique || rpeHistorique.length === 0) return 7;
                const sum = rpeHistorique.reduce((acc, rpe) => acc + rpe, 0);
                return sum / rpeHistorique.length;
            }
            
            // Sélection automatique de l'algorithme
            appliquerProgression(programme, seance, utilisateur) {
                const typeProgression = programme.progression_type || 'linear';
                const niveau = utilisateur.niveau || 'beginner';
                
                switch(typeProgression) {
                    case 'linear':
                        return this.progressionLineaire(seance.charge, seance.semaine);
                    case 'step':
                        return this.progressionPaliers(seance.charge, seance.semaine);
                    case 'adaptive':
                        return this.progressionAdaptative(seance.charge, utilisateur.rpeHistorique);
                    default:
                        return this.progressionLineaire(seance.charge, seance.semaine);
                }
            }
        }

        // Instance globale du gestionnaire de progression
        const progressionManager = new ProgressionManager();

        // Fonctions de recherche intelligente
        const smartSearch = {
            // Fonction principale de recherche
            search(query, exercises = appState.exercises) {
                if (!query || query.length < 1) {
                    return exercises;
                }
                
                // Si la query est très courte (1 caractère), retourner tous les exercices
                if (query.length < 2) {
                    return exercises;
                }
                
                query = query.toLowerCase().trim();
                
                // Vérifier le cache
                const cacheKey = { query, exercisesCount: exercises.length };
                const cached = smartCache.get('exerciseSearch', cacheKey);
                if (cached) {
                    console.log('🔍 Résultats de recherche récupérés du cache');
                    this.addToHistory(query);
                    return cached;
                }
                
                console.log('🔍 Recherche d\'exercices...');
                this.addToHistory(query);

                const results = exercises.filter(exercise => {
                    return this.matchExercise(exercise, query);
                });

                // Mettre en cache les résultats et les retourner
                const sortedResults = this.sortByRelevance(results, query);
                return smartCache.set('exerciseSearch', cacheKey, sortedResults);
            },
        
            // Vérifier si un exercice correspond à la recherche
            matchExercise(exercise, query) {
                const searchTerms = query.split(' ').filter(term => term.length > 1);
            
                return searchTerms.every(term => {
                    // Recherche dans le nom
                    if (exercise.name.toLowerCase().includes(term)) return true;
                    
                    // Recherche dans le groupe musculaire
                    if (exercise.muscle_group && exercise.muscle_group.toLowerCase().includes(term)) return true;
                    
                    // Recherche avec tolérance aux fautes de frappe (distance de Levenshtein simplifiée)
                    if (this.fuzzyMatch(exercise.name.toLowerCase(), term)) return true;
                    
                    // Recherche dans les synonymes
                    if (this.matchSynonyms(exercise.muscle_group, term)) return true;
                    
                    // Recherche dans le type d'ancrage
                    if (exercise.anchor_point && this.matchAnchor(exercise.anchor_point, term)) return true;
                    
                    return false;
                });
            },
        
            // Correspondance floue pour les fautes de frappe
            fuzzyMatch(text, term) {
                if (term.length < 3) return false;
            
                // Recherche avec 1 caractère de différence maximum
                for (let i = 0; i <= text.length - term.length; i++) {
                    const substring = text.substring(i, i + term.length);
                    if (this.levenshteinDistance(substring, term) <= 1) {
                        return true;
                    }
                }
                return false;
            },
        
            // Distance de Levenshtein simplifiée
            levenshteinDistance(str1, str2) {
                if (str1.length !== str2.length) return 999;
                let diff = 0;
                for (let i = 0; i < str1.length; i++) {
                    if (str1[i] !== str2[i]) diff++;
                }
                return diff;
            },
        
            // Correspondance avec les synonymes
            matchSynonyms(muscleGroup, term) {
                if (!muscleGroup || !EXERCISE_SYNONYMS[muscleGroup]) return false;
                
                return EXERCISE_SYNONYMS[muscleGroup].some(synonym => 
                    synonym.toLowerCase().includes(term) || term.includes(synonym.toLowerCase())
                );
            },
        
            // Correspondance avec les points d'ancrage
            matchAnchor(anchorPoint, term) {
                const anchorTerms = {
                    'door': ['porte', 'door'],
                    'floor': ['sol', 'pied', 'floor'],
                    'body': ['corps', 'body'],
                    'none': ['libre', 'sans', 'none'],
                    'external': ['extérieur', 'externe', 'external']
                };
                
                for (const [anchor, terms] of Object.entries(anchorTerms)) {
                    if (anchorPoint.includes(anchor) && terms.some(t => term.includes(t))) {
                        return true;
                    }
                }
                return false;
            },
        
            // Trier par pertinence
            sortByRelevance(results, query) {
                return results.sort((a, b) => {
                    const scoreA = this.calculateRelevanceScore(a, query);
                    const scoreB = this.calculateRelevanceScore(b, query);
                    return scoreB - scoreA;
                });
            },
        
            // Calculer le score de pertinence
            calculateRelevanceScore(exercise, query) {
                let score = 0;
                const lowerQuery = query.toLowerCase();
                const lowerName = exercise.name.toLowerCase();
                
                // Correspondance exacte dans le nom = score max
                if (lowerName.includes(lowerQuery)) score += 100;
                
                // Correspondance au début du nom
                if (lowerName.startsWith(lowerQuery)) score += 50;
                
                // Correspondance dans le groupe musculaire
                if (exercise.muscle_group && exercise.muscle_group.toLowerCase().includes(lowerQuery)) {
                    score += 30;
                }
                
                // Bonus pour les exercices populaires
                const popularExercises = ['curl', 'squat', 'développé', 'tirage', 'fente'];
                if (popularExercises.some(pop => lowerName.includes(pop))) score += 10;
                
                return score;
            },
        
            // Ajouter à l'historique
            addToHistory(query) {
                // Éviter les doublons
                searchHistory = searchHistory.filter(item => item.query !== query);
                
                // Ajouter en première position
                searchHistory.unshift({
                    query: query,
                    timestamp: Date.now()
                });
                
                // Limiter à 10 recherches
                if (searchHistory.length > 10) {
                    searchHistory = searchHistory.slice(0, 10);
                }
                
                // Sauvegarder dans localStorage
                storage.save('searchHistory', searchHistory);
            },
        
            // Charger l'historique
            loadHistory() {
                searchHistory = storage.load('searchHistory', []);
                return searchHistory;
            },
        
            // Effacer l'historique
            clearHistory() {
                searchHistory = [];
                storage.remove('searchHistory');
            }
        };

        class ExerciseTimer {
            constructor() {
                this.duration = 0;
                this.timeLeft = 0;
                this.isRunning = false;
                this.isPaused = false;
                this.interval = null;
                this.audioContext = null;
                this.onTick = null;
                this.onComplete = null;
                this.lastBeepSecond = null;
                
                // Initialiser le contexte audio
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio non supporté');
                }
            }
            
            // Configurer le timer
            setup(duration, onTick, onComplete) {
                this.duration = duration;
                this.timeLeft = duration;
                this.onTick = onTick;
                this.onComplete = onComplete;
                this.isRunning = false;
                this.isPaused = false;
                
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
            
            // Démarrer le timer
            start() {
                if (this.isRunning && !this.isPaused) return;
                this.isRunning = true;
                this.isPaused = false;
                
                // Réinitialiser le dernier bip
                this.lastBeepSecond = this.timeLeft + 1;
                
                this.interval = setInterval(() => {
                    if (this.timeLeft > 0) {
                        this.timeLeft--;
                        
                        // Appeler la fonction de mise à jour
                        if (this.onTick) {
                            this.onTick(this.timeLeft, this.duration);
                        }
                        
                        // Alertes sonores améliorées - bip de 5 à 2 secondes (pas à 1 pour éviter le double bip)
                        if (this.timeLeft <= 5 && this.timeLeft > 1 && this.timeLeft !== this.lastBeepSecond) {
                            this.lastBeepSecond = this.timeLeft;
                            this.playBeep(800, 200);
                            // Vibration dans les dernières secondes
                            if ('vibrate' in navigator) {
                                navigator.vibrate(100);
                            }
                        }
                    } else {
                        // Timer terminé
                        this.complete();
                    }
                }, 1000);
            }
            
            // Mettre en pause
            pause() {
                this.isPaused = true;
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
            
            // Arrêter complètement
            stop() {
                this.isRunning = false;
                this.isPaused = false;
                if (this.interval) {
                    clearInterval(this.interval);
                }
                this.timeLeft = this.duration;
            }
            
            // Timer terminé
            complete() {
                this.isRunning = false;
                this.isPaused = false;
                if (this.interval) {
                    clearInterval(this.interval);
                }
                
                // Son de fin plus long
                this.playBeep(1000, 500);
                
                // Vibration de fin
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                // Appeler la fonction de completion
                if (this.onComplete) {
                    this.onComplete();
                }
            }
            
            // Jouer un bip sonore
            playBeep(frequency = 800, duration = 200) {
                if (!this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration / 1000);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration / 1000);
                } catch (e) {
                    console.log('Erreur audio:', e);
                }
            }
            
            // Formater le temps MM:SS
            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            

            // Ajouter du temps
            addTime(seconds) {
                this.timeLeft += seconds;
                this.duration += seconds;
                if (this.onTick) {
                    this.onTick(this.timeLeft, this.duration);
                }
            }
            
            // Enlever du temps
            removeTime(seconds) {
                this.timeLeft = Math.max(0, this.timeLeft - seconds);
                if (this.timeLeft === 0) {
                    this.complete();
                } else if (this.onTick) {
                    this.onTick(this.timeLeft, this.duration);
                }
            }
        }

        // Instance globale du timer
        let exerciseTimer = new ExerciseTimer();

        // Fonctions globales pour contrôler le timer
        function startExerciseTimer() {
            exerciseTimer.start();
            updateTimerButtons();
        }

        function pauseExerciseTimer() {
            exerciseTimer.pause();
            updateTimerButtons();
        }

        function stopExerciseTimer() {
            exerciseTimer.stop();
            updateTimerButtons();
            // Remettre l'affichage par défaut
            const timerDisplay = document.getElementById('exercise-timer-display');
            if (timerDisplay) {
                timerDisplay.textContent = exerciseTimer.formatTime(exerciseTimer.duration);
                timerDisplay.style.color = 'var(--primary)';
            }
        }

        function addExerciseTime() {
            exerciseTimer.addTime(10); // Ajouter 10 secondes
        }

        function removeExerciseTime() {
            exerciseTimer.removeTime(10); // Enlever 10 secondes
        }

        function updateTimerButtons() {
            const startBtn = document.getElementById('timer-start-btn');
            const pauseBtn = document.getElementById('timer-pause-btn');
            const stopBtn = document.getElementById('timer-stop-btn');
            
            if (startBtn && pauseBtn && stopBtn) {
                if (exerciseTimer.isRunning && !exerciseTimer.isPaused) {
                    startBtn.style.display = 'none';
                    pauseBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'inline-block';
                } else if (exerciseTimer.isPaused) {
                    startBtn.style.display = 'inline-block';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                } else {
                    startBtn.style.display = 'inline-block';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                }
            }
        }

        // Fonction pour générer l'interface du timer
        function generateTimerInterface(exercise, prefix = '') {
            // Récupérer la durée personnalisée si elle existe
            let defaultDuration = 30;
            if (appState.liveSession) {
                const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                defaultDuration = currentExercise?.duration || exercise.default_duration || 30;
            } else if (appState.manualSession) {
                const currentExercise = appState.manualSession.exercises[appState.manualSession.currentExerciseIndex];
                defaultDuration = currentExercise?.duration || exercise.default_duration || 30;
            } else {
                defaultDuration = exercise.default_duration || 30;
            }
            
            return `
                <div class="exercise-timer-container" style="text-align: center; margin: 20px 0; padding: 20px; background: var(--surface); border-radius: 16px; border: 2px solid var(--primary);">
                    <h3 style="margin-bottom: 16px; color: var(--primary);">⏱️ Timer d'exercice</h3>
                    
                    <!-- Affichage du timer -->
                    <div id="exercise-timer-display" style="font-size: 48px; font-weight: bold; color: var(--primary); margin: 16px 0;">
                        ${exerciseTimer.formatTime(defaultDuration)}
                    </div>
                    
                    <!-- Contrôles de temps -->
                    <div style="display: flex; justify-content: center; gap: 8px; margin: 16px 0;">
                        <button class="btn btn-small btn-secondary" onclick="removeExerciseTime()" style="font-size: 18px; padding: 8px 12px;">-10s</button>
                        <input type="number" id="${prefix}duration" class="input" value="${defaultDuration}" min="10" max="300" 
                            style="width: 80px; text-align: center; font-weight: bold;" 
                            onchange="setupTimerDuration(this.value)">
                        <button class="btn btn-small btn-secondary" onclick="addExerciseTime()" style="font-size: 18px; padding: 8px 12px;">+10s</button>
                    </div>
                    
                    <!-- Boutons de contrôle -->
                    <div style="display: flex; justify-content: center; gap: 12px; margin: 16px 0;">
                        <button id="timer-start-btn" class="btn btn-success" onclick="startExerciseTimer()" style="display: inline-block;">
                            ▶️ Start
                        </button>
                        <button id="timer-pause-btn" class="btn btn-warning" onclick="pauseExerciseTimer()" style="display: none;">
                            ⏸️ Pause
                        </button>
                        <button id="timer-stop-btn" class="btn btn-danger" onclick="stopExerciseTimer()" style="display: none;">
                            ⏹️ Stop
                        </button>
                    </div>
                    
                    <!-- Indicateur de progression -->
                    <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 16px 0;">
                        <div id="timer-progress" style="height: 100%; background: var(--primary); width: 100%; transition: width 1s linear;"></div>
                    </div>
                    
                    <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">
                        🔔 Sons et vibrations activés • Validation automatique
                    </p>
                </div>
            `;
        }

        // Fonction pour configurer la durée du timer
        function setupTimerDuration(newDuration) {
            const duration = parseInt(newDuration) || 30;
            const timerDisplay = document.getElementById('exercise-timer-display');
            
            if (timerDisplay && !exerciseTimer.isRunning) {
                exerciseTimer.setup(
                    duration,
                    updateTimerDisplay,
                    completeTimedExercise
                );
                timerDisplay.textContent = exerciseTimer.formatTime(duration);
                updateTimerProgress(duration, duration);
            }
        }

        // Fonction pour mettre à jour l'affichage du timer
        function updateTimerDisplay(timeLeft, totalDuration) {
            const timerDisplay = document.getElementById('exercise-timer-display');
            
            if (timerDisplay) {
                timerDisplay.textContent = exerciseTimer.formatTime(timeLeft);
                
                // Changer la couleur selon le temps restant
                if (timeLeft <= 5) {
                    timerDisplay.style.color = 'var(--danger)';
                } else if (timeLeft <= 10) {
                    timerDisplay.style.color = 'var(--warning)';
                } else {
                    timerDisplay.style.color = 'var(--primary)';
                }
            }
            
            // Mettre à jour la barre de progression
            updateTimerProgress(timeLeft, totalDuration);
        }

        // Fonction pour mettre à jour la barre de progression
        function updateTimerProgress(timeLeft, totalDuration) {
            const progressBar = document.getElementById('timer-progress');
            if (progressBar) {
                const percentage = (timeLeft / totalDuration) * 100;
                progressBar.style.width = percentage + '%';
                
                // Changer la couleur de la barre selon le temps restant
                if (timeLeft <= 5) {
                    progressBar.style.background = 'var(--danger)';
                } else if (timeLeft <= 10) {
                    progressBar.style.background = 'var(--warning)';
                } else {
                    progressBar.style.background = 'var(--primary)';
                }
            }
        }

        // Fonction appelée quand le timer se termine
        function completeTimedExercise() {
            // Validation automatique de la série
            setTimeout(() => {
                if (confirm('⏰ Temps écoulé ! Valider cette série automatiquement ?')) {
                    // Remplir automatiquement la durée
                    const durationInput = document.getElementById('duration');
                    if (durationInput) {
                        durationInput.value = exerciseTimer.duration;
                    }
                    
                    // Valider la série
                    actions.validateSet();
                }
            }, 500); // Petit délai pour que l'utilisateur entende le son
        }

        // === FONCTIONS UTILITAIRES ÉLASTIQUES ===

        // Fonction pour toggle le mode d'exercice dans le formulaire
        function toggleExerciseMode() {
            const mode = document.getElementById('exercise-mode').value;
            const durationGroup = document.getElementById('duration-group');
            
            if (mode === 'time' || mode === 'both') {
                durationGroup.style.display = 'block';
            } else {
                durationGroup.style.display = 'none';
            }
        }

        // Fonction pour toggle entre temps et répétitions dans les séances
        function togglePerformanceMode(prefix = '') {
            const mode = document.getElementById(`${prefix}execution-mode`).value;
            const repsInputs = document.querySelectorAll(`[id*="${prefix}reps-inputs"]`);
            const timerContainer = document.getElementById(`${prefix}timer-container`);
            
            // Arrêter le timer si il était en cours
            if (exerciseTimer.isRunning) {
                exerciseTimer.stop();
            }
            
            if (mode === 'time') {
                // Masquer les inputs de répétitions
                repsInputs.forEach(input => {
                    if (input) input.style.display = 'none';
                });
                
                // Afficher le timer
                if (timerContainer) {
                    timerContainer.style.display = 'block';
                    
                    // Configurer le timer après un court délai
                    setTimeout(() => {
                        const defaultDuration = 30; // Valeur par défaut
                        exerciseTimer.setup(
                            defaultDuration,
                            updateTimerDisplay,
                            completeTimedExercise
                        );
                        
                        // Mettre à jour l'affichage initial
                        const timerDisplay = document.getElementById('exercise-timer-display');
                        if (timerDisplay) {
                            timerDisplay.textContent = exerciseTimer.formatTime(defaultDuration);
                        }
                        updateTimerButtons();
                    }, 100);
                }
            } else {
                // Afficher les inputs de répétitions
                repsInputs.forEach(input => {
                    if (input) input.style.display = 'block';
                });
                
                // Masquer le timer
                if (timerContainer) {
                    timerContainer.style.display = 'none';
                }
            }
        }

        // Fonction pour créer un item d'exercice avec réorganisation
        function createExerciseItem(exerciseData, sectionIndex, section) {
            const { exercise, planned_sets, originalIndex } = exerciseData;
            
            const div = document.createElement('div');
            div.className = 'exercise-item';
            
            // Indicateur du mode d'exercice
            const modeIcon = exercise.exercise_mode === 'time' ? '⏱️' : 
                            exercise.exercise_mode === 'both' ? '🔄' : '🔢';
            
            // Informations sur l'exercice
            const restTime = exerciseData.rest_time || exercise.default_rest_time;
            let exerciseInfo = `${exercise.is_unilateral ? 'Unilatéral' : 'Bilatéral'} • ${restTime}s repos`;
            if (exercise.exercise_mode === 'time') {
                exerciseInfo += ` • ${exercise.default_duration || 30}s par défaut`;
            }
            
            // Calculer si on peut monter/descendre
            const isFirst = sectionIndex === 0;
            const totalInSection = section === 'warmup' ? 
                appState.currentSession.exercises.filter(ex => {
                    const e = appState.exercises.find(e => e.id === ex.exercise_id);
                    return e && (e.muscle_group === 'echauffement' || e.category === 'warmup');
                }).length :
                appState.currentSession.exercises.filter(ex => {
                    const e = appState.exercises.find(e => e.id === ex.exercise_id);
                    return e && e.muscle_group !== 'echauffement' && e.category !== 'warmup';
                }).length;
            const isLast = sectionIndex === totalInSection - 1;
            
            div.innerHTML = `
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span class="exercise-number">${sectionIndex + 1}</span>
                        <strong>${modeIcon} ${exercise.name}</strong>
                    </div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-left: 32px;">
                        ${exerciseInfo}
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" value="${planned_sets}" min="1" max="20"
                        style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px;"
                        onchange="actions.updatePlannedSets(${exercise.id}, this.value)">
                    <span style="font-size: 14px;">séries</span>
                    
                    <input type="number" value="${restTime}" min="30" max="600"
                        style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px;"
                        onchange="actions.updateExerciseRestTime(${exercise.id}, this.value)"
                        title="Temps de repos en secondes">
                    <span style="font-size: 14px;">s repos</span>
                    ${(exercise.exercise_mode === 'time' || exercise.exercise_mode === 'both') ? `
                        <input type="number" value="${exerciseData.duration || exercise.default_duration || 30}" min="10" max="300"
                            style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; margin-left: 8px;"
                            onchange="actions.updateExerciseDuration(${exercise.id}, this.value)"
                            title="Durée de l'exercice en secondes">
                        <span style="font-size: 14px;">s durée</span>
                    ` : ''}
                    
                    <div class="reorder-buttons">
                        <button class="btn btn-small btn-secondary" onclick="actions.moveExerciseUp(${originalIndex}, 'session')"
                            ${isFirst ? 'disabled' : ''}>↑</button>
                        <button class="btn btn-small btn-secondary" onclick="actions.moveExerciseDown(${originalIndex}, 'session')"
                            ${isLast ? 'disabled' : ''}>↓</button>
                    </div>
                    <button class="btn btn-small btn-danger" onclick="actions.removeExerciseFromSession(${exercise.id})">✕</button>
                </div>
            `;
            
            return div;
        }

        // Fonction pour calculer la résistance totale
        function calculateTotalResistance(selectedElastics) {
            let total = 0;
            Object.keys(selectedElastics).forEach(color => {
                const count = selectedElastics[color] || 0;
                if (ELASTICS_DB[color] && count > 0) {
                    total += ELASTICS_DB[color].resistance * count;
                }
            });
            return total;
        }

        // Fonction pour générer le sélecteur d'élastiques
        function generateElasticSelector(prefix = '', isUnilateral = false) {
            if (isUnilateral) {
                // Pour les exercices unilatéraux, deux sélecteurs séparés
                let html = '<div class="elastics-selector" style="margin: 16px 0;">';
                html += '<h4>Combinaison d\'élastiques par côté</h4>';
                
                // Côté gauche
                html += '<div style="margin-bottom: 16px;">';
                html += '<h5 style="color: var(--primary); margin-bottom: 8px;">🫱 Côté gauche</h5>';
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                Object.keys(ELASTICS_DB).forEach(color => {
                    const elastic = ELASTICS_DB[color];
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="width: 20px; height: 20px; background: ${elastic.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        <div style="flex: 1; font-size: 14px;">${elastic.name} (${elastic.resistance}kg)</div>
                        <select id="${prefix}elastic-left-${color}" class="select" style="width: 60px; padding: 4px;" onchange="updateResistanceDisplay('${prefix}', true)">
                        `;
                    for (let i = 0; i <= elastic.quantity; i++) {
                        html += `<option value="${i}">${i}</option>`;
                    }
                    html += '</select></div>';
                });
                html += '</div>';
                html += `<div style="margin-top: 8px; padding: 8px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: bold;">Résistance gauche: <span id="${prefix}total-resistance-left">0</span> kg
                </div>`;
                html += '</div>';
                
                // Côté droit
                html += '<div>';
                html += '<h5 style="color: var(--primary); margin-bottom: 8px;">🫲 Côté droit</h5>';
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                Object.keys(ELASTICS_DB).forEach(color => {
                    const elastic = ELASTICS_DB[color];
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="width: 20px; height: 20px; background: ${elastic.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        <div style="flex: 1; font-size: 14px;">${elastic.name} (${elastic.resistance}kg)</div>
                        <select id="${prefix}elastic-right-${color}" class="select" style="width: 60px; padding: 4px;" onchange="updateResistanceDisplay('${prefix}', true)">
                        `;
                    for (let i = 0; i <= elastic.quantity; i++) {
                        html += `<option value="${i}">${i}</option>`;
                    }
                    html += '</select></div>';
                });
                html += '</div>';
                html += `<div style="margin-top: 8px; padding: 8px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: bold;">Résistance droite: <span id="${prefix}total-resistance-right">0</span> kg
                </div>`;
                html += '</div>';
                
                html += '</div>';
                return html;
            } else {
                // Code existant pour les exercices bilatéraux
                let html = '<div class="elastics-selector" style="margin: 16px 0;">';
                html += '<h4>Combinaison d\'élastiques</h4>';
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                Object.keys(ELASTICS_DB).forEach(color => {
                    const elastic = ELASTICS_DB[color];
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="width: 20px; height: 20px; background: ${elastic.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        <div style="flex: 1; font-size: 14px;">${elastic.name} (${elastic.resistance}kg)</div>
                        <select id="${prefix}elastic-${color}" class="select" style="width: 60px; padding: 4px;" onchange="updateResistanceDisplay('${prefix}', false)">
                        `;
                    for (let i = 0; i <= elastic.quantity; i++) {
                        html += `<option value="${i}">${i}</option>`;
                    }
                    html += '</select></div>';
                });
                html += '</div>';
                html += `<div style="margin-top: 12px; padding: 8px; background: var(--primary); color: white; border-radius: 8px; text-align: center; font-weight: bold;">Résistance totale: <span id="${prefix}total-resistance">0</span> kg
                </div>`;
                html += '</div>';
                return html;
            }
        }

        // Fonction pour mettre à jour l'affichage de la résistance
        function updateResistanceDisplay(prefix = '', isUnilateral = false) {
            if (isUnilateral) {
                // Pour les exercices unilatéraux
                const selectedElasticsLeft = {};
                const selectedElasticsRight = {};
                
                Object.keys(ELASTICS_DB).forEach(color => {
                    const selectElementLeft = document.getElementById(`${prefix}elastic-left-${color}`);
                    const selectElementRight = document.getElementById(`${prefix}elastic-right-${color}`);
                    
                    if (selectElementLeft) {
                        selectedElasticsLeft[color] = parseInt(selectElementLeft.value) || 0;
                    }
                    if (selectElementRight) {
                        selectedElasticsRight[color] = parseInt(selectElementRight.value) || 0;
                    }
                });
                
                const totalLeft = calculateTotalResistance(selectedElasticsLeft);
                const totalRight = calculateTotalResistance(selectedElasticsRight);
                
                const totalElementLeft = document.getElementById(`${prefix}total-resistance-left`);
                const totalElementRight = document.getElementById(`${prefix}total-resistance-right`);
                
                if (totalElementLeft) {
                    totalElementLeft.textContent = totalLeft;
                }
                if (totalElementRight) {
                    totalElementRight.textContent = totalRight;
                }
                
                return { 
                    selectedElastics: { left: selectedElasticsLeft, right: selectedElasticsRight }, 
                    total: { left: totalLeft, right: totalRight } 
                };
            } else {
                // Code existant pour les exercices bilatéraux
                const selectedElastics = {};
                Object.keys(ELASTICS_DB).forEach(color => {
                    const selectElement = document.getElementById(`${prefix}elastic-${color}`);
                    if (selectElement) {
                        selectedElastics[color] = parseInt(selectElement.value) || 0;
                    }
                });
                
                const total = calculateTotalResistance(selectedElastics);
                const totalElement = document.getElementById(`${prefix}total-resistance`);
                if (totalElement) {
                    totalElement.textContent = total;
                }
                
                return { selectedElastics, total };
            }
        }

        // Fonction pour charger les exercices pré-définis
        function loadPredefinedExercises() {
            const exercisesToAdd = [];
            
            Object.keys(PREDEFINED_EXERCISES).forEach(category => {
                PREDEFINED_EXERCISES[category].forEach(ex => {
                    exercisesToAdd.push({
                        id: Date.now() + Math.floor(Math.random() * 1000),
                        name: ex.name,
                        is_unilateral: ex.unilateral,
                        default_rest_time: 90,
                        exercise_type: 'elastics',
                        anchor_point: ex.anchor,
                        muscle_group: category
                    });
                });
            });
            
            return exercisesToAdd;
        }

        // Fonction pour générer les conseils de résistance
        function generateResistanceRecommendations(exerciseName) {
            const recommendations = RESISTANCE_RECOMMENDATIONS[exerciseName];
            if (!recommendations) {
                return '<p style="font-size: 14px; color: var(--text-secondary);">Pas de recommandations disponibles pour cet exercice.</p>';
            }
            
            let html = '<div style="background: var(--background); padding: 16px; border-radius: 8px; margin: 12px 0;">';
            html += '<h5 style="color: var(--primary); margin-bottom: 12px;">💡 Conseils de résistance (première fois)</h5>';
            
            // Débutant
            html += `
                <div style="margin-bottom: 12px; padding: 12px; background: var(--surface); border-radius: 8px; border-left: 4px solid #34C759;">
                    <div style="font-weight: 600; color: #34C759; margin-bottom: 4px;">🟢 Débutant</div>
                    <div style="font-size: 14px;">
                        <strong>${recommendations.beginner.min}-${recommendations.beginner.max}kg</strong> • 
                        Élastiques : ${recommendations.beginner.elastics.join(' + ')}
                    </div>
                </div>
            `;
            
            // Intermédiaire
            html += `
                <div style="margin-bottom: 12px; padding: 12px; background: var(--surface); border-radius: 8px; border-left: 4px solid #FF9500;">
                    <div style="font-weight: 600; color: #FF9500; margin-bottom: 4px;">🟡 Intermédiaire</div>
                    <div style="font-size: 14px;">
                        <strong>${recommendations.intermediate.min}-${recommendations.intermediate.max}kg</strong> • 
                        Élastiques : ${recommendations.intermediate.elastics.join(' + ')}
                    </div>
                </div>
            `;
            
            // Confirmé
            html += `
                <div style="padding: 12px; background: var(--surface); border-radius: 8px; border-left: 4px solid #FF3B30;">
                    <div style="font-weight: 600; color: #FF3B30; margin-bottom: 4px;">🔴 Confirmé</div>
                    <div style="font-size: 14px;">
                        <strong>${recommendations.advanced.min}-${recommendations.advanced.max}kg</strong> • 
                        Élastiques : ${recommendations.advanced.elastics.join(' + ')}
                    </div>
                </div>
            `;
            
            html += '<p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px; font-style: italic;">Commencez léger et ajustez selon vos sensations !</p>';
            html += '</div>';
            
            return html;
        }

        // Fonction pour afficher les exemples d'exercices
        function showExerciseExamples(anchorType) {
            const examplesContainer = document.getElementById('exercise-examples');
            const examplesList = document.getElementById('examples-list');
            
            if (anchorType && examplesList) {
                const examples = {
                    'none': ['Biceps curls', 'Élévations latérales', 'Squats', 'Overhead press'],
                    'door-middle': ['Face Pull', 'Développé debout', 'Rowing horizontal'],
                    'door-high': ['Tirage vertical', 'Extension triceps', 'Développé incliné'],
                    'door-low': ['Tirage poulie basse', 'Curl biceps', 'Développé décliné'],
                    'floor': ['Soulevé de terre', 'Rowing buste penché', 'Front squat'],
                    'body': ['Hip thrust', 'Abduction hanches', 'Donkey kick'],
                    'external': ['Exercices extérieurs', 'Sprints résistance']
                };
                
                if (examples[anchorType]) {
                    examplesList.innerHTML = examples[anchorType].join(', ');
                    examplesContainer.style.display = 'block';
                } else {
                    examplesContainer.style.display = 'none';
                }
            }
        }

        // === ARCHITECTURE RÉACTIVE: ÉTAT CENTRAL ===
        let appState = {
            currentScreen: 'dashboard',
            currentSession: null,
            liveSession: null,
            editingExercise: null,
            exercises: [],
            sessions: [],
            templates: [],
            measurements: [],
            records: {},
            settings: {
                theme: 'light'
            },
            // États pour les programmes
            currentProgram: null,
            selectedProgram: null,
            programTab: 'predefined',
            programSubtab: 'histoire-gloire'
        };

        // === GESTION DE L'HISTORIQUE DE NAVIGATION ===
        let navigationHistory = ['dashboard'];
        let isNavigatingBack = false;

        // Fonction pour ajouter un écran à l'historique
        function addToNavigationHistory(screenName) {
            if (!isNavigatingBack && screenName !== navigationHistory[navigationHistory.length - 1]) {
                navigationHistory.push(screenName);
                // Limiter l'historique à 10 écrans pour éviter les fuites mémoire
                if (navigationHistory.length > 10) {
                    navigationHistory = navigationHistory.slice(-10);
                }
            }
            isNavigatingBack = false;
        }

        // Fonction pour naviguer vers l'écran précédent
        function navigateBack() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Enlever l'écran actuel
                const previousScreen = navigationHistory[navigationHistory.length - 1];
                isNavigatingBack = true;
                actions.showScreen(previousScreen);
                return true; // Navigation interne effectuée
            }
            return false; // Pas d'écran précédent, laisser le comportement par défaut
        }

        // === STOCKAGE LOCAL AVEC VERSIONING ===
        const STORAGE_VERSION = 'v1';
        const STORAGE_PREFIX = `smarttrack_${STORAGE_VERSION}_`;

        const storage = {
            isAvailable() {
                try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
                } catch (e) {
                return false;
                }
            },
            
            save(key, data) {
                if (!this.isAvailable()) {
                console.warn('localStorage non disponible');
                return false;
                }
                try {
                localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(data));
                return true;
                } catch (e) {
                console.error('Erreur de sauvegarde:', e);
                return false;
                }
            },
            
            load(key, defaultValue = null) {
                if (!this.isAvailable()) {
                return defaultValue;
                }
                try {
                const item = localStorage.getItem(STORAGE_PREFIX + key);
                return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                console.error('Erreur de chargement:', e);
                return defaultValue;
                }
            },
            
            remove(key) {
                if (!this.isAvailable()) {
                return false;
                }
                try {
                localStorage.removeItem(STORAGE_PREFIX + key);
                return true;
                } catch (e) {
                console.error('Erreur de suppression:', e);
                return false;
                }
            },
            
            clear() {
                if (!this.isAvailable()) {
                return false;
                }
                try {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(STORAGE_PREFIX)) {
                    localStorage.removeItem(key);
                    }
                });
                return true;
                } catch (e) {
                console.error('Erreur de nettoyage:', e);
                return false;
                }
            }
        };

        // === CACHE INTELLIGENT ===
        const smartCache = {
            // Cache pour les calculs coûteux
            cache: new Map(),
            
            // Générer une clé de cache
            generateKey(type, params) {
                return `${type}_${JSON.stringify(params)}`;
            },
        
            // Récupérer du cache
            get(type, params) {
                const key = this.generateKey(type, params);
                return this.cache.get(key);
            },
        
            // Stocker en cache
            set(type, params, value) {
                const key = this.generateKey(type, params);
                this.cache.set(key, value);
                
                // Limiter la taille du cache (garder les 100 entrées les plus récentes)
                if (this.cache.size > 100) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                return value;
            },
        
            // Invalider le cache pour un type donné
            invalidate(type) {
                const keysToDelete = [];
                for (let key of this.cache.keys()) {
                    if (key.startsWith(type + '_')) {
                        keysToDelete.push(key);
                    }
                }
                keysToDelete.forEach(key => this.cache.delete(key));
            },
        
            // Nettoyer tout le cache
            clear() {
                this.cache.clear();
            }
        };

        // === DEBOUNCING POUR OPTIMISER LES APPELS FRÉQUENTS ===
        const debounceManager = {
            timers: new Map(),
        
            debounce(func, delay = 300, key = 'default') {
                if (this.timers.has(key)) {
                    clearTimeout(this.timers.get(key));
                }
            
                const timer = setTimeout(() => {
                    func();
                    this.timers.delete(key);
                }, delay);
            
                this.timers.set(key, timer);
            }
        };

        // === FONCTIONS UTILITAIRES DE VALIDATION ===
        const utils = {
            validateNumber(value, min = 0, max = 999) {
                const num = parseFloat(value);
                return !isNaN(num) && num >= min && num <= max ? num : 0;
            },
            
            validateString(value, minLength = 1, maxLength = 100) {
                if (typeof value !== 'string') return '';
                return value.trim().length >= minLength && value.trim().length <= maxLength ? value.trim() : '';
            },
            
            validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },
            
            validateDate(dateString) {
                const date = new Date(dateString);
                return !isNaN(date.getTime()) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
            }
        };

        // === ACTIONS (MODIFICATION DE L'ÉTAT) ===
        const actions = {
            // Initialisation
            init() {
                this.loadData();
                this.initializeMediaSystem();
                this.initializeTagsSystem();
                this.applyTheme();
                this.setCurrentDate();
                // Restaurer l'écran sauvegardé ou dashboard par défaut
                const savedScreen = storage.load('currentScreen', 'dashboard');
                appState.currentScreen = savedScreen;
                render();
            },
            
            loadData() {
                appState.exercises = storage.load('exercises', []);
                appState.sessions = storage.load('sessions', []);
                appState.templates = storage.load('templates', []);
                appState.measurements = storage.load('measurements', []);
                appState.records = storage.load('records', {});
                appState.settings = storage.load('settings', { theme: 'light' });
                appState.currentScreen = storage.load('currentScreen', 'dashboard');
                appState.mediaLibrary = storage.load('mediaLibrary', []);
                appState.exerciseFavorites = storage.load('exerciseFavorites', []);
                console.log('📚 Médias chargés:', appState.mediaLibrary?.length || 0, 'images');
                appState.customTags = storage.load('customTags', []);
                appState.exerciseTags = storage.load('exerciseTags', {});
                console.log('🏷️ Tags chargés:', appState.customTags?.length || 0, 'tags personnalisés');
                // Charger les données de programmes
                appState.currentProgram = storage.load('currentProgram', null);
                appState.programTab = storage.load('programTab', 'predefined');
                appState.programSubtab = storage.load('programSubtab', 'histoire-gloire');
            },
            
            saveData() {
                // Invalider les caches liés aux données modifiées
                smartCache.invalidate('generalStats');
                smartCache.invalidate('calendar');
                smartCache.invalidate('exerciseSearch');
                storage.save('exercises', appState.exercises);
                storage.save('sessions', appState.sessions);
                storage.save('templates', appState.templates);
                storage.save('measurements', appState.measurements);
                storage.save('records', appState.records);
                storage.save('settings', appState.settings);
                storage.save('mediaLibrary', appState.mediaLibrary || []);
                storage.save('exerciseFavorites', appState.exerciseFavorites || []);
                storage.save('customTags', appState.customTags || []);
                storage.save('exerciseTags', appState.exerciseTags || {});
                // Sauvegarder les données de programmes
                storage.save('currentProgram', appState.currentProgram);
                storage.save('programTab', appState.programTab);
                storage.save('programSubtab', appState.programSubtab);
            },
            
            // Navigation
            showScreen(screenName) {
                // Ajouter à l'historique de navigation
                addToNavigationHistory(screenName);
                appState.currentScreen = screenName;
                // Sauvegarder l'écran actuel
                storage.save('currentScreen', screenName);
                
                // Synchroniser avec l'historique du navigateur
                if (!isNavigatingBack) {
                    window.history.pushState({ screen: screenName }, '', window.location.href);
                }
                
                render();
            },
            
            // Fonction pour naviguer intelligemment vers la séance
            goToSession() {
                if (appState.liveSession) {
                    // Si une séance live est en cours, aller directement à l'écran live
                    this.showScreen('live');
                } else {
                    // Sinon, aller à l'écran de préparation
                    this.showScreen('preparation');
                }
            },

            showSettings() {
                appState.currentScreen = 'settings';
                render();
            },
            
            // Gestion des exercices
            saveExercise() {
                const name = utils.validateString(document.getElementById('exercise-name').value, 1, 50);
                const isUnilateral = document.getElementById('exercise-unilateral').checked;
                const restTime = utils.validateNumber(document.getElementById('exercise-rest').value, 30, 600);
                const category = document.getElementById('exercise-category')?.value || 'strength';
                const mode = document.getElementById('exercise-mode')?.value || 'reps';
                const duration = utils.validateNumber(document.getElementById('exercise-duration').value, 10, 300);

                if (!name) {
                    this.showNotification('Le nom de l\'exercice est requis (1-50 caractères)');
                    return;
                }

                if (appState.editingExercise) {
                    // Modification d'exercice existant
                    const exercise = appState.exercises.find(e => e.id === appState.editingExercise);
                    exercise.name = name;
                    exercise.is_unilateral = isUnilateral;
                    exercise.default_rest_time = restTime;
                    exercise.category = category;
                    exercise.exercise_mode = mode;
                    exercise.default_duration = duration;
                    exercise.exercise_type = category === 'warmup' ? 'bodyweight' : 'elastics';
                    exercise.anchor_point = document.getElementById('exercise-anchor')?.value || 'none';
                    exercise.muscle_group = document.getElementById('exercise-muscle-group')?.value || 'autres';
                    
                    // Gérer les médias
                    if (appState.currentExerciseMedia) {
                        this.saveExerciseMedia(exercise);
                    }
                    
                    appState.editingExercise = null;
                } else {
                    // Création d'un nouvel exercice
                    const newExercise = {
                        id: Date.now(),
                        name,
                        is_unilateral: isUnilateral,
                        default_rest_time: restTime,
                        category: category,
                        exercise_mode: mode,
                        default_duration: duration,
                        exercise_type: category === 'warmup' ? 'bodyweight' : 'elastics',
                        anchor_point: document.getElementById('exercise-anchor')?.value || 'none',
                        muscle_group: document.getElementById('exercise-muscle-group')?.value || 'autres'
                    };

                    // Gérer les médias pour le nouvel exercice
                    if (appState.currentExerciseMedia) {
                        
                    }

                    appState.exercises.push(newExercise);
                }

                this.clearExerciseForm();
                this.saveData();
                render();
                this.showNotification('Exercice sauvegardé !');
            },

            saveExerciseMedia(exercise) {
                if (!appState.currentExerciseMedia) return;

                console.log('💾 Sauvegarde média pour:', exercise.name);
                console.log('📊 Données média:', appState.currentExerciseMedia);

                if (appState.currentExerciseMedia.libraryId) {
                    // Image vient de la bibliothèque
                    exercise.mediaId = appState.currentExerciseMedia.libraryId;
                    console.log('✅ MediaId assigné depuis bibliothèque:', exercise.mediaId);
                } else if (appState.currentExerciseMedia.file || appState.currentExerciseMedia.preview) {
                    // Nouvelle image uploadée
                    if (!appState.mediaLibrary) {
                        appState.mediaLibrary = [];
                    }

                    // Ajouter à la bibliothèque avec catégorie
                    const media = {
                        id: Date.now() + Math.random(),
                        name: appState.currentExerciseMedia.name,
                        preview: appState.currentExerciseMedia.preview,
                        size: appState.currentExerciseMedia.size,
                        type: appState.currentExerciseMedia.file?.type || 'image/webp',
                        dateAdded: new Date().toISOString(),
                        category: exercise.muscle_group,
                        tags: [exercise.muscle_group, exercise.name.toLowerCase()]
                    };

                    appState.mediaLibrary.push(media);
                    exercise.mediaId = media.id;
                    
                    console.log('✅ Nouveau média ajouté:', media);
                    console.log('✅ MediaId assigné:', exercise.mediaId);
                }

                // Nettoyer les données temporaires
                appState.currentExerciseMedia = null;
            },
            
            // Fonction pour déplacer un exercice vers le haut
            moveExerciseUp(index, context = 'session') {
                if (index === 0) return;
                
                let exercises;
                if (context === 'session' && appState.currentSession) {
                    exercises = appState.currentSession.exercises;
                } else if (context === 'template' && appState.editingTemplate) {
                    exercises = appState.editingTemplate.exerciseIds;
                } else {
                    return;
                }
                
                // Échanger les éléments
                [exercises[index], exercises[index - 1]] = [exercises[index - 1], exercises[index]];
                render();
            },

            // Fonction pour déplacer un exercice vers le bas
            moveExerciseDown(index, context = 'session') {
                let exercises;
                if (context === 'session' && appState.currentSession) {
                    exercises = appState.currentSession.exercises;
                    if (index >= exercises.length - 1) return;
                } else if (context === 'template' && appState.editingTemplate) {
                    exercises = appState.editingTemplate.exerciseIds;
                    if (index >= exercises.length - 1) return;
                } else {
                    return;
                }
                
                // Échanger les éléments
                [exercises[index], exercises[index + 1]] = [exercises[index + 1], exercises[index]];
                render();
            },

            editExercise(id) {
                const exercise = appState.exercises.find(e => e.id === id);
                if (exercise) {
                    appState.editingExercise = id;
                    document.getElementById('exercise-name').value = exercise.name;
                    document.getElementById('exercise-unilateral').checked = exercise.is_unilateral;
                    document.getElementById('exercise-rest').value = exercise.default_rest_time;
                    document.getElementById('exercise-category').value = exercise.category || 'strength';
                    document.getElementById('exercise-mode').value = exercise.exercise_mode || 'reps';
                    document.getElementById('exercise-duration').value = exercise.default_duration || 30;
                    document.getElementById('exercise-anchor').value = exercise.anchor_point || 'none';
                    document.getElementById('exercise-muscle-group').value = exercise.muscle_group || 'autres';
                    
                    // Charger l'image si elle existe
                    this.loadExerciseMedia(exercise);
                    
                    // Afficher/masquer le champ durée selon le mode
                    toggleExerciseMode();
                    
                    // Afficher les exemples d'exercices
                    showExerciseExamples(exercise.anchor_point || 'none');
                    
                    render();
                }
            },

            loadExerciseMedia(exercise) {
                // Nettoyer d'abord
                this.removeExerciseMedia();
                
                if (exercise.mediaId && appState.mediaLibrary) {
                    const media = appState.mediaLibrary.find(m => m.id === exercise.mediaId);
                    if (media) {
                        appState.currentExerciseMedia = {
                            file: null,
                            preview: media.preview,
                            name: media.name,
                            size: media.size,
                            libraryId: media.id
                        };
                        
                        this.showMediaPreview(media.preview, media.name, media.size);
                    }
                }
            },
            
            debugExerciseMedia(exercise) {
                console.log('🔍 Debug exercice:', exercise.name);
                console.log('📊 MediaId:', exercise.mediaId);
                console.log('📚 MediaLibrary:', appState.mediaLibrary);
                console.log('🔄 Recherche media avec ID:', exercise.mediaId);
                
                if (exercise.mediaId && appState.mediaLibrary) {
                    const media = appState.mediaLibrary.find(m => m.id === exercise.mediaId);
                    console.log('🖼️ Media trouvé:', media);
                }
                
                return this.getExerciseMediaDisplay(exercise);
            },

            getExerciseMediaDisplay(exercise) {
                // Vérifier s'il y a une image dans la bibliothèque
                if (exercise.mediaId && appState.mediaLibrary) {
                    const media = appState.mediaLibrary.find(m => m.id === exercise.mediaId);
                    if (media) {
                        return `
                            <img src="${media.preview}" 
                                 alt="${exercise.name}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                 loading="lazy">
                            <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">
                                ${Math.round(media.size/1024)}KB
                            </div>
                        `;
                    }
                }
                
                // Fallback : vérifier s'il y a une URL d'image (ancien système)
                if (exercise.imageUrl) {
                    return `
                        <img src="${exercise.imageUrl}" 
                             alt="${exercise.name}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                             loading="lazy">
                    `;
                }
                
                // Fallback par défaut avec emoji spécifique au groupe musculaire
                const muscleEmojis = {
                    'echauffement': '🔥',
                    'biceps': '💪',
                    'triceps': '🔧', 
                    'epaules': '🤲',
                    'dos': '🗂️',
                    'pectoraux': '🦆',
                    'jambes': '🦵',
                    'autres': '💪'
                };
                
                const emoji = muscleEmojis[exercise.muscle_group] || '💪';
                
                return `
                    <div style="text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%;">
                        <div style="font-size: 72px; margin-bottom: 16px; opacity: 0.6;">${emoji}</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Image à venir</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            Bientôt disponible • Format WebP optimisé
                        </div>
                        <button class="btn btn-small btn-secondary" onclick="actions.goToEditExercise(${exercise.id})" style="margin-top: 12px; max-width: 150px; margin-left: auto; margin-right: auto;">
                            📷 Ajouter une image
                        </button>
                    </div>
                `;
            },

            generateAnatomyDiagram(exercise) {
                // Mapping des muscles vers les zones SVG
                const muscleMapping = {
                    // Avant du corps
                    'Biceps brachial': 'biceps',
                    'Biceps court': 'biceps',
                    'Biceps': 'biceps',
                    'Deltoïde antérieur': 'shoulders-front',
                    'Deltoïde moyen': 'shoulders-front',
                    'Deltoïdes antérieurs': 'shoulders-front',
                    'Deltoïdes': 'shoulders-front',
                    'Pectoraux': 'chest',
                    'Pectoraux (partie haute)': 'chest',
                    'Quadriceps': 'quads',
                    'Fessiers': 'glutes',
                    'Abdominaux': 'abs',
                    'Core': 'abs',
                    'Avant-bras': 'forearms',
                    'Mollets': 'calves',

                    // Arrière du corps
                    'Triceps': 'triceps',
                    'Triceps (chef long)': 'triceps',
                    'Deltoïdes postérieurs': 'shoulders-back',
                    'Grand dorsal': 'lats',
                    'Rhomboïdes': 'rhomboids',
                    'Trapèzes': 'traps',
                    'Trapèzes moyens': 'traps',
                    'Ischio-jambiers': 'hamstrings',
                    'Dos': 'back-general'
                };

                // Identifier les muscles actifs
                const primaryMuscles = exercise.muscleGroups.primary || [];
                const secondaryMuscles = exercise.muscleGroups.secondary || [];

                let primaryZones = [];
                let secondaryZones = [];

                primaryMuscles.forEach(muscle => {
                    const zone = muscleMapping[muscle];
                    if (zone && !primaryZones.includes(zone)) {
                        primaryZones.push(zone);
                    }
                });

                secondaryMuscles.forEach(muscle => {
                    const zone = muscleMapping[muscle];
                    if (zone && !secondaryZones.includes(zone) && !primaryZones.includes(zone)) {
                        secondaryZones.push(zone);
                    }
                });

                return `
                    <div class="anatomy-diagram">
                        <!-- Corps de face -->
                        <div class="body-diagram">
                            <div class="anatomy-title">Vue de face</div>
                            ${this.generateFrontBodySVG(primaryZones, secondaryZones)}
                        </div>
                    
                        <!-- Corps de dos -->
                        <div class="body-diagram">
                            <div class="anatomy-title">Vue de dos</div>
                            ${this.generateBackBodySVG(primaryZones, secondaryZones)}
                        </div>
                    </div>

                    <!-- Légende -->
                    <div class="anatomy-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--primary);"></div>
                            <span>Muscles principaux</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FFB84D;"></div>
                            <span>Muscles secondaires</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #E5E5E5;"></div>
                            <span>Non sollicités</span>
                        </div>
                    </div>
                `;
            },

            generateFrontBodySVG(primaryZones, secondaryZones) {
                const getClass = (zone) => {
                    if (primaryZones.includes(zone)) return 'muscle-group primary';
                    if (secondaryZones.includes(zone)) return 'muscle-group secondary';
                    return 'muscle-group';
                };

                return `
                    <svg viewBox="0 0 150 300" xmlns="http://www.w3.org/2000/svg">
                        <!-- Tête -->
                        <circle cx="75" cy="25" r="20" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- Cou -->
                        <rect x="70" y="40" width="10" height="15" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- Épaules avant -->
                        <ellipse cx="55" cy="60" rx="12" ry="8" class="${getClass('shoulders-front')}" title="Deltoïdes antérieurs"/>
                        <ellipse cx="95" cy="60" rx="12" ry="8" class="${getClass('shoulders-front')}" title="Deltoïdes antérieurs"/>
                        
                        <!-- Pectoraux -->
                        <ellipse cx="75" cy="75" rx="25" ry="15" class="${getClass('chest')}" title="Pectoraux"/>
                        
                        <!-- Biceps -->
                        <ellipse cx="50" cy="85" rx="8" ry="20" class="${getClass('biceps')}" title="Biceps"/>
                        <ellipse cx="100" cy="85" rx="8" ry="20" class="${getClass('biceps')}" title="Biceps"/>
                        
                        <!-- Avant-bras -->
                        <ellipse cx="48" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        <ellipse cx="102" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        
                        <!-- Abdominaux -->
                        <rect x="65" y="95" width="20" height="25" rx="3" class="${getClass('abs')}" title="Abdominaux"/>
                        
                        <!-- Torse général -->
                        <rect x="60" y="55" width="30" height="65" fill="none" stroke="#CCCCCC" stroke-width="1" opacity="0.3"/>
                        
                        <!-- Quadriceps -->
                        <ellipse cx="65" cy="160" rx="10" ry="35" class="${getClass('quads')}" title="Quadriceps"/>
                        <ellipse cx="85" cy="160" rx="10" ry="35" class="${getClass('quads')}" title="Quadriceps"/>
                        
                        <!-- Mollets -->
                        <ellipse cx="65" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        <ellipse cx="85" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        
                        <!-- Pieds -->
                        <ellipse cx="65" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                        <ellipse cx="85" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                    </svg>
                `;
            },

            generateBackBodySVG(primaryZones, secondaryZones) {
                const getClass = (zone) => {
                    if (primaryZones.includes(zone)) return 'muscle-group primary';
                    if (secondaryZones.includes(zone)) return 'muscle-group secondary';
                    return 'muscle-group';
                };

                return `
                    <svg viewBox="0 0 150 300" xmlns="http://www.w3.org/2000/svg">
                        <!-- Tête -->
                        <circle cx="75" cy="25" r="20" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- Cou -->
                        <rect x="70" y="40" width="10" height="15" fill="#F0F0F0" stroke="#CCCCCC"/>
                        
                        <!-- Épaules arrière -->
                        <ellipse cx="55" cy="60" rx="12" ry="8" class="${getClass('shoulders-back')}" title="Deltoïdes postérieurs"/>
                        <ellipse cx="95" cy="60" rx="12" ry="8" class="${getClass('shoulders-back')}" title="Deltoïdes postérieurs"/>
                        
                        <!-- Trapèzes -->
                        <polygon points="60,50 90,50 85,75 65,75" class="${getClass('traps')}" title="Trapèzes"/>
                        
                        <!-- Grand dorsal -->
                        <ellipse cx="75" cy="90" rx="25" ry="20" class="${getClass('lats')}" title="Grand dorsal"/>
                        
                        <!-- Rhomboïdes -->
                        <ellipse cx="75" cy="75" rx="15" ry="10" class="${getClass('rhomboids')}" title="Rhomboïdes"/>
                        
                        <!-- Triceps -->
                        <ellipse cx="50" cy="85" rx="8" ry="18" class="${getClass('triceps')}" title="Triceps"/>
                        <ellipse cx="100" cy="85" rx="8" ry="18" class="${getClass('triceps')}" title="Triceps"/>
                        
                        <!-- Avant-bras arrière -->
                        <ellipse cx="48" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        <ellipse cx="102" cy="115" rx="6" ry="18" class="${getClass('forearms')}" title="Avant-bras"/>
                        
                        <!-- Fessiers -->
                        <ellipse cx="75" cy="135" rx="20" ry="15" class="${getClass('glutes')}" title="Fessiers"/>
                        
                        <!-- Ischio-jambiers -->
                        <ellipse cx="65" cy="170" rx="10" ry="30" class="${getClass('hamstrings')}" title="Ischio-jambiers"/>
                        <ellipse cx="85" cy="170" rx="10" ry="30" class="${getClass('hamstrings')}" title="Ischio-jambiers"/>
                        
                        <!-- Mollets arrière -->
                        <ellipse cx="65" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        <ellipse cx="85" cy="230" rx="8" ry="25" class="${getClass('calves')}" title="Mollets"/>
                        
                        <!-- Pieds -->
                        <ellipse cx="65" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                        <ellipse cx="85" cy="270" rx="8" ry="12" fill="#F0F0F0" stroke="#CCCCCC"/>
                    </svg>
                `;
            },

            initializeMediaSystem() {
                // Charger la bibliothèque de médias au démarrage
                if (!appState.mediaLibrary) {
                    appState.mediaLibrary = storage.load('mediaLibrary', []);
                }
                
                // Nettoyer les URLs d'objets orphelins au démarrage
                this.cleanupOrphanedMediaUrls();
            },

            cleanupOrphanedMediaUrls() {
                // Cette fonction nettoie les URLs créées par createObjectURL qui ne sont plus utilisées
                // Important pour éviter les fuites mémoire
                if (appState.mediaLibrary) {
                    appState.mediaLibrary.forEach(media => {
                        if (media.preview && media.preview.startsWith('blob:')) {
                            // Vérifier si l'image est encore utilisée
                            const isUsed = appState.exercises.some(ex => ex.mediaId === media.id);
                            if (!isUsed) {
                                console.log(`🧹 Nettoyage de l'URL orpheline: ${media.name}`);
                            }
                        }
                    });
                }
            },

            // Fonction pour générer les inputs de performance selon le mode de l'exercice
            generatePerformanceInputs(exercise, prefix = '') {
                let html = '';
                
                if (exercise.exercise_mode === 'time') {
                    // Mode temps avec TIMER INTÉGRÉ
                    html = `
                        ${generateTimerInterface(exercise, prefix)}
                        ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                    `;
                    
                    // Configurer le timer après le rendu
                    setTimeout(() => {
                        const defaultDuration = exercise.default_duration || 30;
                        exerciseTimer.setup(
                            defaultDuration,
                            updateTimerDisplay,
                            completeTimedExercise
                        );
                    }, 100);
                    
                } else if (exercise.exercise_mode === 'both') {
                    // Mode mixte - choix entre temps et répétitions
                    const modeInputs = exercise.is_unilateral ? `
                        <div class="input-group" id="${prefix}reps-inputs" style="display: none;">
                            <label>Reps Gauche</label>
                            <input type="number" id="${prefix}left-reps" class="input" min="0">
                        </div>
                        <div class="input-group" id="${prefix}reps-inputs-2" style="display: none;">
                            <label>Reps Droite</label>
                            <input type="number" id="${prefix}right-reps" class="input" min="0">
                        </div>
                        <div id="${prefix}timer-container" style="display: none;">
                            ${generateTimerInterface(exercise, prefix)}
                        </div>
                    ` : `
                        <div class="input-group" id="${prefix}reps-inputs" style="display: none;">
                            <label>Répétitions</label>
                            <input type="number" id="${prefix}reps" class="input" min="0">
                        </div>
                        <div id="${prefix}timer-container" style="display: none;">
                            ${generateTimerInterface(exercise, prefix)}
                        </div>
                    `;
                    
                    html = `
                        <div class="input-group">
                            <label>Mode d'exécution</label>
                            <select id="${prefix}execution-mode" class="select" onchange="togglePerformanceMode('${prefix}')">
                                <option value="reps">Répétitions</option>
                                <option value="time">Temps avec Timer</option>
                            </select>
                        </div>
                        <div class="performance-inputs">
                            ${modeInputs}
                        </div>
                        ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                    `;
                } else {
                    // Mode répétitions classique
                    if (exercise.is_unilateral) {
                        html = `
                            <div class="performance-inputs">
                                <div class="input-group">
                                    <label>Reps Gauche</label>
                                    <input type="number" id="${prefix}left-reps" class="input" min="0">
                                </div>
                                <div class="input-group">
                                    <label>Reps Droite</label>
                                    <input type="number" id="${prefix}right-reps" class="input" min="0">
                                </div>
                            </div>
                            ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                        `;
                    } else {
                        html = `
                            <div class="performance-inputs">
                                <div class="input-group">
                                    <label>Répétitions</label>
                                    <input type="number" id="${prefix}reps" class="input" min="0">
                                </div>
                            </div>
                            ${exercise.exercise_type === 'elastics' ? generateElasticSelector(prefix, exercise.is_unilateral) : ''}
                        `;
                    }
                }
                
                return html;
            },

            deleteExercise(id) {
                if (confirm('Supprimer cet exercice ? Cette action est irréversible.')) {
                    appState.exercises = appState.exercises.filter(e => e.id !== id);
                    this.saveData();
                    render();
                    this.showNotification('Exercice supprimé');
                }
            },
            
            cancelExerciseEdit() {
                appState.editingExercise = null;
                this.clearExerciseForm();
                render();
            },
            
            clearExerciseForm() {
                document.getElementById('exercise-name').value = '';
                document.getElementById('exercise-unilateral').checked = false;
                document.getElementById('exercise-rest').value = '90';
                document.getElementById('exercise-category').value = 'strength';
                document.getElementById('exercise-mode').value = 'reps';
                document.getElementById('exercise-duration').value = '30';
                document.getElementById('exercise-anchor').value = 'none';
                document.getElementById('exercise-muscle-group').value = 'biceps';
                document.getElementById('exercise-examples').style.display = 'none';
                document.getElementById('duration-group').style.display = 'none';
                // Nettoyer les médias
                this.removeExerciseMedia();
            },
            
            // Gestion des modèles
            saveTemplate() {
                const name = document.getElementById('template-name').value.trim();
            
                if (!name) {
                    this.showNotification('Le nom du modèle est requis');
                    return;
                }

                if (!appState.templateInCreation || appState.templateInCreation.exercises.length === 0) {
                    this.showNotification('Sélectionnez au moins un exercice');
                    return;
                }

                // Récupérer les paramètres globaux
                const restBetweenExercises = parseInt(document.getElementById('template-rest-between-exercises')?.value) || 120;
                const restBetweenSets = parseInt(document.getElementById('template-rest-between-sets')?.value) || 90;

                const newTemplate = {
                    id: Date.now(),
                    name,
                    exercises: appState.templateInCreation.exercises.map(ex => ({
                        exerciseId: ex.exerciseId,
                        plannedSets: ex.plannedSets,
                        restTime: ex.restTime,
                        duration: ex.duration // Ajouter la durée
                    })),
                    globalSettings: {
                        restBetweenExercises,
                        restBetweenSets
                    }
                };

                appState.templates.push(newTemplate);
                this.clearTemplateForm();
                this.saveData();
                render();
                this.showNotification('Modèle créé !');
            },
            
            deleteTemplate(id) {
                if (confirm('Supprimer ce modèle ?')) {
                    appState.templates = appState.templates.filter(t => t.id !== id);
                    this.saveData();
                    render();
                    this.showNotification('Modèle supprimé');
                }
            },
            
            clearTemplateForm() {
                document.getElementById('template-name').value = '';
                
                // Nettoyer le modèle en création
                appState.templateInCreation = null;
                
                // Réafficher l'interface vide
                const selectedExercisesContainer = document.getElementById('template-selected-exercises');
                if (selectedExercisesContainer) {
                    selectedExercisesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucun exercice sélectionné</p>';
                }
                
                const globalSettings = document.getElementById('template-global-settings');
                if (globalSettings) {
                    globalSettings.style.display = 'none';
                }
            },
            
            // Afficher le sélecteur d'exercices
            showExerciseSelector() {
                // Fermer le modal existant s'il y en a un
                const existingModal = document.getElementById('exercise-selector-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                if (!appState.templateInCreation) {
                    appState.templateInCreation = {
                        exercises: [],
                        globalSettings: {
                            restBetweenExercises: 120,
                            restBetweenSets: 90
                        }
                    };
                }

                // Créer le modal de sélection d'exercices
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'exercise-selector-modal';
                
                let exercisesList = '';
                const groupedExercises = {};
                appState.exercises.forEach(exercise => {
                    const group = exercise.muscle_group || 'autres';
                    if (!groupedExercises[group]) {
                        groupedExercises[group] = [];
                    }
                    groupedExercises[group].push(exercise);
                });

                const groupOrder = ['echauffement', 'biceps', 'triceps', 'epaules', 'dos', 'pectoraux', 'jambes', 'autres'];
                groupOrder.forEach(group => {
                    if (groupedExercises[group] && groupedExercises[group].length > 0) {
                        exercisesList += `<h4 class="exercise-group-title">${group.charAt(0).toUpperCase() + group.slice(1)}</h4>`;
                        groupedExercises[group].forEach(exercise => {
                            const modeIcon = exercise.exercise_mode === 'time' ? '⏱️' : 
                                             exercise.exercise_mode === 'both' ? '🔄' : '🔢';
                            const isSelected = appState.templateInCreation.exercises.some(ex => ex.exerciseId === exercise.id);
                            exercisesList += `
                                <div class="exercise-item" style="opacity: ${isSelected ? '0.5' : '1'};">
                                    <div>
                                        <strong>${modeIcon} ${exercise.name}</strong>
                                        <div style="font-size: 14px; color: var(--text-secondary);">
                                            ${exercise.is_unilateral ? 'Unilatéral' : 'Bilatéral'} • ${exercise.default_rest_time}s repos
                                        </div>
                                    </div>
                                    <button class="btn btn-small ${isSelected ? 'btn-secondary' : 'btn-primary'}" 
                                        onclick="actions.${isSelected ? 'removeFromTemplate' : 'addToTemplate'}(${exercise.id})"
                                        ${isSelected ? 'disabled' : ''}>
                                        ${isSelected ? '✓ Ajouté' : '➕ Ajouter'}
                                    </button>
                                </div>
                            `;
                        });
                    }
                });

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>Sélectionner des exercices</h3>
                            <button class="close-btn" onclick="actions.closeExerciseSelector()" style="font-size: 24px; padding: 8px; background: none; border: none; cursor: pointer;">×</button>
                        </div>
                        <div style="margin: 16px 0;">
                            ${exercisesList}
                        </div>
                        <button class="btn btn-success btn-full" onclick="actions.closeExerciseSelector()">
                            ✅ Terminer la sélection
                        </button>
                    </div>
                `;
                    
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        actions.closeExerciseSelector();
                    }
                });

                document.body.appendChild(modal);
            },

            // Ajouter un exercice au modèle en création
            addToTemplate(exerciseId) {
                if (!appState.templateInCreation) {
                    appState.templateInCreation = { exercises: [], globalSettings: { restBetweenExercises: 120, restBetweenSets: 90 } };
                }

                const exercise = appState.exercises.find(e => e.id === exerciseId);
                if (exercise && !appState.templateInCreation.exercises.some(ex => ex.exerciseId === exerciseId)) {
                    appState.templateInCreation.exercises.push({
                        exerciseId: exerciseId,
                        plannedSets: 3,
                        restTime: exercise.default_rest_time
                    });
                
                    // Mettre à jour SEULEMENT le bouton de l'exercice ajouté (éviter la remontée)
                    const button = document.querySelector(`button[onclick*="addToTemplate(${exerciseId})"]`);
                    if (button) {
                        button.textContent = '✓ Ajouté';
                        button.className = 'btn btn-small btn-secondary';
                        button.disabled = true;
                        button.onclick = () => actions.removeFromTemplate(exerciseId);
                    }

                    // Rafraîchir l'affichage principal sans fermer le modal
                    this.renderSelectedExercises();
                }
            },

            // Retirer un exercice du modèle en création
            removeFromTemplate(exerciseId) {
                if (appState.templateInCreation) {
                    appState.templateInCreation.exercises = appState.templateInCreation.exercises.filter(
                        ex => ex.exerciseId !== exerciseId
                    );
                
                    // Rafraîchir le modal
                    this.showExerciseSelector();
                    // Rafraîchir l'affichage principal
                    this.renderSelectedExercises();
                }
            },

            // Fermer le sélecteur d'exercices
            closeExerciseSelector() {
                const modal = document.getElementById('exercise-selector-modal');
                if (modal) {
                    modal.remove();
                }
                this.renderSelectedExercises();
            },

            // Afficher les exercices sélectionnés
            renderSelectedExercises() {
                const container = document.getElementById('template-selected-exercises');
                
                if (!container) {
                    console.error('Container template-selected-exercises not found');
                    return;
                }
                
                if (!appState.templateInCreation || appState.templateInCreation.exercises.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucun exercice sélectionné</p>';
                    return;
                }
                
                let html = '';
                appState.templateInCreation.exercises.forEach((exData, index) => {
                    const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                    if (exercise) {
                        const modeIcon = exercise.exercise_mode === 'time' ? '⏱️' :
                            exercise.exercise_mode === 'both' ? '🔄' : '🔢';
                        html += `
                            <div class="exercise-item" style="margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span class="exercise-number">${index + 1}</span>
                                        <strong>${modeIcon} ${exercise.name}</strong>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" value="${exData.plannedSets}" min="1" max="20"
                                            style="width: 50px; padding: 4px; border: 1px solid var(--border); border-radius: 4px;"
                                            onchange="actions.updateTemplateExerciseSets(${index}, this.value)">
                                        <span style="font-size: 12px;">séries</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" value="${exData.restTime}" min="30" max="600"
                                            style="width: 60px; padding: 4px; border: 1px solid var(--border); border-radius: 4px;"
                                            onchange="actions.updateTemplateExerciseRest(${index}, this.value)">
                                        <span style="font-size: 12px;">s repos</span>
                                    </div>
                                    ${exercise.exercise_mode === 'time' || exercise.exercise_mode === 'both' ? `
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <input type="number" value="${exData.duration || exercise.default_duration || 30}" min="10" max="300"
                                                style="width: 60px; padding: 4px; border: 1px solid var(--border); border-radius: 4px;"
                                                onchange="actions.updateTemplateExerciseDuration(${index}, this.value)">
                                            <span style="font-size: 12px;">s durée</span>
                                        </div>
                                    ` : ''}
                                    <div class="reorder-buttons">
                                        <button class="btn btn-small btn-secondary" onclick="actions.moveTemplateExerciseUp(${index})"
                                            ${index === 0 ? 'disabled' : ''}>↑</button>
                                        <button class="btn btn-small btn-secondary" onclick="actions.moveTemplateExerciseDown(${index})"
                                            ${index === appState.templateInCreation.exercises.length - 1 ? 'disabled' : ''}>↓</button>
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="actions.removeFromTemplateByIndex(${index})">✕</button>
                                </div>
                            </div>
                        `;
                    }
                });
                container.innerHTML = html;
                },

            // Mettre à jour le nombre de séries d'un exercice dans le modèle
            updateTemplateExerciseSets(index, sets) {
                const setsNumber = parseInt(sets);
                if (appState.templateInCreation && setsNumber >= 1 && setsNumber <= 20) {
                    appState.templateInCreation.exercises[index].plannedSets = setsNumber;
                }
            },

            // Mettre à jour le temps de repos d'un exercice dans le modèle
            updateTemplateExerciseRest(index, restTime) {
                const rest = parseInt(restTime);
                if (appState.templateInCreation && rest >= 30 && rest <= 600) {
                    appState.templateInCreation.exercises[index].restTime = rest;
                }
            },

            // Mettre à jour la durée d'un exercice dans le modèle
            updateTemplateExerciseDuration(index, duration) {
                const durationNumber = parseInt(duration);
                if (appState.templateInCreation && durationNumber >= 10 && durationNumber <= 300) {
                    appState.templateInCreation.exercises[index].duration = durationNumber;
                }
            },

            // Déplacer un exercice vers le haut dans le modèle
            moveTemplateExerciseUp(index) {
                if (appState.templateInCreation && index > 0) {
                    const exercises = appState.templateInCreation.exercises;
                    [exercises[index], exercises[index - 1]] = [exercises[index - 1], exercises[index]];
                    this.renderSelectedExercises();
                }
            },

            // Déplacer un exercice vers le bas dans le modèle
            moveTemplateExerciseDown(index) {
                if (appState.templateInCreation && index < appState.templateInCreation.exercises.length - 1) {
                    const exercises = appState.templateInCreation.exercises;
                    [exercises[index], exercises[index + 1]] = [exercises[index + 1], exercises[index]];
                    this.renderSelectedExercises();
                }
            },

            // Retirer un exercice du modèle par index
            removeFromTemplateByIndex(index) {
                if (appState.templateInCreation) {
                    appState.templateInCreation.exercises.splice(index, 1);
                    this.renderSelectedExercises();
                }
            },

            // Préparation de séance
            setCurrentDate() {
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('session-date');
                if (dateInput) {
                    dateInput.value = today;
                    appState.currentSession = {
                        date: today,
                        notes: '',
                        exercises: [],
                        globalSettings: {
                            restBetweenExercises: 120,
                            restBetweenSets: 90
                        }
                    };
                }
            },
            
            updateSessionDate(date) {
                if (appState.currentSession) {
                    appState.currentSession.date = date;
                }
            },
            
            updateSessionNotes(notes) {
                if (appState.currentSession) {
                    appState.currentSession.notes = notes;
                }
            },
            
            addExerciseToSession() {
                // Cette fonction n'est plus utilisée avec le nouveau système de recherche
                // Elle est remplacée par selectExercise() dans le système de recherche
                this.showNotification('Utilisez la recherche ci-dessus pour ajouter un exercice');
            },
            
            removeExerciseFromSession(exerciseId) {
                if (appState.currentSession) {
                    appState.currentSession.exercises = appState.currentSession.exercises.filter(
                        e => e.exercise_id !== exerciseId
                    );
                    render();
                }
            },
            
            updatePlannedSets(exerciseId, sets) {
                if (appState.currentSession) {
                    const exercise = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                    if (exercise) {
                        const setsNumber = utils.validateNumber(sets, 1, 20);
                        if (setsNumber > 0) {
                            exercise.planned_sets = setsNumber;
                        } else {
                            // Remettre la valeur précédente si la validation échoue
                            const input = document.querySelector(`input[onchange*="${exerciseId}"]`);
                            if (input) {
                                input.value = exercise.planned_sets;
                            }
                            this.showNotification('Nombre de séries invalide (1-20)');
                        }
                    }
                }
            },
            
            updateExerciseRestTime(exerciseId, restTime) {
                if (appState.currentSession) {
                    const exercise = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                    if (exercise) {
                        const restNumber = utils.validateNumber(restTime, 30, 600);
                        if (restNumber >= 30) {
                            exercise.rest_time = restNumber;
                        } else {
                            // Remettre la valeur précédente si la validation échoue
                            const input = document.querySelector(`input[onchange*="updateExerciseRestTime(${exerciseId}"]`);
                            if (input) {
                                input.value = exercise.rest_time || 90;
                            }
                            this.showNotification('Temps de repos invalide (30-600s)');
                        }
                    }
                }
            },

            updateExerciseDuration(exerciseId, duration) {
                if (appState.currentSession) {
                    const exercise = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                    if (exercise) {
                        const durationNumber = utils.validateNumber(duration, 10, 300);
                        if (durationNumber >= 10) {
                            exercise.duration = durationNumber;
                        } else {
                            // Remettre la valeur précédente si la validation échoue
                            const input = document.querySelector(`input[onchange*="updateExerciseDuration(${exerciseId}"]`);
                            if (input) {
                                const defaultExercise = appState.exercises.find(e => e.id === exerciseId);
                                input.value = exercise.duration || defaultExercise?.default_duration || 30;
                            }
                            this.showNotification('Durée invalide (10-300s)');
                        }
                    }
                }
            },

            updateSessionRestSettings() {
                if (!appState.currentSession) {
                    appState.currentSession = {
                        date: new Date().toISOString().split('T')[0],
                        notes: '',
                        exercises: []
                    };
                }

                const restBetweenExercises = utils.validateNumber(document.getElementById('session-rest-between-exercises')?.value, 30, 600);
                const restBetweenSets = utils.validateNumber(document.getElementById('session-rest-between-sets')?.value, 30, 300);

                if (!appState.currentSession.globalSettings) {
                    appState.currentSession.globalSettings = {};
                }

                appState.currentSession.globalSettings.restBetweenExercises = restBetweenExercises || 120;
                appState.currentSession.globalSettings.restBetweenSets = restBetweenSets || 90;
            },

            startNewSession() {
                appState.currentSession = {
                    date: new Date().toISOString().split('T')[0],
                    notes: '',
                    exercises: [],
                    globalSettings: {
                        restBetweenExercises: 120,
                        restBetweenSets: 90
                    }
                };
                this.showScreen('preparation');
            },
            
            resumeLastSession() {
                const lastSession = appState.sessions[appState.sessions.length - 1];
                if (lastSession) {
                    appState.currentSession = {
                        date: new Date().toISOString().split('T')[0],
                        notes: '',
                        exercises: lastSession.exercises.map(e => ({
                            exercise_id: e.exercise_id,
                            planned_sets: e.planned_sets,
                            rest_time: e.rest_time, // Conserver les temps de repos individuels
                            sets: []
                        })),
                        globalSettings: {
                            // Utiliser les paramètres de la dernière séance ou les valeurs par défaut
                            restBetweenExercises: lastSession.globalSettings?.restBetweenExercises || 120,
                            restBetweenSets: lastSession.globalSettings?.restBetweenSets || 90
                        }
                    };
                    this.showScreen('preparation');
                } else {
                    this.showNotification('Aucune séance précédente trouvée');
                }
            },

            saveSessionManually() {
                if (!appState.currentSession || appState.currentSession.exercises.length === 0) {
                    this.showNotification('Ajoutez au moins un exercice');
                    return;
                }
                
                // Préparer la séance pour saisie manuelle
                appState.manualSession = {
                    ...appState.currentSession,
                    id: Date.now(),
                    startTime: Date.now(),
                    currentExerciseIndex: 0,
                    globalSettings: {
                        restBetweenExercises: appState.currentSession.globalSettings?.restBetweenExercises || 120,
                        restBetweenSets: appState.currentSession.globalSettings?.restBetweenSets || 90
                    }
                };
                this.showScreen('manual-entry');
                render();
            },

            finishManualSession() {
                if (appState.manualSession) {
                    // Préparer la séance à sauvegarder
                    appState.sessionToFinish = {
                        ...appState.manualSession,
                        endTime: Date.now(),
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    // Nettoyer les variables de session en cours
                    appState.manualSession = null;
                    appState.currentSession = null;
                    
                    // Afficher le modal de difficulté
                    document.getElementById('difficulty-modal').classList.add('active');
                }
            },

            // Fonction pour terminer la séance avec évaluation de difficulté
            finishSessionWithDifficulty(difficulty) {
                if (!appState.sessionToFinish) return;
                
                // Ajouter la difficulté à la séance
                if (difficulty) {
                    appState.sessionToFinish.difficulty = difficulty;
                }
                
                // Sauvegarder la séance
                appState.sessions.push(appState.sessionToFinish);
                
                // Gestion du suivi de programme si la séance vient d'un programme
                if (appState.sessionToFinish.fromProgram && appState.currentProgram) {
                    const sessionData = {
                        seance_id: appState.sessionToFinish.fromProgram.sessionId,
                        date_realisation: new Date().toISOString(),
                        duree_reelle: Math.floor((appState.sessionToFinish.endTime - appState.sessionToFinish.startTime) / 1000 / 60),
                        exercices_realises: appState.sessionToFinish.exercises.map(ex => ({
                            exercice_id: ex.exercise_id,
                            series_completees: ex.sets ? ex.sets.length : 0,
                            qualite_execution: difficulty === 'Facile' ? 8 : difficulty === 'Normale' ? 7 : 6
                        })),
                        rpe: difficulty === 'Facile' ? 6 : difficulty === 'Normale' ? 7 : 8,
                        notes: `Séance ${appState.sessionToFinish.fromProgram.sessionName}`,
                        statut: 'completed'
                    };
                    
                    // Marquer la séance comme effectuée dans le programme
                    this.marquerSeanceEffectuee(appState.sessionToFinish.fromProgram.sessionId, sessionData);
                }
                
                // Nettoyer les variables temporaires
                appState.sessionToFinish = null;
                
                // Fermer le modal
                document.getElementById('difficulty-modal').classList.remove('active');
                
                // Sauvegarder et rediriger
                this.saveData();
                this.showScreen('dashboard');
                
                const difficultyEmoji = {
                    'Facile': '😊',
                    'Normale': '💪', 
                    'Difficile': '🔥'
                };
                
                this.showNotification(
                    difficulty ? 
                    `${difficultyEmoji[difficulty]} Séance ${difficulty.toLowerCase()} terminée ! 🎉` :
                    'Séance terminée ! 🎉'
                );
                
                // Forcer la mise à jour du calendrier
                setTimeout(() => {
                    render();
                }, 50);
            },

            saveManualSet() {
                if (!appState.manualSession) return;
                
                const currentExercise = appState.manualSession.exercises[appState.manualSession.currentExerciseIndex];
                const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                
                // Récupérer les données de performance selon le mode de l'exercice
                let performance = {};
                const setType = document.getElementById('manual-set-type')?.value || 'work';

                // Récupérer la combinaison d'élastiques (si applicable)
                const elasticsData = exercise.exercise_type === 'elastics' ? updateResistanceDisplay('manual-', exercise.is_unilateral) : { selectedElastics: {}, total: 0 };

                if (exercise.exercise_mode === 'time') {
                    // Mode temps pur - utiliser la valeur du timer ou de l'input
                    const durationInput = document.getElementById('manual-duration');
                    const duration = durationInput ? parseInt(durationInput.value) : (exerciseTimer.duration || 30);
                    
                    performance = {
                        duration: duration,
                        exercise_mode: 'time',
                        elastics: elasticsData.selectedElastics,
                        total_resistance: elasticsData.total
                    };
                    
                    // Arrêter le timer si il était en cours
                    if (exerciseTimer.isRunning) {
                        exerciseTimer.stop();
                    }
                    
                } else if (exercise.exercise_mode === 'both') {
                    // Mode mixte - vérifier le mode choisi
                    const executionMode = document.getElementById('manual-execution-mode')?.value || 'reps';
                    
                    if (executionMode === 'time') {
                        const durationInput = document.getElementById('manual-duration');
                        const duration = durationInput ? parseInt(durationInput.value) : 30;
                        
                        performance = {
                            duration: duration,
                            exercise_mode: 'time',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                        
                        if (exerciseTimer.isRunning) {
                            exerciseTimer.stop();
                        }
                    } else {
                        // Mode répétitions
                        if (exercise.is_unilateral) {
                            performance = {
                                left_reps: parseInt(document.getElementById('manual-left-reps')?.value) || 0,
                                right_reps: parseInt(document.getElementById('manual-right-reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        } else {
                            performance = {
                                reps: parseInt(document.getElementById('manual-reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        }
                    }
                } else {
                    // Mode répétitions classique
                    if (exercise.is_unilateral) {
                        performance = {
                            left_reps: parseInt(document.getElementById('manual-left-reps')?.value) || 0,
                            right_reps: parseInt(document.getElementById('manual-right-reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    } else {
                        performance = {
                            reps: parseInt(document.getElementById('manual-reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    }
                }
                
                // Ajouter la série
                currentExercise.sets.push({
                    type: setType,
                    ...performance
                });

                // Vérification de sécurité pour éviter les bugs
                if (!currentExercise.sets) {
                    currentExercise.sets = [];
                }
                
                // Vérifier les records
                this.checkRecords(currentExercise.exercise_id, performance, setType);
                
                // Vérifier si on a atteint le nombre de séries prévues
                if (currentExercise.sets.length >= currentExercise.planned_sets) {
                    // Vérifier s'il y a encore des exercices
                    if (appState.manualSession.currentExerciseIndex + 1 >= appState.manualSession.exercises.length) {
                        // C'était le dernier exercice, proposer de finir
                        if (confirm('Toutes les séries prévues sont terminées. Finir la séance ?')) {
                            this.finishManualSession();
                        } else {
                            render();
                        }
                    } else {
                        // Passer automatiquement à l'exercice suivant
                        this.nextManualExercise();
                    }
                    return;
                }
                
                // Effacer les champs pour la série suivante
                if (exercise.is_unilateral) {
                    document.getElementById('manual-left-reps').value = '';
                    document.getElementById('manual-right-reps').value = '';
                } else {
                    document.getElementById('manual-reps').value = '';
                }
                
                // Remettre les élastiques à zéro
                if (exercise.exercise_type === 'elastics') {
                    if (exercise.is_unilateral) {
                        // Pour les exercices unilatéraux, remettre les deux côtés à zéro
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElementLeft = document.getElementById(`manual-elastic-left-${color}`);
                            const selectElementRight = document.getElementById(`manual-elastic-right-${color}`);
                            if (selectElementLeft) selectElementLeft.value = '0';
                            if (selectElementRight) selectElementRight.value = '0';
                        });
                        updateResistanceDisplay('manual-', true);
                    } else {
                        // Pour les exercices bilatéraux
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElement = document.getElementById(`manual-elastic-${color}`);
                            if (selectElement) selectElement.value = '0';
                        });
                        updateResistanceDisplay('manual-', false);
                    }
                }
            },

            nextManualExercise() {
                if (appState.manualSession) {
                    appState.manualSession.currentExerciseIndex++;
                    if (appState.manualSession.currentExerciseIndex >= appState.manualSession.exercises.length) {
                        this.finishManualSession();
                    } else {
                        render();
                    }
                }
            },
            
            // Séance live
            startLiveSession() {
                if (!appState.currentSession || appState.currentSession.exercises.length === 0) {
                    this.showNotification('Ajoutez au moins un exercice');
                    return;
                }
                
                appState.liveSession = {
                    ...appState.currentSession,
                    id: Date.now(),
                    startTime: Date.now(),
                    currentExerciseIndex: 0,
                    currentSetIndex: 0,
                    isResting: false,
                    isPreparing: true, // NOUVEAU : phase de préparation
                    prepareStartTime: Date.now(),
                    prepareDuration: 5000, // 5 secondes
                    restStartTime: null,
                    restDuration: 0,
                    exercises: appState.currentSession.exercises.map(ex => ({
                        ...ex,
                        sets: ex.sets || []  // IMPORTANT : s'assurer que sets existe
                    })),
                    globalSettings: {
                        restBetweenExercises: appState.currentSession.globalSettings?.restBetweenExercises || 120,
                        restBetweenSets: appState.currentSession.globalSettings?.restBetweenSets || 90
                    }
                };
                
                this.showScreen('live');
                this.startSessionTimer();
                render();
            },

            // Fonction pour mettre en pause la séance live
            pauseLiveSession() {
                if (appState.liveSession && !appState.liveSession.isPaused) {
                    appState.liveSession.isPaused = true;
                    appState.liveSession.pauseStartTime = Date.now();
                    
                    // Arrêter tous les timers
                    this.cleanupTimers();
                    if (exerciseTimer.isRunning) {
                        exerciseTimer.pause();
                    }
                    
                    render();
                    this.showNotification('⏸️ Séance en pause');
                }
            },

            // Fonction pour reprendre la séance live
            resumeLiveSession() {
                if (appState.liveSession && appState.liveSession.isPaused) {
                    const pauseDuration = Date.now() - appState.liveSession.pauseStartTime;
                    
                    // Ajuster les temps de début pour compenser la pause
                    appState.liveSession.startTime += pauseDuration;
                    if (appState.liveSession.restStartTime) {
                        appState.liveSession.restStartTime += pauseDuration;
                    }
                    if (appState.liveSession.prepareStartTime) {
                        appState.liveSession.prepareStartTime += pauseDuration;
                    }
                    
                    appState.liveSession.isPaused = false;
                    delete appState.liveSession.pauseStartTime;
                    
                    // Redémarrer les timers
                    this.startSessionTimer();
                    if (exerciseTimer.isPaused) {
                        exerciseTimer.start();
                    }
                    
                    render();
                    this.showNotification('▶️ Séance reprise');
                }
            },
            
            startSessionTimer() {
                if (appState.sessionTimer) {
                    clearInterval(appState.sessionTimer);
                }
                
                appState.sessionTimer = setInterval(() => {
                    if (appState.liveSession) {
                        const elapsed = Date.now() - appState.liveSession.startTime;
                        const timerElement = document.getElementById('live-timer');
                        if (timerElement) {
                            if (appState.liveSession.isPaused) {
                                // Affichage en mode pause
                                const pauseDuration = Math.floor((Date.now() - appState.liveSession.pauseStartTime) / 1000);
                                timerElement.textContent = `⏸️ ${pauseDuration}s`;
                                timerElement.style.color = 'var(--warning)';
                            } else {
                                // Affichage normal
                                timerElement.textContent = this.formatTime(elapsed);
                                timerElement.style.color = 'var(--primary)';
                            }
                        }
                        
                        // Gérer le timer de repos
                        if (appState.liveSession.isResting && !appState.liveSession.isPaused) {
                            const restElapsed = Date.now() - appState.liveSession.restStartTime;
                            const restRemaining = Math.max(0, appState.liveSession.restDuration - restElapsed);
                            const restElement = document.querySelector('.rest-time');
                            if (restElement) {
                                // Forcer la mise à jour de l'affichage à chaque seconde
                                const secondsRemaining = Math.ceil(restRemaining / 1000);
                                const minutes = Math.floor(secondsRemaining / 60);
                                const seconds = secondsRemaining % 60;
                                restElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                                // Couleurs selon le temps restant
                                if (restRemaining <= 5000) {
                                    restElement.style.color = 'var(--danger)';
                                } else if (restRemaining <= 10000) {
                                    restElement.style.color = 'var(--warning)';
                                } else {
                                    restElement.style.color = 'var(--warning)';
                                }
                            
                                // Sons pour les dernières secondes (logique finale corrigée)
                                const currentSecond = Math.ceil(restRemaining / 1000);
                                const previousSecond = appState.liveSession.lastRestSecond || currentSecond + 1;

                                // Vérifier si on vient de passer à une nouvelle seconde
                                if (currentSecond !== previousSecond && currentSecond > 1) {
                                    appState.liveSession.lastRestSecond = currentSecond;
                                    
                                    // Bip à chaque seconde de 5 à 2 secondes (pas à 1 seconde pour éviter le double bip)
                                    if (currentSecond <= 5) {
                                        exerciseTimer.playBeep(800, 200);
                                        if ('vibrate' in navigator) {
                                            navigator.vibrate(100);
                                        }
                                    }
                                } else if (restRemaining === 0 && previousSecond !== 0) {
                                    // Son spécial pour la fin (remplace le bip à 1 seconde)
                                    appState.liveSession.lastRestSecond = 0;
                                    exerciseTimer.playBeep(1000, 500);
                                    if ('vibrate' in navigator) {
                                        navigator.vibrate([200, 100, 200]);
                                    }
                                }
                            
                                // Passer automatiquement quand le repos est fini
                                if (restRemaining === 0) {
                                    appState.liveSession.isResting = false;
                                    appState.liveSession.lastRestSecond = null; // Reset
                                    // CORRECTION : Vérifier que l'index est valide
                                    if (appState.liveSession.currentExerciseIndex < appState.liveSession.exercises.length) {
                                        const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                                        
                                        // Démarrer automatiquement les exercices en mode temps
                                        const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                                        
                                        // Attendre que le rendu soit terminé puis démarrer automatiquement
                                        setTimeout(() => {
                                            render();
                                        
                                            // Si l'exercice est en mode temps ou mode mixte, démarrer automatiquement le timer
                                            if (exercise && (exercise.exercise_mode === 'time' || exercise.exercise_mode === 'both')) {
                                                setTimeout(() => {
                                                    // Vérifier le mode d'exécution pour les exercices mixtes
                                                    const executionMode = document.getElementById('execution-mode');
                                                    const shouldAutoStart = !executionMode || executionMode.value === 'time';
                                                
                                                    if (shouldAutoStart) {
                                                        const durationInput = document.getElementById('duration');
                                                        const defaultDuration = currentExercise.duration || exercise.default_duration || 30;
                                                        
                                                        if (durationInput) {
                                                            durationInput.value = defaultDuration;
                                                        }
                                                        
                                                        // Configurer et démarrer automatiquement le timer
                                                        exerciseTimer.setup(
                                                            defaultDuration,
                                                            updateTimerDisplay,
                                                            completeTimedExercise
                                                        );
                                                        
                                                        // Démarrer automatiquement
                                                        startExerciseTimer();
                                                        
                                                        // Notification pour informer l'utilisateur
                                                        actions.showNotification('⏱️ Timer démarré automatiquement !');
                                                    }
                                                }, 300); // Délai pour que le DOM soit prêt
                                            }
                                        }, 100);
                                    
                                    } else {
                                        // Index invalide, terminer la séance
                                        this.finishLiveSession();
                                    }
                                }
                            }
                        }

                        // Gérer le timer de préparation
                        if (appState.liveSession.isPreparing) {
                            const prepareElapsed = Date.now() - appState.liveSession.prepareStartTime;
                            const prepareRemaining = Math.max(0, appState.liveSession.prepareDuration - prepareElapsed);
                            const countdownElement = document.getElementById('countdown-display');
                            
                            if (countdownElement) {
                                const secondsLeft = Math.ceil(prepareRemaining / 1000);
                                countdownElement.textContent = secondsLeft;
                                
                                // Changer la couleur selon le temps restant
                                if (secondsLeft <= 2) {
                                    countdownElement.style.color = 'var(--danger)';
                                } else if (secondsLeft <= 3) {
                                    countdownElement.style.color = 'var(--warning)';
                                } else {
                                    countdownElement.style.color = 'var(--primary)';
                                }
                                
                                // Sons aux dernières secondes (éviter les répétitions)
                                if (secondsLeft <= 3 && secondsLeft > 0) {
                                    const currentSecond = Math.floor(prepareRemaining / 1000);
                                    const lastSecond = Math.floor((prepareRemaining + 1000) / 1000);
                                    if (currentSecond !== lastSecond) {
                                        exerciseTimer.playBeep(800, 200);
                                    }
                                }
                                
                                // Fin de la préparation
                                if (prepareRemaining === 0) {
                                    appState.liveSession.isPreparing = false;
                                    exerciseTimer.playBeep(1000, 500); // Son de début plus long
                                    
                                    // Démarrer automatiquement le timer si l'exercice est en mode temps
                                    const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                                    const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                                
                                    // Attendre un petit moment après le son pour démarrer
                                    setTimeout(() => {
                                        render();
                                    
                                        // Si l'exercice est en mode temps, démarrer automatiquement le timer
                                        if (exercise && (exercise.exercise_mode === 'time' ||
                                            (exercise.exercise_mode === 'both' && document.getElementById('execution-mode')?.value === 'time'))) {
                                            // Configurer et démarrer le timer automatiquement
                                            setTimeout(() => {
                                                const durationInput = document.getElementById('duration');
                                                const defaultDuration = exercise.default_duration || 30;
                                                if (durationInput) {
                                                    durationInput.value = defaultDuration;
                                                }
                                                exerciseTimer.setup(
                                                    defaultDuration,
                                                    updateTimerDisplay,
                                                    completeTimedExercise
                                                );
                                                // Démarrer automatiquement
                                                startExerciseTimer();
                                                
                                                // Notification pour informer l'utilisateur
                                                actions.showNotification('🚀 Premier exercice démarré !');
                                            }, 200); // Petit délai pour que le DOM soit prêt
                                        }
                                    }, 500); // Délai pour que le son se termine
                                }
                            }
                        }
                    }
                }, 1000);
            },
            
            formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },
            
            // Calculer la progression basée sur les séries
            calculateSessionProgress() {
                if (!appState.liveSession || !appState.liveSession.exercises) return 0;
                
                let totalPlannedSets = 0;
                let totalCompletedSets = 0;
                
                appState.liveSession.exercises.forEach(exerciseData => {
                    totalPlannedSets += exerciseData.planned_sets || 0;
                    totalCompletedSets += exerciseData.sets ? exerciseData.sets.length : 0;
                });
                
                if (totalPlannedSets === 0) return 0;
                return Math.round((totalCompletedSets / totalPlannedSets) * 100);
            },

            validateSet() {
                if (!appState.liveSession) return;
                
                const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                
                // Récupérer les données de performance selon le mode de l'exercice
                let performance = {};
                const setType = document.getElementById('set-type')?.value || 'work';

                // Récupérer la combinaison d'élastiques (si applicable)
                const elasticsData = exercise.exercise_type === 'elastics' ? updateResistanceDisplay('', exercise.is_unilateral) : { selectedElastics: {}, total: 0 };

                if (exercise.exercise_mode === 'time') {
                    // Mode temps pur - utiliser la valeur du timer ou de l'input
                    const durationInput = document.getElementById('duration');
                    const duration = durationInput ? parseInt(durationInput.value) : (exerciseTimer.duration || 30);
                    
                    performance = {
                        duration: duration,
                        exercise_mode: 'time',
                        elastics: elasticsData.selectedElastics,
                        total_resistance: elasticsData.total
                    };
                    
                    // Arrêter le timer si il était en cours
                    if (exerciseTimer.isRunning) {
                        exerciseTimer.stop();
                    }
                    
                } else if (exercise.exercise_mode === 'both') {
                    // Mode mixte - vérifier le mode choisi
                    const executionMode = document.getElementById('execution-mode')?.value || 'reps';
                    
                    if (executionMode === 'time') {
                        const durationInput = document.getElementById('duration');
                        const duration = durationInput ? parseInt(durationInput.value) : 30;
                        
                        performance = {
                            duration: duration,
                            exercise_mode: 'time',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                        
                        if (exerciseTimer.isRunning) {
                            exerciseTimer.stop();
                        }
                    } else {
                        // Mode répétitions
                        if (exercise.is_unilateral) {
                            performance = {
                                left_reps: parseInt(document.getElementById('left-reps')?.value) || 0,
                                right_reps: parseInt(document.getElementById('right-reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        } else {
                            performance = {
                                reps: parseInt(document.getElementById('reps')?.value) || 0,
                                exercise_mode: 'reps',
                                elastics: elasticsData.selectedElastics,
                                total_resistance: elasticsData.total
                            };
                        }
                    }
                } else {
                    // Mode répétitions classique
                    if (exercise.is_unilateral) {
                        performance = {
                            left_reps: parseInt(document.getElementById('left-reps')?.value) || 0,
                            right_reps: parseInt(document.getElementById('right-reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    } else {
                        performance = {
                            reps: parseInt(document.getElementById('reps')?.value) || 0,
                            exercise_mode: 'reps',
                            elastics: elasticsData.selectedElastics,
                            total_resistance: elasticsData.total
                        };
                    }
                }
                
                // Ajouter la série
                currentExercise.sets.push({
                    type: setType,
                    ...performance
                });
                
                // Remettre les élastiques à zéro après validation
                if (exercise.exercise_type === 'elastics') {
                    if (exercise.is_unilateral) {
                        // Pour les exercices unilatéraux, remettre les deux côtés à zéro
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElementLeft = document.getElementById(`elastic-left-${color}`);
                            const selectElementRight = document.getElementById(`elastic-right-${color}`);
                            if (selectElementLeft) selectElementLeft.value = '0';
                            if (selectElementRight) selectElementRight.value = '0';
                        });
                        updateResistanceDisplay('', true);
                    } else {
                        // Pour les exercices bilatéraux
                        Object.keys(ELASTICS_DB).forEach(color => {
                            const selectElement = document.getElementById(`elastic-${color}`);
                            if (selectElement) selectElement.value = '0';
                        });
                        updateResistanceDisplay('', false);
                    }
                }        

                // Vérifier les records
                this.checkRecords(currentExercise.exercise_id, performance, setType);
                
                // Vérifier si on a atteint le nombre de séries prévues
                if (currentExercise.sets.length >= currentExercise.planned_sets) {
                    // Vérifier s'il y a encore des exercices
                    if (appState.liveSession.currentExerciseIndex + 1 >= appState.liveSession.exercises.length) {
                        // C'était le dernier exercice, finir la séance
                        this.finishLiveSession();
                    } else {
                        // Passer à l'exercice suivant
                        this.nextExercise();
                    }
                } else {
                    // Passer au repos pour la série suivante
                    appState.liveSession.isResting = true;
                    appState.liveSession.restStartTime = Date.now();
                    const sessionExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                    // Utiliser UNIQUEMENT le temps de repos spécifique à l'exercice, pas les règles globales
                    const customRestTime = sessionExercise.rest_time || exercise.default_rest_time;
                    appState.liveSession.restDuration = customRestTime * 1000;
                    render();
                }
            },
            
            skipRest() {
                if (appState.liveSession) {
                    appState.liveSession.isResting = false;
                    render();
                }
            },
            
            nextExercise() {
                if (!appState.liveSession) return;
                appState.liveSession.currentExerciseIndex++;
                appState.liveSession.currentSetIndex = 0;
                if (appState.liveSession.currentExerciseIndex >= appState.liveSession.exercises.length) {
                    this.finishLiveSession();
                } else {
                    // Repos avant le prochain exercice - utiliser le temps de repos du prochain exercice
                    appState.liveSession.isResting = true;
                    appState.liveSession.restStartTime = Date.now();
                    
                    // CORRECTION : Utiliser le temps de repos spécifique du prochain exercice
                    const nextExerciseData = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                    const nextExercise = appState.exercises.find(e => e.id === nextExerciseData.exercise_id);
                    const customRestTime = nextExerciseData.rest_time || nextExercise.default_rest_time || 90;
                    appState.liveSession.restDuration = customRestTime * 1000;
                    render();
                }
            },
            
            // Nettoyer tous les timers actifs
            cleanupTimers() {
                if (appState.sessionTimer) {
                    clearInterval(appState.sessionTimer);
                    appState.sessionTimer = null;
                }
                if (appState.restTimer) {
                    clearInterval(appState.restTimer);
                    appState.restTimer = null;
                }
            },

            finishLiveSession() {
                if (!appState.liveSession) return;
                
                // Préparer la séance à sauvegarder
                appState.sessionToFinish = {
                    ...appState.liveSession,
                    endTime: Date.now(),
                    date: new Date().toISOString().split('T')[0]
                };
                
                // Nettoyer les timers
                this.cleanupTimers();
                if (exerciseTimer.isRunning) {
                    exerciseTimer.stop();
                }
                
                // Nettoyer les variables de session en cours
                appState.liveSession = null;
                appState.currentSession = null;
                
                // Afficher le modal de difficulté
                document.getElementById('difficulty-modal').classList.add('active');
            },
            
            stopLiveSession() {
                if (confirm('Arrêter la séance ? Les données seront perdues.')) {
                    appState.liveSession = null;
                    this.cleanupTimers(); // Utilise la nouvelle fonction
                    this.showScreen('preparation');
                    render();
                }
            },
            
            // Gestion des records
            checkRecords(exerciseId, performance, setType) {
                if (setType !== 'work') return; // Seules les séries de travail comptent pour les records
                
                if (!appState.records[exerciseId]) {
                    appState.records[exerciseId] = [];
                }
                
                const today = new Date().toISOString().split('T')[0];
                let newRecords = [];
                
                // Record de poids max (utiliser la résistance totale des élastiques)
                let maxWeight = performance.total_resistance || 0;
                
                const currentMaxWeight = this.getCurrentRecord(exerciseId, 'max_weight');
                if (maxWeight > currentMaxWeight) {
                    newRecords.push({ date: today, type: 'max_weight', value: maxWeight });
                }
                
                // Record de répétitions max
                let maxReps = 0;
                if (performance.reps) {
                    maxReps = performance.reps;
                } else if (performance.left_reps && performance.right_reps) {
                    maxReps = Math.max(performance.left_reps, performance.right_reps);
                }
                
                const currentMaxReps = this.getCurrentRecord(exerciseId, 'max_reps');
                if (maxReps > currentMaxReps) {
                    newRecords.push({ date: today, type: 'max_reps', value: maxReps });
                }

                // Record de temps max (pour les exercices en mode temps)
                if (performance.exercise_mode === 'time' && performance.duration) {
                    const currentMaxTime = this.getCurrentRecord(exerciseId, 'max_time');
                    if (performance.duration > currentMaxTime) {
                        newRecords.push({ date: today, type: 'max_time', value: performance.duration });
                    }
                }
                
                // 1RM estimé (formule d'Epley)
                if (maxWeight > 0 && maxReps > 0) {
                    const estimated1RM = maxWeight * (1 + maxReps / 30);
                    const current1RM = this.getCurrentRecord(exerciseId, 'max_1rm');
                    if (estimated1RM > current1RM) {
                        newRecords.push({ date: today, type: 'max_1rm', value: estimated1RM });
                    }
                }
                
                // Ajouter les nouveaux records
                if (newRecords.length > 0) {
                    appState.records[exerciseId].push(...newRecords);
                    this.showNotification('🎉 Nouveau PR !');
                }
            },
            
            getCurrentRecord(exerciseId, type) {
                const records = appState.records[exerciseId] || [];
                const typeRecords = records.filter(r => r.type === type);
                return typeRecords.length > 0 ? Math.max(...typeRecords.map(r => r.value)) : 0;
            },

            getLastPerformance(exerciseId) {
                // Conversion en nombre pour éviter les problèmes de type
                const numericExerciseId = parseInt(exerciseId);
                const exercise = appState.exercises.find(e => e.id === numericExerciseId);
                if (!exercise) {
                    console.log(`Exercise not found for ID: ${exerciseId}`);
                    return null;
                }
                
                // Trouver la dernière séance avec cet exercice (comparaison flexible)
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => parseInt(ex.exercise_id) === numericExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));
                    
                if (sessionsWithExercise.length === 0) {
                    console.log(`No sessions found for exercise ID: ${exerciseId}`);
                    return null;
                }
                
                const lastSession = sessionsWithExercise[0];
                const exerciseData = lastSession.exercises.find(ex => parseInt(ex.exercise_id) === numericExerciseId);
                
                if (!exerciseData || !exerciseData.sets || exerciseData.sets.length === 0) {
                    console.log(`No exercise data or sets found for exercise ID: ${exerciseId}`);
                    return null;
                }
                
                // Récupérer TOUTES les séries de travail de la dernière séance
                const workSets = exerciseData.sets.filter(set => set.type === 'work' || !set.type);
                if (workSets.length === 0) {
                    console.log(`No work sets found for exercise ID: ${exerciseId}`);
                    return null;
                }
                
                // Retourner toutes les séries avec leurs détails
                const allSets = workSets.map(set => {
                    if (exercise.is_unilateral) {
                        return {
                            left_reps: set.left_reps || 0,
                            right_reps: set.right_reps || 0,
                            resistance: set.total_resistance || 0,
                            exercise_mode: set.exercise_mode || 'reps',
                            duration: set.duration || 0
                        };
                    } else {
                        return {
                            reps: set.reps || 0,
                            resistance: set.total_resistance || 0,
                            exercise_mode: set.exercise_mode || 'reps',
                            duration: set.duration || 0
                        };
                    }
                });
                
                console.log(`Found ${allSets.length} sets for exercise ${exercise.name}`);
                return {
                    date: lastSession.date,
                    sets: allSets,
                    totalSets: allSets.length
                };
            },

            getLastPerformanceForSet(exerciseId, setNumber) {
                // Conversion en nombre pour éviter les problèmes de type
                const numericExerciseId = parseInt(exerciseId);
                const exercise = appState.exercises.find(e => e.id === numericExerciseId);
                if (!exercise) return null;
                
                // Trouver la dernière séance avec cet exercice (comparaison flexible)
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => parseInt(ex.exercise_id) === numericExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));
                    
                if (sessionsWithExercise.length === 0) return null;
                
                const lastSession = sessionsWithExercise[0];
                const exerciseData = lastSession.exercises.find(ex => parseInt(ex.exercise_id) === numericExerciseId);
                
                if (!exerciseData || !exerciseData.sets || exerciseData.sets.length === 0) return null;
                
                // Récupérer seulement les séries de travail
                const workSets = exerciseData.sets.filter(set => set.type === 'work' || !set.type);
                if (workSets.length < setNumber) return null;
                
                // Récupérer la série spécifique (setNumber - 1 car les arrays commencent à 0)
                const specificSet = workSets[setNumber - 1];
                if (!specificSet) return null;
                
                // Adapter le retour selon le mode de l'exercice
                if (specificSet.exercise_mode === 'time') {
                    return {
                        date: lastSession.date,
                        resistance: specificSet.total_resistance || 0,
                        duration: specificSet.duration || 0,
                        mode: 'time',
                        setNumber: setNumber,
                        elastics: specificSet.elastics || {}
                    };
                } else {
                    return {
                        date: lastSession.date,
                        resistance: specificSet.total_resistance || 0,
                        reps: exercise.is_unilateral ?
                            `${specificSet.left_reps || 0}G/${specificSet.right_reps || 0}D` :
                            (specificSet.reps || 0),
                        mode: 'reps',
                        setNumber: setNumber,
                        elastics: specificSet.elastics || {}
                    };
                }
            },

            getAllLastPerformances(exerciseId) {
                // Conversion en nombre pour éviter les problèmes de type
                const numericExerciseId = parseInt(exerciseId);
                const exercise = appState.exercises.find(e => e.id === numericExerciseId);
                if (!exercise) return null;
                
                // Trouver la dernière séance avec cet exercice (comparaison flexible)
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => parseInt(ex.exercise_id) === numericExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));
                    
                if (sessionsWithExercise.length === 0) return null;
                
                const lastSession = sessionsWithExercise[0];
                const exerciseData = lastSession.exercises.find(ex => parseInt(ex.exercise_id) === numericExerciseId);
                
                if (!exerciseData || !exerciseData.sets || exerciseData.sets.length === 0) return null;
                
                // Récupérer toutes les séries de travail
                const workSets = exerciseData.sets.filter(set => set.type === 'work' || !set.type);
                if (workSets.length === 0) return null;
                
                return {
                    date: lastSession.date,
                    sets: workSets.map((set, index) => {
                        if (set.exercise_mode === 'time') {
                            return {
                                setNumber: index + 1,
                                resistance: set.total_resistance || 0,
                                duration: set.duration || 0,
                                mode: 'time'
                            };
                        } else {
                            return {
                                setNumber: index + 1,
                                resistance: set.total_resistance || 0,
                                reps: exercise.is_unilateral ?
                                    `${set.left_reps || 0}G/${set.right_reps || 0}D` :
                                    (set.reps || 0),
                                mode: 'reps'
                            };
                        }
                    })
                };
            },

            // Navigation du calendrier
            previousMonth() {
                if (!appState.calendarDate) {
                    appState.calendarDate = new Date();
                }
                appState.calendarDate.setMonth(appState.calendarDate.getMonth() - 1);
                render();
            },

            nextMonth() {
                if (!appState.calendarDate) {
                    appState.calendarDate = new Date();
                }
                appState.calendarDate.setMonth(appState.calendarDate.getMonth() + 1);
                render();
            },

            generateMeasurementsChart() {
                console.log('Measurements data:', appState.measurements); // LIGNE DE DEBUG
                if (appState.measurements.length === 0) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Aucune donnée disponible</p>';
                }
    
                // Trier par date
                const sortedMeasurements = [...appState.measurements].sort((a, b) => a.date.localeCompare(b.date));
    
                let chartHtml = '<div style="font-size: 12px; max-height: 250px; overflow-y: auto;">';
    
                // Graphique du poids
                const weightData = sortedMeasurements.filter(m => m.weight && m.weight > 0);
                if (weightData.length > 0) {
                    chartHtml += '<h4>Évolution du poids</h4>';
                    const maxWeight = Math.max(...weightData.map(d => d.weight));
                    const minWeight = Math.min(...weightData.map(d => d.weight));
        
                    weightData.forEach(data => {
                        const date = new Date(data.date).toLocaleDateString('fr-FR', {month: 'short', day: 'numeric'});
                        const barWidth = Math.max(10, ((data.weight - minWeight) / (maxWeight - minWeight)) * 80 + 20);
            
                        chartHtml += `
                        <div style="display: flex; align-items: center; margin: 4px 0;">
                            <div style="width: 60px; font-size: 10px;">${date}</div>
                            <div style="width: ${barWidth}%; height: 15px; background: var(--primary); margin: 0 8px; border-radius: 2px;"></div>
                            <div style="font-size: 10px;">${data.weight}kg</div>
                        </div>
                        `;
                    });
                }
    
                // Graphique de la taille
                const waistData = sortedMeasurements.filter(m => m.waist && m.waist > 0);
                if (waistData.length > 0) {
                    chartHtml += '<h4 style="margin-top: 16px;">Évolution tour de taille</h4>';
                    const maxWaist = Math.max(...waistData.map(d => d.waist));
                    const minWaist = Math.min(...waistData.map(d => d.waist));
                    
                    waistData.forEach(data => {
                        const date = new Date(data.date).toLocaleDateString('fr-FR', {month: 'short', day: 'numeric'});
                        const barWidth = Math.max(10, ((data.waist - minWaist) / (maxWaist - minWaist)) * 80 + 20);
                        
                        chartHtml += `
                            <div style="display: flex; align-items: center; margin: 4px 0;">
                                <div style="width: 60px; font-size: 10px;">${date}</div>
                                <div style="width: ${barWidth}%; height: 15px; background: var(--secondary); margin: 0 8px; border-radius: 2px;"></div>
                                <div style="font-size: 10px;">${data.waist}cm</div>
                            </div>
                        `;
                    });
                }
                
                // Si aucune donnée n'est disponible
                if (weightData.length === 0 && waistData.length === 0) {
                    chartHtml += '<p style="text-align: center; color: var(--text-secondary);">Ajoutez des mensurations pour voir les graphiques</p>';
                }
                
                chartHtml += '</div>';
                return chartHtml;
            },
    

            generateSimpleChart(exerciseId, exerciseName) {
                // Récupérer les données de performance
                const performanceData = [];
                const exercise = appState.exercises.find(e => e.id === exerciseId);
                
                appState.sessions.forEach(session => {
                    const sessionExercise = session.exercises.find(e => e.exercise_id === exerciseId);
                    if (sessionExercise && sessionExercise.sets.length > 0) {
                        // Calculer le meilleur set de la séance
                        let maxWeight = 0;
                        let maxReps = 0;
                        
                        sessionExercise.sets.forEach(set => {
                            if (set.type === 'work') {
                                // Utiliser la résistance totale des élastiques
                                const setWeight = set.total_resistance || 0;
                                if (setWeight > maxWeight) maxWeight = setWeight;
                                
                                // Pour les répétitions
                                if (exercise.is_unilateral) {
                                    const leftReps = set.left_reps || 0;
                                    const rightReps = set.right_reps || 0;
                                    if (leftReps > maxReps) maxReps = leftReps;
                                    if (rightReps > maxReps) maxReps = rightReps;
                                } else {
                                    const setReps = set.reps || 0;
                                    if (setReps > maxReps) maxReps = setReps;
                                }
                            }
                        });
                        
                        if (maxWeight > 0 || maxReps > 0) {
                            performanceData.push({
                                date: session.date,
                                weight: maxWeight,
                                reps: maxReps,
                                volume: maxWeight * maxReps
                            });
                        }
                    }
                });
                
                if (performanceData.length === 0) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Aucune donnée disponible</p>';
                }
                
                // Trier par date
                performanceData.sort((a, b) => a.date.localeCompare(b.date));
                
                // Créer un graphique simple
                let chartHtml = `<div style="font-size: 12px; max-height: 250px; overflow-y: auto;">`;
                chartHtml += `<h4>Progression du poids max</h4>`;
                
                const maxWeight = Math.max(...performanceData.map(d => d.weight));
                
                performanceData.forEach((data, index) => {
                    const date = new Date(data.date).toLocaleDateString('fr-FR', {month: 'short', day: 'numeric'});
                    const barWidth = Math.max(1, (data.weight / maxWeight) * 100);
                    
                    chartHtml += `
                        <div style="display: flex; align-items: center; margin: 4px 0;">
                            <div style="width: 60px; font-size: 10px;">${date}</div>
                            <div style="width: ${barWidth}%; height: 20px; background: var(--primary); margin: 0 8px; border-radius: 2px;"></div>
                            <div style="font-size: 10px;">${data.weight}kg</div>
                        </div>
                    `;
                });
                
                chartHtml += `</div>`;
                return chartHtml;
            },
            
            // Gestion des mesures corporelles
            addMeasurement() {
                const date = document.getElementById('measurement-date').value;
                const height = parseFloat(document.getElementById('measurement-height').value);
                const weight = parseFloat(document.getElementById('measurement-weight').value);
                const waist = parseFloat(document.getElementById('measurement-waist').value);
                const chest = parseFloat(document.getElementById('measurement-chest').value);
                const arm = parseFloat(document.getElementById('measurement-arm').value);
                const thigh = parseFloat(document.getElementById('measurement-thigh').value);

                if (!date) {
                    this.showNotification('Date requise');
                    return;
                }

                // Calculer l'IMC si taille et poids sont renseignés
                let imc = 0;
                let imcCategory = '';
                if (height > 0 && weight > 0) {
                    const heightInMeters = height / 100;
                    imc = weight / (heightInMeters * heightInMeters);
                    
                    // Déterminer la catégorie IMC
                    if (imc < 18.5) {
                        imcCategory = 'Insuffisance pondérale';
                    } else if (imc < 25) {
                        imcCategory = 'Poids normal';
                    } else if (imc < 30) {
                        imcCategory = 'Surpoids';
                    } else if (imc < 35) {
                        imcCategory = 'Obésité modérée';
                    } else if (imc < 40) {
                        imcCategory = 'Obésité sévère';
                    } else {
                        imcCategory = 'Obésité morbide';
                    }
                }

                const newMeasurement = {
                    id: Date.now(),
                    date,
                    height: height || 0,
                    weight: weight || 0,
                    waist: waist || 0,
                    chest: chest || 0,
                    arm: arm || 0,
                    thigh: thigh || 0,
                    imc: Math.round(imc * 10) / 10, // Arrondir à 1 décimale
                    imcCategory: imcCategory
                };

                appState.measurements.push(newMeasurement);
                this.clearMeasurementForm();
                this.saveData();
                render();
                
                if (imc > 0) {
                    this.showNotification(`Mensuration ajoutée ! IMC: ${newMeasurement.imc} (${imcCategory})`);
                } else {
                    this.showNotification('Mensuration ajoutée !');
                }
            },
            
            deleteMeasurement(id) {
                if (confirm('Supprimer cette mesure ?')) {
                    appState.measurements = appState.measurements.filter(m => m.id !== id);
                    this.saveData();
                    render();
                    this.showNotification('Mensuration supprimée');
                }
            },
            
            clearMeasurementForm() {
                document.getElementById('measurement-date').value = '';
                document.getElementById('measurement-height').value = '';
                document.getElementById('measurement-weight').value = '';
                document.getElementById('measurement-waist').value = '';
                document.getElementById('measurement-chest').value = '';
                document.getElementById('measurement-arm').value = '';
                document.getElementById('measurement-thigh').value = '';
            },
            
            // Statistiques
            updateStats(exerciseId) {
                console.log('Updating stats for exercise:', exerciseId);
                // Pas besoin de render() complet, juste re-rendre les stats
                renderStats();
            },

            // Calculer les statistiques générales
            calculateGeneralStats() {
                // Vérifier le cache d'abord
                const cacheKey = { sessionsCount: appState.sessions.length, today: new Date().toISOString().split('T')[0] };
                const cached = smartCache.get('generalStats', cacheKey);
                if (cached) {
                    console.log('📊 Stats générales récupérées du cache');
                    return cached;
                }
                
                console.log('📊 Calcul des stats générales...');
                const now = new Date();
                const today = now.toISOString().split('T')[0];

                // Calculer le début de la semaine (lundi)
                const startOfWeek = new Date(now);
                const dayOfWeek = now.getDay();
                const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Dimanche = 0
                startOfWeek.setDate(now.getDate() - daysToMonday);
                startOfWeek.setHours(0, 0, 0, 0);
                const weekStart = startOfWeek.toISOString().split('T')[0];

                // Calculer le début du mois
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthStart = startOfMonth.toISOString().split('T')[0];

                // Statistiques cette semaine
                const sessionsThisWeek = appState.sessions.filter(session =>
                    session.date >= weekStart && session.date <= today
                );

                // Statistiques ce mois
                const sessionsThisMonth = appState.sessions.filter(session =>
                    session.date >= monthStart && session.date <= today
                );

                // Calculer le volume total cette semaine
                let totalVolumeThisWeek = 0;
                sessionsThisWeek.forEach(session => {
                    session.exercises.forEach(ex => {
                        const exercise = appState.exercises.find(e => e.id === ex.exercise_id);
                        ex.sets.forEach(set => {
                            if (set.type === 'work' && set.exercise_mode !== 'time') {
                                let resistance = 0;
                                let reps = 0;
                                if (exercise && exercise.is_unilateral) {
                                    if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                        resistance = (set.total_resistance.left || 0) + (set.total_resistance.right || 0);
                                    } else {
                                        resistance = (set.total_resistance || 0) * 2;
                                    }
                                    reps = (set.left_reps || 0) + (set.right_reps || 0);
                                } else {
                                    resistance = set.total_resistance || 0;
                                    reps = set.reps || 0;
                                }
                                totalVolumeThisWeek += (resistance * reps);
                            }
                        });
                    });
                });

                // Calculer le volume total ce mois
                let totalVolumeThisMonth = 0;
                sessionsThisMonth.forEach(session => {
                    session.exercises.forEach(ex => {
                        const exercise = appState.exercises.find(e => e.id === ex.exercise_id);
                        ex.sets.forEach(set => {
                            if (set.type === 'work' && set.exercise_mode !== 'time') {
                                let resistance = 0;
                                let reps = 0;
                                if (exercise && exercise.is_unilateral) {
                                    if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                        resistance = (set.total_resistance.left || 0) + (set.total_resistance.right || 0);
                                    } else {
                                        resistance = (set.total_resistance || 0) * 2;
                                    }
                                    reps = (set.left_reps || 0) + (set.right_reps || 0);
                                } else {
                                    resistance = set.total_resistance || 0;
                                    reps = set.reps || 0;
                                }
                                totalVolumeThisMonth += (resistance * reps);
                            }
                        });
                    });
                });

                // Calculer la durée moyenne des séances
                let totalDuration = 0;
                let sessionsWithDuration = 0;
                appState.sessions.forEach(session => {
                    if (session.endTime && session.startTime) {
                        totalDuration += (session.endTime - session.startTime);
                        sessionsWithDuration++;
                    }
                });
                const averageSessionDuration = sessionsWithDuration > 0 ?
                    Math.round(totalDuration / sessionsWithDuration / 1000 / 60) : 0;

                // Récupérer les records récents (derniers 30 jours)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                const recentRecords = [];
                Object.keys(appState.records).forEach(exerciseId => {
                    const exercise = appState.exercises.find(e => e.id == exerciseId);
                    if (exercise) {
                        const records = appState.records[exerciseId] || [];
                        records.forEach(record => {
                            if (record.date >= thirtyDaysAgoStr) {
                                recentRecords.push({
                                    ...record,
                                    exerciseName: exercise.name
                                });
                            }
                        });
                    }
                });

                // Trier les records récents par date (plus récent en premier)
                recentRecords.sort((a, b) => b.date.localeCompare(a.date));

                const result = {
                    sessionsThisWeek: sessionsThisWeek.length,
                    totalVolumeThisWeek: Math.round(totalVolumeThisWeek),
                    sessionsThisMonth: sessionsThisMonth.length,
                    totalVolumeThisMonth: Math.round(totalVolumeThisMonth),
                    averageSessionDuration,
                    totalSessions: appState.sessions.length,
                    recentRecords: recentRecords.slice(0, 10)
                };

                // Mettre en cache et retourner
                return smartCache.set('generalStats', cacheKey, result);
            },
            
            // Modals
            showTemplates() {
                document.getElementById('templates-modal').classList.add('active');
                this.renderTemplatesModal();
            },
            
            showImportModal() {
                document.getElementById('import-modal').classList.add('active');
            },
            
            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            },
            
            loadTemplate(templateId) {
                const template = appState.templates.find(t => t.id === templateId);
                if (!template) {
                    this.showNotification('Modèle introuvable');
                    return;
                }
                
                if (!appState.currentSession) {
                    appState.currentSession = {
                        date: new Date().toISOString().split('T')[0],
                        notes: '',
                        exercises: [],
                        globalSettings: {
                            restBetweenExercises: 120,
                            restBetweenSets: 90
                        }
                    };
                }

                // Remplacer tous les exercices par ceux du modèle
                appState.currentSession.exercises = [];
                
                if (template.exercises && template.exercises.length > 0) {
                    // Nouveau format avec ordre et paramètres détaillés
                    template.exercises.forEach(exData => {
                        const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                        if (exercise) {
                            appState.currentSession.exercises.push({
                                exercise_id: exData.exerciseId,
                                planned_sets: exData.plannedSets || 3,
                                rest_time: exData.restTime || exercise.default_rest_time || 90,
                                duration: exData.duration || exercise.default_duration || 30,
                                sets: []
                            });
                        }
                    });
                
                    // Appliquer les paramètres globaux s'ils existent
                    if (template.globalSettings) {
                        appState.currentSession.globalSettings = {
                            restBetweenExercises: template.globalSettings.restBetweenExercises || 120,
                            restBetweenSets: template.globalSettings.restBetweenSets || 90
                        };
                    }
                } else {
                    // Compatibilité avec l'ancien format
                    (template.exerciseIds || []).forEach(exerciseId => {
                        const exercise = appState.exercises.find(e => e.id === exerciseId);
                        if (exercise) {
                            appState.currentSession.exercises.push({
                                exercise_id: exerciseId,
                                planned_sets: 3,
                                rest_time: exercise.default_rest_time || 90,
                                duration: exercise.default_duration || 30,
                                sets: []
                            });
                        }
                    });
                }

                this.closeModal('templates-modal');
                render();
                this.showNotification(`Modèle "${template.name}" chargé ! (${appState.currentSession.exercises.length} exercices)`);
            },
            
            // Éditer un modèle existant
            editTemplate(templateId) {
                const template = appState.templates.find(t => t.id === templateId);
                if (template) {
                    // Pré-remplir le nom
                    document.getElementById('template-name').value = template.name;
                    
                    // Charger la structure dans templateInCreation
                    if (template.exercises && template.exercises.length > 0) {
                        // Nouveau format
                        appState.templateInCreation = {
                            exercises: template.exercises.map(ex => ({
                                exerciseId: ex.exerciseId,
                                plannedSets: ex.plannedSets,
                                restTime: ex.restTime
                            })),
                            globalSettings: template.globalSettings || {
                                restBetweenExercises: 120,
                                restBetweenSets: 90
                            }
                        };
                    } else {
                        // Convertir l'ancien format
                        appState.templateInCreation = {
                            exercises: (template.exerciseIds || []).map(exerciseId => ({
                                exerciseId: exerciseId,
                                plannedSets: 3,
                                restTime: 90
                            })),
                            globalSettings: {
                                restBetweenExercises: 120,
                                restBetweenSets: 90
                            }
                        };
                    }
                
                    // Marquer comme modification d'un modèle existant
                    appState.editingTemplateId = templateId;
                    
                    // Supprimer l'ancien modèle (il sera re-créé à la sauvegarde)
                    appState.templates = appState.templates.filter(t => t.id !== templateId);
                    
                    // Remplir les paramètres globaux
                    const restBetweenExercises = document.getElementById('template-rest-between-exercises');
                    const restBetweenSets = document.getElementById('template-rest-between-sets');
                    
                    if (restBetweenExercises) {
                        restBetweenExercises.value = appState.templateInCreation.globalSettings.restBetweenExercises;
                    }
                    if (restBetweenSets) {
                        restBetweenSets.value = appState.templateInCreation.globalSettings.restBetweenSets;
                    }
                
                    // Réafficher les exercices sélectionnés
                    this.renderSelectedExercises();
                    
                    this.showNotification('Modèle chargé pour modification');
                }
            },

            // Thème
            toggleTheme() {
                appState.settings.theme = appState.settings.theme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                this.saveData();
            },
            
            applyTheme() {
                document.documentElement.setAttribute('data-theme', appState.settings.theme);
                const checkbox = document.getElementById('dark-theme');
                if (checkbox) {
                    checkbox.checked = appState.settings.theme === 'dark';
                }
            },
            
            // Import/Export
            exportData() {
                const data = {
                    exercises: appState.exercises,
                    sessions: appState.sessions,
                    templates: appState.templates,
                    measurements: appState.measurements,
                    records: appState.records,
                    settings: appState.settings,
                    exportDate: new Date().toISOString(),
                    version: STORAGE_VERSION
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `smarttrack_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showNotification('Données exportées !');
            },
            
            importData() {
                const textarea = document.getElementById('import-data');
                try {
                    const data = JSON.parse(textarea.value);
                    
                    if (confirm('Remplacer toutes les données actuelles ? Cette action est irréversible.')) {
                        appState.exercises = data.exercises || [];
                        appState.sessions = data.sessions || [];
                        appState.templates = data.templates || [];
                        appState.measurements = data.measurements || [];
                        appState.records = data.records || {};
                        appState.settings = data.settings || { theme: 'light' };
                        
                        this.saveData();
                        this.closeModal('import-modal');
                        this.applyTheme();
                        render();
                        this.showNotification('Données importées !');
                        textarea.value = '';
                    }
                } catch (e) {
                    this.showNotification('Format JSON invalide');
                }
            },
            
            clearAllData() {
                if (confirm('Effacer TOUTES les données ? Cette action est irréversible !')) {
                    if (confirm('Êtes-vous vraiment sûr ? Toutes vos séances et exercices seront perdus !')) {
                        storage.clear();
                        appState = {
                            currentScreen: 'dashboard',
                            currentSession: null,
                            liveSession: null,
                            editingExercise: null,
                            exercises: [],
                            sessions: [],
                            templates: [],
                            measurements: [],
                            records: {},
                            settings: { theme: 'light' }
                        };
                        render();
                        this.showNotification('Toutes les données ont été effacées');
                    }
                }
            },
            
           loadPredefinedExercises() {
                if (appState.exercises.length > 0) {
                    if (!confirm('Cela va ajouter les nouveaux exercices SmartWorkout (+ échauffement). Continuer ?')) {
                        return;
                    }
                }
                
                const predefinedExercises = [];
                
                // Exercices existants + nouveaux exercices d'échauffement
                Object.keys(PREDEFINED_EXERCISES).forEach(category => {
                    PREDEFINED_EXERCISES[category].forEach(ex => {
                        predefinedExercises.push({
                            id: Date.now() + Math.floor(Math.random() * 10000),
                            name: ex.name,
                            is_unilateral: ex.unilateral,
                            default_rest_time: category === 'echauffement' ? 30 : 90,
                            exercise_type: category === 'echauffement' ? 'bodyweight' : 'elastics',
                            anchor_point: ex.anchor,
                            muscle_group: category,
                            category: category === 'echauffement' ? 'warmup' : 'strength',
                            exercise_mode: ex.timeBase ? 'time' : 'reps',
                            default_duration: ex.timeBase ? 30 : null
                        });
                    });
                });
                
                let added = 0;
                predefinedExercises.forEach(newEx => {
                    const exists = appState.exercises.find(ex =>
                        ex.name === newEx.name && ex.muscle_group === newEx.muscle_group
                    );
                    if (!exists) {
                        appState.exercises.push(newEx);
                        added++;
                    }
                });
                
                this.saveData();
                render();
                this.showNotification(`${added} nouveaux exercices ajoutés (dont ${PREDEFINED_EXERCISES.echauffement ? PREDEFINED_EXERCISES.echauffement.length : 0} d'échauffement) !`);
            },

            // Notifications
            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                // Style spécial pendant les séances live
                if (appState.liveSession) {
                    notification.classList.add('live-session');
                } else {
                    notification.classList.remove('live-session');
                }
                // Réduire le temps pour les notifications de records pendant les séances
                const duration = appState.liveSession ? 1500 : 3000;
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.remove('live-session');
                }, duration);
            },

            // === GESTION BASE DE DONNÉES EXERCICES ===
            toggleExerciseView() {
                appState.exerciseView = appState.exerciseView === 'grid' ? 'list' : 'grid';
                const toggleBtn = document.getElementById('view-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.innerHTML = appState.exerciseView === 'grid' ? '📋 Vue Grille' : '🔤 Vue Liste';
                }
                this.filterExerciseDatabase();
            },

            filterExerciseDatabase() {
                const searchTerm = document.getElementById('exercise-db-search')?.value.toLowerCase() || '';
                const muscleFilter = document.getElementById('muscle-filter')?.value || '';
                const difficultyFilter = document.getElementById('difficulty-filter')?.value || '';
                const anchorFilter = document.getElementById('anchor-filter')?.value || '';
                const tagsFilter = document.getElementById('tags-filter')?.value || '';
                const durationFilter = document.getElementById('duration-filter')?.value || '';
                const modeFilter = document.getElementById('mode-filter')?.value || '';
                const typeFilter = document.getElementById('type-filter')?.value || '';
                
                // Obtenir la liste des exercices étendus avec les données d'entraînement
                const extendedExercises = this.getExtendedExerciseDatabase();
                
                // Filtrer les exercices
                let filteredExercises = extendedExercises.filter(exercise => {
                    // Filtre de recherche textuelle
                    const matchesSearch = !searchTerm || 
                        exercise.name.toLowerCase().includes(searchTerm) ||
                        exercise.muscle_group.toLowerCase().includes(searchTerm) ||
                        (exercise.tags && exercise.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
                    
                    // Filtre groupe musculaire
                    const matchesMuscle = !muscleFilter || exercise.muscle_group === muscleFilter;
                    
                    // Filtre difficulté
                    const matchesDifficulty = !difficultyFilter || exercise.difficulty === difficultyFilter;
                    
                    // Filtre ancrage
                    const matchesAnchor = !anchorFilter || 
                        (anchorFilter === 'door' && exercise.anchor_point.includes('door')) ||
                        exercise.anchor_point === anchorFilter;
                    
                    // Filtre tags prédéfinis
                    const matchesTags = !tagsFilter || (exercise.tags && exercise.tags.includes(tagsFilter));
                    
                    // Filtre durée par défaut
                    const matchesDuration = !durationFilter || this.matchesDurationFilter(exercise, durationFilter);
                    
                    // Filtre mode d'exécution
                    const matchesMode = !modeFilter || exercise.exercise_mode === modeFilter;
                    
                    // Filtre type (unilatéral/bilatéral)
                    const matchesType = !typeFilter || this.matchesTypeFilter(exercise, typeFilter);
                    
                    // Filtre tags personnalisés actifs
                    const matchesCustomTags = this.matchesCustomTagsFilter(exercise);
                    
                    return matchesSearch && matchesMuscle && matchesDifficulty && matchesAnchor && 
                        matchesTags && matchesDuration && matchesMode && matchesType && matchesCustomTags;
                });
                
                this.renderExerciseResults(filteredExercises);
            },

            matchesDurationFilter(exercise, filter) {
                const duration = exercise.default_duration || 30;
                switch(filter) {
                    case 'short': return duration <= 30;
                    case 'medium': return duration > 30 && duration <= 60;
                    case 'long': return duration > 60;
                    default: return true;
                }
            },

            matchesTypeFilter(exercise, filter) {
                switch(filter) {
                    case 'unilateral': return exercise.is_unilateral;
                    case 'bilateral': return !exercise.is_unilateral;
                    default: return true;
                }
            },

            matchesCustomTagsFilter(exercise) {
                if (!appState.activeCustomTagFilters || appState.activeCustomTagFilters.length === 0) {
                    return true;
                }
                
                const exerciseTags = appState.exerciseTags?.[exercise.id] || [];
                return appState.activeCustomTagFilters.every(tag => exerciseTags.includes(tag));
            },

            getExtendedExerciseDatabase() {
                // Combiner exercices personnalisés avec données enrichies
                return appState.exercises.map(exercise => {
                    const enrichedData = this.getExerciseEnrichedData(exercise);
                    return {
                        ...exercise,
                        ...enrichedData
                    };
                });
            },

            getExerciseEnrichedData(exercise) {
                // Base de données enrichie avec descriptions, instructions, etc.
                const enrichedDatabase = {
                    // === ÉCHAUFFEMENT ===
                    'Jumping Jacks': {
                        difficulty: 'beginner',
                        description: 'Excellent exercice cardio pour échauffer tout le corps.',
                        instructions: [
                            'Debout, pieds joints, bras le long du corps',
                            'Sautez en écartant les pieds et montant les bras',
                            'Revenez à la position initiale en sautant',
                            'Maintenez un rythme régulier'
                        ],
                        tips: ['Gardez le dos droit', 'Respirez régulièrement', 'Atterrissez sur la pointe des pieds'],
                        commonMistakes: ['Rythme trop rapide', 'Mauvaise coordination', 'Dos rond'],
                        muscleGroups: { primary: ['Cardio'], secondary: ['Mollets', 'Épaules'] },
                        tags: ['échauffement', 'cardio', 'coordination'],
                        imageUrl: null
                    },
                    'Montées de genoux': {
                        difficulty: 'beginner',
                        description: 'Échauffement dynamique pour les jambes et le cardio.',
                        instructions: [
                            'Debout, montez alternativement les genoux',
                            'Amenez les genoux au niveau de la taille',
                            'Gardez le dos droit',
                            'Bougez les bras naturellement'
                        ],
                        tips: ['Montez bien les genoux', 'Gardez l\'équilibre', 'Respirez régulièrement'],
                        commonMistakes: ['Genoux pas assez hauts', 'Se pencher vers l\'arrière', 'Rythme irrégulier'],
                        muscleGroups: { primary: ['Hip flexeurs'], secondary: ['Quadriceps', 'Core'] },
                        tags: ['échauffement', 'jambes', 'cardio'],
                        imageUrl: null
                    },
                    'Talons-fesses': {
                        difficulty: 'beginner',
                        description: 'Échauffement dynamique ciblant les ischio-jambiers.',
                        instructions: [
                            'Debout, amenez alternativement les talons vers les fesses',
                            'Gardez le torse droit',
                            'Utilisez les bras pour l\'équilibre',
                            'Maintenez un rythme régulier'
                        ],
                        tips: ['Touchez vraiment les fesses avec les talons', 'Gardez les genoux parallèles', 'Respirez naturellement'],
                        commonMistakes: ['Pencher le torse vers l\'avant', 'Genoux qui s\'écartent', 'Mouvement trop lent'],
                        muscleGroups: { primary: ['Ischio-jambiers'], secondary: ['Mollets', 'Core'] },
                        tags: ['échauffement', 'jambes', 'ischio-jambiers'],
                        imageUrl: null
                    },
                    'Burpees': {
                        difficulty: 'advanced',
                        description: 'Exercice intense combinant squat, planche et saut.',
                        instructions: [
                            'Squat, mains au sol',
                            'Jetez les pieds vers l\'arrière en planche',
                            'Ramenez les pieds sous le corps',
                            'Sautez verticalement bras tendus'
                        ],
                        tips: ['Mouvement fluide', 'Gardez le rythme', 'Respirez bien'],
                        commonMistakes: ['Sauter l\'étape planche', 'Mouvement saccadé', 'Mauvaise respiration'],
                        muscleGroups: { primary: ['Corps entier'], secondary: [] },
                        tags: ['cardio', 'intense', 'fonctionnel'],
                        imageUrl: null
                    },
                    'Planche': {
                        difficulty: 'intermediate',
                        description: 'Exercice isométrique pour renforcer le core et la stabilité.',
                        instructions: [
                            'Position de pompes, appui sur les avant-bras',
                            'Corps aligné de la tête aux pieds',
                            'Contractez les abdominaux',
                            'Maintenez la position'
                        ],
                        tips: ['Ne creusez pas le dos', 'Respirez normalement', 'Regardez le sol'],
                        commonMistakes: ['Fesses trop hautes', 'Dos creusé', 'Retenir sa respiration'],
                        muscleGroups: { primary: ['Core', 'Abdominaux'], secondary: ['Épaules', 'Dos'] },
                        tags: ['gainage', 'core', 'isométrique'],
                        imageUrl: null
                    },
                    'Planche latérale': {
                        difficulty: 'intermediate',
                        description: 'Planche sur le côté pour renforcer les obliques.',
                        instructions: [
                            'Allongé sur le côté, appui sur l\'avant-bras',
                            'Soulevez le bassin en alignant le corps',
                            'Maintenez la position',
                            'Changez de côté'
                        ],
                        tips: ['Corps parfaitement aligné', 'Ne laissez pas tomber le bassin', 'Respirez normalement'],
                        commonMistakes: ['Bassin qui tombe', 'Corps mal aligné', 'Appui instable'],
                        muscleGroups: { primary: ['Obliques', 'Core'], secondary: ['Épaules', 'Quadratus lumborum'] },
                        tags: ['gainage', 'unilatéral', 'obliques'],
                        imageUrl: null
                    },
                    'Mountain climbers': {
                        difficulty: 'intermediate',
                        description: 'Exercice dynamique combinant gainage et cardio.',
                        instructions: [
                            'Position de planche haute',
                            'Amenez alternativement les genoux vers la poitrine',
                            'Gardez les hanches stables',
                            'Maintenez un rythme soutenu'
                        ],
                        tips: ['Gardez les hanches basses', 'Mouvement rapide des jambes', 'Appui stable sur les bras'],
                        commonMistakes: ['Hanches trop hautes', 'Mouvement trop lent', 'Instabilité du haut du corps'],
                        muscleGroups: { primary: ['Core', 'Hip flexeurs'], secondary: ['Épaules', 'Quadriceps'] },
                        tags: ['cardio', 'gainage', 'dynamique'],
                        imageUrl: null
                    },
                    'Squats au poids du corps': {
                        difficulty: 'beginner',
                        description: 'Version de base du squat pour échauffer les jambes.',
                        instructions: [
                            'Pieds écartés largeur d\'épaules',
                            'Descendez en poussant les hanches vers l\'arrière',
                            'Gardez le dos droit',
                            'Remontez en poussant sur les talons'
                        ],
                        tips: ['Genoux dans l\'axe des orteils', 'Descendez bien bas', 'Gardez la poitrine haute'],
                        commonMistakes: ['Genoux vers l\'intérieur', 'Dos rond', 'Pas assez profond'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers'] },
                        tags: ['échauffement', 'jambes', 'fonctionnel'],
                        imageUrl: null
                    },
                    'Pompes': {
                        difficulty: 'intermediate',
                        description: 'Exercice classique pour le haut du corps.',
                        instructions: [
                            'Position de planche, mains sous les épaules',
                            'Descendez en fléchissant les bras',
                            'Poussez pour revenir en position haute',
                            'Gardez le corps aligné'
                        ],
                        tips: ['Corps rigide', 'Amplitude complète', 'Contrôlez la descente'],
                        commonMistakes: ['Hanches qui tombent', 'Amplitude partielle', 'Mains trop écartées'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Triceps', 'Épaules', 'Core'] },
                        tags: ['pectoraux', 'poids du corps', 'classique'],
                        imageUrl: null
                    },
                    'Fentes alternées': {
                        difficulty: 'intermediate',
                        description: 'Fentes dynamiques pour échauffer les jambes.',
                        instructions: [
                            'Debout, faites un grand pas en avant',
                            'Descendez en fléchissant les deux genoux',
                            'Revenez debout et alternez les jambes',
                            'Gardez le torse droit'
                        ],
                        tips: ['Grand pas', 'Descendez bien bas', 'Gardez l\'équilibre'],
                        commonMistakes: ['Pas trop petit', 'Pencher vers l\'avant', 'Genou avant qui dépasse'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers', 'Mollets'] },
                        tags: ['échauffement', 'jambes', 'unilatéral'],
                        imageUrl: null
                    },
                    'Rotations épaules': {
                        difficulty: 'beginner',
                        description: 'Mobilisation articulaire pour les épaules.',
                        instructions: [
                            'Debout, bras le long du corps',
                            'Effectuez des rotations avec les épaules',
                            'Commencez petit puis agrandissez',
                            'Changez de sens'
                        ],
                        tips: ['Mouvement lent et contrôlé', 'Amplitude progressive', 'Relâchez les tensions'],
                        commonMistakes: ['Mouvement trop rapide', 'Épaules crispées', 'Amplitude insuffisante'],
                        muscleGroups: { primary: ['Deltoïdes'], secondary: ['Trapèzes', 'Rhomboïdes'] },
                        tags: ['mobilité', 'épaules', 'échauffement'],
                        imageUrl: null
                    },
                    'Cercles de bras': {
                        difficulty: 'beginner',
                        description: 'Mobilisation dynamique des bras et épaules.',
                        instructions: [
                            'Bras tendus sur les côtés',
                            'Effectuez des cercles avec les bras',
                            'Commencez petit puis agrandissez',
                            'Changez de sens'
                        ],
                        tips: ['Bras bien tendus', 'Mouvement contrôlé', 'Respirez naturellement'],
                        commonMistakes: ['Bras fléchis', 'Mouvement saccadé', 'Épaules remontées'],
                        muscleGroups: { primary: ['Deltoïdes'], secondary: ['Trapèzes', 'Coiffe des rotateurs'] },
                        tags: ['mobilité', 'épaules', 'dynamique'],
                        imageUrl: null
                    },
                    'Étirements dynamiques': {
                        difficulty: 'beginner',
                        description: 'Mouvements d\'amplitude pour préparer les muscles.',
                        instructions: [
                            'Combinez différents mouvements d\'amplitude',
                            'Balancez les jambes, bras, tronc',
                            'Mouvement fluide et contrôlé',
                            'Augmentez progressivement l\'amplitude'
                        ],
                        tips: ['Progression graduelle', 'Mouvement fluide', 'Écoutez votre corps'],
                        commonMistakes: ['Trop d\'amplitude trop vite', 'Mouvement brusque', 'Rester statique'],
                        muscleGroups: { primary: ['Corps entier'], secondary: [] },
                        tags: ['mobilité', 'préparation', 'amplitude'],
                        imageUrl: null
                    },
                    'High knees': {
                        difficulty: 'beginner',
                        description: 'Course sur place avec genoux hauts.',
                        instructions: [
                            'Course sur place',
                            'Montez les genoux le plus haut possible',
                            'Utilisez les bras comme en course',
                            'Maintenez un rythme soutenu'
                        ],
                        tips: ['Genoux à hauteur de taille', 'Restez sur l\'avant du pied', 'Bras actifs'],
                        commonMistakes: ['Genoux pas assez hauts', 'Rythme trop lent', 'Bras passifs'],
                        muscleGroups: { primary: ['Hip flexeurs', 'Mollets'], secondary: ['Quadriceps', 'Core'] },
                        tags: ['cardio', 'échauffement', 'dynamique'],
                        imageUrl: null
                    },
                    'Pas chassés': {
                        difficulty: 'beginner',
                        description: 'Déplacements latéraux pour échauffer les jambes.',
                        instructions: [
                            'Pas sur le côté avec une jambe',
                            'Ramenez l\'autre jambe',
                            'Continuez dans la même direction',
                            'Changez de sens'
                        ],
                        tips: ['Gardez les pieds parallèles', 'Fléchissez légèrement les genoux', 'Bras pour l\'équilibre'],
                        commonMistakes: ['Pieds qui se croisent', 'Jambes tendues', 'Mouvement trop lent'],
                        muscleGroups: { primary: ['Abducteurs', 'Adducteurs'], secondary: ['Quadriceps', 'Mollets'] },
                        tags: ['échauffement', 'latéral', 'coordination'],
                        imageUrl: null
                    },

                    // === BICEPS ===
                    'Curl biceps': {
                        difficulty: 'beginner',
                        description: 'Exercice de base pour développer la masse et la force des biceps.',
                        instructions: [
                            'Placez-vous debout, pieds écartés largeur d\'épaules',
                            'Tenez l\'élastique avec prise en supination',
                            'Gardez les coudes près du corps',
                            'Montez lentement en fléchissant les avant-bras',
                            'Revenez lentement à la position de départ'
                        ],
                        tips: ['Gardez le dos droit', 'Contrôlez la descente', 'Ne balancez pas le corps'],
                        commonMistakes: ['Utiliser l\'élan', 'Lâcher trop vite', 'Écarter les coudes'],
                        muscleGroups: { primary: ['Biceps brachial'], secondary: ['Avant-bras', 'Brachial antérieur'] },
                        tags: ['isolation', 'bras', 'force', 'masse'],
                        imageUrl: null
                    },
                    'Curl biceps (poulie basse)': {
                        difficulty: 'beginner',
                        description: 'Variante du curl avec ancrage bas pour un angle différent.',
                        instructions: [
                            'Ancrez l\'élastique en bas',
                            'Tenez les poignées en supination',
                            'Fléchissez les avant-bras en gardant les coudes fixes',
                            'Contractez les biceps en haut',
                            'Redescendez lentement'
                        ],
                        tips: ['Gardez le torse stable', 'Focalisez sur la contraction', 'Amplitude complète'],
                        commonMistakes: ['Se pencher vers l\'avant', 'Bouger les coudes', 'Relâcher trop vite'],
                        muscleGroups: { primary: ['Biceps brachial'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'bras', 'ancrage bas'],
                        imageUrl: null
                    },
                    'Curl biceps face à la porte': {
                        difficulty: 'beginner',
                        description: 'Curl biceps avec ancrage frontal pour une résistance constante.',
                        instructions: [
                            'Ancrez l\'élastique à hauteur moyenne',
                            'Face à l\'ancrage, tenez les poignées',
                            'Reculez pour créer de la tension',
                            'Fléchissez en ramenant vers vous',
                            'Contrôlez le retour'
                        ],
                        tips: ['Gardez les coudes stables', 'Reculez suffisamment', 'Mouvement contrôlé'],
                        commonMistakes: ['Trop proche de l\'ancrage', 'Coudes qui bougent', 'Mouvement saccadé'],
                        muscleGroups: { primary: ['Biceps'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'biceps', 'ancrage frontal'],
                        imageUrl: null
                    },
                    'Curl marteau': {
                        difficulty: 'beginner',
                        description: 'Variante ciblant davantage le brachial et les avant-bras.',
                        instructions: [
                            'Prise neutre (pouces vers le haut)',
                            'Gardez les coudes près du corps',
                            'Montez en gardant la prise neutre',
                            'Contractez en haut',
                            'Descendez lentement'
                        ],
                        tips: ['Prise ferme', 'Coudes fixes', 'Contrôlez bien la descente'],
                        commonMistakes: ['Tourner les poignets', 'Bouger les coudes', 'Mouvement trop rapide'],
                        muscleGroups: { primary: ['Brachial', 'Biceps'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'bras', 'avant-bras'],
                        imageUrl: null
                    },
                    'Curl marteau (poulie basse)': {
                        difficulty: 'beginner',
                        description: 'Curl marteau avec ancrage bas pour plus de résistance.',
                        instructions: [
                            'Ancrez l\'élastique en bas',
                            'Prise neutre sur les poignées',
                            'Fléchissez en maintenant la prise neutre',
                            'Contractez biceps et avant-bras',
                            'Descendez contrôlé'
                        ],
                        tips: ['Prise neutre stricte', 'Coudes collés au corps', 'Contraction maximale'],
                        commonMistakes: ['Changer la prise en cours', 'Coudes qui bougent', 'Descente trop rapide'],
                        muscleGroups: { primary: ['Brachial', 'Biceps'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'marteau', 'ancrage bas'],
                        imageUrl: null
                    },
                    'Curl biceps avec poignée': {
                        difficulty: 'beginner',
                        description: 'Curl biceps utilisant les poignées pour une meilleure prise.',
                        instructions: [
                            'Tenez fermement les poignées',
                            'Position debout stable',
                            'Curl classique avec bonne prise',
                            'Concentration sur les biceps',
                            'Mouvement contrôlé'
                        ],
                        tips: ['Prise ferme et sécurisée', 'Concentration maximale', 'Qualité avant quantité'],
                        commonMistakes: ['Prise glissante', 'Mouvement précipité', 'Manque de concentration'],
                        muscleGroups: { primary: ['Biceps'], secondary: ['Avant-bras'] },
                        tags: ['isolation', 'poignées', 'concentration'],
                        imageUrl: null
                    },
                    'Curl biceps en pronation': {
                        difficulty: 'intermediate',
                        description: 'Curl avec prise pronation pour cibler différemment les avant-bras.',
                        instructions: [
                            'Prise en pronation (paumes vers le bas)',
                            'Même mouvement que le curl classique',
                            'Focus sur les avant-bras et biceps',
                            'Contraction intense',
                            'Descente lente'
                        ],
                        tips: ['Prise pronation ferme', 'Travail intense des avant-bras', 'Mouvement précis'],
                        commonMistakes: ['Prise qui glisse', 'Négliger les avant-bras', 'Mouvement trop rapide'],
                        muscleGroups: { primary: ['Avant-bras', 'Biceps'], secondary: ['Brachial'] },
                        tags: ['avant-bras', 'pronation', 'force'],
                        imageUrl: null
                    },

                    // === ÉPAULES ===
                    'Cuban press': {
                        difficulty: 'advanced',
                        description: 'Exercice complexe combinant rotation externe et développé pour les épaules.',
                        instructions: [
                            'Coudes fléchis à 90°, bras parallèles au sol',
                            'Rotation externe en montant les avant-bras',
                            'Développé vertical complet',
                            'Redescendez en inversant le mouvement',
                            'Contrôlez chaque phase'
                        ],
                        tips: ['Mouvement décomposé', 'Rotation externe contrôlée', 'Résistance modérée'],
                        commonMistakes: ['Mouvement trop rapide', 'Sauter la rotation', 'Trop de résistance'],
                        muscleGroups: { primary: ['Deltoïdes', 'Coiffe des rotateurs'], secondary: ['Trapèzes'] },
                        tags: ['épaules', 'rotation', 'complexe', 'stabilité'],
                        imageUrl: null
                    },
                    'Développé arnold': {
                        difficulty: 'advanced',
                        description: 'Développé avec rotation pour solliciter tous les faisceaux des épaules.',
                        instructions: [
                            'Commencez en position curl (paumes vers vous)',
                            'Montez en tournant les paumes vers l\'avant',
                            'Développé complet bras tendus',
                            'Redescendez en inversant la rotation',
                            'Mouvement fluide et contrôlé'
                        ],
                        tips: ['Rotation progressive', 'Mouvement continu', 'Contrôle total'],
                        commonMistakes: ['Rotation trop brusque', 'Pauses dans le mouvement', 'Manque de fluidité'],
                        muscleGroups: { primary: ['Deltoïdes antérieurs', 'Deltoïdes moyens'], secondary: ['Triceps'] },
                        tags: ['épaules', 'rotation', 'développé', 'arnold'],
                        imageUrl: null
                    },
                    'Développé militaire assis': {
                        difficulty: 'intermediate',
                        description: 'Développé pour les épaules en position assise.',
                        instructions: [
                            'Assis, élastique sous les pieds',
                            'Tenez les poignées à hauteur d\'épaules',
                            'Poussez vers le haut',
                            'Étendez complètement les bras',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le dos droit', 'Poussée verticale', 'Extension complète'],
                        commonMistakes: ['Dos rond', 'Poussée vers l\'avant', 'Mouvement partiel'],
                        muscleGroups: { primary: ['Deltoïdes'], secondary: ['Triceps', 'Trapèzes'] },
                        tags: ['composé', 'épaules', 'force'],
                        imageUrl: null
                    },
                    'Élévations frontales': {
                        difficulty: 'beginner',
                        description: 'Isolation du deltoïde antérieur.',
                        instructions: [
                            'Élastique sous les pieds',
                            'Levez un bras devant vous',
                            'Montez jusqu\'à la hauteur des épaules',
                            'Descendez lentement',
                            'Alternez les bras'
                        ],
                        tips: ['Pas plus haut que les épaules', 'Mouvement contrôlé', 'Gardez le torse stable'],
                        commonMistakes: ['Monter trop haut', 'Utiliser l\'élan', 'Pencher en arrière'],
                        muscleGroups: { primary: ['Deltoïde antérieur'], secondary: ['Core'] },
                        tags: ['isolation', 'épaules', 'avant'],
                        imageUrl: null
                    },
                    'Élévations latérales': {
                        difficulty: 'beginner',
                        description: 'Exercice d\'isolation pour développer la largeur des épaules.',
                        instructions: [
                            'Placez l\'élastique sous vos pieds',
                            'Tenez les poignées le long du corps',
                            'Élevez les bras sur les côtés jusqu\'à l\'horizontale',
                            'Maintenez 1 seconde en haut',
                            'Redescendez lentement'
                        ],
                        tips: ['Légère flexion des coudes', 'Pas plus haut que les épaules', 'Contrôlez la descente'],
                        commonMistakes: ['Monter trop haut', 'Utiliser l\'élan', 'Bras tendus', 'Pencher le torse'],
                        muscleGroups: { primary: ['Deltoïde moyen'], secondary: ['Deltoïde antérieur', 'Trapèzes'] },
                        tags: ['isolation', 'épaules', 'largeur'],
                        imageUrl: null
                    },
                    'Oiseau': {
                        difficulty: 'intermediate',
                        description: 'Excellent pour les deltoïdes postérieurs et la posture.',
                        instructions: [
                            'Ancrage à hauteur de poitrine',
                            'Bras tendus devant vous',
                            'Écartez les bras sur les côtés',
                            'Contractez les omoplates',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez les bras tendus', 'Contractez les omoplates', 'Mouvement lent'],
                        commonMistakes: ['Plier les bras', 'Utiliser le dos', 'Mouvement trop rapide'],
                        muscleGroups: { primary: ['Deltoïdes postérieurs'], secondary: ['Rhomboïdes', 'Trapèzes'] },
                        tags: ['isolation', 'épaules', 'posture'],
                        imageUrl: null
                    },
                    'Overhead press': {
                        difficulty: 'intermediate',
                        description: 'Développé vertical pour force et masse des épaules.',
                        instructions: [
                            'Position debout, élastique sous les pieds',
                            'Poignées à hauteur d\'épaules',
                            'Poussez verticalement au-dessus de la tête',
                            'Extension complète des bras',
                            'Redescendez contrôlé'
                        ],
                        tips: ['Trajectory verticale', 'Core engagé', 'Extension complète'],
                        commonMistakes: ['Poussée vers l\'avant', 'Dos cambré', 'Extension partielle'],
                        muscleGroups: { primary: ['Deltoïdes'], secondary: ['Triceps', 'Core'] },
                        tags: ['développé', 'vertical', 'force'],
                        imageUrl: null
                    },
                    'Reverse fly': {
                        difficulty: 'intermediate',
                        description: 'Mouvement inverse pour les deltoïdes postérieurs.',
                        instructions: [
                            'Ancrage frontal à hauteur poitrine',
                            'Bras tendus, écartez vers l\'arrière',
                            'Contractez fortement les omoplates',
                            'Focus sur l\'arrière des épaules',
                            'Retour contrôlé'
                        ],
                        tips: ['Bras tendus', 'Contraction omoplates', 'Mouvement précis'],
                        commonMistakes: ['Plier les bras', 'Négliger la contraction', 'Mouvement trop large'],
                        muscleGroups: { primary: ['Deltoïdes postérieurs'], secondary: ['Rhomboïdes'] },
                        tags: ['arrière épaules', 'posture', 'isolation'],
                        imageUrl: null
                    },
                    'Reverse fly unilatéral': {
                        difficulty: 'intermediate',
                        description: 'Version unilatérale du reverse fly pour plus de focus.',
                        instructions: [
                            'Un bras, ancrage frontal',
                            'Écartez le bras vers l\'arrière',
                            'Contraction maximale du deltoïde postérieur',
                            'Alternez les bras',
                            'Mouvement précis et contrôlé'
                        ],
                        tips: ['Focus sur un côté', 'Contraction maximale', 'Pas de compensation'],
                        commonMistakes: ['Rotation du tronc', 'Mouvement trop rapide', 'Manque de focus'],
                        muscleGroups: { primary: ['Deltoïde postérieur'], secondary: ['Rhomboïdes'] },
                        tags: ['unilatéral', 'arrière épaules', 'précision'],
                        imageUrl: null
                    },
                    'Shrug': {
                        difficulty: 'beginner',
                        description: 'Haussements d\'épaules pour les trapèzes.',
                        instructions: [
                            'Élastique sous les pieds',
                            'Bras tendus le long du corps',
                            'Haussez les épaules vers les oreilles',
                            'Contractez les trapèzes',
                            'Redescendez lentement'
                        ],
                        tips: ['Mouvement vertical pur', 'Contraction forte', 'Pas de rotation'],
                        commonMistakes: ['Rotation des épaules', 'Utiliser les bras', 'Mouvement partiel'],
                        muscleGroups: { primary: ['Trapèzes supérieurs'], secondary: [] },
                        tags: ['trapèzes', 'haussements', 'isolation'],
                        imageUrl: null
                    },
                    'Tirage menton': {
                        difficulty: 'intermediate',
                        description: 'Tirage vertical étroit pour épaules et trapèzes.',
                        instructions: [
                            'Élastique sous les pieds',
                            'Prise rapprochée',
                            'Tirez vers le menton coudes hauts',
                            'Menez avec les coudes',
                            'Descendez contrôlé'
                        ],
                        tips: ['Coudes plus hauts que les mains', 'Prise rapprochée', 'Tirage vers le menton'],
                        commonMistakes: ['Coudes bas', 'Prise trop large', 'Tirage partiel'],
                        muscleGroups: { primary: ['Deltoïdes', 'Trapèzes'], secondary: ['Biceps'] },
                        tags: ['vertical', 'trapèzes', 'épaules'],
                        imageUrl: null
                    },

                    // === DOS ===
                    'Face Pull': {
                        difficulty: 'intermediate',
                        description: 'Excellent exercice pour les deltoïdes postérieurs et la posture.',
                        instructions: [
                            'Ancrez l\'élastique à hauteur d\'épaules',
                            'Tenez les poignées, bras tendus',
                            'Tirez vers votre visage en écartant les coudes',
                            'Contractez les omoplates',
                            'Revenez lentement'
                        ],
                        tips: ['Coudes hauts', 'Contractez le haut du dos', 'Mouvement contrôlé'],
                        commonMistakes: ['Coudes qui descendent', 'Tirer vers le bas', 'Mouvement rapide'],
                        muscleGroups: { primary: ['Deltoïdes postérieurs', 'Rhomboïdes'], secondary: ['Trapèzes'] },
                        tags: ['isolation', 'dos', 'posture'],
                        imageUrl: null
                    },
                    'Face pull (poulie basse)': {
                        difficulty: 'intermediate',
                        description: 'Face pull depuis un ancrage bas pour un angle différent.',
                        instructions: [
                            'Ancrage en bas, tirez vers le visage',
                            'Trajectoire légèrement ascendante',
                            'Coudes écartés',
                            'Contraction du haut du dos',
                            'Retour contrôlé'
                        ],
                        tips: ['Angle ascendant', 'Coudes écartés', 'Focus haut du dos'],
                        commonMistakes: ['Trajectoire horizontale', 'Coudes bas', 'Manque de contraction'],
                        muscleGroups: { primary: ['Deltoïdes postérieurs', 'Rhomboïdes'], secondary: ['Trapèzes moyens'] },
                        tags: ['face pull', 'ancrage bas', 'posture'],
                        imageUrl: null
                    },
                    'Pull-Over': {
                        difficulty: 'intermediate',
                        description: 'Mouvement d\'amplitude pour les dorsaux et la cage thoracique.',
                        instructions: [
                            'Allongé, ancrage derrière la tête',
                            'Bras tendus, amenez au-dessus de la poitrine',
                            'Grand mouvement d\'amplitude',
                            'Étirement des dorsaux',
                            'Retour contrôlé'
                        ],
                        tips: ['Grande amplitude', 'Bras tendus', 'Étirement en position basse'],
                        commonMistakes: ['Amplitude réduite', 'Bras fléchis', 'Mouvement trop rapide'],
                        muscleGroups: { primary: ['Grand dorsal'], secondary: ['Pectoraux', 'Triceps'] },
                        tags: ['amplitude', 'dorsaux', 'étirement'],
                        imageUrl: null
                    },
                    'Rowing buste penché': {
                        difficulty: 'intermediate',
                        description: 'Exercice de base pour l\'épaisseur du dos.',
                        instructions: [
                            'Élastique sous les pieds',
                            'Penchez le buste vers l\'avant',
                            'Tirez les coudes vers l\'arrière',
                            'Contractez les omoplates',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le dos droit', 'Contractez les omoplates', 'Coudes près du corps'],
                        commonMistakes: ['Dos rond', 'Tirer avec les bras', 'Se redresser'],
                        muscleGroups: { primary: ['Grand dorsal', 'Rhomboïdes'], secondary: ['Biceps', 'Trapèzes'] },
                        tags: ['composé', 'dos', 'force'],
                        imageUrl: null
                    },
                    'Rowing buste penché (prise large)': {
                        difficulty: 'intermediate',
                        description: 'Rowing avec prise large pour cibler différemment le dos.',
                        instructions: [
                            'Même position que rowing classique',
                            'Prise plus large sur l\'élastique',
                            'Tirez coudes écartés',
                            'Focus sur les rhomboïdes',
                            'Contraction forte'
                        ],
                        tips: ['Prise large', 'Coudes écartés', 'Rhomboïdes et trapèzes'],
                        commonMistakes: ['Prise trop étroite', 'Coudes collés', 'Mauvais focus'],
                        muscleGroups: { primary: ['Rhomboïdes', 'Trapèzes moyens'], secondary: ['Grand dorsal', 'Biceps'] },
                        tags: ['rowing', 'prise large', 'rhomboïdes'],
                        imageUrl: null
                    },
                    'Rowing buste penché (prise serrée)': {
                        difficulty: 'intermediate',
                        description: 'Rowing prise serrée pour focus sur les dorsaux.',
                        instructions: [
                            'Position rowing classique',
                            'Prise rapprochée',
                            'Tirez coudes près du corps',
                            'Focus dorsaux et rhomboïdes',
                            'Contraction maximale'
                        ],
                        tips: ['Prise serrée', 'Coudes collés', 'Focus dorsaux'],
                        commonMistakes: ['Prise trop large', 'Coudes écartés', 'Mauvaise trajectoire'],
                        muscleGroups: { primary: ['Grand dorsal'], secondary: ['Rhomboïdes', 'Biceps'] },
                        tags: ['rowing', 'prise serrée', 'dorsaux'],
                        imageUrl: null
                    },
                    'Soulevé de terre': {
                        difficulty: 'intermediate',
                        description: 'Mouvement de charnière de hanche fondamental.',
                        instructions: [
                            'Élastique sous les pieds',
                            'Penchez-vous en poussant les hanches arrière',
                            'Gardez le dos droit',
                            'Tirez en contractant les fessiers',
                            'Revenez debout'
                        ],
                        tips: ['Charnière de hanche', 'Dos droit', 'Contractez les fessiers'],
                        commonMistakes: ['Dos rond', 'Plier les genoux', 'Pas de poussée de hanches'],
                        muscleGroups: { primary: ['Fessiers', 'Ischio-jambiers'], secondary: ['Dos', 'Trapèzes'] },
                        tags: ['composé', 'chaîne postérieure', 'force'],
                        imageUrl: null
                    },
                    'Soulevé de terre (prise large)': {
                        difficulty: 'intermediate',
                        description: 'Soulevé de terre avec prise large pour plus de challenge.',
                        instructions: [
                            'Même mouvement, prise plus large',
                            'Augmente la difficulté',
                            'Charnière de hanche stricte',
                            'Focus chaîne postérieure',
                            'Mouvement puissant'
                        ],
                        tips: ['Prise large sécurisée', 'Même technique', 'Plus de challenge'],
                        commonMistakes: ['Prise instable', 'Compenser par le dos', 'Mouvement précipité'],
                        muscleGroups: { primary: ['Fessiers', 'Ischio-jambiers'], secondary: ['Dos', 'Avant-bras'] },
                        tags: ['soulevé', 'prise large', 'challenge'],
                        imageUrl: null
                    },
                    'Tirage Bucheron (poulie basse)': {
                        difficulty: 'intermediate',
                        description: 'Tirage unilatéral en position penchée.',
                        instructions: [
                            'Position fendue, appui sur un genou',
                            'Ancrage bas, tirez vers la hanche',
                            'Mouvement unilatéral',
                            'Focus sur un côté du dos',
                            'Alternez les côtés'
                        ],
                        tips: ['Position stable', 'Tirage vers la hanche', 'Contraction maximale'],
                        commonMistakes: ['Position instable', 'Mauvaise trajectoire', 'Rotation du tronc'],
                        muscleGroups: { primary: ['Grand dorsal'], secondary: ['Rhomboïdes', 'Biceps'] },
                        tags: ['unilatéral', 'bucheron', 'dorsaux'],
                        imageUrl: null
                    },
                    'Tirage horizontal unilatéral': {
                        difficulty: 'intermediate',
                        description: 'Tirage horizontal pour développer l\'épaisseur du dos.',
                        instructions: [
                            'Ancrage à hauteur de poitrine',
                            'Un bras tendu devant vous',
                            'Tirez le coude vers l\'arrière',
                            'Contractez le dos',
                            'Alternez les bras'
                        ],
                        tips: ['Coude près du corps', 'Contractez le dos', 'Mouvement contrôlé'],
                        commonMistakes: ['Tirer avec le bras', 'Coude qui s\'écarte', 'Rotation du torse'],
                        muscleGroups: { primary: ['Grand dorsal', 'Rhomboïdes'], secondary: ['Biceps'] },
                        tags: ['unilatéral', 'dos', 'épaisseur'],
                        imageUrl: null
                    },
                    'Tirage poulie basse': {
                        difficulty: 'intermediate',
                        description: 'Tirage horizontal depuis un ancrage bas.',
                        instructions: [
                            'Assis ou debout, ancrage en bas',
                            'Tirez vers l\'abdomen',
                            'Coudes près du corps',
                            'Contractez les omoplates',
                            'Retour contrôlé'
                        ],
                        tips: ['Position stable', 'Tirage vers l\'abdomen', 'Omoplates serrées'],
                        commonMistakes: ['Position instable', 'Tirage trop haut', 'Manque de contraction'],
                        muscleGroups: { primary: ['Grand dorsal', 'Rhomboïdes'], secondary: ['Biceps'] },
                        tags: ['horizontal', 'poulie basse', 'masse'],
                        imageUrl: null
                    },
                    'Tirage poulie basse (supination)': {
                        difficulty: 'intermediate',
                        description: 'Tirage poulie basse avec prise supination.',
                        instructions: [
                            'Même position, prise en supination',
                            'Paumes vers le haut',
                            'Tirage vers l\'abdomen',
                            'Plus de sollicitation des biceps',
                            'Contraction dorsaux et biceps'
                        ],
                        tips: ['Prise supination ferme', 'Tirage strict', 'Double sollicitation'],
                        commonMistakes: ['Prise qui glisse', 'Tirer avec les biceps uniquement', 'Oublier le dos'],
                        muscleGroups: { primary: ['Grand dorsal', 'Biceps'], secondary: ['Rhomboïdes'] },
                        tags: ['supination', 'biceps', 'dorsaux'],
                        imageUrl: null
                    },
                    'Tirage vertical': {
                        difficulty: 'intermediate',
                        description: 'Simulation de tractions pour la largeur du dos.',
                        instructions: [
                            'Ancrez l\'élastique en haut',
                            'Bras tendus au-dessus de la tête',
                            'Tirez les coudes vers les côtes',
                            'Contractez le dos',
                            'Remontez lentement'
                        ],
                        tips: ['Penchez-vous légèrement', 'Contractez les dorsaux', 'Tirez avec le dos'],
                        commonMistakes: ['Tirer avec les bras', 'Pas assez penché', 'Mouvement rapide'],
                        muscleGroups: { primary: ['Grand dorsal'], secondary: ['Biceps', 'Rhomboïdes'] },
                        tags: ['composé', 'dos', 'largeur'],
                        imageUrl: null
                    },
                    'Tirage vertical (prise serrée)': {
                        difficulty: 'intermediate',
                        description: 'Tirage vertical avec prise rapprochée.',
                        instructions: [
                            'Ancrage haut, prise serrée',
                            'Tirez vers la poitrine',
                            'Focus sur les dorsaux',
                            'Coudes près du corps',
                            'Contraction maximale'
                        ],
                        tips: ['Prise rapprochée', 'Coudes collés', 'Focus dorsaux'],
                        commonMistakes: ['Prise trop large', 'Coudes écartés', 'Tirage partiel'],
                        muscleGroups: { primary: ['Grand dorsal'], secondary: ['Biceps'] },
                        tags: ['vertical', 'prise serrée', 'dorsaux'],
                        imageUrl: null
                    },
                    'Tirage vertical (supination)': {
                        difficulty: 'intermediate',
                        description: 'Tirage vertical en supination pour plus de biceps.',
                        instructions: [
                            'Ancrage haut, paumes vers soi',
                            'Tirage en supination',
                            'Sollicitation dorsaux et biceps',
                            'Mouvement puissant',
                            'Double contraction'
                        ],
                        tips: ['Prise supination ferme', 'Double focus', 'Mouvement puissant'],
                        commonMistakes: ['Négliger les dorsaux', 'Prise instable', 'Déséquilibre'],
                        muscleGroups: { primary: ['Grand dorsal', 'Biceps'], secondary: ['Rhomboïdes'] },
                        tags: ['supination', 'biceps', 'vertical'],
                        imageUrl: null
                    },
                    'Tirage vertical unilatéral': {
                        difficulty: 'intermediate',
                        description: 'Tirage vertical un bras pour plus de focus.',
                        instructions: [
                            'Ancrage haut, un bras',
                            'Tirage unilatéral vers la côte',
                            'Focus sur un côté',
                            'Contraction maximale',
                            'Alternez les bras'
                        ],
                        tips: ['Focus sur un côté', 'Pas de compensation', 'Contraction maximale'],
                        commonMistakes: ['Rotation du tronc', 'Manque de focus', 'Mouvement compensé'],
                        muscleGroups: { primary: ['Grand dorsal'], secondary: ['Biceps'] },
                        tags: ['unilatéral', 'vertical', 'focus'],
                        imageUrl: null
                    },

                    // === JAMBES ===
                    'Abduction de hanches': {
                        difficulty: 'beginner',
                        description: 'Exercice pour les muscles abducteurs (côté des hanches).',
                        instructions: [
                            'Élastique autour des chevilles ou genoux',
                            'Écartez la jambe sur le côté',
                            'Gardez le tronc stable',
                            'Contractez les fessiers',
                            'Revenez contrôlé'
                        ],
                        tips: ['Mouvement latéral pur', 'Tronc stable', 'Contraction fessiers'],
                        commonMistakes: ['Pencher le tronc', 'Mouvement vers l\'avant', 'Manque de contrôle'],
                        muscleGroups: { primary: ['Abducteurs', 'Moyen fessier'], secondary: ['Core'] },
                        tags: ['abducteurs', 'fessiers', 'stabilité'],
                        imageUrl: null
                    },
                    'Adduction de hanches': {
                        difficulty: 'beginner',
                        description: 'Exercice pour les muscles adducteurs (intérieur des cuisses).',
                        instructions: [
                            'Élastique fixé, jambe vers l\'intérieur',
                            'Ramenez la jambe vers la ligne médiane',
                            'Contractez l\'intérieur de la cuisse',
                            'Mouvement contrôlé',
                            'Alternez les jambes'
                        ],
                        tips: ['Mouvement vers l\'intérieur', 'Contraction adducteurs', 'Contrôle total'],
                        commonMistakes: ['Mouvement trop ample', 'Vitesse excessive', 'Position instable'],
                        muscleGroups: { primary: ['Adducteurs'], secondary: ['Core'] },
                        tags: ['adducteurs', 'intérieur cuisse', 'isolation'],
                        imageUrl: null
                    },
                    'Donkey kick': {
                        difficulty: 'beginner',
                        description: 'Excellent exercice pour les fessiers.',
                        instructions: [
                            'À quatre pattes, élastique sous le pied',
                            'Poussez la jambe vers l\'arrière et le haut',
                            'Contractez fortement les fessiers',
                            'Gardez le dos droit',
                            'Alternez les jambes'
                        ],
                        tips: ['Poussée puissante', 'Contraction fessiers', 'Dos stable'],
                        commonMistakes: ['Dos qui bouge', 'Jambe trop haute', 'Manque de contraction'],
                        muscleGroups: { primary: ['Fessiers'], secondary: ['Ischio-jambiers'] },
                        tags: ['fessiers', 'unilatéral', 'isolation'],
                        imageUrl: null
                    },
                    'Donkey kick (jambes fléchies)': {
                        difficulty: 'beginner',
                        description: 'Variante du donkey kick avec jambe fléchie.',
                        instructions: [
                            'Position quadrupédie',
                            'Jambe fléchie à 90°',
                            'Poussez le talon vers le plafond',
                            'Contraction intense des fessiers',
                            'Jambe reste fléchie'
                        ],
                        tips: ['Jambe toujours fléchie', 'Poussée du talon', 'Focus fessiers'],
                        commonMistakes: ['Tendre la jambe', 'Mouvement du dos', 'Vitesse excessive'],
                        muscleGroups: { primary: ['Fessiers'], secondary: ['Ischio-jambiers'] },
                        tags: ['fessiers', 'jambe fléchie', 'isolation'],
                        imageUrl: null
                    },
                    'Extensions mollets': {
                        difficulty: 'beginner',
                        description: 'Exercice pour développer les mollets.',
                        instructions: [
                            'Debout, élastique sous les pieds',
                            'Montez sur la pointe des pieds',
                            'Contractez les mollets en haut',
                            'Descendez lentement',
                            'Amplitude complète'
                        ],
                        tips: ['Montée haute', 'Contraction en haut', 'Descente lente'],
                        commonMistakes: ['Amplitude réduite', 'Descente rapide', 'Manque de contraction'],
                        muscleGroups: { primary: ['Mollets'], secondary: [] },
                        tags: ['mollets', 'extension', 'isolation'],
                        imageUrl: null
                    },
                    'Extensions mollets unilatérales': {
                        difficulty: 'intermediate',
                        description: 'Extensions de mollets sur une jambe pour plus d\'intensité.',
                        instructions: [
                            'Debout sur une jambe',
                            'Extension du mollet unilatérale',
                            'Équilibre et contraction',
                            'Amplitude maximale',
                            'Alternez les jambes'
                        ],
                        tips: ['Équilibre parfait', 'Contraction maximale', 'Une jambe à la fois'],
                        commonMistakes: ['Perte d\'équilibre', 'Amplitude réduite', 'Manque de focus'],
                        muscleGroups: { primary: ['Mollets'], secondary: ['Core'] },
                        tags: ['mollets', 'unilatéral', 'équilibre'],
                        imageUrl: null
                    },
                    'Fentes': {
                        difficulty: 'intermediate',
                        description: 'Exercice unilatéral pour jambes et équilibre.',
                        instructions: [
                            'Élastique sous le pied avant',
                            'Grand pas en arrière',
                            'Descendez en fléchissant les genoux',
                            'Genou arrière frôle le sol',
                            'Remontez sur le pied avant'
                        ],
                        tips: ['Gardez le torse droit', 'Poids sur le pied avant', 'Descendez bien bas'],
                        commonMistakes: ['Pas assez grand', 'Pencher avant', 'Pas assez bas'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers', 'Core'] },
                        tags: ['unilatéral', 'jambes', 'équilibre'],
                        imageUrl: null
                    },
                    'Fentes bulgares': {
                        difficulty: 'advanced',
                        description: 'Fentes avec pied arrière surélevé.',
                        instructions: [
                            'Pied arrière sur support élevé',
                            'Fente sur la jambe avant',
                            'Plus d\'amplitude et de difficulté',
                            'Focus sur la jambe avant',
                            'Stabilité maximale'
                        ],
                        tips: ['Support stable', 'Focus jambe avant', 'Amplitude maximale'],
                        commonMistakes: ['Support instable', 'Répartition du poids', 'Amplitude réduite'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers'] },
                        tags: ['fentes', 'avancé', 'surélevé'],
                        imageUrl: null
                    },
                    'Front squat': {
                        difficulty: 'intermediate',
                        description: 'Squat avec résistance frontale, plus difficile.',
                        instructions: [
                            'Élastique sous les pieds',
                            'Tenez les poignées devant les épaules',
                            'Squat normal en gardant les coudes hauts',
                            'Résistance frontale constante',
                            'Remontez en poussant les talons'
                        ],
                        tips: ['Coudes hauts', 'Gardez le torse droit', 'Résistance constante'],
                        commonMistakes: ['Coudes qui descendent', 'Pencher vers l\'avant', 'Mauvaise posture'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Core', 'Ischio-jambiers'] },
                        tags: ['composé', 'jambes', 'core'],
                        imageUrl: null
                    },
                    'Hip thrust': {
                        difficulty: 'intermediate',
                        description: 'Excellent pour développer les fessiers.',
                        instructions: [
                            'Allongé, élastique sur les hanches',
                            'Pieds au sol, genoux fléchis',
                            'Poussez les hanches vers le haut',
                            'Contractez les fessiers en haut',
                            'Redescendez lentement'
                        ],
                        tips: ['Contractez fort les fessiers', 'Gardez le dos droit', 'Poussée vers le haut'],
                        commonMistakes: ['Pousser avec le dos', 'Pas de contraction', 'Mouvement partiel'],
                        muscleGroups: { primary: ['Fessiers'], secondary: ['Ischio-jambiers', 'Core'] },
                        tags: ['isolation', 'fessiers', 'force'],
                        imageUrl: null
                    },
                    'Leg curl': {
                        difficulty: 'intermediate',
                        description: 'Flexion des jambes pour les ischio-jambiers.',
                        instructions: [
                            'Allongé ventre, élastique aux chevilles',
                            'Fléchissez les jambes vers les fessiers',
                            'Contractez les ischio-jambiers',
                            'Descendez lentement',
                            'Amplitude complète'
                        ],
                        tips: ['Contraction ischio-jambiers', 'Mouvement contrôlé', 'Amplitude maximale'],
                        commonMistakes: ['Mouvement trop rapide', 'Amplitude partielle', 'Compensation avec le dos'],
                        muscleGroups: { primary: ['Ischio-jambiers'], secondary: ['Mollets'] },
                        tags: ['ischio-jambiers', 'flexion', 'isolation'],
                        imageUrl: null
                    },
                    'Leg extension unilatérale': {
                        difficulty: 'intermediate',
                        description: 'Extension de jambe unilatérale pour les quadriceps.',
                        instructions: [
                            'Assis, élastique sous le pied',
                            'Extension de jambe vers l\'avant',
                            'Contraction des quadriceps',
                            'Une jambe à la fois',
                            'Mouvement contrôlé'
                        ],
                        tips: ['Extension complète', 'Contraction quadriceps', 'Mouvement isolé'],
                        commonMistakes: ['Extension partielle', 'Mouvement brusque', 'Compensation corporelle'],
                        muscleGroups: { primary: ['Quadriceps'], secondary: [] },
                        tags: ['quadriceps', 'unilatéral', 'extension'],
                        imageUrl: null
                    },
                    'Soulevé de terre jambes tendues': {
                        difficulty: 'intermediate',
                        description: 'Variante du soulevé ciblant plus les ischio-jambiers.',
                        instructions: [
                            'Jambes tendues ou légèrement fléchies',
                            'Penchez-vous en gardant les jambes droites',
                            'Focus sur les ischio-jambiers',
                            'Étirement en bas',
                            'Remontée contrôlée'
                        ],
                        tips: ['Jambes quasi-tendues', 'Étirement ischio-jambiers', 'Dos droit'],
                        commonMistakes: ['Trop plier les genoux', 'Dos rond', 'Amplitude insuffisante'],
                        muscleGroups: { primary: ['Ischio-jambiers', 'Fessiers'], secondary: ['Dos'] },
                        tags: ['ischio-jambiers', 'étirement', 'jambes tendues'],
                        imageUrl: null
                    },
                    'Squat': {
                        difficulty: 'beginner',
                        description: 'Exercice roi pour les jambes et les fessiers.',
                        instructions: [
                            'Élastique sous les pieds',
                            'Pieds écartés largeur d\'épaules',
                            'Descendez en poussant les hanches arrière',
                            'Gardez le dos droit',
                            'Remontez en poussant sur les talons'
                        ],
                        tips: ['Genoux dans l\'axe', 'Descendez bien bas', 'Gardez la poitrine haute'],
                        commonMistakes: ['Genoux vers l\'intérieur', 'Dos rond', 'Pas assez profond'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Ischio-jambiers', 'Mollets'] },
                        tags: ['composé', 'jambes', 'force', 'fonctionnel'],
                        imageUrl: null
                    },
                    'Squat sumo': {
                        difficulty: 'intermediate',
                        description: 'Squat avec position large pour cibler différemment.',
                        instructions: [
                            'Position très large, pieds tournés vers l\'extérieur',
                            'Squat avec cette position sumo',
                            'Plus de sollicitation des adducteurs',
                            'Descendez entre les jambes',
                            'Poussée puissante'
                        ],
                        tips: ['Position très large', 'Pieds tournés', 'Descendre profond'],
                        commonMistakes: ['Position pas assez large', 'Pieds parallèles', 'Amplitude insuffisante'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers', 'Adducteurs'], secondary: ['Ischio-jambiers'] },
                        tags: ['sumo', 'adducteurs', 'large'],
                        imageUrl: null
                    },
                    'Squat swing': {
                        difficulty: 'intermediate',
                        description: 'Squat avec mouvement de balancier dynamique.',
                        instructions: [
                            'Squat avec mouvement de balancier',
                            'Momentum contrôlé',
                            'Aspect cardio et force',
                            'Rythmé et fluide',
                            'Stabilité du core'
                        ],
                        tips: ['Mouvement fluide', 'Rythme constant', 'Core engagé'],
                        commonMistakes: ['Perte de contrôle', 'Mouvement saccadé', 'Instabilité'],
                        muscleGroups: { primary: ['Quadriceps', 'Fessiers'], secondary: ['Core', 'Cardio'] },
                        tags: ['dynamique', 'cardio', 'swing'],
                        imageUrl: null
                    },
                    'Thruster': {
                        difficulty: 'advanced',
                        description: 'Combinaison squat + développé pour tout le corps.',
                        instructions: [
                            'Squat avec élastique',
                            'En remontant, développé au-dessus de la tête',
                            'Mouvement combiné fluide',
                            'Explosif et complet',
                            'Corps entier sollicité'
                        ],
                        tips: ['Mouvement fluide', 'Transition squat-développé', 'Explosivité'],
                        commonMistakes: ['Pause entre les mouvements', 'Manque de fluidité', 'Déséquilibre'],
                        muscleGroups: { primary: ['Corps entier'], secondary: [] },
                        tags: ['corps entier', 'explosif', 'combiné'],
                        imageUrl: null
                    },

                    // === PECTORAUX ===
                    'Développé épaules debout': {
                        difficulty: 'intermediate',
                        description: 'Développé debout ciblant épaules et haut des pectoraux.',
                        instructions: [
                            'Debout, élastique sous les pieds',
                            'Développé vers le haut et l\'avant',
                            'Sollicitation épaules et pectoraux',
                            'Trajectoire légèrement oblique',
                            'Extension complète'
                        ],
                        tips: ['Trajectoire optimale', 'Extension complète', 'Stabilité corporelle'],
                        commonMistakes: ['Mauvaise trajectoire', 'Instabilité', 'Extension partielle'],
                        muscleGroups: { primary: ['Deltoïdes', 'Pectoraux'], secondary: ['Triceps'] },
                        tags: ['développé', 'épaules', 'debout'],
                        imageUrl: null
                    },
                    'Développé debout (poulie moyenne)': {
                        difficulty: 'intermediate',
                        description: 'Développé pour les pectoraux en position debout.',
                        instructions: [
                            'Ancrage à hauteur de poitrine',
                            'Dos à l\'ancrage, poignées en main',
                            'Poussez devant vous',
                            'Contractez les pectoraux',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le dos droit', 'Contractez les pectoraux', 'Mouvement fluide'],
                        commonMistakes: ['Pencher vers l\'avant', 'Mouvement rapide', 'Pas de contraction'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Deltoïdes antérieurs', 'Triceps'] },
                        tags: ['composé', 'pectoraux', 'poussée'],
                        imageUrl: null
                    },
                    'Développé debout (2 ancrages)': {
                        difficulty: 'advanced',
                        description: 'Développé avec deux points d\'ancrage pour plus de résistance.',
                        instructions: [
                            'Deux ancrages symétriques',
                            'Développé avec double résistance',
                            'Plus de stabilité requise',
                            'Mouvement coordonné',
                            'Résistance équilibrée'
                        ],
                        tips: ['Ancrages symétriques', 'Mouvement coordonné', 'Stabilité renforcée'],
                        commonMistakes: ['Ancrages déséquilibrés', 'Mouvement non coordonné', 'Instabilité'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Deltoïdes', 'Triceps', 'Core'] },
                        tags: ['double ancrage', 'stabilité', 'avancé'],
                        imageUrl: null
                    },
                    'Développé décliné': {
                        difficulty: 'intermediate',
                        description: 'Développé vers le bas pour le bas des pectoraux.',
                        instructions: [
                            'Ancrage en haut',
                            'Poussée vers le bas et l\'avant',
                            'Cible le bas des pectoraux',
                            'Angle descendant',
                            'Contraction spécifique'
                        ],
                        tips: ['Angle décliné', 'Focus bas pectoraux', 'Trajectoire descendante'],
                        commonMistakes: ['Mauvais angle', 'Trajectoire horizontale', 'Manque de focus'],
                        muscleGroups: { primary: ['Pectoraux (partie basse)'], secondary: ['Triceps', 'Deltoïdes'] },
                        tags: ['décliné', 'bas pectoraux', 'angle'],
                        imageUrl: null
                    },
                    'Développé incliné': {
                        difficulty: 'intermediate',
                        description: 'Variante inclinée pour cibler le haut des pectoraux.',
                        instructions: [
                            'Ancrage en bas',
                            'Poussez vers le haut et l\'avant',
                            'Angle de 45 degrés',
                            'Contractez le haut des pectoraux',
                            'Revenez contrôlé'
                        ],
                        tips: ['Bon angle de poussée', 'Contractez le haut', 'Mouvement contrôlé'],
                        commonMistakes: ['Mauvais angle', 'Mouvement trop rapide', 'Pas de contraction'],
                        muscleGroups: { primary: ['Pectoraux (partie haute)'], secondary: ['Deltoïdes', 'Triceps'] },
                        tags: ['composé', 'pectoraux', 'incliné'],
                        imageUrl: null
                    },
                    'Développé incliné (poulie basse)': {
                        difficulty: 'intermediate',
                        description: 'Développé incliné depuis un ancrage bas.',
                        instructions: [
                            'Ancrage très bas',
                            'Trajectoire ascendante marquée',
                            'Cible spécifiquement le haut des pectoraux',
                            'Angle optimal',
                            'Extension complète'
                        ],
                        tips: ['Ancrage bas', 'Trajectoire ascendante', 'Focus haut pectoraux'],
                        commonMistakes: ['Ancrage pas assez bas', 'Trajectoire plate', 'Mauvais focus'],
                        muscleGroups: { primary: ['Pectoraux (partie haute)'], secondary: ['Deltoïdes antérieurs'] },
                        tags: ['incliné', 'poulie basse', 'haut pectoraux'],
                        imageUrl: null
                    },
                    'Développé joint (poulie basse)': {
                        difficulty: 'intermediate',
                        description: 'Développé avec les mains jointes depuis un ancrage bas.',
                        instructions: [
                            'Mains jointes, ancrage bas',
                            'Poussée avec mains ensemble',
                            'Sollicitation différente',
                            'Stabilité accrue',
                            'Contraction centrale'
                        ],
                        tips: ['Mains bien jointes', 'Mouvement stable', 'Focus central'],
                        commonMistakes: ['Mains qui se séparent', 'Instabilité', 'Mouvement désordonné'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Triceps', 'Core'] },
                        tags: ['mains jointes', 'stabilité', 'central'],
                        imageUrl: null
                    },
                    'Développé joint (poulie haute)': {
                        difficulty: 'intermediate',
                        description: 'Développé mains jointes depuis un ancrage haut.',
                        instructions: [
                            'Ancrage haut, mains jointes',
                            'Poussée vers le bas et l\'avant',
                            'Angle descendant',
                            'Stabilité maximale',
                            'Contraction spécifique'
                        ],
                        tips: ['Union des mains', 'Trajectoire descendante', 'Stabilité corporelle'],
                        commonMistakes: ['Mains instables', 'Mauvaise trajectoire', 'Déséquilibre'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Triceps', 'Deltoïdes'] },
                        tags: ['poulie haute', 'mains jointes', 'descendant'],
                        imageUrl: null
                    },
                    'Développé 1 ancrage (poulie haute)': {
                        difficulty: 'advanced',
                        description: 'Développé avec un seul ancrage haut pour plus de challenge.',
                        instructions: [
                            'Un seul ancrage en haut',
                            'Plus de défi d\'équilibre',
                            'Développé asymétrique',
                            'Stabilisation corporelle',
                            'Focus sur la coordination'
                        ],
                        tips: ['Équilibre parfait', 'Stabilisation active', 'Mouvement contrôlé'],
                        commonMistakes: ['Perte d\'équilibre', 'Compensation corporelle', 'Mouvement désordonné'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Core', 'Stabilisateurs'] },
                        tags: ['un ancrage', 'équilibre', 'challenge'],
                        imageUrl: null
                    },
                    'Développé joint (poulie moyenne)': {
                        difficulty: 'intermediate',
                        description: 'Développé mains jointes depuis un ancrage moyen.',
                        instructions: [
                            'Ancrage à hauteur poitrine',
                            'Mains jointes ensemble',
                            'Développé horizontal',
                            'Stabilité et coordination',
                            'Mouvement unifié'
                        ],
                        tips: ['Mains solidaires', 'Mouvement horizontal', 'Coordination parfaite'],
                        commonMistakes: ['Séparation des mains', 'Mouvement désordonné', 'Instabilité'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Triceps', 'Core'] },
                        tags: ['poulie moyenne', 'horizontal', 'coordination'],
                        imageUrl: null
                    },
                    'Écarté unilatéral': {
                        difficulty: 'intermediate',
                        description: 'Isolation des pectoraux avec étirement.',
                        instructions: [
                            'Ancrage à hauteur de poitrine',
                            'Bras tendu sur le côté',
                            'Ramenez le bras devant la poitrine',
                            'Contractez le pectoral',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le bras tendu', 'Bon étirement', 'Contraction forte'],
                        commonMistakes: ['Plier le bras', 'Pas assez d\'étirement', 'Mouvement rapide'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: [] },
                        tags: ['isolation', 'pectoraux', 'étirement'],
                        imageUrl: null
                    },
                    'Écarté unilatéral (poulie basse)': {
                        difficulty: 'intermediate',
                        description: 'Écarté unilatéral depuis un ancrage bas.',
                        instructions: [
                            'Ancrage bas, écarté vers le haut',
                            'Trajectoire ascendante',
                            'Focus sur le haut des pectoraux',
                            'Bras tendu',
                            'Étirement maximal'
                        ],
                        tips: ['Trajectoire ascendante', 'Bras tendu', 'Étirement en bas'],
                        commonMistakes: ['Trajectoire plate', 'Bras fléchi', 'Amplitude réduite'],
                        muscleGroups: { primary: ['Pectoraux (partie haute)'], secondary: [] },
                        tags: ['écarté', 'poulie basse', 'ascendant'],
                        imageUrl: null
                    },
                    'Écarté unilatéral (poulie haute)': {
                        difficulty: 'intermediate',
                        description: 'Écarté unilatéral depuis un ancrage haut.',
                        instructions: [
                            'Ancrage haut, écarté vers le bas',
                            'Trajectoire descendante',
                            'Focus bas des pectoraux',
                            'Amplitude maximale',
                            'Contraction intense'
                        ],
                        tips: ['Trajectoire descendante', 'Amplitude maximale', 'Focus bas pectoraux'],
                        commonMistakes: ['Trajectoire horizontale', 'Amplitude réduite', 'Manque de focus'],
                        muscleGroups: { primary: ['Pectoraux (partie basse)'], secondary: [] },
                        tags: ['écarté', 'poulie haute', 'descendant'],
                        imageUrl: null
                    },
                    'Pompes lestées': {
                        difficulty: 'advanced',
                        description: 'Pompes avec résistance élastique pour plus de difficulté.',
                        instructions: [
                            'Position de pompes, élastique sur le dos',
                            'Tenez les extrémités sous les mains',
                            'Effectuez des pompes normales',
                            'La résistance augmente en montant',
                            'Descendez lentement'
                        ],
                        tips: ['Gardez le corps aligné', 'Résistance progressive', 'Mouvement complet'],
                        commonMistakes: ['Corps mal aligné', 'Mouvement partiel', 'Trop de résistance'],
                        muscleGroups: { primary: ['Pectoraux'], secondary: ['Triceps', 'Deltoïdes', 'Core'] },
                        tags: ['composé', 'pectoraux', 'avancé'],
                        imageUrl: null
                    },

                    // === TRICEPS ===
                    'Triceps barre au front': {
                        difficulty: 'intermediate',
                        description: 'Extension des triceps en position allongée.',
                        instructions: [
                            'Allongé, élastique ancré derrière',
                            'Bras tendus vers le plafond',
                            'Fléchissez seulement les avant-bras',
                            'Extension vers le front',
                            'Mouvement des avant-bras uniquement'
                        ],
                        tips: ['Coudes fixes', 'Mouvement des avant-bras seuls', 'Étirement en bas'],
                        commonMistakes: ['Bouger les coudes', 'Mouvement des bras entiers', 'Amplitude partielle'],
                        muscleGroups: { primary: ['Triceps'], secondary: [] },
                        tags: ['extension', 'allongé', 'isolation'],
                        imageUrl: null
                    },
                    'Extension triceps (poulie haute)': {
                        difficulty: 'beginner',
                        description: 'Exercice d\'isolation classique pour développer les triceps.',
                        instructions: [
                            'Ancrez l\'élastique en haut',
                            'Tenez les poignées, coudes près du corps',
                            'Étendez les avant-bras vers le bas',
                            'Contractez les triceps en bas',
                            'Remontez lentement'
                        ],
                        tips: ['Gardez les coudes fixes', 'Mouvement des avant-bras uniquement', 'Contractez fort en bas'],
                        commonMistakes: ['Bouger les coudes', 'Utiliser le dos', 'Mouvement partiel'],
                        muscleGroups: { primary: ['Triceps'], secondary: ['Deltoïdes antérieurs'] },
                        tags: ['isolation', 'triceps', 'bras'],
                        imageUrl: null
                    },
                    'Extension triceps verticale': {
                        difficulty: 'intermediate',
                        description: 'Extension triceps au-dessus de la tête pour étirer le muscle.',
                        instructions: [
                            'Élastique derrière le dos, une main en haut',
                            'Étendez le bras vers le haut',
                            'Gardez le coude près de l\'oreille',
                            'Descendez lentement',
                            'Alternez les bras'
                        ],
                        tips: ['Coude près de la tête', 'Mouvement contrôlé', 'Bon étirement en bas'],
                        commonMistakes: ['Coude qui part sur le côté', 'Mouvement trop rapide', 'Mauvaise position'],
                        muscleGroups: { primary: ['Triceps (chef long)'], secondary: [] },
                        tags: ['isolation', 'triceps', 'étirement'],
                        imageUrl: null
                    },
                    'Extension triceps verticale (poulie basse)': {
                        difficulty: 'intermediate',
                        description: 'Extension verticale depuis un ancrage bas.',
                        instructions: [
                            'Ancrage bas, bras au-dessus de la tête',
                            'Extension verticale des triceps',
                            'Coudes fixes près des oreilles',
                            'Mouvement des avant-bras',
                            'Étirement maximal'
                        ],
                        tips: ['Coudes hauts et fixes', 'Mouvement vertical pur', 'Étirement en bas'],
                        commonMistakes: ['Coudes qui bougent', 'Mouvement oblique', 'Amplitude réduite'],
                        muscleGroups: { primary: ['Triceps'], secondary: ['Core'] },
                        tags: ['vertical', 'poulie basse', 'étirement'],
                        imageUrl: null
                    },
                    'Kickback triceps (poulie basse)': {
                        difficulty: 'intermediate',
                        description: 'Kickback depuis un ancrage bas.',
                        instructions: [
                            'Ancrage bas, buste penché',
                            'Extension du bras vers l\'arrière',
                            'Bras parallèle au sol',
                            'Contraction maximale',
                            'Mouvement de l\'avant-bras'
                        ],
                        tips: ['Bras parallèle au sol', 'Coude fixe', 'Contraction forte'],
                        commonMistakes: ['Bras qui descend', 'Mouvement du coude', 'Contraction insuffisante'],
                        muscleGroups: { primary: ['Triceps'], secondary: [] },
                        tags: ['kickback', 'poulie basse', 'isolation'],
                        imageUrl: null
                    },
                    'Kickback triceps unilatéral': {
                        difficulty: 'intermediate',
                        description: 'Isolation des triceps en position penchée.',
                        instructions: [
                            'Penchez-vous vers l\'avant, coude fixe',
                            'Étendez l\'avant-bras vers l\'arrière',
                            'Gardez le bras parallèle au sol',
                            'Contractez en fin de mouvement',
                            'Revenez lentement'
                        ],
                        tips: ['Gardez le coude fixe', 'Bras parallèle au sol', 'Contraction forte'],
                        commonMistakes: ['Bouger le coude', 'Bras qui descend', 'Utiliser l\'élan'],
                        muscleGroups: { primary: ['Triceps'], secondary: [] },
                        tags: ['isolation', 'triceps', 'unilatéral'],
                        imageUrl: null
                    }
                };

                // Données par défaut pour exercices non référencés
                const defaultData = {
                    difficulty: 'beginner',
                    description: 'Exercice avec élastiques SmartWorkout. Consultez votre guide pour plus de détails.',
                    instructions: [
                        'Préparez votre élastique selon la résistance désirée',
                        'Adoptez une position stable et sécurisée',
                        'Effectuez le mouvement de manière contrôlée',
                        'Respirez correctement pendant l\'exercice'
                    ],
                    tips: [
                        'Commencez avec une résistance légère',
                        'Augmentez progressivement la difficulté',
                        'Maintenez une bonne technique'
                    ],
                    commonMistakes: [
                        'Résistance trop importante au début',
                        'Mouvements trop rapides',
                        'Mauvaise position de départ'
                    ],
                    muscleGroups: {
                        primary: [exercise.muscle_group || 'Non défini'],
                        secondary: []
                    },
                    tags: ['elastique', exercise.muscle_group || 'general'],
                    imageUrl: null
                };

                return enrichedDatabase[exercise.name] || defaultData;
            },

            renderExerciseResults(exercises) {
                const resultsContainer = document.getElementById('exercise-database-results');
            
                if (exercises.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="card">
                            <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                                🔍 Aucun exercice trouvé avec ces critères
                            </p>
                        </div>
                    `;
                    return;
                }
            
                // En-tête avec compteur
                let html = `
                    <div class="card">
                        <h3>📋 ${exercises.length} exercice${exercises.length > 1 ? 's' : ''} trouvé${exercises.length > 1 ? 's' : ''}</h3>
                    </div>
                `;
            
                if (appState.exerciseView === 'grid') {
                    // Vue grille - cartes compactes
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">';
                    
                    exercises.forEach(exercise => {
                        const difficultyColor = {
                            'beginner': '#34C759',
                            'intermediate': '#FF9500', 
                            'advanced': '#FF3B30'
                        };
                    
                        const difficultyLabel = {
                            'beginner': '🟢 Débutant',
                            'intermediate': '🟡 Intermédiaire',
                            'advanced': '🔴 Confirmé'
                        };
                    
                        html += `
                            <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="actions.showExerciseDetails(${exercise.id})">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <h4 style="margin: 0; flex: 1;">${exercise.name}</h4>
                                    <span style="background: ${difficultyColor[exercise.difficulty]}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; white-space: nowrap;">
                                        ${difficultyLabel[exercise.difficulty]}
                                    </span>
                                </div>
                            
                                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                                    ${exercise.description.substring(0, 100)}...
                                </div>
                            
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
                                    <span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">
                                        ${exercise.muscle_group}
                                    </span>
                                    ${exercise.is_unilateral ? '<span style="background: var(--warning); color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">Unilatéral</span>' : ''}
                                    ${exercise.tags.slice(0, 2).map(tag => 
                                        `<span style="background: var(--border); color: var(--text-secondary); padding: 2px 6px; border-radius: 8px; font-size: 11px;">${tag}</span>`
                                    ).join('')}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-secondary);">
                                    <span>👆 Cliquer pour détails</span>
                                    <span>${exercise.muscleGroups.primary.length} muscles ciblés</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    // Vue liste - format compact
                    exercises.forEach(exercise => {
                        const difficultyIcon = {
                            'beginner': '🟢',
                            'intermediate': '🟡',
                            'advanced': '🔴'
                        };
                    
                        html += `
                            <div class="exercise-item" style="cursor: pointer;" onclick="actions.showExerciseDetails(${exercise.id})">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <strong>${exercise.name}</strong>
                                        <span>${difficultyIcon[exercise.difficulty]}</span>
                                        <span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;">
                                            ${exercise.muscle_group}
                                        </span>
                                    </div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">
                                        ${exercise.description.substring(0, 120)}...
                                    </div>
                                </div>
                                <div style="font-size: 20px; color: var(--primary);">👆</div>
                            </div>
                        `;
                    });
                }
                
                resultsContainer.innerHTML = html;
            },

            clearExerciseFilters() {
                document.getElementById('exercise-db-search').value = '';
                document.getElementById('muscle-filter').value = '';
                document.getElementById('difficulty-filter').value = '';
                document.getElementById('anchor-filter').value = '';
                document.getElementById('tags-filter').value = '';
                
                // Nettoyer les filtres avancés
                if (document.getElementById('duration-filter')) {
                    document.getElementById('duration-filter').value = '';
                }
                if (document.getElementById('mode-filter')) {
                    document.getElementById('mode-filter').value = '';
                }
                if (document.getElementById('type-filter')) {
                    document.getElementById('type-filter').value = '';
                }
                
                // Nettoyer les tags personnalisés actifs
                appState.activeCustomTagFilters = [];
                this.updateCustomTagFiltersDisplay();
                
                this.filterExerciseDatabase();
                this.showNotification('🗑️ Tous les filtres effacés');
            },

            showExerciseFavorites() {
                if (!appState.exerciseFavorites || appState.exerciseFavorites.length === 0) {
                    this.showNotification('⭐ Aucun exercice en favoris pour le moment');
                    return;
                }
                
                // Filtrer pour afficher seulement les favoris
                const favoriteExercises = appState.exercises.filter(ex => 
                    appState.exerciseFavorites.includes(ex.id)
                );
                
                const extendedFavorites = favoriteExercises.map(exercise => {
                    const enrichedData = this.getExerciseEnrichedData(exercise);
                    return { ...exercise, ...enrichedData };
                });
                
                this.renderExerciseResults(extendedFavorites);
                this.showNotification(`⭐ ${favoriteExercises.length} exercice(s) favori(s) affiché(s)`);
            },

            showExerciseDetails(exerciseId) {
                // Recharger l'exercice depuis les données sauvegardées pour avoir les dernières infos
                this.loadData();
                
                const exercise = appState.exercises.find(e => e.id === exerciseId);
                if (!exercise) {
                    this.showNotification('Exercice introuvable');
                    return;
                }

                console.log('🔍 Exercice à afficher:', exercise.name, 'MediaId:', exercise.mediaId);

                const enrichedData = this.getExerciseEnrichedData(exercise);
                const fullExercise = { ...exercise, ...enrichedData };

                // Obtenir les statistiques de l'exercice
                const stats = this.getExerciseStats(exerciseId);

                // Vérifier si c'est un favori
                const isFavorite = this.isExerciseFavorite(exerciseId);

                // Construire le contenu du modal
                const content = this.generateExerciseDetailsHTML(fullExercise, stats, isFavorite);

                // Afficher le modal
                document.getElementById('exercise-details-title').textContent = fullExercise.name;
                document.getElementById('exercise-details-content').innerHTML = content;
                document.getElementById('exercise-details-modal').classList.add('active');
            },

            generateExerciseDetailsHTML(exercise, stats, isFavorite) {
                const difficultyClass = `difficulty-${exercise.difficulty}`;
                const difficultyLabel = {
                    'beginner': '🟢 Débutant',
                    'intermediate': '🟡 Intermédiaire', 
                    'advanced': '🔴 Confirmé'
                };

                const anchorText = {
                    'none': '🏃 Sans ancrage (élastique libre)',
                    'door-middle': '🚪 Porte - hauteur moyenne',
                    'door-high': '🚪⬆️ Porte - position haute',
                    'door-low': '🚪⬇️ Porte - position basse',
                    'floor': '🦵 Sol/Pieds (marcher dessus)',
                    'body': '🔄 Corps (élastique autour)',
                    'external': '🌳 Ancrage extérieur'
                };

                return `
                    <!-- En-tête avec image et infos principales -->
                    <div class="exercise-details-section" style="position: relative;">
                        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="actions.toggleExerciseFavorite(${exercise.id})" title="${isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                            ${isFavorite ? '⭐' : '☆'}
                        </button>
                    
                        <div class="image-placeholder">
                            ${this.debugExerciseMedia(exercise)}
                        </div>

                        <div style="margin-top: 16px;">
                            <div class="difficulty-badge ${difficultyClass}">
                                ${difficultyLabel[exercise.difficulty]}
                            </div>
                            
                            <p style="font-size: 16px; margin: 16px 0; line-height: 1.6;">
                                ${exercise.description}
                            </p>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 16px 0;">
                                <div>
                                    <strong>🎯 Type :</strong> ${exercise.is_unilateral ? 'Unilatéral' : 'Bilatéral'}
                                </div>
                                <div>
                                    <strong>⚓ Ancrage :</strong> ${anchorText[exercise.anchor_point] || 'Non défini'}
                                </div>
                                <div>
                                    <strong>⏱️ Mode :</strong> ${exercise.exercise_mode === 'time' ? 'Temps' : exercise.exercise_mode === 'both' ? 'Temps ou Répétitions' : 'Répétitions'}
                                </div>
                                <div>
                                    <strong>😴 Repos :</strong> ${exercise.default_rest_time}s
                                </div>
                            </div>

                            <!-- Tags -->
                            <div style="margin: 16px 0;">
                                ${exercise.tags.map(tag => 
                                    `<span style="background: var(--primary); color: white; padding: 4px 8px; margin: 2px; border-radius: 12px; font-size: 12px; display: inline-block;">${tag}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques personnelles -->
                    ${stats.totalSessions > 0 ? `
                        <div class="exercise-details-section">
                            <h4>📊 Vos statistiques</h4>
                            <div class="exercise-stats">
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.totalSessions}</div>
                                    <div class="exercise-stat-label">Séances</div>
                                </div>
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.totalSets}</div>
                                    <div class="exercise-stat-label">Séries</div>
                                </div>
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.maxWeight}kg</div>
                                    <div class="exercise-stat-label">Poids Max</div>
                                </div>
                                <div class="exercise-stat">
                                    <div class="exercise-stat-value">${stats.lastSession}</div>
                                    <div class="exercise-stat-label">Dernière fois</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Muscles ciblés -->
                    <div class="exercise-details-section">
                        <h4>🎯 Muscles ciblés</h4>
                        
                        <!-- Tags textuels -->
                        <div style="margin: 12px 0;">
                            <strong>Muscles principaux :</strong><br>
                            ${exercise.muscleGroups.primary.map(muscle => 
                                `<span class="muscle-tag muscle-primary">${muscle}</span>`
                            ).join('')}
                        </div>
                        ${exercise.muscleGroups.secondary.length > 0 ? `
                            <div style="margin: 12px 0;">
                                <strong>Muscles secondaires :</strong><br>
                                ${exercise.muscleGroups.secondary.map(muscle => 
                                    `<span class="muscle-tag muscle-secondary">${muscle}</span>`
                                ).join('')}
                            </div>
                        ` : ''}

                        <!-- Schémas anatomiques interactifs -->
                        <div style="margin: 20px 0;">
                            ${this.generateAnatomyDiagram(exercise)}
                        </div>
                    </div>

                    <!-- Instructions détaillées -->
                    <div class="exercise-details-section">
                        <h4>📋 Instructions pas-à-pas</h4>
                        ${exercise.instructions.map((instruction, index) => `
                            <div class="instruction-step">
                                <div class="step-number">${index + 1}</div>
                                <div style="flex: 1;">${instruction}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Conseils d'exécution -->
                    <div class="exercise-details-section">
                        <h4>💡 Conseils d'exécution</h4>
                        ${exercise.tips.map(tip => `
                            <div class="tip-item">
                                <div style="color: #34C759; font-size: 14px;">✓</div>
                                <div style="flex: 1;">${tip}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Erreurs communes -->
                    <div class="exercise-details-section">
                        <h4>⚠️ Erreurs communes à éviter</h4>
                        ${exercise.commonMistakes.map(mistake => `
                            <div class="mistake-item">
                                <div style="color: #FF3B30; font-size: 14px;">✗</div>
                                <div style="flex: 1;">${mistake}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Recommandations de résistance -->
                    ${this.hasResistanceRecommendations(exercise.name) ? `
                        <div class="exercise-details-section">
                            <h4>💪 Recommandations de résistance</h4>
                            ${generateResistanceRecommendations(exercise.name)}
                        </div>
                    ` : ''}

                    <!-- Actions -->
                    <div class="exercise-details-section">
                        <h4>🚀 Actions</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button class="btn btn-primary" onclick="actions.addExerciseToCurrentSession(${exercise.id})">
                                ➕ Ajouter à la séance
                            </button>
                            <button class="btn btn-secondary" onclick="actions.viewExerciseHistory(${exercise.id})">
                                📊 Voir l'historique
                            </button>
                            <button class="btn btn-secondary" onclick="actions.goToEditExercise(${exercise.id})">
                                ✏️ Modifier l'exercice
                            </button>
                            <button class="btn btn-secondary" onclick="actions.shareExercise(${exercise.id})">
                                🔗 Partager
                            </button>
                        </div>
                    </div>
                `;
            },

            getExerciseStats(exerciseId) {
                let totalSessions = 0;
                let totalSets = 0;
                let maxWeight = 0;
                let lastSessionDate = null;

                appState.sessions.forEach(session => {
                    const exerciseData = session.exercises.find(ex => ex.exercise_id === exerciseId);
                    if (exerciseData && exerciseData.sets.length > 0) {
                        totalSessions++;
                        totalSets += exerciseData.sets.length;
                        lastSessionDate = session.date;
                    
                        exerciseData.sets.forEach(set => {
                            const resistance = set.total_resistance || 0;
                            if (resistance > maxWeight) {
                                maxWeight = resistance;
                            }
                        });
                    }
                });

                const lastSession = lastSessionDate ? 
                    new Date(lastSessionDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : 
                    'Jamais';

                return {
                    totalSessions,
                    totalSets,
                    maxWeight,
                    lastSession
                };
            },

            hasResistanceRecommendations(exerciseName) {
                return RESISTANCE_RECOMMENDATIONS.hasOwnProperty(exerciseName);
            },

            // Gestion des favoris
            isExerciseFavorite(exerciseId) {
                if (!appState.exerciseFavorites) {
                    appState.exerciseFavorites = [];
                }
                return appState.exerciseFavorites.includes(exerciseId);
            },

            toggleExerciseFavorite(exerciseId) {
                if (!appState.exerciseFavorites) {
                    appState.exerciseFavorites = [];
                }
                
                const index = appState.exerciseFavorites.indexOf(exerciseId);
                if (index === -1) {
                    appState.exerciseFavorites.push(exerciseId);
                    this.showNotification('⭐ Ajouté aux favoris !');
                } else {
                    appState.exerciseFavorites.splice(index, 1);
                    this.showNotification('☆ Retiré des favoris');
                }
                
                this.saveData();
                
                // Mettre à jour le bouton si le modal est ouvert
                const favoriteBtn = document.querySelector('.favorite-btn');
                if (favoriteBtn) {
                    const isFavorite = this.isExerciseFavorite(exerciseId);
                    favoriteBtn.classList.toggle('active', isFavorite);
                    favoriteBtn.innerHTML = isFavorite ? '⭐' : '☆';
                    favoriteBtn.title = isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris';
                }
            },

            addExerciseToCurrentSession(exerciseId) {
                if (!appState.currentSession) {
                    if (confirm('Aucune séance en cours. Voulez-vous créer une nouvelle séance ?')) {
                        this.startNewSession();
                    } else {
                        return;
                    }
                }

                const exercise = appState.exercises.find(e => e.id === exerciseId);
                const exists = appState.currentSession.exercises.find(e => e.exercise_id === exerciseId);
                
                if (exists) {
                    this.showNotification('Cet exercice est déjà dans la séance en cours');
                    return;
                }

                appState.currentSession.exercises.push({
                    exercise_id: exerciseId,
                    planned_sets: 3,
                    rest_time: exercise.default_rest_time || 90,
                    duration: exercise.default_duration || 30,
                    sets: []
                });

                this.closeModal('exercise-details-modal');
                this.showScreen('preparation');
                this.showNotification(`"${exercise.name}" ajouté à la séance !`);
            },

            viewExerciseHistory(exerciseId) {
                // Aller aux stats avec cet exercice sélectionné
                this.closeModal('exercise-details-modal');
                this.showScreen('stats');
                
                // Sélectionner l'exercice dans le dropdown
                setTimeout(() => {
                    const select = document.getElementById('stats-exercise-select');
                    if (select) {
                        select.value = exerciseId;
                        this.updateStats(exerciseId);
                    }
                }, 100);
            },

            shareExercise(exerciseId) {
                const exercise = appState.exercises.find(e => e.id === exerciseId);
                const enrichedData = this.getExerciseEnrichedData(exercise);
                
                const shareText = `💪 ${exercise.name}\n\n📝 ${enrichedData.description}\n\n🎯 Muscles: ${enrichedData.muscleGroups.primary.join(', ')}\n\nDécouvrez SmartTrack pour vos entraînements !`;
                
                if (navigator.share) {
                    navigator.share({
                        title: `Exercice: ${exercise.name}`,
                        text: shareText
                    });
                } else if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareText);
                    this.showNotification('📋 Informations copiées dans le presse-papier !');
                } else {
                    this.showNotification('Partage non supporté sur cet appareil');
                }
            },

            goToEditExercise(exerciseId) {
                this.closeModal('exercise-details-modal');
                this.showScreen('exercises');
                
                // Attendre que l'écran soit chargé puis éditer
                setTimeout(() => {
                    this.editExercise(exerciseId);
                }, 100);
            },

            // === GESTION DES MÉDIAS ===
            handleExerciseMediaUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Vérifications de base
                if (!this.validateMediaFile(file)) {
                    return;
                }

                this.processMediaFile(file, (optimizedFile, preview) => {
                    // Stocker temporairement pour l'exercice en cours d'édition
                    appState.currentExerciseMedia = {
                        file: optimizedFile,
                        preview: preview,
                        name: file.name,
                        size: optimizedFile.size
                    };

                    this.showMediaPreview(preview, file.name, optimizedFile.size);
                });
            },

            validateMediaFile(file) {
                const maxSize = 5 * 1024 * 1024; // 5MB avant compression
                const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];

                if (!allowedTypes.includes(file.type)) {
                    this.showNotification('❌ Format non supporté. Utilisez JPG, PNG, WebP ou GIF');
                    return false;
                }

                if (file.size > maxSize) {
                    this.showNotification('❌ Fichier trop volumineux. Maximum 5MB avant compression');
                    return false;
                }

                return true;
            },

            processMediaFile(file, callback) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    // Redimensionner vers 400x300
                    const targetWidth = 400;
                    const targetHeight = 300;
                    
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;

                    // Calculer le ratio pour conserver les proportions
                    const ratio = Math.min(targetWidth / img.width, targetHeight / img.height);
                    const width = img.width * ratio;
                    const height = img.height * ratio;
                    
                    // Centrer l'image
                    const x = (targetWidth - width) / 2;
                    const y = (targetHeight - height) / 2;

                    // Fond blanc si nécessaire
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, targetWidth, targetHeight);
                    
                    // Dessiner l'image redimensionnée
                    ctx.drawImage(img, x, y, width, height);

                    // Convertir en WebP avec compression
                    this.compressToTargetSize(canvas, callback, file.name);
                };

                img.src = URL.createObjectURL(file);
            },

            compressToTargetSize(canvas, callback, originalName) {
                const targetSize = 50 * 1024; // 50KB
                let quality = 0.9;
                let attempts = 0;
                const maxAttempts = 10;

                const tryCompress = () => {
                    canvas.toBlob((blob) => {
                        if (blob.size <= targetSize || attempts >= maxAttempts || quality <= 0.1) {
                            // Créer le fichier optimisé
                            const optimizedFile = new File([blob], originalName, { type: 'image/webp' });
                            const preview = URL.createObjectURL(blob);
                            
                            console.log(`🎯 Compression terminée: ${blob.size} bytes (${Math.round(blob.size/1024)}KB) avec qualité ${quality}`);
                            callback(optimizedFile, preview);
                        } else {
                            // Réduire la qualité et réessayer
                            quality -= 0.1;
                            attempts++;
                            tryCompress();
                        }
                    }, 'image/webp', quality);
                };

                tryCompress();
            },

            showMediaPreview(preview, name, size) {
                const previewDiv = document.getElementById('exercise-media-preview');
                const uploadDiv = document.getElementById('exercise-media-upload');
                const img = document.getElementById('exercise-media-img');
                const info = document.getElementById('media-file-info');

                img.src = preview;
                info.textContent = `${name} • ${Math.round(size/1024)}KB`;
                
                previewDiv.style.display = 'block';
                uploadDiv.style.display = 'none';
            },

            removeExerciseMedia() {
                const previewDiv = document.getElementById('exercise-media-preview');
                const uploadDiv = document.getElementById('exercise-media-upload');
                
                previewDiv.style.display = 'none';
                uploadDiv.style.display = 'block';
                
                // Nettoyer les données temporaires
                if (appState.currentExerciseMedia && appState.currentExerciseMedia.preview) {
                    URL.revokeObjectURL(appState.currentExerciseMedia.preview);
                }
                appState.currentExerciseMedia = null;
                
                // Nettoyer l'input
                document.getElementById('exercise-media-input').value = '';
            },

            showMediaLibrary() {
                this.loadMediaLibrary();
                document.getElementById('media-library-modal').classList.add('active');
                
                // Configurer le drag & drop
                this.setupMediaDragDrop();
            },

            loadMediaLibrary() {
                if (!appState.mediaLibrary) {
                    appState.mediaLibrary = [];
                }

                this.renderMediaLibrary();
                this.updateMediaStats();
            },

            renderMediaLibrary() {
                const grid = document.getElementById('media-grid');
                const searchTerm = document.getElementById('media-search-input')?.value.toLowerCase() || '';
                const activeCategory = document.querySelector('.media-category-btn.active')?.textContent.toLowerCase() || 'tout';

                let filteredMedia = appState.mediaLibrary.filter(media => {
                    const matchesSearch = !searchTerm || media.name.toLowerCase().includes(searchTerm) || (media.tags && media.tags.some(tag => tag.includes(searchTerm)));
                    const matchesCategory = activeCategory === 'tout' || (media.category && media.category === activeCategory);
                    return matchesSearch && matchesCategory;
                });

                if (filteredMedia.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                            ${appState.mediaLibrary.length === 0 ? 
                                '📁 Aucune image dans la bibliothèque<br><small>Ajoutez des images en les glissant ci-dessus</small>' :
                                '🔍 Aucun résultat pour cette recherche'
                            }
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = filteredMedia.map((media, index) => `
                    <div class="media-item" onclick="actions.selectMediaItem(${media.id})" data-media-id="${media.id}">
                        <img src="${media.preview}" alt="${media.name}" loading="lazy" class="lazy-image">
                        <div class="media-item-info">
                            <div class="media-item-name">${media.name}</div>
                            <div class="media-item-size">${Math.round(media.size/1024)}KB</div>
                        </div>
                    </div>
                `).join('');

                // Lazy loading des images
                this.setupLazyLoading();
            },

            setupLazyLoading() {
                const images = document.querySelectorAll('.lazy-image');
                
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.classList.add('loaded');
                            observer.unobserve(img);
                        }
                    });
                });

                images.forEach(img => imageObserver.observe(img));
            },

            selectMediaItem(mediaId) {
                // Désélectionner tous
                document.querySelectorAll('.media-item').forEach(item => {
                    item.classList.remove('selected');
                });

                // Sélectionner le cliqué
                const item = document.querySelector(`[data-media-id="${mediaId}"]`);
                if (item) {
                    item.classList.add('selected');
                    appState.selectedMediaId = mediaId;
                    document.getElementById('select-media-btn').disabled = false;
                }
            },

            selectMediaFromLibrary() {
                if (!appState.selectedMediaId) return;

                const media = appState.mediaLibrary.find(m => m.id === appState.selectedMediaId);
                if (media) {
                    // Utiliser cette image pour l'exercice
                    appState.currentExerciseMedia = {
                        file: null, // Déjà en bibliothèque
                        preview: media.preview,
                        name: media.name,
                        size: media.size,
                        libraryId: media.id
                    };

                    this.showMediaPreview(media.preview, media.name, media.size);
                    this.closeModal('media-library-modal');
                    this.showNotification('✅ Image sélectionnée !');
                }
            },

            filterMediaLibrary() {
                this.renderMediaLibrary();
            },

            filterMediaByCategory(category) {
                // Mettre à jour les boutons actifs
                document.querySelectorAll('.media-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                this.renderMediaLibrary();
            },

            setupMediaDragDrop() {
                const dropZone = document.getElementById('media-drop-zone');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
                });

                dropZone.addEventListener('drop', this.handleDrop.bind(this), false);
                dropZone.addEventListener('click', () => {
                    document.getElementById('media-library-input').click();
                });
            },

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            },

            handleDrop(e) {
                const files = e.dataTransfer.files;
                this.handleMediaLibraryUpload({ target: { files } });
            },

            handleMediaLibraryUpload(event) {
                const files = Array.from(event.target.files);
                let processed = 0;
                const total = files.length;

                if (total === 0) return;

                this.showNotification(`📤 Traitement de ${total} fichier(s)...`);

                files.forEach(file => {
                    if (this.validateMediaFile(file)) {
                        this.processMediaFile(file, (optimizedFile, preview) => {
                            this.addToMediaLibrary(optimizedFile, preview, file.name);
                            processed++;
                            
                            if (processed === total) {
                                this.showNotification(`✅ ${processed} image(s) ajoutée(s) à la bibliothèque !`);
                                this.renderMediaLibrary();
                                this.updateMediaStats();
                            }
                        });
                    }
                });
            },

            addToMediaLibrary(file, preview, originalName) {
                if (!appState.mediaLibrary) {
                    appState.mediaLibrary = [];
                }

                const media = {
                    id: Date.now() + Math.random(),
                    name: originalName,
                    preview: preview,
                    size: file.size,
                    type: file.type,
                    dateAdded: new Date().toISOString(),
                    category: null, // À déterminer selon l'exercice
                    tags: []
                };

                appState.mediaLibrary.push(media);
                this.saveData();
            },

            updateMediaStats() {
                const count = appState.mediaLibrary?.length || 0;
                const totalSize = appState.mediaLibrary?.reduce((sum, media) => sum + media.size, 0) || 0;
                
                document.getElementById('media-count').textContent = count;
                document.getElementById('media-total-size').textContent = Math.round(totalSize / 1024);
            },

            // === SYSTÈME DE TAGS AVANCÉ ===
            initializeTagsSystem() {
                if (!appState.customTags) {
                    appState.customTags = [];
                }
                if (!appState.exerciseTags) {
                    appState.exerciseTags = {}; // exerciseId -> [tags]
                }
            },

            toggleAdvancedFilters() {
                const panel = document.getElementById('advanced-filters');
                const btn = document.getElementById('advanced-filters-btn');
                
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    btn.innerHTML = '🔧 Masquer filtres';
                    this.loadCustomTagsInFilters();
                } else {
                    panel.style.display = 'none';
                    btn.innerHTML = '🔧 Filtres avancés';
                }
            },

            loadCustomTagsInFilters() {
                const container = document.getElementById('custom-tags-container');
                const noTagsSpan = document.getElementById('no-custom-tags');
                
                if (!appState.customTags || appState.customTags.length === 0) {
                    noTagsSpan.style.display = 'block';
                    return;
                }
                
                noTagsSpan.style.display = 'none';
                
                // Ajouter les tags personnalisés comme filtres cliquables
                appState.customTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = `tag-item tag-${tag.color}`;
                    tagElement.textContent = tag.name;
                    tagElement.onclick = () => this.toggleCustomTagFilter(tag.name);
                    container.appendChild(tagElement);
                });
            },

            toggleCustomTagFilter(tagName) {
                if (!appState.activeCustomTagFilters) {
                    appState.activeCustomTagFilters = [];
                }
                
                const index = appState.activeCustomTagFilters.indexOf(tagName);
                if (index === -1) {
                    appState.activeCustomTagFilters.push(tagName);
                } else {
                    appState.activeCustomTagFilters.splice(index, 1);
                }
                
                // Mettre à jour l'affichage des tags actifs
                this.updateCustomTagFiltersDisplay();
                this.filterExerciseDatabase();
            },

            updateCustomTagFiltersDisplay() {
                const container = document.getElementById('custom-tags-container');
                const tags = container.querySelectorAll('.tag-item');
                
                tags.forEach(tag => {
                    if (appState.activeCustomTagFilters && appState.activeCustomTagFilters.includes(tag.textContent)) {
                        tag.classList.add('selected');
                    } else {
                        tag.classList.remove('selected');
                    }
                });
            },

            showTagsManager() {
                this.loadTagsManager();
                document.getElementById('tags-manager-modal').classList.add('active');
            },

            loadTagsManager() {
                this.renderExistingCustomTags();
                this.renderTagsStats();
            },

            renderExistingCustomTags() {
                const container = document.getElementById('existing-custom-tags');
                
                if (!appState.customTags || appState.customTags.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin: 0;">Aucun tag personnalisé créé</p>';
                    return;
                }
                
                container.innerHTML = appState.customTags.map(tag => `
                    <div class="tag-item tag-${tag.color} removable" style="margin: 4px;">
                        ${tag.name}
                        <button class="remove-btn" onclick="actions.deleteCustomTag('${tag.name}')" title="Supprimer ce tag">×</button>
                    </div>
                `).join('');
            },

            renderTagsStats() {
                const container = document.getElementById('tags-stats');
                
                // Calculer les statistiques d'utilisation des tags
                const tagUsage = {};
                
                // Tags par défaut
                appState.exercises.forEach(exercise => {
                    const enrichedData = this.getExerciseEnrichedData(exercise);
                    enrichedData.tags.forEach(tag => {
                        tagUsage[tag] = (tagUsage[tag] || 0) + 1;
                    });
                });
                
                // Tags personnalisés
                Object.values(appState.exerciseTags || {}).forEach(tags => {
                    tags.forEach(tag => {
                        tagUsage[tag] = (tagUsage[tag] || 0) + 1;
                    });
                });
                
                // Trier par utilisation
                const sortedTags = Object.entries(tagUsage)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 8); // Top 8
                
                container.innerHTML = sortedTags.map(([tag, count]) => `
                    <div style="background: var(--surface); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary);">${count}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${tag}</div>
                    </div>
                `).join('');
            },

            createCustomTag() {
                const nameInput = document.getElementById('new-tag-name');
                const colorSelect = document.getElementById('new-tag-color');
                
                const name = nameInput.value.trim().toLowerCase();
                const color = colorSelect.value;
                
                if (!name) {
                    this.showNotification('❌ Nom du tag requis');
                    return;
                }
                
                if (name.length > 20) {
                    this.showNotification('❌ Nom trop long (max 20 caractères)');
                    return;
                }
                
                // Vérifier les doublons
                if (appState.customTags.some(tag => tag.name === name)) {
                    this.showNotification('❌ Ce tag existe déjà');
                    return;
                }
                
                // Ajouter le nouveau tag
                appState.customTags.push({
                    name,
                    color,
                    createdAt: new Date().toISOString()
                });
                
                // Nettoyer le formulaire
                nameInput.value = '';
                colorSelect.value = 'blue';
                
                // Rafraîchir l'affichage
                this.renderExistingCustomTags();
                this.renderTagsStats();
                this.saveData();
                
                this.showNotification(`✅ Tag "${name}" créé !`);
            },

            deleteCustomTag(tagName) {
                if (!confirm(`Supprimer le tag "${tagName}" ? Il sera retiré de tous les exercices.`)) {
                    return;
                }
                
                // Supprimer le tag de la liste
                appState.customTags = appState.customTags.filter(tag => tag.name !== tagName);
                
                // Supprimer le tag de tous les exercices
                Object.keys(appState.exerciseTags || {}).forEach(exerciseId => {
                    appState.exerciseTags[exerciseId] = appState.exerciseTags[exerciseId].filter(tag => tag !== tagName);
                });
                
                // Rafraîchir l'affichage
                this.renderExistingCustomTags();
                this.renderTagsStats();
                this.saveData();
                
                this.showNotification(`🗑️ Tag "${tagName}" supprimé`);
            },

            exportTags() {
                const data = {
                    customTags: appState.customTags || [],
                    exerciseTags: appState.exerciseTags || {},
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `smarttrack_tags_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showNotification('📤 Tags exportés !');
            },

            importTags() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (data.customTags) {
                                appState.customTags = [...(appState.customTags || []), ...data.customTags];
                            }
                            
                            if (data.exerciseTags) {
                                appState.exerciseTags = {...(appState.exerciseTags || {}), ...data.exerciseTags};
                            }
                            
                            this.loadTagsManager();
                            this.saveData();
                            this.showNotification('📥 Tags importés !');
                        } catch (error) {
                            this.showNotification('❌ Fichier invalide');
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            },

            resetAllTags() {
                if (!confirm('⚠️ Supprimer TOUS les tags personnalisés ? Cette action est irréversible !')) {
                    return;
                }
                
                appState.customTags = [];
                appState.exerciseTags = {};
                
                this.loadTagsManager();
                this.saveData();
                this.showNotification('🗑️ Tous les tags supprimés');
            }
        };

        // === FONCTION DE RENDU UNIQUE ===
        function render() {
            console.log('Rendu pour l\'écran:', appState.currentScreen);
            
            // Mettre à jour la navigation active
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Afficher le bon écran
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(`screen-${appState.currentScreen}`).classList.add('active');
            
            // Rendu spécifique par écran
            switch (appState.currentScreen) {
                case 'dashboard':
                    renderDashboard();
                    document.querySelector('.nav-item').classList.add('active');
                    break;
                case 'preparation':
                    renderPreparation();
                    document.querySelectorAll('.nav-item')[1].classList.add('active');
                    break;
                case 'live':
                    renderLiveSession();
                    break;
                case 'history':
                    renderHistory();
                    document.querySelectorAll('.nav-item')[2].classList.add('active');
                    break;
                case 'stats':
                    renderStats();
                    document.querySelectorAll('.nav-item')[3].classList.add('active');
                    break;
                case 'body':
                    renderBody();
                    document.querySelectorAll('.nav-item')[4].classList.add('active');
                    break;
                case 'exercise-database':
                    renderExerciseDatabase();
                    document.querySelectorAll('.nav-item')[2].classList.add('active');
                    break;
                case 'exercises':
                    renderExercises();
                    break;
                case 'templates':
                    renderTemplates();
                    break;
                case 'settings':
                    renderSettings();
                    break;
                case 'manual-entry':
                    renderManualEntry();
                    break;
                case 'programmes':
                    renderProgrammes();
                    document.querySelectorAll('.nav-item')[2].classList.add('active');
                    break;
                case 'program-details':
                    // Pas de rendu spécial, géré par actions.showProgramDetails
                    break;
                case 'program-tracking':
                    actions.renderProgramTracking();
                    break;
            }
        }

        // Nouvelle fonction de rendu pour l'écran programmes
        function renderProgrammes() {
            // Charger l'onglet actif
            actions.switchProgramTab(appState.programTab);
        }

        // === FONCTIONS DE RENDU PAR ÉCRAN ===
        function renderDashboard() {
            // Date actuelle ou mois sélectionné
            if (!appState.calendarDate) {
                appState.calendarDate = new Date();
            }
  
            const currentMonth = appState.calendarDate.getMonth();
            const currentYear = appState.calendarDate.getFullYear();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Calendrier mensuel
            const calendarGrid = document.getElementById('calendar-grid');
            const calendarContainer = calendarGrid.parentElement;
            
            // Remplacer le titre et ajouter la navigation
            const titleElement = calendarContainer.querySelector('h3');
            if (titleElement) {
                const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin','Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    
                titleElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button onclick="actions.previousMonth()" class="btn btn-small btn-secondary">←</button>
                        <span>${monthNames[currentMonth]} ${currentYear}</span>
                        <button onclick="actions.nextMonth()" class="btn btn-small btn-secondary">→</button>
                    </div>
                `;
            }
  
            // Vérifier le cache du calendrier
            const calendarCacheKey = { 
                month: currentMonth, 
                year: currentYear, 
                sessionsCount: appState.sessions.length 
            };
            const cachedCalendar = smartCache.get('calendar', calendarCacheKey);

            if (cachedCalendar) {
                console.log('📅 Calendrier récupéré du cache');
                calendarGrid.innerHTML = cachedCalendar;
                return;
            }

            console.log('📅 Génération du calendrier...');
            // Créer le calendrier
            calendarGrid.innerHTML = '';
            calendarGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
            calendarGrid.style.gap = '4px';
            calendarGrid.style.maxHeight = 'none';
            
            // En-têtes des jours
            const dayHeaders = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.style.cssText = 'text-align: center; font-weight: bold; padding: 8px; font-size: 12px; color: var(--text-secondary);';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
  
            // Premier jour du mois et nombre de jours
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const firstDayOfWeek = (firstDay.getDay() + 6) % 7; // Lundi = 0
            const daysInMonth = lastDay.getDate();
            
            // Récupérer les dates des séances
            const sessionDates = new Set(appState.sessions.map(s => s.date));
            
            // Cases vides avant le 1er du mois
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.style.cssText = 'aspect-ratio: 1; border-radius: 8px; opacity: 0.3;';
                calendarGrid.appendChild(emptyDay);
            }
  
            // Jours du mois
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
    
                const dayElement = document.createElement('div');
                dayElement.style.cssText = `
                    aspect-ratio: 1; 
                    border-radius: 8px; 
                    background: var(--border); 
                    opacity: 0.3; 
                    font-size: 14px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: var(--text-secondary); 
                    font-weight: 500;
                    min-height: 35px;
                `;
    
                dayElement.textContent = day;
    
                // Jour actuel
                if (dateStr === todayStr) {
                    dayElement.style.border = '2px solid var(--primary)';
                    dayElement.style.fontWeight = 'bold';
                }
    
                // Jour avec séance
                if (sessionDates.has(dateStr)) {
                    dayElement.style.opacity = '1';
                    dayElement.style.background = 'var(--secondary)';
                    dayElement.style.color = 'white';
                }
    
                calendarGrid.appendChild(dayElement);
            }
  
            // Mettre en cache le HTML du calendrier
            smartCache.set('calendar', calendarCacheKey, calendarGrid.innerHTML);

            // Statistiques
            document.getElementById('total-sessions').textContent = appState.sessions.length;
            
            // Calcul de la série actuelle
            let streak = 0;
            const sortedSessions = [...appState.sessions].sort((a, b) => b.date.localeCompare(a.date));
            
            if (sortedSessions.length > 0) {
                let checkDate = new Date();
                const sessionDatesArray = new Set(sortedSessions.map(s => s.date));
                
                for (let i = 0; i < 30; i++) {
                    const dateStr = checkDate.toISOString().split('T')[0];
      
                    if (sessionDatesArray.has(dateStr)) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        if (i === 0 && dateStr === todayStr) {
                            checkDate.setDate(checkDate.getDate() - 1);
                            continue;
                        }
                        break;
                    }
                }
            }
  
            document.getElementById('current-streak').textContent = streak;

            // Widget programme actif
            const dashboardContainer = document.querySelector('#screen-dashboard');
            let programWidget = dashboardContainer.querySelector('#program-widget');
            
            if (appState.currentProgram) {
                const program = PREDEFINED_PROGRAMS[appState.currentProgram.programme_id];
                const progression = actions.calculerProgression(appState.currentProgram);
                
                if (!programWidget) {
                    programWidget = document.createElement('div');
                    programWidget.id = 'program-widget';
                    // Insérer après les statistiques mais avant les boutons
                    const buttonsCard = dashboardContainer.querySelector('.card:last-child');
                    dashboardContainer.insertBefore(programWidget, buttonsCard);
                }
                
                programWidget.innerHTML = `
                    <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0;">🏆 Mon Programme</h3>
                            <div style="font-size: 12px; opacity: 0.8;">
                                Semaine ${progression.semaineActuelle}/${program.duree_semaines}
                            </div>
                        </div>
                        
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            ${appState.currentProgram.programme_nom}
                        </div>
                        
                        <div style="margin: 12px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 14px; opacity: 0.9;">Progression</span>
                                <span style="font-size: 14px; font-weight: bold;">${progression.pourcentage}%</span>
                            </div>
                            <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: white; width: ${progression.pourcentage}%; transition: width 0.6s ease;"></div>
                            </div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                                ${progression.seancesRealisees}/${progression.seancesTotales} séances • ${progression.joursRestants} jours restants
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
                            <button class="btn" onclick="actions.showScreen('program-tracking')" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                                📊 Suivi détaillé
                            </button>
                            <button class="btn" onclick="actions.startNextSession()" style="background: white; color: var(--primary); border: none;">
                                ⚡ Prochaine séance
                            </button>
                        </div>
                    </div>
                `;
            } else if (programWidget) {
                // Supprimer le widget s'il n'y a pas de programme actif
                programWidget.remove();
            }
        }

        function renderPreparation() {
            // Initialiser la recherche d'exercices
            actions.initializeExerciseSearch();
            
            // Afficher les exercices planifiés AVEC SECTIONS
            const plannedDiv = document.getElementById('planned-exercises');
            plannedDiv.innerHTML = '';
            
            if (appState.currentSession && appState.currentSession.exercises.length > 0) {
                // Séparer échauffement et entraînement principal
                const warmupExercises = [];
                const mainExercises = [];
                
                appState.currentSession.exercises.forEach((plannedEx, index) => {
                    const exercise = appState.exercises.find(e => e.id === plannedEx.exercise_id);
                    if (exercise) {
                        const exerciseData = { ...plannedEx, exercise, originalIndex: index };
                        if (exercise.muscle_group === 'echauffement' || exercise.category === 'warmup') {
                            warmupExercises.push(exerciseData);
                        } else {
                            mainExercises.push(exerciseData);
                        }
                    }
                });
                
                // Section Échauffement
                if (warmupExercises.length > 0) {
                    const warmupTitle = document.createElement('h4');
                    warmupTitle.textContent = '🔥 Échauffement';
                    warmupTitle.className = 'exercise-section-title warmup';
                    plannedDiv.appendChild(warmupTitle);
                    warmupExercises.forEach((exerciseData, sectionIndex) => {
                        plannedDiv.appendChild(createExerciseItem(exerciseData, sectionIndex, 'warmup'));
                    });
                }
                
                // Section Entraînement Principal
                if (mainExercises.length > 0) {
                    const mainTitle = document.createElement('h4');
                    mainTitle.textContent = '💪 Entraînement Principal';
                    mainTitle.className = 'exercise-section-title main';
                    plannedDiv.appendChild(mainTitle);
                    mainExercises.forEach((exerciseData, sectionIndex) => {
                        plannedDiv.appendChild(createExerciseItem(exerciseData, sectionIndex, 'main'));
                    });
                }
                
                document.getElementById('start-live-btn').style.display = 'block';
                document.getElementById('save-manual-btn').style.display = 'block';
            } else {
                plannedDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Aucun exercice planifié</p>';
                document.getElementById('start-live-btn').style.display = 'none';
                document.getElementById('save-manual-btn').style.display = 'none';
            }
            
            // Les temps de repos sont maintenant gérés individuellement par exercice
            // Plus besoin de paramètres globaux
        }

        function renderLiveSession() {
            const liveContent = document.getElementById('live-content');
            
            // AJOUTEZ CES LIGNES DE DEBUG
            console.log('Live session state:', appState.liveSession);
            console.log('Current session:', appState.currentSession);

            if (!appState.liveSession) {
                liveContent.innerHTML = '<p>Aucune séance en cours</p>';
                return;
            }
            
            const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
            if (!currentExercise) {
                actions.finishLiveSession();
                return;
            }
            
            const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
            
            // Calculer la progression
            const currentExerciseNum = appState.liveSession.currentExerciseIndex + 1;
            const totalExercises = appState.liveSession.exercises.length;
            const progressPercentage = actions.calculateSessionProgress();

            // Générer la barre de progression
            const progressBarHtml = `
                <div style="background: var(--surface); padding: 16px; margin-bottom: 16px; border-radius: 12px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">Progression de la séance</span>
                        <span style="font-size: 14px; font-weight: 600; color: var(--primary);">${progressPercentage}%</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; background: var(--primary); width: ${progressPercentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; text-align: center;">
                        Exercice ${currentExerciseNum}/${totalExercises} • ${progressPercentage}% des séries
                    </div>
                </div>
            `;

            // Gérer la phase de préparation avant le premier exercice
            if (appState.liveSession.isPreparing) {
                const firstExercise = exercise;
                
                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div style="text-align: center; padding: 40px 20px;">
                        <h2 style="margin-bottom: 24px; color: var(--primary);">🏁 Préparation</h2>
                        <div id="countdown-display" style="font-size: 72px; font-weight: bold; color: var(--primary); margin: 24px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                            5
                        </div>
                        <h3 style="margin-bottom: 16px;">Premier exercice :</h3>
                        <div style="font-size: 24px; font-weight: 600; margin: 16px 0; color: var(--text-primary);">
                            ${firstExercise.name}
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); background: var(--background); padding: 12px; border-radius: 8px; margin: 16px 0;">
                            Préparez vos élastiques et votre position
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            ${firstExercise.is_unilateral ? '🔄 Exercice unilatéral' : '⚖️ Exercice bilatéral'} • 
                            ${firstExercise.default_rest_time}s de repos par défaut
                        </div>
                    </div>
                `;
                return; // Sortir de la fonction
            }

            if (appState.liveSession.isPaused) {
                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 24px;">⏸️</div>
                        <h2 style="color: var(--warning);">Séance en pause</h2>
                        <p style="color: var(--text-secondary); margin: 16px 0;">
                            Votre progression est sauvegardée
                        </p>
                        <div style="font-size: 14px; color: var(--text-secondary); margin: 16px 0;">
                            Pause depuis ${Math.floor((Date.now() - appState.liveSession.pauseStartTime) / 1000)}s
                        </div>
                        <button class="btn btn-success btn-full" onclick="actions.resumeLiveSession()">
                            ▶️ Reprendre la séance
                        </button>
                        <button class="btn btn-secondary btn-full" onclick="actions.stopLiveSession()" style="margin-top: 12px;">
                            🏁 Terminer la séance
                        </button>
                    </div>
                `;
                return; // Sortir de la fonction
            }

            if (appState.liveSession.isResting) {
                // Phase de repos - LOGIQUE CORRIGÉE
                const currentExercise = appState.liveSession.exercises[appState.liveSession.currentExerciseIndex];
                const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
                
                // Déterminer si on est entre séries du même exercice ou entre exercices différents
                const isRestBetweenSets = currentExercise.sets.length < currentExercise.planned_sets;
                
                let completedExercise, completedExerciseData;
                let nextExercise, nextExerciseData;
                let isLastExercise = false;
                
                if (isRestBetweenSets) {
                    // Repos entre séries du MÊME exercice
                    completedExercise = exercise;
                    completedExerciseData = currentExercise;
                    nextExercise = exercise; // Même exercice pour la série suivante
                    nextExerciseData = currentExercise;
                } else {
                    // Repos entre exercices DIFFÉRENTS
                    // L'exercice terminé est celui à l'index actuel (qui vient de finir toutes ses séries)
                    completedExercise = exercise;
                    completedExerciseData = currentExercise;
                    
                    // Le prochain exercice est à l'index suivant
                    const nextExerciseIndex = appState.liveSession.currentExerciseIndex + 1;
                    isLastExercise = nextExerciseIndex >= appState.liveSession.exercises.length;
                    
                    if (!isLastExercise) {
                        nextExerciseData = appState.liveSession.exercises[nextExerciseIndex];
                        nextExercise = appState.exercises.find(e => e.id === nextExerciseData.exercise_id);
                    } else {
                        nextExercise = null;
                        nextExerciseData = null;
                    }
                }
                
                // Récupérer les dernières performances du prochain exercice
                let nextExerciseInfo = '';
                if (nextExercise) {
                    let lastPerf;
                    if (isRestBetweenSets) {
                        // Repos entre séries - récupérer la performance de la série suivante de la dernière séance
                        const nextSetNumber = completedExerciseData.sets.length + 1;
                        lastPerf = actions.getLastPerformanceForSet(completedExerciseData.exercise_id, nextSetNumber);
                    } else {
                        // Repos entre exercices - récupérer toutes les séries du prochain exercice
                        lastPerf = actions.getAllLastPerformances(nextExercise.id);
                    }
                    if (lastPerf) {
                        let performanceDetails = '';
                        if (lastPerf.sets) {
                            // Affichage de toutes les séries (repos entre exercices)
                            performanceDetails = lastPerf.sets.map(set => {
                                const resistance = set.resistance || 0;
                                const duration = set.duration || 0;
                                const reps = set.reps || 0;
                                return `Série ${set.setNumber}: ${resistance}kg • ${set.mode === 'time' ? `${duration}s` : `${reps} reps`}`;
                            }).join('<br>');
                        } else {
                            // Affichage d'une seule série (repos entre séries du même exercice)
                            const resistance = lastPerf.resistance || 0;
                            const duration = lastPerf.duration || 0;
                            const reps = lastPerf.reps || '0';
                            performanceDetails = `${resistance}kg • ${lastPerf.mode === 'time' ? `${duration}s` : `${reps} reps`}`;
                        }
                        
                        nextExerciseInfo = `
                            <div class="card" style="margin: 16px 0; padding: 16px; background: var(--surface); border: 2px solid var(--primary);">
                                <h4 style="color: var(--primary); margin-bottom: 8px;">🔜 Prochain exercice</h4>
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                                    ${nextExercise.name}
                                </div>
                                <div style="font-size: 14px; color: var(--primary); font-weight: bold; background: var(--background); padding: 8px; border-radius: 8px;">
                                    📊 Dernière fois :<br>${performanceDetails}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    ${new Date(lastPerf.date).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                        `;
                    } else {
                        // NOUVEAU CODE : Afficher les conseils de résistance
                        const resistanceAdvice = generateResistanceRecommendations(nextExercise.name);
                        
                        nextExerciseInfo = `
                            <div class="card" style="margin: 16px 0; padding: 16px; background: var(--surface); border: 2px solid var(--primary);">
                                <h4 style="color: var(--primary); margin-bottom: 8px;">🔜 Prochain exercice</h4>
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                                    ${nextExercise.name}
                                </div>
                                <div style="font-size: 14px; color: var(--text-secondary); background: var(--background); padding: 8px; border-radius: 8px;">
                                    🆕 Premier essai pour cet exercice
                                </div>
                                ${resistanceAdvice}
                            </div>
                        `;
                    }
                } else {
                    nextExerciseInfo = `
                        <div class="card" style="margin: 16px 0; padding: 16px; background: var(--secondary); color: white; text-align: center;">
                            <h4 style="margin-bottom: 8px;">🏁 Dernier exercice terminé !</h4>
                            <div style="font-size: 18px;">Félicitations ! 🎉</div>
                        </div>
                    `;
                }

                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div class="rest-timer">
                        <h2>Temps de repos</h2>
                        <div class="rest-time">00:00</div>
                        <button class="btn btn-primary btn-full" onclick="actions.skipRest()">
                            ⏭️ Passer le repos
                        </button>
                    </div>
                    
                    <div class="card" style="margin: 16px 0; padding: 12px; background: var(--background);">
                        <h4>✅ ${isRestBetweenSets ? 'Série terminée' : 'Exercice terminé'}</h4>
                        <div style="font-size: 16px; font-weight: bold;">${completedExercise.name}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            ${isRestBetweenSets ?
                                `Série ${completedExerciseData.sets.length} / ${completedExerciseData.planned_sets} terminée` :
                                `Toutes les séries terminées (${completedExerciseData.sets.length}/${completedExerciseData.planned_sets})`
                            }
                        </div>
                    </div>
                    
                    ${nextExerciseInfo}
                `;
            } else {
                // Phase d'exercice
                const setNumber = currentExercise.sets.length + 1;
                
                // MODIFICATION : Utiliser la nouvelle fonction pour gérer tous les modes
                const performanceInputs = actions.generatePerformanceInputs(exercise);
                
                // Récupérer les dernières performances
                const lastPerf = actions.getLastPerformance(exercise.id);

                let perfRecap = '';
                if (lastPerf) {
                    let setsDisplay = '';
                    if (lastPerf.sets && lastPerf.sets.length > 0) {
                        setsDisplay = lastPerf.sets.map((set, index) => {
                            if (set.exercise_mode === 'time') {
                                return `Série ${index + 1}: ${set.duration}s${set.resistance > 0 ? ` - ${set.resistance}kg` : ''}`;
                            } else if (exercise.is_unilateral) {
                                return `Série ${index + 1}: ${set.left_reps}G/${set.right_reps}D - ${set.resistance}kg`;
                            } else {
                                return `Série ${index + 1}: ${set.reps} reps - ${set.resistance}kg`;
                            }
                        }).join(' • ');
                    }
                    
                    perfRecap += `
                        <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                            <h5>🎯 Dernière performance (${lastPerf.totalSets} séries) :</h5>
                            <div style="font-size: 14px;">
                                ${setsDisplay}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${new Date(lastPerf.date).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                    `;
                }


                // Déterminer ce qui vient après cette série
                const willHaveMoreSets = (currentExercise.sets.length + 1) < currentExercise.planned_sets;
                if (willHaveMoreSets) {
                    // Il reste des séries pour cet exercice
                    perfRecap += `
                        <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                            <h5>🔜 Après cette série :</h5>
                            <div style="font-size: 14px;">
                                Série ${currentExercise.sets.length + 2} de ${exercise.name}
                            </div>
                        </div>
                    `;
                } else {
                    // C'est la dernière série de cet exercice, afficher le prochain exercice
                    const nextExerciseIndex = appState.liveSession.currentExerciseIndex + 1;
                    const nextExercise = nextExerciseIndex < appState.liveSession.exercises.length ?
                        appState.exercises.find(e => e.id === appState.liveSession.exercises[nextExerciseIndex].exercise_id) : null;
                    const nextPerf = nextExercise ? actions.getLastPerformance(nextExercise.id) : null;
                    
                    if (nextPerf && nextExercise) {
                        const resistance = nextPerf.resistance || 0;
                        const duration = nextPerf.duration || 0;
                        const reps = nextPerf.reps || '0';
                        perfRecap += `
                            <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                                <h5>🔜 Prochain exercice : ${nextExercise.name}</h5>
                                <div style="font-size: 14px;">
                                    Dernière fois : ${resistance}kg • ${nextPerf.mode === 'time' ? `${duration}s` : `${reps} reps`}
                                </div>
                            </div>
                        `;
                    } else if (nextExercise) {
                        perfRecap += `
                            <div class="card" style="margin: 12px 0; padding: 12px; background: var(--background);">
                                <h5>🔜 Prochain exercice : ${nextExercise.name}</h5>
                                <div style="font-size: 14px;">
                                    🆕 Premier essai pour cet exercice
                                </div>
                            </div>
                        `;
                    } else {
                        perfRecap += `
                            <div class="card" style="margin: 12px 0; padding: 12px; background: var(--secondary); color: white;">
                                <h5>🏁 Dernière série du dernier exercice !</h5>
                                <div style="font-size: 14px;">Félicitations, vous terminez ! 🎉</div>
                            </div>
                        `;
                    }
                }

                liveContent.innerHTML = `
                    ${progressBarHtml}
                    <div class="current-exercise">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="set-counter">Série ${setNumber} / ${currentExercise.planned_sets}</div>
                    </div>
                    ${perfRecap}
                    ${performanceInputs}
                    
                    <div class="input-group">
                        <label>Type de série</label>
                        <select id="set-type" class="select">
                            <option value="work">Travail</option>
                            <option value="warmup">Échauffement</option>
                            <option value="dropset">Série dégressif</option>
                            <option value="failure">Jusqu'à l'échec</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success btn-full" onclick="actions.validateSet()">
                        ✅ Valider la série
                    </button>
                    
                    <button class="btn btn-secondary btn-full" onclick="actions.nextExercise()">
                        ➡️ Exercice suivant
                    </button>
                `;
            }
        }

        function renderHistory() {
            const sessionsList = document.getElementById('sessions-list');
            const historyCount = document.getElementById('history-count');
            
            historyCount.textContent = appState.sessions.length;
            sessionsList.innerHTML = '';
            
            const sortedSessions = [...appState.sessions].sort((a, b) => b.date.localeCompare(a.date));
            
            sortedSessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'card';
                
                const date = new Date(session.date);
                const formattedDate = date.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                let exercisesHtml = '';
                session.exercises.forEach(sessionEx => {
                    const exercise = appState.exercises.find(e => e.id === sessionEx.exercise_id);
                    if (exercise) {
                        exercisesHtml += `
                            <div style="margin: 8px 0; padding: 8px; background: var(--background); border-radius: 8px;">
                                <strong>${exercise.name}</strong> (${sessionEx.sets.length} séries)
                                <div style="font-size: 14px; color: var(--text-secondary);">
                                    ${sessionEx.sets.map(set => {
                                        if (set.exercise_mode === 'time') {
                                            // Exercice en mode temps - ne pas afficher les résistances si elles sont à 0
                                            if (exercise.is_unilateral) {
                                                let leftResistance, rightResistance;
                                                if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                    leftResistance = set.total_resistance.left || 0;
                                                    rightResistance = set.total_resistance.right || 0;
                                                } else {
                                                    leftResistance = set.total_resistance || 0;
                                                    rightResistance = set.total_resistance || 0;
                                                }
                                            
                                                // Afficher les résistances seulement si elles sont > 0
                                                if (leftResistance > 0 || rightResistance > 0) {
                                                    return `${set.duration || 0}s - ${leftResistance}kg (G) | ${rightResistance}kg (D)`;
                                                } else {
                                                    return `${set.duration || 0}s`;
                                                }
                                            } else {
                                                const resistance = set.total_resistance || 0;
                                                // Afficher la résistance seulement si elle est > 0
                                                if (resistance > 0) {
                                                    return `${set.duration || 0}s - ${resistance}kg`;
                                                } else {
                                                    return `${set.duration || 0}s`;
                                                }
                                            }
                                        } else {
                                            // Exercice en mode répétitions (logique existante)
                                            if (exercise.is_unilateral) {
                                                let leftResistance, rightResistance;
                                                if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                    leftResistance = set.total_resistance.left || 0;
                                                    rightResistance = set.total_resistance.right || 0;
                                                } else {
                                                    leftResistance = set.total_resistance || 0;
                                                    rightResistance = set.total_resistance || 0;
                                                }
                                                return `${set.left_reps || 0} reps (G) | ${set.right_reps || 0} reps (D) - ${leftResistance}kg (G) | ${rightResistance}kg (D)`;
                                            } else {
                                                return `${set.reps || 0} reps - ${set.total_resistance || 0}kg`;
                                            }
                                        }
                                    }).join(' • ')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                // Calculer la durée totale de la séance
                const sessionDuration = session.endTime && session.startTime ? 
                    Math.floor((session.endTime - session.startTime) / 1000 / 60) : 0;

                // Calculer le volume total et le temps total d'exercice
                let totalVolume = 0;
                let totalExerciseTime = 0;
                session.exercises.forEach(ex => {
                    const sessionExercise = appState.exercises.find(e => e.id === ex.exercise_id);
                    ex.sets.forEach(set => {
                        // Calculer le temps d'exercice selon le mode
                        if (set.exercise_mode === 'time' && set.duration) {
                            // Exercice en mode temps
                            totalExerciseTime += set.duration;
                        } else if (set.exercise_mode === 'reps' || !set.exercise_mode) {
                            // Exercice en mode répétitions - estimer le temps
                            let reps = 0;
                            if (sessionExercise && sessionExercise.is_unilateral) {
                                reps = (set.left_reps || 0) + (set.right_reps || 0);
                            } else {
                                reps = set.reps || 0;
                            }
                            // Estimer 2 secondes par répétition
                            totalExerciseTime += (reps * 2);
                        }
                    
                        // Calculer le volume pour les exercices en répétitions
                        if (set.exercise_mode !== 'time' && set.type === 'work') {
                            let resistance = 0;
                            let reps = 0;
                    
                            if (sessionExercise && sessionExercise.is_unilateral) {
                                // Exercice unilatéral - gérer les résistances par côté
                                if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                    resistance = (set.total_resistance.left || 0) + (set.total_resistance.right || 0);
                                } else {
                                    // Compatibilité avec l'ancien format
                                    resistance = (set.total_resistance || 0) * 2;
                                }
                                reps = (set.left_reps || 0) + (set.right_reps || 0);
                            } else {
                                // Exercice bilatéral
                                resistance = set.total_resistance || 0;
                                reps = set.reps || 0;
                            }
                    
                            totalVolume += (resistance * reps);
                        }
                    });
                });

                sessionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h3>${formattedDate}</h3>
                            <div style="font-size: 14px; color: var(--text-secondary); margin: 4px 0;">
                                ⏱️ ${sessionDuration}min • 📊 ${Math.round(totalVolume)}kg volume
                                ${totalExerciseTime > 0 ? ` • 🔥 ${Math.floor(totalExerciseTime / 60)}min ${totalExerciseTime % 60}s actif` : ''}
                                ${session.difficulty ? ` • ${session.difficulty === 'Facile' ? '😊' : session.difficulty === 'Normale' ? '💪' : '🔥'} ${session.difficulty}` : ''}
                                ${session.globalSettings ? ` • Repos: ${session.globalSettings.restBetweenExercises}s/${session.globalSettings.restBetweenSets}s` : ''}
                            </div>
                            ${session.notes ? `<p style="color: var(--text-secondary); margin: 8px 0;">${session.notes}</p>` : ''}
                            <details style="margin-top: 12px;">
                                <summary style="cursor: pointer; font-weight: 500;">Voir les détails</summary>
                                <div style="margin-top: 12px;">${exercisesHtml}</div>
                            </details>
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 12px;">
                            <button class="btn btn-small btn-secondary" onclick="actions.editSession(${session.id})" title="Modifier la séance">
                                ✏️
                            </button>
                            <button class="btn btn-small btn-danger" onclick="actions.deleteSession(${session.id})" title="Supprimer la séance">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
                
                sessionsList.appendChild(sessionDiv);
            });
            
            if (sortedSessions.length === 0) {
                sessionsList.innerHTML = '<div class="card"><p style="text-align: center; color: var(--text-secondary);">Aucune séance enregistrée</p></div>';
            }
        }

        function renderStats() {
            const statsContent = document.getElementById('stats-content');
            
            // STATISTIQUES GÉNÉRALES
            const generalStats = actions.calculateGeneralStats();
            let generalStatsHtml = `
                <div class="card">
                    <h3>📊 Statistiques générales</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.sessionsThisWeek}</div>
                            <div class="stat-label">Séances cette semaine</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalVolumeThisWeek}kg</div>
                            <div class="stat-label">Volume cette semaine</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.sessionsThisMonth}</div>
                            <div class="stat-label">Séances ce mois</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalVolumeThisMonth}kg</div>
                            <div class="stat-label">Volume ce mois</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.averageSessionDuration}min</div>
                            <div class="stat-label">Durée moyenne</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalSessions}</div>
                            <div class="stat-label">Total séances</div>
                        </div>
                    </div>
                    <div style="margin: 16px 0;">
                        <h4>🏆 Records personnels récents</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${generalStats.recentRecords.length > 0 ?
                                generalStats.recentRecords.map(record => `
                                    <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                                        <div>
                                            <strong>${record.exerciseName}</strong>
                                            <div style="font-size: 14px; color: var(--text-secondary);">
                                                ${record.type === 'max_weight' ? 'Poids Max' :
                                                    record.type === 'max_reps' ? 'Reps Max' : '1RM Estimé'}:
                                                ${record.value}${record.type === 'max_reps' ? '' : 'kg'}
                                            </div>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            ${new Date(record.date).toLocaleDateString('fr-FR')}
                                        </div>
                                    </div>
                                `).join('') :
                                '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun record récent</p>'
                            }
                        </div>
                    </div>
                </div>
            `;

            // UTILISER LE SELECT EXISTANT dans le HTML (pas en créer un nouveau)
            const exerciseSelect = document.getElementById('stats-exercise-select');
            
            // Remplir le select existant s'il est vide
            if (exerciseSelect && exerciseSelect.children.length <= 1) {
                // Grouper les exercices par groupes musculaires
                const groupedExercises = {};
                appState.exercises.forEach(exercise => {
                    const group = exercise.muscle_group || 'autres';
                    if (!groupedExercises[group]) {
                        groupedExercises[group] = [];
                    }
                    groupedExercises[group].push(exercise);
                });

                // Ordre d'affichage des catégories
                const groupOrder = ['echauffement', 'biceps', 'triceps', 'epaules', 'dos', 'pectoraux', 'jambes', 'autres'];
                
                // Vider le select et ajouter l'option par défaut
                exerciseSelect.innerHTML = '<option value="">Choisir un exercice...</option>';
                
                groupOrder.forEach(group => {
                    if (groupedExercises[group] && groupedExercises[group].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `${group.charAt(0).toUpperCase() + group.slice(1)} (${groupedExercises[group].length})`;
                        // Trier les exercices par nom dans chaque groupe
                        groupedExercises[group].sort((a, b) => a.name.localeCompare(b.name));
                        groupedExercises[group].forEach(exercise => {
                            const option = document.createElement('option');
                            option.value = exercise.id;
                            // Ajouter l'indicateur de mode
                            const modeIcon = exercise.exercise_mode === 'time' ? '⏱️' :
                                exercise.exercise_mode === 'both' ? '🔄' : '🔢';
                            option.textContent = `${modeIcon} ${exercise.name}`;
                            optgroup.appendChild(option);
                        });
                        exerciseSelect.appendChild(optgroup);
                    }
                });
            }

            // Afficher les statistiques de base
            statsContent.innerHTML = generalStatsHtml;

            // Afficher les stats de l'exercice sélectionné
            const selectedExerciseId = parseInt(exerciseSelect?.value || '0');
            if (selectedExerciseId) {
                const exercise = appState.exercises.find(e => e.id === selectedExerciseId);
                const records = appState.records[selectedExerciseId] || [];

                // Calculer les records actuels
                const maxWeight = actions.getCurrentRecord(selectedExerciseId, 'max_weight');
                const maxReps = actions.getCurrentRecord(selectedExerciseId, 'max_reps');
                const max1RM = actions.getCurrentRecord(selectedExerciseId, 'max_1rm');

                // Calculer le volume max
                let maxVolume = 0;
                appState.sessions.forEach(session => {
                    const sessionExercise = session.exercises.find(e => e.exercise_id === selectedExerciseId);
                    if (sessionExercise) {
                        let sessionVolume = 0;
                        sessionExercise.sets.forEach(set => {
                            if (set.type === 'work') {
                                const resistance = set.total_resistance || 0;
                                if (exercise.is_unilateral) {
                                    const leftReps = set.left_reps || 0;
                                    const rightReps = set.right_reps || 0;
                                    sessionVolume += (leftReps + rightReps) * resistance;
                                } else {
                                    const reps = set.reps || 0;
                                    sessionVolume += reps * resistance;
                                }
                            }
                        });
                        maxVolume = Math.max(maxVolume, sessionVolume);
                    }
                });

                // Calculer le temps max pour les exercices en mode temps
                let maxTime = 0;
                let hasTimeMode = false;
                appState.sessions.forEach(session => {
                    const sessionExercise = session.exercises.find(e => e.exercise_id === selectedExerciseId);
                    if (sessionExercise) {
                        sessionExercise.sets.forEach(set => {
                            if (set.exercise_mode === 'time' && set.duration) {
                                hasTimeMode = true;
                                maxTime = Math.max(maxTime, set.duration);
                            }
                        });
                    }
                });

                // Générer les cartes de statistiques selon le mode de l'exercice
                let statsCardsHtml = '';
                if (hasTimeMode) {
                    statsCardsHtml = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${maxTime}s</div>
                                <div class="stat-label">Temps Max Tenu</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxWeight}kg</div>
                                <div class="stat-label">Poids Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxVolume}kg</div>
                                <div class="stat-label">Volume Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${Math.round((maxTime * maxWeight) / 10) / 10}pts</div>
                                <div class="stat-label">Score Temps×Poids</div>
                            </div>
                        </div>
                    `;
                } else {
                    statsCardsHtml = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${maxWeight}kg</div>
                                <div class="stat-label">Poids Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxReps}</div>
                                <div class="stat-label">Reps Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${maxVolume}kg</div>
                                <div class="stat-label">Volume Max</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${max1RM.toFixed(1)}kg</div>
                                <div class="stat-label">1RM Estimé</div>
                            </div>
                        </div>
                    `;
                }

                // Récupérer les dernières séries effectuées
                const lastSets = [];
                const sessionsWithExercise = appState.sessions
                    .filter(session => session.exercises.some(ex => ex.exercise_id === selectedExerciseId))
                    .sort((a, b) => b.date.localeCompare(a.date));

                // Collecter les dernières séries jusqu'à 5 maximum
                for (const session of sessionsWithExercise) {
                    const exerciseData = session.exercises.find(ex => ex.exercise_id === selectedExerciseId);
                    if (exerciseData && exerciseData.sets.length > 0) {
                        const workSets = exerciseData.sets.filter(set => set.type === 'work');
                        for (const set of workSets) {
                            if (lastSets.length < 5) {
                                lastSets.push({
                                    date: session.date,
                                    ...set
                                });
                            }
                        }
                    }
                    if (lastSets.length >= 5) break;
                }

                // Générer l'HTML des dernières séries
                let lastSetsHtml = '';
                if (lastSets.length > 0) {
                    lastSetsHtml = `
                        <div class="card">
                            <h3>🔄 Dernières séries effectuées</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${lastSets.map((set, index) => {
                                    const date = new Date(set.date).toLocaleDateString('fr-FR', {
                                        day: 'numeric',
                                        month: 'short'
                                    });
                                    let setInfo = '';
                                    if (set.exercise_mode === 'time') {
                                        if (exercise.is_unilateral) {
                                            let leftResistance, rightResistance;
                                            if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                leftResistance = set.total_resistance.left || 0;
                                                rightResistance = set.total_resistance.right || 0;
                                            } else {
                                                leftResistance = set.total_resistance || 0;
                                                rightResistance = set.total_resistance || 0;
                                            }
                                            setInfo = leftResistance > 0 || rightResistance > 0 ?
                                                `${set.duration || 0}s - ${leftResistance}kg (G) | ${rightResistance}kg (D)` :
                                                `${set.duration || 0}s`;
                                        } else {
                                            const resistance = set.total_resistance || 0;
                                            setInfo = resistance > 0 ?
                                                `${set.duration || 0}s - ${resistance}kg` :
                                                `${set.duration || 0}s`;
                                        }
                                    } else {
                                        if (exercise.is_unilateral) {
                                            let leftResistance, rightResistance;
                                            if (typeof set.total_resistance === 'object' && set.total_resistance.left !== undefined) {
                                                leftResistance = set.total_resistance.left || 0;
                                                rightResistance = set.total_resistance.right || 0;
                                            } else {
                                                leftResistance = set.total_resistance || 0;
                                                rightResistance = set.total_resistance || 0;
                                            }
                                            setInfo = `${set.left_reps || 0} reps (G) | ${set.right_reps || 0} reps (D) - ${leftResistance}kg (G) | ${rightResistance}kg (D)`;
                                        } else {
                                            setInfo = `${set.reps || 0} reps - ${set.total_resistance || 0}kg`;
                                        }
                                    }
                                    return `
                                        <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500;">${setInfo}</div>
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">${date}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Ajouter les statistiques détaillées
                const detailedStatsHtml = `
                    <div class="card">
                        <h3>📈 Statistiques pour ${exercise.name}</h3>
                        ${statsCardsHtml}
                    </div>
                    ${lastSetsHtml}
                    <div class="card">
                        <h3>Évolution des performances</h3>
                        <div class="chart-container">
                            ${actions.generateSimpleChart(selectedExerciseId, exercise.name)}
                        </div>
                    </div>
                    <div class="card">
                        <h3>Historique des records</h3>
                        <div id="records-history">
                            ${records.length > 0 ?
                                records.map(record => `
                                    <div style="padding: 8px; border-bottom: 1px solid var(--border);">
                                        <strong>${new Date(record.date).toLocaleDateString('fr-FR')}</strong> -
                                        ${record.type === 'max_weight' ? 'Poids Max' :
                                            record.type === 'max_reps' ? 'Reps Max' :
                                            record.type === 'max_time' ? 'Temps Max' : '1RM Estimé'}:
                                        <span style="color: var(--primary);">${record.value}${record.type === 'max_reps' ? '' : record.type === 'max_time' ? 's' : 'kg'}</span>
                                    </div>
                                `).join('')
                                : '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun record enregistré</p>'
                            }
                        </div>
                    </div>
                `;

                // Ajouter les statistiques détaillées après les statistiques générales
                statsContent.innerHTML = generalStatsHtml + detailedStatsHtml;
            }
        }

        function renderBody() {
            const measurementsList = document.getElementById('measurements-list');
            
            // Définir la date par défaut à aujourd'hui
            const measurementDate = document.getElementById('measurement-date');
            if (!measurementDate.value) {
                measurementDate.value = new Date().toISOString().split('T')[0];
            }
            
            measurementsList.innerHTML = '';
            
            // Mettre à jour le graphique
            const chartContainer = document.querySelector('#screen-body .chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = actions.generateMeasurementsChart();
            }
            
            const sortedMeasurements = [...appState.measurements].sort((a, b) => b.date.localeCompare(a.date));
            
            // Calculer l'IMC actuel (dernière mesure)
            const latestMeasurement = sortedMeasurements.length > 0 ? sortedMeasurements[0] : null;
            let currentImcCard = '';

            if (latestMeasurement && latestMeasurement.height > 0 && latestMeasurement.weight > 0) {
                let imc, imcCategory;
            
                if (latestMeasurement.imc && latestMeasurement.imc > 0) {
                    // IMC déjà calculé
                    imc = latestMeasurement.imc;
                    imcCategory = latestMeasurement.imcCategory;
                } else {
                    // Calculer l'IMC
                    const heightInMeters = latestMeasurement.height / 100;
                    imc = latestMeasurement.weight / (heightInMeters * heightInMeters);
                    imc = Math.round(imc * 10) / 10;
                    
                    if (imc < 18.5) {
                        imcCategory = 'Insuffisance pondérale';
                    } else if (imc < 25) {
                        imcCategory = 'Poids normal';
                    } else if (imc < 30) {
                        imcCategory = 'Surpoids';
                    } else if (imc < 35) {
                        imcCategory = 'Obésité modérée';
                    } else if (imc < 40) {
                        imcCategory = 'Obésité sévère';
                    } else {
                        imcCategory = 'Obésité morbide';
                    }
                }
            
                const imcColor = imc < 18.5 ? '#FF9500' : 
                                 imc < 25 ? '#34C759' : 
                                 imc < 30 ? '#FF9500' : '#FF3B30';
                
                const imcIcon = imc < 18.5 ? '⬇️' : 
                                imc < 25 ? '✅' : 
                                imc < 30 ? '⚠️' : '🔴';
            
                currentImcCard = `
                    <div class="card">
                        <h3>📏 IMC Actuel</h3>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; font-weight: bold; color: ${imcColor}; margin-bottom: 8px;">
                                ${imc}
                            </div>
                            <div style="font-size: 18px; font-weight: 600; color: ${imcColor}; margin-bottom: 16px;">
                                ${imcIcon} ${imcCategory}
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                Taille: ${latestMeasurement.height}cm • Poids: ${latestMeasurement.weight}kg
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                                Mesuré le ${new Date(latestMeasurement.date).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                
                        <div style="font-size: 12px; color: var(--text-secondary); background: var(--background); padding: 12px; border-radius: 8px; margin-top: 16px;">
                            <strong>Référence IMC :</strong><br>
                            • &lt; 18.5 : Insuffisance pondérale<br>
                            • 18.5 - 24.9 : Poids normal<br>
                            • 25 - 29.9 : Surpoids<br>
                            • ≥ 30 : Obésité
                        </div>
                    </div>
                `;
            }

            if (sortedMeasurements.length > 0) {
                const listDiv = document.createElement('div');
                listDiv.className = 'card';
                listDiv.innerHTML = '<h3>Historique des mensurations</h3>';
                
                sortedMeasurements.forEach(measurement => {
                    const measurementDiv = document.createElement('div');
                    measurementDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);';
                    
                    let details = [];
                    let imcInfo = '';

                    // Afficher les mensurations de base
                    if (measurement.height > 0) details.push('Taille: ' + measurement.height + 'cm');
                    if (measurement.weight > 0) details.push(measurement.weight + 'kg');

                    // Calculer et afficher l'IMC s'il n'est pas déjà stocké
                    if (measurement.imc && measurement.imc > 0) {
                        // IMC déjà calculé et stocké
                        const imcColor = measurement.imc < 18.5 ? '#FF9500' : 
                                         measurement.imc < 25 ? '#34C759' : 
                                         measurement.imc < 30 ? '#FF9500' : '#FF3B30';
                        imcInfo = `<div style="font-size: 14px; margin-top: 4px; padding: 4px 8px; background: ${imcColor}20; border-radius: 4px; color: ${imcColor}; font-weight: 600;">
                            IMC: ${measurement.imc} • ${measurement.imcCategory}
                        </div>`;
                    } else if (measurement.height > 0 && measurement.weight > 0) {
                        // Calculer l'IMC à la volée pour les anciennes données
                        const heightInMeters = measurement.height / 100;
                        const imc = measurement.weight / (heightInMeters * heightInMeters);
                        const roundedImc = Math.round(imc * 10) / 10;
                    
                        let imcCategory = '';
                        if (imc < 18.5) {
                            imcCategory = 'Insuffisance pondérale';
                        } else if (imc < 25) {
                            imcCategory = 'Poids normal';
                        } else if (imc < 30) {
                            imcCategory = 'Surpoids';
                        } else if (imc < 35) {
                            imcCategory = 'Obésité modérée';
                        } else if (imc < 40) {
                            imcCategory = 'Obésité sévère';
                        } else {
                            imcCategory = 'Obésité morbide';
                        }
                    
                        const imcColor = imc < 18.5 ? '#FF9500' : 
                                         imc < 25 ? '#34C759' : 
                                         imc < 30 ? '#FF9500' : '#FF3B30';
                        imcInfo = `<div style="font-size: 14px; margin-top: 4px; padding: 4px 8px; background: ${imcColor}20; border-radius: 4px; color: ${imcColor}; font-weight: 600;">
                            IMC: ${roundedImc} • ${imcCategory}
                        </div>`;
                    }

                    // Autres mensurations
                    if (measurement.waist > 0) details.push('Tour taille: ' + measurement.waist + 'cm');
                    if (measurement.chest > 0) details.push('Poitrine: ' + measurement.chest + 'cm');
                    if (measurement.arm > 0) details.push('Bras: ' + measurement.arm + 'cm');
                    if (measurement.thigh > 0) details.push('Cuisse: ' + measurement.thigh + 'cm');
                    
                    measurementDiv.innerHTML = `
                        <div>
                            <strong>${new Date(measurement.date).toLocaleDateString('fr-FR')}</strong>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${details.join(' • ')}
                            </div>
                            ${imcInfo}
                        </div>
                        <button class="btn btn-small btn-danger" onclick="actions.deleteMeasurement(${measurement.id})">🗑️</button>
                    `;
                    listDiv.appendChild(measurementDiv);
                });
                
                // Ajouter la carte IMC si elle existe
                if (currentImcCard) {
                    const imcDiv = document.createElement('div');
                    imcDiv.innerHTML = currentImcCard;
                    measurementsList.appendChild(imcDiv);
                }

                measurementsList.appendChild(listDiv);
            } else {
                measurementsList.innerHTML = '<div class="card"><p style="text-align: center; color: var(--text-secondary);">Aucune mensuration enregistrée</p></div>';
            }
        }

        function renderExerciseDatabase() {
            // Initialiser la vue si elle n'existe pas
            if (!appState.exerciseView) {
                appState.exerciseView = 'grid'; // 'grid' ou 'list'
            }
            
            actions.filterExerciseDatabase();
        }

        function renderExercises() {
            const exercisesList = document.getElementById('exercises-list');
            const formTitle = document.getElementById('exercise-form-title');
            const saveBtn = document.getElementById('save-exercise-btn');
            const cancelBtn = document.getElementById('cancel-exercise-btn');
            
            // Mise à jour du formulaire selon le mode (création/édition)
            if (appState.editingExercise) {
                formTitle.textContent = 'Modifier l\'exercice';
                saveBtn.textContent = '💾 Sauvegarder';
                cancelBtn.style.display = 'block';
            } else {
                formTitle.textContent = 'Nouvel exercice';
                saveBtn.textContent = '➕ Ajouter l\'exercice';
                cancelBtn.style.display = 'none';
            }
            
            // Liste des exercices
            exercisesList.innerHTML = '';
            
            if (appState.exercises.length > 0) {
                // Grouper les exercices par groupe musculaire
                const groupedExercises = {};
                appState.exercises.forEach(exercise => {
                    const group = exercise.muscle_group || 'autres';
                    if (!groupedExercises[group]) {
                        groupedExercises[group] = [];
                    }
                    groupedExercises[group].push(exercise);
                });
                
                // Afficher par groupes
                const groupOrder = ['echauffement', 'biceps', 'triceps', 'epaules', 'dos', 'pectoraux', 'jambes', 'autres'];
                groupOrder.forEach(group => {
                    if (groupedExercises[group] && groupedExercises[group].length > 0) {
                        const groupTitle = document.createElement('h4');
                        groupTitle.textContent = `${group.charAt(0).toUpperCase() + group.slice(1)} (${groupedExercises[group].length})`;
                        groupTitle.style.cssText = 'margin: 20px 0 10px 0; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 8px;';
                        exercisesList.appendChild(groupTitle);
                        
                        groupedExercises[group].forEach(exercise => {
                            const anchorText = {
                                'none': 'Sans ancrage',
                                'door-middle': 'Porte (milieu)',
                                'door-high': 'Porte (haut)',
                                'door-low': 'Porte (bas)',
                                'floor': 'Sol/Pieds',
                                'body': 'Corps',
                                'external': 'Extérieur'
                            };
                            
                            const div = document.createElement('div');
                            div.className = 'exercise-item';
                            div.innerHTML = `
                                <div>
                                    <strong>${exercise.name}</strong>
                                    <div style="font-size: 14px; color: var(--text-secondary);">
                                        ${exercise.is_unilateral ? 'Unilatéral' : 'Bilatéral'} • ${exercise.default_rest_time}s repos • ${anchorText[exercise.anchor_point] || 'Non défini'}
                                    </div>
                                </div>
                                <div class="exercise-actions">
                                    <button class="btn btn-small btn-secondary" onclick="actions.editExercise(${exercise.id})">✏️</button>
                                    <button class="btn btn-small btn-danger" onclick="actions.deleteExercise(${exercise.id})">🗑️</button>
                                </div>
                            `;
                            exercisesList.appendChild(div);
                        });
                    }
                });
            } else {
                exercisesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun exercice créé</p>';
            }
        }

        function renderTemplates() {
            const templatesList = document.getElementById('templates-list');
            const checkboxContainer = document.getElementById('template-exercises-checkboxes');

            // NOUVELLE INTERFACE DE CRÉATION DE MODÈLE
            checkboxContainer.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-secondary btn-full" onclick="actions.showExerciseSelector()" id="show-exercise-selector-btn">
                        ➕ Ajouter des exercices au modèle
                    </button>
                </div>
                
                <div id="selected-exercises-container" style="margin: 16px 0;">
                    <h4>Exercices sélectionnés :</h4>
                    <div id="template-selected-exercises" style="min-height: 50px; padding: 16px; border: 2px dashed var(--border); border-radius: 8px; background: var(--background);">
                        <p style="text-align: center; color: var(--text-secondary);">Aucun exercice sélectionné</p>
                    </div>
                </div>
            `;

            // Initialiser la liste des exercices sélectionnés si elle existe
            if (appState.templateInCreation) {
                actions.renderSelectedExercises();
            }

            // Afficher les modèles existants avec les nouvelles informations
            templatesList.innerHTML = '';
            if (appState.templates.length > 0) {
                appState.templates.forEach(template => {
                    const div = document.createElement('div');
                    div.className = 'exercise-item';
                
                    // Construire la liste des exercices du modèle avec les nouvelles informations
                    let exercisesHtml = '';
                    if (template.exercises && template.exercises.length > 0) {
                        exercisesHtml = template.exercises.map((exData, index) => {
                            const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                            if (exercise) {
                                const modeIcon = exercise.exercise_mode === 'time' ? '⏱️' : 
                                                exercise.exercise_mode === 'both' ? '🔄' : '🔢';
                                return `${index + 1}. ${modeIcon} ${exercise.name} (${exData.plannedSets} séries)`;
                            }
                            return null;
                        }).filter(name => name).join(', ');
                    } else {
                        // Compatibilité avec l'ancien format
                        exercisesHtml = (template.exerciseIds || [])
                            .map(id => {
                                const exercise = appState.exercises.find(e => e.id === id);
                                if (exercise) {
                                    const modeIcon = exercise.exercise_mode === 'time' ? '⏱️' : 
                                                    exercise.exercise_mode === 'both' ? '🔄' : '🔢';
                                    return `${modeIcon} ${exercise.name}`;
                                }
                                return null;
                            })
                            .filter(name => name)
                            .join(', ');
                    }

                    // Afficher les paramètres globaux s'ils existent
                    let settingsHtml = '';
                    if (template.globalSettings) {
                        settingsHtml = `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                            Repos: ${template.globalSettings.restBetweenExercises}s (exercices) • ${template.globalSettings.restBetweenSets}s (séries)
                        </div>`;
                    }

                    div.innerHTML = `
                        <div>
                            <strong>${template.name}</strong>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${exercisesHtml || 'Aucun exercice'}
                            </div>
                            ${settingsHtml}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-small btn-secondary" onclick="actions.editTemplate(${template.id})">✏️</button>
                            <button class="btn btn-small btn-danger" onclick="actions.deleteTemplate(${template.id})">🗑️</button>
                        </div>
                    `;
                    templatesList.appendChild(div);
                });
            } else {
                templatesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun modèle créé</p>';
            }
        }    

        function renderSettings() {
            // Le thème est déjà appliqué via applyTheme()
        }

        function renderManualEntry() {
            const content = document.getElementById('manual-entry-content');
            if (!appState.manualSession) {
                content.innerHTML = '<p>Aucune séance en cours</p>';
                return;
            }

            const currentExercise = appState.manualSession.exercises[appState.manualSession.currentExerciseIndex];
            if (!currentExercise) {
                actions.finishManualSession();
                return;
            }

            const exercise = appState.exercises.find(e => e.id === currentExercise.exercise_id);
            const performanceInputs = actions.generatePerformanceInputs(exercise, 'manual-');

            // Afficher les séries déjà saisies
            let setsHtml = '';
            if (currentExercise.sets.length > 0) {
                setsHtml = `
                    <div class="card">
                        <h4>Séries effectuées</h4>
                        ${currentExercise.sets.map((set, index) => {
                            if (exercise.is_unilateral) {
                                return `<div>Série ${index + 1}: ${set.left_reps || 0} reps (G) | ${set.right_reps || 0} reps (D) - ${set.total_resistance || 0}kg</div>`;
                            } else {
                                return `<div>Série ${index + 1}: ${set.reps || 0} reps - ${set.total_resistance || 0}kg</div>`;
                            }
                        }).join('')}
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="current-exercise">
                    <div class="exercise-name">${exercise.name}</div>
                    <div class="set-counter">Série ${currentExercise.sets.length + 1}</div>
                    <div style="color: var(--text-secondary);">Exercice ${appState.manualSession.currentExerciseIndex + 1} / ${appState.manualSession.exercises.length}</div>
                </div>
                ${setsHtml}
                ${performanceInputs}
                <div class="input-group">
                    <label>Type de série</label>
                    <select id="manual-set-type" class="select">
                        <option value="work">Travail</option>
                        <option value="warmup">Échauffement</option>
                        <option value="dropset">Série dégressif</option>
                        <option value="failure">Jusqu'à l'échec</option>
                    </select>
                </div>
                <button class="btn btn-success btn-full" onclick="actions.saveManualSet()">
                    ✅ Ajouter cette série
                </button>
                <button class="btn btn-primary btn-full" onclick="actions.nextManualExercise()">
                    ➡️ Exercice suivant
                </button>
                <button class="btn btn-secondary btn-full" onclick="actions.finishManualSession()">
                    🏁 Terminer la séance
                </button>
            `;
        }

        // === FONCTIONS UTILITAIRES ===
        actions.renderTemplatesModal = function() {
            const modalContent = document.getElementById('templates-modal-content');
            modalContent.innerHTML = '';

            // Forcer le rechargement des modèles depuis le stockage
            appState.templates = storage.load('templates', []);

            if (appState.templates.length > 0) {
                appState.templates.forEach(template => {
                    const div = document.createElement('div');
                    div.className = 'exercise-item';
                    div.style.cursor = 'pointer';
                    div.onclick = () => actions.loadTemplate(template.id);
                    
                    let exerciseNames = '';
                    if (template.exercises && template.exercises.length > 0) {
                        // Nouveau format
                        exerciseNames = template.exercises.map(exData => {
                            const exercise = appState.exercises.find(e => e.id === exData.exerciseId);
                            return exercise ? exercise.name : 'Exercice supprimé';
                        }).join(', ');
                    } else {
                        // Ancien format
                        exerciseNames = (template.exerciseIds || [])
                            .map(id => appState.exercises.find(e => e.id === id)?.name)
                            .filter(name => name)
                            .join(', ');
                    }
                
                    div.innerHTML = `
                        <div>
                            <strong>${template.name}</strong>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${exerciseNames || 'Aucun exercice'}
                            </div>
                        </div>
                        <div>👆</div>
                    `;
                    modalContent.appendChild(div);
                });
            } else {
            modalContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun modèle disponible</p>';
            }
        };

        actions.deleteSession = function(sessionId) {
            if (confirm('Supprimer cette séance ?')) {
                appState.sessions = appState.sessions.filter(s => s.id !== sessionId);
                this.saveData();
                render();
                this.showNotification('Séance supprimée');
            }
        };

        // Édition des séances
        actions.editSession = function(sessionId) {
            const session = appState.sessions.find(s => s.id === sessionId);
            if (!session) {
                this.showNotification('Séance introuvable');
                return;
            }
            
            appState.editingSession = { ...session }; // Copie pour éviter les modifications directes
            this.renderEditSessionModal();
            document.getElementById('edit-session-modal').classList.add('active');
        };

        actions.renderEditSessionModal = function() {
            const content = document.getElementById('edit-session-content');
            const session = appState.editingSession;
            
            let exercisesHtml = '';
            session.exercises.forEach((sessionEx, exerciseIndex) => {
                const exercise = appState.exercises.find(e => e.id === sessionEx.exercise_id);
                if (!exercise) return;
                
                let setsHtml = '';
                sessionEx.sets.forEach((set, setIndex) => {
                    setsHtml += this.renderEditableSet(set, exercise, exerciseIndex, setIndex);
                });
                
                exercisesHtml += `
                    <div class="card" style="margin-bottom: 16px;">
                        <h4>${exercise.name}</h4>
                        <div style="margin-bottom: 12px;">
                            <button class="btn btn-small btn-secondary" onclick="actions.addSetToExercise(${exerciseIndex})">
                                ➕ Ajouter une série
                            </button>
                        </div>
                        ${setsHtml}
                    </div>
                `;
            });
            
            content.innerHTML = `
                <div class="input-group">
                    <label>Date de la séance</label>
                    <input type="date" id="edit-session-date" class="input" value="${session.date}">
                </div>
                
                <div class="input-group">
                    <label>Notes de séance</label>
                    <textarea id="edit-session-notes" class="textarea" placeholder="Notes optionnelles...">${session.notes || ''}</textarea>
                </div>
                
                <div class="input-group" ${session.difficulty ? '' : 'style="display: none;"'}>
                    <label>Difficulté ressentie</label>
                    <select id="edit-session-difficulty" class="select">
                        <option value="">Non définie</option>
                        <option value="Facile" ${session.difficulty === 'Facile' ? 'selected' : ''}>😊 Facile</option>
                        <option value="Normale" ${session.difficulty === 'Normale' ? 'selected' : ''}>💪 Normale</option>
                        <option value="Difficile" ${session.difficulty === 'Difficile' ? 'selected' : ''}>🔥 Difficile</option>
                    </select>
                </div>
                
                <h3>Exercices et performances</h3>
                ${exercisesHtml}
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-success" onclick="actions.saveSessionEdits()" style="flex: 1;">
                        💾 Sauvegarder les modifications
                    </button>
                    <button class="btn btn-secondary" onclick="actions.cancelSessionEdit()" style="flex: 1;">
                        ❌ Annuler
                    </button>
                </div>
            `;
        };

        actions.renderEditableSet = function(set, exercise, exerciseIndex, setIndex) {
            const setId = `exercise-${exerciseIndex}-set-${setIndex}`;
            
            let performanceInputs = '';
            if (set.exercise_mode === 'time') {
                performanceInputs = `
                    <div class="input-group">
                        <label>Durée (secondes)</label>
                        <input type="number" id="${setId}-duration" class="input" value="${set.duration || 0}" min="0" max="600">
                    </div>
                `;
            } else {
                if (exercise.is_unilateral) {
                    performanceInputs = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="input-group">
                                <label>Reps Gauche</label>
                                <input type="number" id="${setId}-left-reps" class="input" value="${set.left_reps || 0}" min="0">
                            </div>
                            <div class="input-group">
                                <label>Reps Droite</label>
                                <input type="number" id="${setId}-right-reps" class="input" value="${set.right_reps || 0}" min="0">
                            </div>
                        </div>
                    `;
                } else {
                    performanceInputs = `
                        <div class="input-group">
                            <label>Répétitions</label>
                            <input type="number" id="${setId}-reps" class="input" value="${set.reps || 0}" min="0">
                        </div>
                    `;
                }
            }
            
            // Gestion de la résistance (simplifiée pour l'édition)
            let resistanceInput = '';
            if (exercise.exercise_type === 'elastics') {
                const resistance = exercise.is_unilateral ? 
                    (typeof set.total_resistance === 'object' ? 
                        (set.total_resistance.left || 0) + (set.total_resistance.right || 0) : 
                        (set.total_resistance || 0) * 2) :
                    (set.total_resistance || 0);
                
                resistanceInput = `
                    <div class="input-group">
                        <label>Résistance totale (kg)</label>
                        <input type="number" id="${setId}-resistance" class="input" value="${resistance}" min="0" step="0.5">
                    </div>
                `;
            }
            
            return `
                <div class="card" style="margin: 8px 0; padding: 12px; background: var(--background);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5>Série ${setIndex + 1}</h5>
                        <button class="btn btn-small btn-danger" onclick="actions.removeSetFromExercise(${exerciseIndex}, ${setIndex})" title="Supprimer cette série">
                            🗑️
                        </button>
                    </div>
                
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        ${performanceInputs}
                        ${resistanceInput}
                        <div class="input-group">
                            <label>Type</label>
                            <select id="${setId}-type" class="select">
                                <option value="work" ${set.type === 'work' ? 'selected' : ''}>Travail</option>
                                <option value="warmup" ${set.type === 'warmup' ? 'selected' : ''}>Échauffement</option>
                                <option value="dropset" ${set.type === 'dropset' ? 'selected' : ''}>Dégressif</option>
                                <option value="failure" ${set.type === 'failure' ? 'selected' : ''}>Échec</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        };

        actions.addSetToExercise = function(exerciseIndex) {
            const session = appState.editingSession;
            const sessionExercise = session.exercises[exerciseIndex];
            const exercise = appState.exercises.find(e => e.id === sessionExercise.exercise_id);
            
            // Créer une nouvelle série basée sur le type d'exercice
            const newSet = {
                type: 'work',
                exercise_mode: exercise.exercise_mode || 'reps'
            };
            
            if (exercise.is_unilateral) {
                newSet.left_reps = 0;
                newSet.right_reps = 0;
            } else {
                newSet.reps = 0;
            }
            
            if (exercise.exercise_mode === 'time') {
                newSet.duration = exercise.default_duration || 30;
            }
            
            newSet.total_resistance = 0;
            
            sessionExercise.sets.push(newSet);
            this.renderEditSessionModal();
        };

        actions.removeSetFromExercise = function(exerciseIndex, setIndex) {
            if (confirm('Supprimer cette série ?')) {
                appState.editingSession.exercises[exerciseIndex].sets.splice(setIndex, 1);
                this.renderEditSessionModal();
            }
        };

        actions.saveSessionEdits = function() {
            const session = appState.editingSession;
            
            // Récupérer les données du formulaire
            session.date = document.getElementById('edit-session-date').value;
            session.notes = document.getElementById('edit-session-notes').value;
            
            const difficultySelect = document.getElementById('edit-session-difficulty');
            if (difficultySelect) {
                session.difficulty = difficultySelect.value || null;
            }
            
            // Récupérer toutes les modifications de performances
            session.exercises.forEach((sessionEx, exerciseIndex) => {
                const exercise = appState.exercises.find(e => e.id === sessionEx.exercise_id);
                
                sessionEx.sets.forEach((set, setIndex) => {
                    const setId = `exercise-${exerciseIndex}-set-${setIndex}`;
                
                    // Type de série
                    const typeInput = document.getElementById(`${setId}-type`);
                    if (typeInput) set.type = typeInput.value;
                
                    // Performances selon le mode
                    if (set.exercise_mode === 'time') {
                        const durationInput = document.getElementById(`${setId}-duration`);
                        if (durationInput) set.duration = parseInt(durationInput.value) || 0;
                    } else {
                        if (exercise.is_unilateral) {
                            const leftRepsInput = document.getElementById(`${setId}-left-reps`);
                            const rightRepsInput = document.getElementById(`${setId}-right-reps`);
                            if (leftRepsInput) set.left_reps = parseInt(leftRepsInput.value) || 0;
                            if (rightRepsInput) set.right_reps = parseInt(rightRepsInput.value) || 0;
                        } else {
                            const repsInput = document.getElementById(`${setId}-reps`);
                            if (repsInput) set.reps = parseInt(repsInput.value) || 0;
                        }
                    }
                
                    // Résistance
                    const resistanceInput = document.getElementById(`${setId}-resistance`);
                    if (resistanceInput) {
                        const totalResistance = parseFloat(resistanceInput.value) || 0;
                        if (exercise.is_unilateral) {
                            // Pour les exercices unilatéraux, diviser équitablement
                            set.total_resistance = {
                                left: totalResistance / 2,
                                right: totalResistance / 2
                            };
                        } else {
                            set.total_resistance = totalResistance;
                        }
                    }
                });
            });
            
            // Sauvegarder dans l'état principal
            const sessionIndex = appState.sessions.findIndex(s => s.id === session.id);
            if (sessionIndex !== -1) {
                appState.sessions[sessionIndex] = session;
                this.saveData();
                this.closeModal('edit-session-modal');
                render();
                this.showNotification('✅ Séance modifiée avec succès !');
            }
        };

        actions.cancelSessionEdit = function() {
            appState.editingSession = null;
            this.closeModal('edit-session-modal');
        };

        // Initialisation de la recherche d'exercices
        actions.initializeExerciseSearch = function() {
            const searchInput = document.getElementById('exercise-search');
            const resultsContainer = document.getElementById('exercise-search-results');
            const historyContainer = document.getElementById('search-history');
            
            if (!searchInput) return;
            
            let currentSelection = -1;
            let currentResults = [];
            
            // Charger l'historique
            smartSearch.loadHistory();
            this.updateSearchHistory();
            
            // Événement de saisie avec debouncing
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                currentSelection = -1;
                
                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    historyContainer.style.display = searchHistory.length > 0 ? 'block' : 'none';
                    return;
                }
                
                historyContainer.style.display = 'none';
                
                // Utiliser le debouncing pour éviter trop d'appels
                debounceManager.debounce(() => {
                    currentResults = smartSearch.search(query);
                    this.displaySearchResults(currentResults, query);
                }, 200, 'search');
            });
        
            // Événement focus - afficher la liste complète ou l'historique
            searchInput.addEventListener('focus', () => {
                if (!searchInput.value) {
                    if (searchHistory.length > 0) {
                        historyContainer.style.display = 'block';
                    } else {
                        // Afficher tous les exercices si pas d'historique
                        currentResults = smartSearch.search('');
                        this.displaySearchResults(currentResults, '');
                    }
                }
            });
        
            // Événement blur - masquer les résultats (avec délai pour permettre les clics)
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    resultsContainer.style.display = 'none';
                    historyContainer.style.display = 'none';
                }, 200);
            });
        
            // Navigation au clavier
            searchInput.addEventListener('keydown', (e) => {
                if (resultsContainer.style.display === 'none') return;
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentSelection = Math.min(currentSelection + 1, currentResults.length - 1);
                        this.highlightResult(currentSelection);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentSelection = Math.max(currentSelection - 1, -1);
                        this.highlightResult(currentSelection);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentSelection >= 0 && currentResults[currentSelection]) {
                            this.selectExercise(currentResults[currentSelection]);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        resultsContainer.style.display = 'none';
                        searchInput.blur();
                        break;
                }
            });
        };

        actions.displaySearchResults = function(results, query) {
            const resultsContainer = document.getElementById('exercise-search-results');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-no-results">
                        Aucun exercice trouvé pour "${query}"
                        <div style="margin-top: 8px; font-size: 11px;">
                            💡 Essayez avec des mots-clés comme "biceps", "squat", "porte"...
                        </div>
                    </div>
                `;
                resultsContainer.style.display = 'block';
                return;
            }
        
            let html = '';
            results.forEach((exercise, index) => {
                const modeIcon = exercise.exercise_mode === 'time' ? '⏱️' :
                                 exercise.exercise_mode === 'both' ? '🔄' : '🔢';
            
                const anchorText = {
                    'none': 'Sans ancrage',
                    'door-middle': 'Porte (milieu)',
                    'door-high': 'Porte (haut)', 
                    'door-low': 'Porte (bas)',
                    'floor': 'Sol/Pieds',
                    'body': 'Corps',
                    'external': 'Extérieur'
                };
            
                html += `
                    <div class="search-result-item" onclick="actions.selectExercise({id: ${exercise.id}, name: '${exercise.name.replace(/'/g, "\\'")}'})" data-index="${index}">
                        <div>
                            <div class="search-result-name">${modeIcon} ${exercise.name}</div>
                            <div class="search-result-details">
                                ${exercise.muscle_group} • ${exercise.is_unilateral ? 'Unilatéral' : 'Bilatéral'} • ${anchorText[exercise.anchor_point] || 'Non défini'}
                            </div>
                        </div>
                        <div style="font-size: 20px;">+</div>
                    </div>
                `;
            });
        
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        };

        actions.highlightResult = function(index) {
            const items = document.querySelectorAll('.search-result-item');
            items.forEach(item => item.classList.remove('highlighted'));
            
            if (index >= 0 && items[index]) {
                items[index].classList.add('highlighted');
                items[index].scrollIntoView({ block: 'nearest' });
            }
        };

        actions.selectExercise = function(exercise) {
            // Ajouter l'exercice à la session
            if (!appState.currentSession) {
                appState.currentSession = {
                    date: new Date().toISOString().split('T')[0],
                    notes: '',
                    exercises: [],
                    globalSettings: {
                        restBetweenExercises: 120,
                        restBetweenSets: 90
                    }
                };
            }
            
            // Vérifier si l'exercice n'est pas déjà dans la liste
            const exists = appState.currentSession.exercises.find(e => e.exercise_id === exercise.id);
            if (exists) {
                this.showNotification('Cet exercice est déjà dans la liste');
                return;
            }
            
            const fullExercise = appState.exercises.find(e => e.id === exercise.id);
            if (!fullExercise) {
                this.showNotification('Exercice introuvable');
                return;
            }
            
            appState.currentSession.exercises.push({
                exercise_id: exercise.id,
                planned_sets: 3,
                rest_time: fullExercise.default_rest_time || 90,
                duration: fullExercise?.default_duration || 30,
                sets: []
            });
            
            // Réinitialiser la recherche
            const searchInput = document.getElementById('exercise-search');
            const resultsContainer = document.getElementById('exercise-search-results');
            if (searchInput) searchInput.value = '';
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            render();
            this.showNotification(`Exercice "${exercise.name}" ajouté !`);
        };

        actions.updateSearchHistory = function() {
            const historyContainer = document.getElementById('search-history');
            if (!historyContainer) return;
            
            if (searchHistory.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }
            
            let html = '<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Recherches récentes :</div>';
            searchHistory.slice(0, 5).forEach(item => {
                html += `
                    <span class="search-history-item" onclick="actions.useHistorySearch('${item.query}')">
                        ${item.query}
                    </span>
                `;
            });
            
            html += `
                <span class="search-history-item" onclick="actions.clearSearchHistory()" style="background: var(--danger); color: white;">
                    ✕ Effacer
                </span>
            `;
            
            historyContainer.innerHTML = html;
        };

        actions.useHistorySearch = function(query) {
            const searchInput = document.getElementById('exercise-search');
            if (searchInput) {
                searchInput.value = query;
                searchInput.focus();
                // Déclencher la recherche
                const event = new Event('input', { bubbles: true });
                searchInput.dispatchEvent(event);
            }
        };

        actions.clearSearchHistory = function() {
            smartSearch.clearHistory();
            this.updateSearchHistory();
            this.showNotification('Historique de recherche effacé');
        };

        // === GESTION DES PROGRAMMES ===
        
        // Navigation entre onglets programmes
        actions.switchProgramTab = function(tab) {
            // Mise à jour des onglets
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="actions.switchProgramTab('${tab}')"]`).classList.add('active');
            
            // Affichage du contenu
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Charger le contenu selon l'onglet
            if (tab === 'predefined') {
                this.loadPredefinedPrograms();
            } else if (tab === 'custom') {
                this.loadCustomPrograms();
            }
        };

        // Navigation entre sous-onglets
        actions.switchProgramSubtab = function(subtab) {
            // Mise à jour des sous-onglets
            document.querySelectorAll('.subtab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="actions.switchProgramSubtab('${subtab}')"]`).classList.add('active');
            
            // Affichage du contenu
            document.querySelectorAll('.subtab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`subtab-${subtab}`).classList.add('active');
            
            // Charger le contenu selon le sous-onglet
            if (subtab === 'histoire-gloire') {
                this.loadHistoireGloirePrograms();
            } else if (subtab === 'autres') {
                this.loadAutresPrograms();
            }
        };

        // Charger les programmes "Une longue histoire vers la gloire"
        actions.loadHistoireGloirePrograms = function() {
            const container = document.getElementById('programs-list-histoire');
            container.innerHTML = '';

            // Programmes par catégorie
            const categories = {
                'debutant': { emoji: '🔰', titre: 'DÉBUTANT', programs: [] },
                'intermediaire': { emoji: '⚔️', titre: 'INTERMÉDIAIRE', programs: [] },
                'avance': { emoji: '🏺', titre: 'AVANCÉ', programs: [] },
                'legende': { emoji: '👑', titre: 'LÉGENDE', programs: [] },
                'specifique': { emoji: '🎯', titre: 'SPÉCIFIQUE', programs: [] }
            };

            // Organiser les programmes par catégorie
            Object.values(PREDEFINED_PROGRAMS).forEach(program => {
                if (categories[program.categorie]) {
                    categories[program.categorie].programs.push(program);
                }
            });

            // Afficher chaque catégorie
            Object.entries(categories).forEach(([key, category]) => {
                if (category.programs.length === 0) return;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'program-category-section';
                categoryDiv.innerHTML = `
                    <h3 style="margin: 24px 0 16px 0; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">${category.emoji}</span>
                        ${category.titre}
                        <span style="font-size: 14px; color: var(--text-secondary); margin-left: auto;">
                            ${category.programs.length} programme${category.programs.length > 1 ? 's' : ''}
                        </span>
                    </h3>
                `;

                category.programs.forEach(program => {
                    const programCard = this.createProgramCard(program);
                    categoryDiv.appendChild(programCard);
                });

                container.appendChild(categoryDiv);
            });
        };

        // Charger les autres programmes
        actions.loadAutresPrograms = function() {
            const container = document.getElementById('programs-list-autres');
            container.innerHTML = `
                <div class="card" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">🚀</div>
                    <h3>Bientôt disponible</h3>
                    <p>De nouveaux programmes spécialisés arrivent prochainement !</p>
                </div>
            `;
        };

        // Créer une carte de programme
        actions.createProgramCard = function(program) {
            const div = document.createElement('div');
            div.className = `program-card ${!program.disponible ? 'unavailable' : ''}`;
            
            if (program.disponible) {
                div.onclick = () => this.showProgramDetails(program.id);
            }

            const stars = '★'.repeat(program.difficulte) + '☆'.repeat(5 - program.difficulte);
            const objectivesTags = program.objectifs.map(obj => 
                `<span class="objective-tag">${obj}</span>`
            ).join('');

            div.innerHTML = `
                ${!program.disponible ? '<div class="unavailable-badge">Bientôt disponible</div>' : ''}
                
                <div class="program-header">
                    <div>
                        <div class="program-title">${program.nom}</div>
                        ${program.sous_titre ? `<div class="program-subtitle" style="font-size: 12px; color: var(--text-secondary); font-style: italic; margin-bottom: 4px;">${program.sous_titre}</div>` : ''}
                        <div class="program-category ${program.categorie}">${program.categorie.toUpperCase()}</div>
                    </div>
                </div>

                <div class="program-difficulty">
                    <span class="difficulty-stars">${stars}</span>
                    <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">
                        Niveau ${program.difficulte}/5
                    </span>
                </div>

                <div class="program-stats">
                    <div class="program-stat">
                        <div class="program-stat-value">${program.duree_semaines}</div>
                        <div class="program-stat-label">Semaines</div>
                    </div>
                    <div class="program-stat">
                        <div class="program-stat-value">${program.seances_par_semaine}</div>
                        <div class="program-stat-label">Séances/sem</div>
                    </div>
                    <div class="program-stat">
                        <div class="program-stat-value">${program.duree_semaines * program.seances_par_semaine}</div>
                        <div class="program-stat-label">Total séances</div>
                    </div>
                    <div class="program-stat">
                        <div class="program-stat-value">${Math.round(program.duree_semaines * program.seances_par_semaine * 30 / 60)}</div>
                        <div class="program-stat-label">Heures</div>
                    </div>
                </div>

                <div class="program-description">${program.description}</div>

                <div class="program-objectives">
                    ${objectivesTags}
                </div>

                ${program.disponible ? 
                    '<div style="font-size: 14px; color: var(--primary); font-weight: 600; margin-top: 12px;">👆 Cliquez pour voir les détails</div>' :
                    '<div style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">🔒 Programme en cours de développement</div>'
                }
            `;

            return div;
        };

        // Afficher les détails d'un programme
        actions.showProgramDetails = function(programId) {
            const program = PREDEFINED_PROGRAMS[programId];
            if (!program) {
                this.showNotification('Programme introuvable');
                return;
            }

            const screen = document.getElementById('screen-program-details');
            const title = document.getElementById('program-details-title');
            const content = document.getElementById('program-details-content');

            title.textContent = program.nom;

            const stars = '★'.repeat(program.difficulte) + '☆'.repeat(5 - program.difficulte);
            const equipmentList = program.equipement_requis.map(eq => `<li>${eq}</li>`).join('');
            const objectivesList = program.objectifs.map(obj => `<li>${obj}</li>`).join('');
            const conseilsList = program.conseils ? program.conseils.map(conseil => `<li>${conseil}</li>`).join('') : '';

            // Aperçu épique du planning (première semaine)
            let planningPreview = '';
            if (program.seances && program.seances.length > 0) {
                const semaine1 = program.seances.filter(s => s.semaine === 1);
                planningPreview = `
                    <div class="card">
                        <h3 style="color: #ff6b35; margin-bottom: 20px;">📅 Planning de Guerre - Semaine 1</h3>
                        ${semaine1.length > 0 && semaine1[0].philosophie ? `
                            <div style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(212, 56, 13, 0.1) 100%); padding: 16px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-style: italic; color: var(--text-secondary);">
                                "${semaine1[0].philosophie}"
                            </div>
                        ` : ''}
                        <div style="display: grid; gap: 12px;">
                            ${semaine1.map(seance => `
                                <div style="border: 2px solid #ff6b35; border-radius: 12px; padding: 16px; background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, rgba(212, 56, 13, 0.05) 100%);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div>
                                            <strong style="color: #ff6b35;">${seance.jour_semaine || 'Jour ' + seance.jour}</strong>
                                            <div style="font-size: 16px; font-weight: 600; margin-top: 4px;">${seance.nom}</div>
                                        </div>
                                        <div style="text-align: right; font-size: 13px; color: var(--text-secondary);">
                                            ${seance.duree_minutes} min<br>
                                            ${seance.exercices.length} exercices
                                        </div>
                                    </div>
                                    ${seance.phase_eveil ? `
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                            <strong>🔥 Phase d'éveil :</strong> ${seance.phase_eveil.duree}
                                        </div>
                                    ` : ''}
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        <strong>⚔️ Groupes ciblés :</strong> 
                                        ${[...new Set(seance.exercices.map(ex => ex.groupe ? ex.groupe.split(' - ')[0] : 'Général'))].join(' • ')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                <!-- En-tête épique du programme -->
                <div class="card" style="background: linear-gradient(135deg, #ff6b35 0%, #d4380d 100%); color: white; text-align: center;">
                    <h2 style="margin-bottom: 4px;">${program.nom}</h2>
                    ${program.sous_titre ? `<div style="font-size: 14px; margin-bottom: 12px; opacity: 0.8; font-style: italic;">${program.sous_titre}</div>` : ''}
                    <div style="font-size: 16px; margin-bottom: 16px; opacity: 0.9;">${program.description}</div>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${program.duree_semaines}</div>
                            <div style="font-size: 12px; opacity: 0.8;">Semaines</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${program.seances_par_semaine}</div>
                            <div style="font-size: 12px; opacity: 0.8;">Batailles/sem</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px;">${stars}</div>
                            <div style="font-size: 12px; opacity: 0.8;">Difficulté</div>
                        </div>
                    </div>
                </div>

                <!-- Philosophie de l'échec musculaire -->
                ${program.philosophie ? `
                    <div class="card" style="background: linear-gradient(135deg, #722f37 0%, #2c1810 100%); color: white; padding: 20px;">
                        <div style="white-space: pre-line; text-align: center; line-height: 1.6;">
                            ${program.philosophie}
                        </div>
                    </div>
                ` : ''}

                <!-- Structure des Batailles -->
                ${program.structure_batailles ? `
                    <div class="card">
                        <h3 style="color: #ff6b35; margin-bottom: 20px;">🎪 Structure des Batailles</h3>
                        <div style="display: grid; gap: 16px;">
                            ${Object.values(program.structure_batailles).map(bataille => `
                                <div style="border: 2px solid #ff6b35; border-radius: 12px; padding: 16px; background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(212, 56, 13, 0.1) 100%);">
                                    <h4 style="color: #ff6b35; margin-bottom: 4px;">${bataille.nom}</h4>
                                    <p style="font-style: italic; color: var(--text-secondary); margin-bottom: 12px;">${bataille.sous_titre}</p>
                                    <div style="font-size: 14px; line-height: 1.5;">
                                        <p><strong>⏱️ Durée :</strong> ${bataille.duree}</p>
                                        <p><strong>🔥 Éveil :</strong> ${bataille.phase_eveil}</p>
                                        <p><strong>⚔️ Destruction :</strong> ${bataille.phase_destruction}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Progression Épique -->
                ${program.progression_phases ? `
                    <div class="card">
                        <h3 style="color: #ff6b35; margin-bottom: 20px;">📈 Progression Épique</h3>
                        <div style="display: grid; gap: 16px;">
                            ${Object.values(program.progression_phases).map(phase => `
                                <div style="border-left: 4px solid #ff6b35; padding: 16px; background: var(--background); border-radius: 8px;">
                                    <h4 style="color: #ff6b35; margin-bottom: 8px;">Semaines ${phase.semaines} : ${phase.nom}</h4>
                                    <div style="font-size: 14px; line-height: 1.5;">
                                        <p><strong>🎯 Objectif :</strong> ${phase.objectif}</p>
                                        <p><strong>💪 Séries :</strong> ${phase.series}</p>
                                        <p><strong>⏲️ Repos :</strong> ${phase.repos}</p>
                                        <p><strong>🔍 Focus :</strong> ${phase.focus}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Règle d'Or -->
                ${program.regle_or ? `
                    <div class="card" style="background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%); color: #2c1810; text-align: center; padding: 20px;">
                        <h3 style="margin-bottom: 16px;">🎯 Règle d'Or de l'Ajustement</h3>
                        <p style="font-size: 16px; font-weight: 600; font-style: italic; line-height: 1.4;">
                            "${program.regle_or}"
                        </p>
                    </div>
                ` : ''}

                <!-- Arsenal de la Forge -->
                ${program.arsenal_principal ? `
                    <div class="card">
                        <h3 style="color: #ff6b35; margin-bottom: 20px;">⚡ Arsenal de la Forge</h3>
                        <div style="display: grid; gap: 8px;">
                            ${program.arsenal_principal.map(arme => `
                                <div style="padding: 12px; background: var(--background); border-radius: 8px; border-left: 4px solid #ff6b35;">
                                    ${arme}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Niveaux d'utilisateur -->
                ${program.niveau_utilisateur ? `
                    <div class="card">
                        <h3 style="color: #ff6b35; margin-bottom: 20px;">⚖️ Système de Résistance par Niveau</h3>
                        <div style="display: grid; gap: 16px;">
                            ${Object.values(program.niveau_utilisateur).map(niveau => `
                                <div style="border: 2px solid var(--secondary); border-radius: 12px; padding: 16px;">
                                    <h4 style="color: var(--secondary); margin-bottom: 8px;">${niveau.titre}</h4>
                                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">${niveau.description}</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${niveau.elastiques.map(elastique => `
                                            <span style="background: var(--secondary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                                ${elastique}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Informations détaillées -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                    <div class="card">
                        <h3>🎯 Objectifs principaux</h3>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${objectivesList}
                        </ul>
                    </div>

                    <div class="card">
                        <h3>🛠️ Équipement nécessaire</h3>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${equipmentList}
                        </ul>
                    </div>
                </div>

                ${conseilsList ? `
                    <div class="card">
                        <h3>💡 Conseils pour réussir</h3>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${conseilsList}
                        </ul>
                    </div>
                ` : ''}

                ${planningPreview}

                <!-- Héritage de la Forge -->
                ${program.heritage_forge ? `
                    <div class="card">
                        <h3 style="color: #ff6b35; margin-bottom: 20px;">🏆 Héritage de la Forge</h3>
                        <div style="display: grid; gap: 16px; margin-bottom: 20px;">
                            ${Object.entries(program.heritage_forge).map(([key, value]) => `
                                <div style="display: flex; align-items: center; padding: 12px; background: var(--background); border-radius: 8px; border-left: 4px solid #ffd700;">
                                    <div style="font-weight: 600; text-transform: capitalize; color: #ffd700; margin-right: 12px; min-width: 80px;">
                                        ${key === 'physique' ? '💪' : key === 'mental' ? '🧠' : key === 'technique' ? '⚡' : '🎯'} ${key.charAt(0).toUpperCase() + key.slice(1)}:
                                    </div>
                                    <div>${value}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${program.transformation_garantie ? `
                            <h4 style="color: #ff6b35; margin-bottom: 16px;">🔥 Transformation Garantie</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                ${program.transformation_garantie.map(transformation => `
                                    <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(212, 56, 13, 0.1) 100%); border-radius: 8px; border: 1px solid #ff6b35;">
                                        <div style="font-size: 14px; font-weight: 600; color: #ff6b35;">${transformation}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <!-- Progression attendue (pour les autres programmes) -->
                    <div class="card">
                        <h3>📈 Progression attendue</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                            <div style="text-align: center; padding: 16px; background: var(--background); border-radius: 8px;">
                                <div style="font-size: 18px; color: var(--secondary);">+15-25%</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Force générale</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--background); border-radius: 8px;">
                                <div style="font-size: 18px; color: var(--secondary);">+10-20%</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Masse musculaire</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--background); border-radius: 8px;">
                                <div style="font-size: 18px; color: var(--secondary);">+30-50%</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Endurance</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--background); border-radius: 8px;">
                                <div style="font-size: 18px; color: var(--secondary);">+40-60%</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Technique</div>
                            </div>
                        </div>
                    </div>
                `}

                <!-- Bouton d'action -->
                <div class="card" style="text-align: center;">
                    ${program.disponible ? `
                        <button class="btn btn-primary btn-full" onclick="actions.startProgram('${program.id}')" style="font-size: 18px; padding: 16px;">
                            🚀 Suivre ce programme
                        </button>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                            Vous pourrez choisir votre date de début à l'étape suivante
                        </div>
                    ` : `
                        <div style="padding: 20px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">🔒</div>
                            <h3>Programme en développement</h3>
                            <p>Ce programme sera bientôt disponible. Revenez prochainement !</p>
                        </div>
                    `}
                </div>
            `;

            this.showScreen('program-details');
        };

        // Démarrer un programme
        actions.startProgram = function(programId) {
            const program = PREDEFINED_PROGRAMS[programId];
            if (!program || !program.disponible) {
                this.showNotification('Programme non disponible');
                return;
            }

            // Vérifier s'il y a déjà un programme actif
            if (appState.currentProgram) {
                if (!confirm('Vous avez déjà un programme en cours. Voulez-vous le remplacer ?')) {
                    return;
                }
            }

            // Stocker le programme sélectionné temporairement
            appState.selectedProgram = program;

            // Ouvrir le modal de sélection de date
            this.showProgramDateModal(program);
        };

        // Afficher le modal de sélection de date
        actions.showProgramDateModal = function(program) {
            const modal = document.getElementById('program-date-modal');
            const description = document.getElementById('program-date-description');
            const startDateInput = document.getElementById('program-start-date');
            const endDateInput = document.getElementById('program-end-date');

            // Définir la date de début par défaut (aujourd'hui)
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = today;
            startDateInput.min = today;

            description.textContent = `À partir de quelle date souhaitez-vous débuter "${program.nom}" ?`;

            // Calculer et afficher la date de fin
            this.updateProgramEndDate();

            modal.classList.add('active');
        };

        // Mettre à jour la date de fin prévue
        actions.updateProgramEndDate = function() {
            const startDateInput = document.getElementById('program-start-date');
            const endDateInput = document.getElementById('program-end-date');
            const preview = document.getElementById('program-calendar-preview');

            if (!startDateInput.value || !appState.selectedProgram) return;

            const startDate = new Date(startDateInput.value);
            const durationWeeks = appState.selectedProgram.duree_semaines;
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + (durationWeeks * 7));

            endDateInput.value = endDate.toISOString().split('T')[0];

            // Aperçu
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            preview.innerHTML = `
                <strong>Durée totale :</strong> ${durationWeeks} semaines<br>
                <strong>Du :</strong> ${startDate.toLocaleDateString('fr-FR', options)}<br>
                <strong>Au :</strong> ${endDate.toLocaleDateString('fr-FR', options)}<br>
                <strong>Séances totales :</strong> ${appState.selectedProgram.duree_semaines * appState.selectedProgram.seances_par_semaine}
            `;
        };

        // Confirmer le démarrage du programme
        actions.confirmStartProgram = function() {
            const startDateInput = document.getElementById('program-start-date');
            
            if (!startDateInput.value || !appState.selectedProgram) {
                this.showNotification('Date de début requise');
                return;
            }

            const program = appState.selectedProgram;
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + (program.duree_semaines * 7));

            // Créer le suivi de programme
            const suiviProgramme = {
                id: Date.now(),
                programme_id: program.id,
                programme_nom: program.nom,
                date_debut: startDate.toISOString().split('T')[0],
                date_fin_prevue: endDate.toISOString().split('T')[0],
                statut: 'actif',
                progression: {
                    seances_completees: 0,
                    seances_totales: program.duree_semaines * program.seances_par_semaine,
                    pourcentage: 0,
                    semaine_actuelle: 1
                },
                seances_realisees: [],
                parametres: {
                    type_progression: program.progression_type || 'linear',
                    notifications_actives: true,
                    jours_entrainement: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday']
                }
            };

            // Sauvegarder le programme actif
            appState.currentProgram = suiviProgramme;
            this.saveData();

            // Nettoyer et fermer
            appState.selectedProgram = null;
            this.closeModal('program-date-modal');

            // Aller à l'écran de suivi
            this.showScreen('program-tracking');
            this.showNotification(`🎉 Programme "${program.nom}" démarré avec succès !`);
        };

        // Afficher l'écran de suivi de programme
        actions.renderProgramTracking = function() {
            if (!appState.currentProgram) {
                const screen = document.getElementById('screen-program-tracking');
                screen.innerHTML = `
                    <div class="header">
                        <button class="btn btn-small btn-secondary" onclick="actions.showScreen('dashboard')">← Retour</button>
                        <h1>Aucun programme</h1>
                        <div></div>
                    </div>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📚</div>
                        <h3>Aucun programme actif</h3>
                        <p>Commencez par sélectionner un programme dans l'onglet Programmes.</p>
                        <button class="btn btn-primary" onclick="actions.showScreen('programmes')">
                            🏆 Voir les programmes
                        </button>
                    </div>
                `;
                return;
            }

            const program = PREDEFINED_PROGRAMS[appState.currentProgram.programme_id];
            const title = document.getElementById('program-tracking-title');
            const header = document.getElementById('program-progress-header');
            const progressFill = document.getElementById('program-progress-fill');
            const progressText = document.getElementById('program-progress-text');
            const quickActions = document.getElementById('program-quick-actions');
            const weeksContainer = document.getElementById('program-weeks-container');

            title.textContent = appState.currentProgram.programme_nom;

            // Calculer la progression
            const progression = this.calculerProgression(appState.currentProgram);

            // En-tête de progression
            header.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div>
                        <strong>Semaine ${progression.semaineActuelle} / ${program.duree_semaines}</strong>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            ${progression.seancesRealisees} / ${progression.seancesTotales} séances
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: var(--text-secondary);">Reste</div>
                        <div style="font-weight: 600;">${progression.joursRestants} jours</div>
                    </div>
                </div>
            `;

            // Barre de progression
            progressFill.style.width = progression.pourcentage + '%';
            progressText.textContent = progression.pourcentage + '% complété';

            // Actions rapides
            const prochaineSeance = this.getNextSession();
            quickActions.innerHTML = `
                <div style="display: grid; gap: 8px; margin-top: 16px;">
                    ${prochaineSeance ? `
                        <button class="btn btn-primary btn-full" onclick="actions.startNextSession()">
                            ⚡ Prochaine séance : ${prochaineSeance.nom}
                        </button>
                    ` : `
                        <div style="text-align: center; padding: 16px; color: var(--text-secondary);">
                            🎉 Toutes les séances complétées !
                        </div>
                    `}
                    <button class="btn btn-secondary btn-full" onclick="actions.showProgramStats()">
                        📊 Voir mes statistiques
                    </button>
                </div>
            `;

            // Générer les semaines (accordéon)
            this.renderProgramWeeks(weeksContainer, program);
        };

        // Calculer la progression du programme
        actions.calculerProgression = function(suiviProgramme) {
            const seancesTotales = suiviProgramme.progression.seances_totales;
            const seancesRealisees = suiviProgramme.seances_realisees.length;
            const pourcentage = Math.round((seancesRealisees / seancesTotales) * 100);
            
            const dateDebut = new Date(suiviProgramme.date_debut);
            const dateFin = new Date(suiviProgramme.date_fin_prevue);
            const aujourd_hui = new Date();
            
            const joursRestants = Math.max(0, Math.ceil((dateFin - aujourd_hui) / (1000 * 60 * 60 * 24)));
            const semaineActuelle = Math.min(
                Math.floor((aujourd_hui - dateDebut) / (1000 * 60 * 60 * 24 * 7)) + 1,
                PREDEFINED_PROGRAMS[suiviProgramme.programme_id].duree_semaines
            );

            return {
                pourcentage,
                seancesRealisees,
                seancesTotales,
                semaineActuelle: Math.max(1, semaineActuelle),
                joursRestants
            };
        };

        // Obtenir la prochaine séance
        actions.getNextSession = function() {
            if (!appState.currentProgram) return null;
            
            const program = PREDEFINED_PROGRAMS[appState.currentProgram.programme_id];
            if (!program.seances) return null;

            // Trouver la prochaine séance non réalisée
            const seancesRealisees = appState.currentProgram.seances_realisees.map(s => s.seance_id);
            const prochaineSeance = program.seances.find(seance => 
                !seancesRealisees.includes(seance.id)
            );

            return prochaineSeance || null;
        };

        // Démarrer la prochaine séance
        actions.startNextSession = function() {
            const prochaineSeance = this.getNextSession();
            if (!prochaineSeance) {
                this.showNotification('Aucune séance disponible');
                return;
            }

            this.chargerSeance(prochaineSeance.id);
        };

        // Charger une séance spécifique
        actions.chargerSeance = function(seanceId) {
            const program = PREDEFINED_PROGRAMS[appState.currentProgram.programme_id];
            const seance = program.seances.find(s => s.id === seanceId);
            
            if (!seance) {
                this.showNotification('Séance introuvable');
                return;
            }

            // Créer une nouvelle session basée sur la séance du programme
            const newSession = {
                date: new Date().toISOString().split('T')[0],
                notes: `${seance.nom} - ${program.nom}${seance.philosophie ? '\n\n💭 "' + seance.philosophie + '"' : ''}`,
                exercises: seance.exercices.map(ex => ({
                    exercise_id: this.findOrCreateExercise(ex.nom),
                    planned_sets: ex.series || 2,
                    rest_time: this.parseRestTime(ex.temps_repos),
                    duration: ex.duration || 30,
                    sets: [],
                    program_exercise: ex, // Conserver les infos du programme
                    program_info: {
                        groupe: ex.groupe,
                        resistance: ex.resistance,
                        conseil: ex.conseil,
                        repetitions: ex.repetitions
                    }
                })),
                globalSettings: {
                    restBetweenExercises: 120,
                    restBetweenSets: 90
                },
                fromProgram: {
                    programId: appState.currentProgram.programme_id,
                    sessionId: seanceId,
                    sessionName: seance.nom,
                    jour_semaine: seance.jour_semaine,
                    phase_eveil: seance.phase_eveil,
                    philosophie: seance.philosophie
                }
            };

            appState.currentSession = newSession;
            this.showScreen('preparation');
            this.showNotification(`🔥 Bataille "${seance.nom}" chargée ! Prêt pour l'assaut ?`);
        };

        // Helper pour parser le temps de repos
        actions.parseRestTime = function(tempsRepos) {
            if (typeof tempsRepos === 'number') return tempsRepos;
            if (typeof tempsRepos === 'string') {
                // Extraire le premier nombre de la chaîne "60-90 secondes"
                const match = tempsRepos.match(/(\d+)/);
                return match ? parseInt(match[1]) : 90;
            }
            return 90; // Valeur par défaut
        };

        // Trouver ou créer un exercice
        actions.findOrCreateExercise = function(exerciseName) {
            // Chercher d'abord dans les exercices existants
            const existing = appState.exercises.find(ex => 
                ex.name.toLowerCase() === exerciseName.toLowerCase()
            );
            
            if (existing) return existing.id;

            // Chercher dans les exercices prédéfinis
            for (const [category, exercises] of Object.entries(PREDEFINED_EXERCISES)) {
                const found = exercises.find(ex => 
                    ex.name.toLowerCase() === exerciseName.toLowerCase()
                );
                
                if (found) {
                    // Créer l'exercice dans l'app
                    const newExercise = {
                        id: Date.now() + Math.random(),
                        name: found.name,
                        is_unilateral: found.unilateral || false,
                        default_rest_time: 90,
                        category: category === 'echauffement' ? 'warmup' : 'strength',
                        exercise_mode: found.timeBase ? 'time' : 'reps',
                        default_duration: 30,
                        exercise_type: category === 'echauffement' ? 'bodyweight' : 'elastics',
                        anchor_point: found.anchor || 'none',
                        muscle_group: category
                    };
                    
                    appState.exercises.push(newExercise);
                    this.saveData();
                    return newExercise.id;
                }
            }

            // Si pas trouvé, créer un exercice générique
            const newExercise = {
                id: Date.now() + Math.random(),
                name: exerciseName,
                is_unilateral: false,
                default_rest_time: 90,
                category: 'strength',
                exercise_mode: 'reps',
                default_duration: 30,
                exercise_type: 'elastics',
                anchor_point: 'none',
                muscle_group: 'autres'
            };
            
            appState.exercises.push(newExercise);
            this.saveData();
            return newExercise.id;
        };

        // Rendre les semaines du programme (accordéon)
        actions.renderProgramWeeks = function(container, program) {
            container.innerHTML = '';

            if (!program.seances) {
                container.innerHTML = '<p>Aucune séance définie pour ce programme</p>';
                return;
            }

            // Grouper les séances par semaine
            const semainesGroupees = {};
            program.seances.forEach(seance => {
                if (!semainesGroupees[seance.semaine]) {
                    semainesGroupees[seance.semaine] = [];
                }
                semainesGroupees[seance.semaine].push(seance);
            });

            // Créer l'accordéon pour chaque semaine
            Object.entries(semainesGroupees).forEach(([semaine, seances]) => {
                const seancesRealisees = appState.currentProgram.seances_realisees.map(s => s.seance_id);
                const seancesCompletees = seances.filter(s => seancesRealisees.includes(s.id)).length;
                const progression = Math.round((seancesCompletees / seances.length) * 100);

                const weekDiv = document.createElement('div');
                weekDiv.className = 'week-accordion';
                
                weekDiv.innerHTML = `
                    <div class="week-header" onclick="actions.toggleWeek(${semaine})">
                        <div>
                            <div class="week-title">Semaine ${semaine}</div>
                            <div class="week-progress">${seancesCompletees}/${seances.length} séances (${progression}%)</div>
                        </div>
                        <div style="font-size: 18px;">▼</div>
                    </div>
                    <div class="week-content" id="week-${semaine}">
                        ${seances.map(seance => {
                            const isCompleted = seancesRealisees.includes(seance.id);
                            const statusClass = isCompleted ? 'completed' : 'pending';
                            const statusIcon = isCompleted ? '✅' : (seance.jour <= 3 ? '🟡' : '⭕');
                            
                            return `
                                <div class="session-item ${statusClass}" onclick="actions.chargerSeance('${seance.id}')">
                                    <div>
                                        <div class="session-day">Jour ${seance.jour}</div>
                                        <div class="session-name">${seance.nom}</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div class="session-duration">${seance.duree_minutes} min</div>
                                        <div class="session-status ${statusClass}">${statusIcon}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                container.appendChild(weekDiv);
            });
        };

        // Basculer l'affichage d'une semaine
        actions.toggleWeek = function(weekNumber) {
            const content = document.getElementById(`week-${weekNumber}`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                header.classList.remove('active');
                header.querySelector('div:last-child').textContent = '▼';
            } else {
                content.classList.add('active');
                header.classList.add('active');
                header.querySelector('div:last-child').textContent = '▲';
            }
        };

        // Afficher les paramètres du programme
        actions.showProgramSettings = function() {
            if (!appState.currentProgram) return;

            const modal = document.getElementById('program-settings-modal');
            
            // Charger les paramètres actuels
            document.getElementById('program-progression-type').value = 
                appState.currentProgram.parametres.type_progression || 'linear';
            document.getElementById('program-notifications').checked = 
                appState.currentProgram.parametres.notifications_actives;

            // Jours d'entraînement
            const jours = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            jours.forEach(jour => {
                const checkbox = document.getElementById(`day-${jour}`);
                if (checkbox) {
                    checkbox.checked = appState.currentProgram.parametres.jours_entrainement.includes(jour);
                }
            });

            modal.classList.add('active');
        };

        // Sauvegarder les paramètres du programme
        actions.saveProgramSettings = function() {
            if (!appState.currentProgram) return;

            // Sauvegarder les paramètres
            appState.currentProgram.parametres.type_progression = 
                document.getElementById('program-progression-type').value;
            appState.currentProgram.parametres.notifications_actives = 
                document.getElementById('program-notifications').checked;

            // Jours d'entraînement
            const jours = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            appState.currentProgram.parametres.jours_entrainement = jours.filter(jour => {
                const checkbox = document.getElementById(`day-${jour}`);
                return checkbox && checkbox.checked;
            });

            this.saveData();
            this.closeModal('program-settings-modal');
            this.showNotification('Paramètres sauvegardés');
        };

        // Marquer une séance comme effectuée
        actions.marquerSeanceEffectuee = function(seanceId, donnees) {
            if (!appState.currentProgram) return;

            const seance = {
                id: Date.now(),
                seance_id: seanceId,
                date_realisation: new Date().toISOString(),
                duree_reelle: donnees.duree || 30,
                exercices_realises: donnees.exercices || [],
                rpe: donnees.rpe || 7,
                notes: donnees.notes || '',
                statut: 'completed'
            };

            appState.currentProgram.seances_realisees.push(seance);
            
            // Mettre à jour la progression
            const progression = this.calculerProgression(appState.currentProgram);
            appState.currentProgram.progression = progression;

            this.saveData();
            this.showNotification('Séance marquée comme effectuée !');
        };

        // Charger les données des programmes
        actions.loadPredefinedPrograms = function() {
            // Les programmes sont déjà chargés depuis PREDEFINED_PROGRAMS
            this.loadHistoireGloirePrograms();
        };

        actions.loadCustomPrograms = function() {
            const container = document.getElementById('custom-programs-list');
            container.innerHTML = `
                <div class="card" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">⚙️</div>
                    <h3>Programmes personnalisés</h3>
                    <p>Fonctionnalité en cours de développement</p>
                </div>
            `;
        };

        // Afficher les stats du programme
        actions.showProgramStats = function() {
            // Rediriger vers l'écran stats avec le filtre programme
            this.showScreen('stats');
            this.showNotification('Statistiques du programme (en développement)');
        };

        // Fermer les modals
        actions.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log('SmartTrack - Initialisation de l\'application');
            actions.init();
        
            // === GESTION DU BOUTON RETOUR ===
            window.addEventListener('popstate', (event) => {
                event.preventDefault();
            
                // Vérifier s'il y a une séance en cours
                if (appState.liveSession || appState.manualSession) {
                    if (confirm('Une séance est en cours. Voulez-vous vraiment revenir en arrière ?')) {
                        const canGoBack = navigateBack();
                        if (!canGoBack && appState.currentScreen === 'dashboard') {
                            // On est déjà au dashboard, confirmer la sortie
                            if (confirm('Voulez-vous vraiment quitter SmartTrack ?')) {
                                return; // Laisser le navigateur gérer la sortie
                            }
                        }
                    }
                    // Rester dans l'application
                    window.history.pushState({ screen: appState.currentScreen }, '', window.location.href);
                    return;
                }
            
                const canGoBack = navigateBack();
                if (!canGoBack) {
                    // Si on est sur le dashboard et qu'il n'y a nulle part où aller, on peut quitter
                    if (appState.currentScreen === 'dashboard') {
                        // Demander confirmation avant de quitter
                        if (confirm('Voulez-vous vraiment quitter SmartTrack ?')) {
                            return; // Laisser le navigateur gérer la sortie
                        } else {
                            // Rester dans l'application
                            window.history.pushState({ screen: appState.currentScreen }, '', window.location.href);
                        }
                    } else {
                        // Revenir au dashboard par défaut
                        actions.showScreen('dashboard');
                    }
                }
            });

            // Intercepter aussi la tentative de fermeture/actualisation
            window.addEventListener('beforeunload', (event) => {
                // Ne demander confirmation que s'il y a une séance en cours
                if (appState.liveSession || appState.manualSession) {
                    event.preventDefault();
                    event.returnValue = 'Une séance est en cours. Êtes-vous sûr de vouloir quitter ?';
                    return event.returnValue;
                }
            });

            // Ajouter un état initial à l'historique du navigateur
            window.history.replaceState({ screen: 'dashboard' }, '', window.location.href);
        });

        // Fermeture des modals en cliquant à l'extérieur
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    
    
    </script>
    <script>
    // Enregistrement du Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('SmartTrack SW: Enregistré avec succès');
            
            // Écouter les mises à jour
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nouvelle version disponible
                  console.log('SmartTrack: Nouvelle version disponible');
                  // Optionnel: afficher une notification à l'utilisateur
                }
              });
            });
          })
          .catch(error => {
            console.log('SmartTrack SW: Échec d\'enregistrement', error);
          });
      });
    }
  </script>
</body>
</html>
